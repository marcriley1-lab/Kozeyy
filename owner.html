<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Owner Dashboard | Kozeyy</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase JS (FIXED CDN URL) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style> .rotate-180 { transform: rotate(180deg); }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, h4, .brand-font { font-family: 'Outfit', sans-serif; }
        .sidebar-active { background-color: #312e81; border-left: 4px solid #6366f1; color: white !important; }
        .nav-item { color: #94a3b8; }
        .nav-item:hover { color: white; background-color: #312e81; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        #mobile-overlay { background-color: rgba(0,0,0,0.5); }
        .paper-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50">

    <!-- MOBILE OVERLAY -->
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 hidden transition-opacity backdrop-blur-sm md:hidden"></div>

   <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-indigo-950 flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:static shadow-xl">
        <div class="h-20 flex items-center justify-between px-6 border-b border-indigo-900 bg-indigo-950">
            <div class="flex items-center gap-3">
                <!-- Logo Icon -->
                <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                    <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                    <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
                </svg>
                <span class="text-xl font-bold text-white tracking-tight brand-font">Kozeyy</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <!-- FIXED LINKS BELOW: Added event.preventDefault() -->
            <a href="#" onclick="event.preventDefault(); navTo('dashboard')" id="link-dashboard" class="nav-item flex items-center justify-between px-6 py-3.5 transition sidebar-active">
                <div class="flex items-center"><i class="fas fa-th-large w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Dashboard</span></div>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('tenants')" id="link-tenants" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-users w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Tenants</span></div>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('listings')" id="link-listings" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-sign w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Listings</span></div>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('screening')" id="link-screening" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-user-check w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Screening</span></div>
                <span id="badge-screening" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('messages')" id="link-messages" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-comment-dots w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Messages</span></div>
                <span id="badge-messages" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('maintenance')" id="link-maintenance" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-tools w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Maintenance</span></div>
                <span id="badge-maintenance" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('financials')" id="link-financials" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-money-bill-wave w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Records</span></div>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('expenses')" id="link-expenses" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-receipt w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Expenses</span></div>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('reports')" id="link-reports" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-chart-pie w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Reports</span></div>
            </a>
            
            <a href="#" onclick="event.preventDefault(); navTo('settings')" id="link-settings" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-sliders-h w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Settings</span></div>
            </a>
        </nav>
        
        <div class="p-6 border-t border-indigo-900 bg-indigo-950 flex flex-col gap-2">
            <button onclick="initSystem()" class="flex items-center text-xs text-indigo-300 hover:text-white transition"><i class="fas fa-sync-alt mr-2"></i> Refresh Data</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-10 sticky top-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-700 hover:text-indigo-600 focus:outline-none p-2 -ml-2 rounded-xl hover:bg-slate-50 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 class="text-xl md:text-xl font-bold text-slate-800 brand-font truncate" id="header-title">
                    <span class="md:hidden">Menu</span>
                    <span class="hidden md:inline" id="desktop-page-title">Portfolio Overview</span>
                </h2>
            </div>
            
            <div class="flex items-center gap-4 md:gap-6">
                <div class="flex items-center gap-3 md:pl-6 md:border-l border-slate-200">
                    <div class="text-right hidden md:block"><p class="text-sm font-bold text-slate-700 brand-font">James Dalton</p><p class="text-xs text-slate-500">Property Owner</p></div>
                    <div class="w-9 h-9 md:w-10 md:h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-md text-sm brand-font">JD</div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 scroll-smooth pb-32" id="app-content">
            
            <!-- 1. DASHBOARD -->
            <div id="view-dashboard" class="view-section fade-in">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-8">
                    <!-- Revenue -->
                    <div class="bg-gradient-to-br from-emerald-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-emerald-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-emerald-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-dollar-sign"></i></div><p class="text-emerald-800 text-[11px] font-bold uppercase tracking-wider brand-font">Revenue (This Month)</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-revenue">$0.00</h3></div>
                    </div>
                    <!-- Overdue -->
                    <div class="bg-gradient-to-br from-rose-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-rose-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-rose-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-exclamation"></i></div><p class="text-rose-800 text-[11px] font-bold uppercase tracking-wider brand-font">Overdue</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-overdue">$0.00</h3></div>
                    </div>
                    <!-- Occupancy -->
                    <div class="bg-gradient-to-br from-indigo-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-indigo-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-indigo-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-home"></i></div><p class="text-indigo-800 text-[11px] font-bold uppercase tracking-wider brand-font">Occupancy</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-occupancy">0%</h3></div>
                    </div>
                    <!-- REPAIRS -->
                    <div class="bg-gradient-to-br from-amber-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-amber-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-amber-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-tools"></i></div><p class="text-amber-800 text-[11px] font-bold uppercase tracking-wider brand-font">Repairs</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-maintenance">0</h3></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-80">
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="font-bold text-lg text-slate-800 brand-font" id="chart-title">Performance</h3>
                        </div>
                        <div class="h-64"><canvas id="revenueChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 brand-font">Quick Actions</h3>
                        <div class="space-y-3">
                            <button id="qa-tenant" onclick="openModal('modal-tenant')" class="w-full flex items-center justify-between p-4 bg-blue-50 text-blue-700 rounded-2xl hover:bg-blue-100 transition"><span class="font-bold text-sm brand-font">Add Tenant</span><i class="fas fa-user-plus bg-blue-200 p-2 rounded-full text-xs"></i></button>
                            <button id="qa-invoice" onclick="openInvoiceModal()" class="w-full flex items-center justify-between p-4 bg-emerald-50 text-emerald-700 rounded-2xl hover:bg-emerald-100 transition"><span class="font-bold text-sm brand-font">Create Invoice</span><i class="fas fa-plus bg-emerald-200 p-2 rounded-full text-xs"></i></button>
                            <button onclick="openModal('modal-listing')" class="w-full flex items-center justify-between p-4 bg-indigo-50 text-indigo-700 rounded-2xl hover:bg-indigo-100 transition"><span class="font-bold text-sm brand-font">Post Listing</span><i class="fas fa-home bg-indigo-200 p-2 rounded-full text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. TENANTS -->
            <div id="view-tenants" class="view-section hidden-section fade-in">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 brand-font">Directory</h3><button onclick="openModal('modal-tenant')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-blue-700 brand-font">+ Add</button></div>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-x-auto w-full">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Tenant</th>
                                <th class="p-5 hidden md:table-cell">Unit</th>
                                <th class="p-5 hidden md:table-cell">Rent</th>
                                <th class="p-5">Status</th>
                                <th class="p-5 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-tenants" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. LISTINGS -->
            <div id="view-listings" class="view-section hidden-section fade-in">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 brand-font">Listings</h3><button onclick="openModal('modal-listing')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow hover:bg-indigo-700 brand-font">+ Post</button></div>
                <div id="grid-listings" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <!-- 4. SCREENING -->
            <div id="view-screening" class="view-section hidden-section fade-in">
                <h3 class="text-xl font-bold text-slate-800 brand-font mb-4">Applicant Queue</h3>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-white text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Applicant</th>
                                <th class="p-5">Status</th>
                                <th class="p-5 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-screening" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. MESSAGES -->
            <div id="view-messages" class="view-section hidden-section fade-in h-[calc(100dvh-90px)]">
                <div class="flex h-full bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden relative">
                    <div id="msg-list-panel" class="w-full md:w-1/3 border-r border-slate-200 bg-slate-50 flex flex-col">
                        <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700 brand-font">Conversations</div>
                        <div id="list-chats" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    </div>
                    <div id="msg-view-panel" class="absolute inset-0 bg-white md:static w-full md:w-2/3 flex-col hidden md:flex z-20">
                        <div id="header-chat" class="p-4 border-b border-slate-200 bg-white font-bold text-slate-800 brand-font flex items-center gap-3">
                            <button onclick="backToChatList()" class="md:hidden text-slate-500 mr-2 p-2 rounded-full hover:bg-slate-100"><i class="fas fa-arrow-left"></i></button>
                            <span id="chat-title">Select a tenant</span>
                        </div>
                        <div id="box-chat" class="flex-1 p-4 md:p-6 overflow-y-auto bg-slate-50 space-y-4 custom-scroll pb-24 md:pb-6"></div>
                        <div class="p-4 border-t border-slate-200 bg-white flex gap-2 fixed bottom-0 left-0 right-0 md:static z-30 pb-[env(safe-area-inset-bottom,1.5rem)] md:pb-4">
                            <input type="text" id="input-chat" class="flex-1 border p-3 rounded-full outline-none focus:ring-2 focus:ring-indigo-500 text-sm font-medium" placeholder="Type a message...">
                            <button onclick="sendMsg()" class="bg-indigo-600 text-white w-12 h-12 rounded-full font-bold flex items-center justify-center shadow-lg hover:bg-indigo-700 transition"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. MAINTENANCE -->
            <div id="view-maintenance" class="view-section hidden-section fade-in">
                <h3 class="text-xl font-bold text-slate-800 mb-4 brand-font">Maintenance</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden"><div class="p-6 border-b bg-rose-50 border-rose-100"><h3 class="font-bold text-rose-800 brand-font">Active</h3></div><div id="list-maint-active" class="divide-y divide-slate-100"></div></div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden"><div class="p-6 border-b bg-slate-50 border-slate-100"><h3 class="font-bold text-slate-700 brand-font">History</h3></div><div id="list-maint-history" class="divide-y divide-slate-100"></div></div>
                </div>
            </div>

            <!-- 7. PAYMENT RECORDS -->
            <div id="view-financials" class="view-section hidden-section fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Records</h3>
                    <div class="flex gap-2">
                        <button onclick="act_openPayModal(null)" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-blue-700 brand-font">+ Payment</button>
                        <button onclick="openInvoiceModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-emerald-700 brand-font">+ Invoice</button>
                    </div>
                </div>
                
                <div id="fin-summary-container" class="mb-6 hidden-section">
                    <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm max-w-xs">
                        <p class="text-xs text-slate-500 font-bold uppercase">Open Balance</p>
                        <h4 class="text-xl font-bold text-slate-800" id="fin-open-bal">$0.00</h4>
                    </div>
                </div>

                <div class="mb-4">
                    <select id="filter-financials" onchange="renderInvoices()" class="border p-2 rounded-lg text-sm bg-white"><option value="all">All Tenants</option></select>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Date</th>
                                <th class="p-5">Tenant</th>
                                <th class="p-5">Description</th>
                                <th class="p-5 text-right">Amount</th>
                                <th class="p-5 text-right">Balance</th>
                                <th class="p-5 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-invoices" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 8. EXPENSES -->
            <div id="view-expenses" class="view-section hidden-section fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Expenses</h3>
                    <div class="flex gap-3 w-full md:w-auto">
                        <select id="filter-expenses" onchange="renderExpenses()" class="border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white flex-1 md:flex-none font-medium text-slate-600"><option value="all">All Properties</option></select>
                        <div class="bg-rose-50 text-rose-700 px-4 py-2 rounded-xl font-bold border border-rose-200 text-sm flex-1 md:flex-none text-center brand-font">Total: <span id="exp-total-display">$0.00</span></div>
                        <button onclick="populateExpenseModal(); openModal('modal-expense')" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-rose-700 flex-none brand-font">+ Add</button>
                    </div>
                </div>

             <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font"><tr><th class="p-5">Date</th><th class="p-5">Property</th><th class="p-5">Vendor</th><th class="p-5">Category</th><th class="p-5 text-right">Amount</th><th class="p-5 text-center">Receipt</th><th class="p-5 text-right">Actions</th></tr></thead>
                        <tbody id="table-expenses" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 9. REPORTS -->
            <div id="view-reports" class="view-section hidden-section fade-in">
                <h3 class="text-xl font-bold text-slate-800 brand-font mb-6">Reports</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg text-slate-900 border-b pb-4 mb-4 brand-font">Income Statement (Year to Date)</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center"><span class="text-slate-600">Total Revenue</span><span class="font-bold text-emerald-600 text-lg brand-font" id="report-income">$0.00</span></div>
                            <div class="flex justify-between items-center"><span class="text-slate-600">Total Expenses</span><span class="font-bold text-rose-600 text-lg brand-font" id="report-expense">$0.00</span></div>
                            <div class="border-t pt-4 flex justify-between items-center mt-4"><span class="font-extrabold text-slate-800 brand-font">Net Operating Income</span><span class="font-extrabold text-indigo-900 text-2xl brand-font" id="report-noi">$0.00</span></div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg text-slate-900 mb-4 brand-font">Monthly Breakdown</h4>
                        <div class="h-64"><canvas id="monthlyChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 10. SETTINGS -->
            <div id="view-settings" class="view-section hidden-section fade-in">
                <div class="bg-white rounded-3xl shadow-lg border border-slate-200 p-8 max-w-3xl mx-auto">
                    <h3 class="text-2xl font-bold mb-8 brand-font">Settings: Late Fees</h3>
                    <form onsubmit="act_saveSettings(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Apply To</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-xl hover:bg-slate-50 transition"><input type="radio" name="feeTarget" value="all" checked onchange="toggleFeeTarget()" class="text-indigo-600"> <span class="text-sm font-medium">All Tenants</span></label>
                                <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-xl hover:bg-slate-50 transition"><input type="radio" name="feeTarget" value="select" onchange="toggleFeeTarget()" class="text-indigo-600"> <span class="text-sm font-medium">Specific Tenants</span></label>
                            </div>
                            <div id="fee-tenant-select" class="hidden-section mt-3 p-3 bg-slate-50 rounded-xl border border-slate-200 max-h-32 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Charge Method</label>
                            <select id="fee-method" class="w-full border p-3 rounded-xl bg-slate-50" onchange="toggleFeeInput()"><option value="flat">Manual Flat Fee ($)</option><option value="daily">Daily Charge ($/day)</option><option value="percent">Percentage of Rent (%)</option></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-bold text-slate-700 mb-2 brand-font" id="fee-label">Amount ($)</label><input type="number" id="fee-amount" class="w-full border p-3 rounded-xl bg-slate-50" value="50"></div>
                            <div><label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Grace Period (Days)</label><input type="number" id="fee-grace" class="w-full border p-3 rounded-xl bg-slate-50" value="5"></div>
                        </div>
                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="font-bold text-lg text-slate-800 mb-4 brand-font">Lease Requirements</h4>
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="set-insurance" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300"><span class="font-medium text-slate-700 brand-font">Require Renter's Insurance</span></label>
                                <p class="text-xs text-slate-500 mt-1 ml-8">If checked, tenants will see a requirement notice.</p>
                            </div>
                        </div>
                        
                        <!-- NEW: SCREENING CRITERIA SECTION -->
                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="font-bold text-lg text-slate-800 mb-4 brand-font">Screening Criteria</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Min Credit Score</label><input type="number" id="set-min-score" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="e.g. 650"></div>
                                <div><label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Min Income (x Rent)</label><input type="number" step="0.1" id="set-min-income" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="e.g. 3.0"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="set-no-evict" class="text-indigo-600 rounded"><span class="text-sm font-medium">No Evictions</span></label></div>
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="set-no-crim" class="text-indigo-600 rounded"><span class="text-sm font-medium">No Criminal Hist.</span></label></div>
                            </div>
                            <div class="mt-4 p-3 bg-slate-50 rounded-xl border border-slate-200"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="set-req-job" class="text-indigo-600 rounded"><span class="text-sm font-medium">Require Verified Employment</span></label></div>
                        </div>
                        <!-- END NEW SECTION -->

                        <button class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg brand-font">Save Configuration</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- TENANT MODAL -->
    <div id="modal-tenant" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative">
            <button onclick="closeModal('modal-tenant')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-tenant-title">Add Tenant</h3>
            <form onsubmit="act_saveTenant(event)" class="space-y-4">
                <input type="hidden" id="t-id">
                <div class="grid grid-cols-2 gap-4">
                    <input id="t-name" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Full Name" required>
                    <input id="t-phone" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Phone">
                </div>
                <input id="t-email" type="email" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Email Address" required>
                <!-- ADDED ADDRESS INPUTS -->
                <input id="t-addr" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Property Address">
                <div class="grid grid-cols-3 gap-4">
                    <input id="t-city" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="City">
                    <input id="t-state" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="State">
                    <input id="t-zip" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Zip">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="t-unit" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Unit #">
                    <input id="t-rent" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Rent Amount" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 ml-1">Lease Start</label><input type="date" id="t-start" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                    <div><label class="text-xs font-bold text-slate-500 ml-1">Lease End</label><input type="date" id="t-end" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                </div>
                 <select id="t-status" class="w-full border p-3 rounded-xl bg-slate-50">
                    <option value="Active">Active</option>
                    <option value="Vacant">Vacant</option>
                    <option value="Archived">Archived</option>
                </select>
                <button class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold brand-font shadow-lg hover:bg-blue-700 transition" id="btn-save-tenant">Save Tenant</button>
            </form>
        </div>
    </div>

    <!-- VIEW TENANT MODAL -->
    <div id="modal-view-tenant" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative">
            <button onclick="closeModal('modal-view-tenant')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font">Tenant Details</h3>
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Contact Info</p>
                    <h4 class="text-lg font-bold text-slate-800" id="vt-name"></h4>
                    <p class="text-sm text-slate-600"><i class="fas fa-envelope w-5"></i> <span id="vt-email"></span></p>
                    <p class="text-sm text-slate-600"><i class="fas fa-phone w-5"></i> <span id="vt-phone"></span></p>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Property</p>
                    <p class="text-sm font-medium text-slate-800" id="vt-addr"></p>
                    <div class="flex gap-4 mt-2">
                        <div><p class="text-xs text-slate-500">Unit</p><p class="font-bold" id="vt-unit"></p></div>
                        <div><p class="text-xs text-slate-500">Rent</p><p class="font-bold text-emerald-600" id="vt-rent"></p></div>
                        <div><p class="text-xs text-slate-500">Status</p><p class="font-bold" id="vt-status"></p></div>
                    </div>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Lease Term</p>
                    <div class="flex justify-between">
                        <div><p class="text-xs text-slate-500">Start</p><p class="font-bold text-slate-700" id="vt-start"></p></div>
                        <div><p class="text-xs text-slate-500">End</p><p class="font-bold text-slate-700" id="vt-end"></p></div>
                    </div>
                </div>

                <button onclick="closeModal('modal-view-tenant')" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold brand-font shadow-lg hover:bg-slate-900 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- LISTING MODAL -->
    <div id="modal-listing" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-listing')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-listing-title">Property Listing</h3>
            <form onsubmit="act_saveListing(event)" class="space-y-4">
                <input id="l-addr" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Property Address" required>
                <div class="grid grid-cols-2 gap-4">
                    <input id="l-price" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Monthly Price" required>
                    <input id="l-sqft" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Sq Ft">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="l-beds" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Beds">
                    <input id="l-baths" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Baths">
                </div>
                <textarea id="l-desc" class="w-full border p-3 rounded-xl bg-slate-50 h-24" placeholder="Description"></textarea>
                <input id="l-amen" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Amenities (comma separated)">
                <input type="date" id="l-date" class="w-full border p-3 rounded-xl bg-slate-50" required>
                <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold brand-font shadow-lg hover:bg-indigo-700 transition" id="btn-save-listing">Post Listing</button>
            </form>
        </div>
    </div>

    <!-- INVOICE MODAL -->
    <div id="modal-invoice" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-invoice')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="inv-modal-title">Create Invoice</h3>
            
            <!-- STEP 1: INPUTS -->
            <div id="inv-step-input">
                <form onsubmit="event.preventDefault(); logic_generatePreview();" class="space-y-4">
                    <select id="inv-tenant" onchange="logic_resetInvoice()" class="w-full border p-3 rounded-xl bg-slate-50" required><option value="" disabled selected>Select a Tenant</option></select>
                    
                    <div class="flex gap-2 p-1 bg-slate-100 rounded-xl">
                        <button type="button" onclick="logic_invMode('fixed')" id="btn-fixed" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-emerald-700">Fixed Rent</button>
                        <button type="button" onclick="logic_invMode('variable')" id="btn-variable" class="flex-1 py-2 rounded-lg font-bold text-sm text-slate-500">Variable</button>
                    </div>
                    
                    <!-- Items Area -->
                    <div id="inv-items-container" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    <button type="button" id="btn-add-row" onclick="logic_addRow()" class="hidden-section w-full border border-dashed border-slate-300 text-slate-500 py-2 rounded-xl text-sm">+ Add Item</button>
                    
                    <!-- Attach Document -->
                    <div class="mt-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1 brand-font">Attach Document</label>
                        <div class="flex items-center gap-2">
                            <label for="inv-doc" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2 border border-slate-300">
                                <i class="fas fa-paperclip"></i> <span id="inv-doc-label">Choose File</span>
                            </label>
                            <input type="file" id="inv-doc" class="hidden" accept=".pdf, .jpg, .jpeg, .png" onchange="updateFileName('inv-doc', 'inv-doc-label')">
                        </div>
                    </div>

                    <!-- Date Selection -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Send Invoice On</label>
                        <input type="date" id="inv-date" required class="w-full border p-3 rounded-xl bg-slate-50">
                    </div>

                    <!-- Recurring Options (Visible only for Fixed) -->
                    <div id="inv-recurring-options" class="p-4 bg-slate-50 rounded-xl border border-slate-200 hidden-section">
                        <label class="flex items-center gap-2 mb-3 cursor-pointer">
                            <input type="checkbox" id="inv-is-recurring" class="w-4 h-4 text-emerald-600 rounded">
                            <span class="font-bold text-sm text-slate-700">Recurring Invoice?</span>
                        </label>
                        <div id="inv-rec-details" class="hidden-section space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-500 block">Send Day (1-31)</label><input type="number" id="inv-rec-day" min="1" max="31" value="1" class="w-full border p-2 rounded-lg"></div>
                                <div><label class="text-xs text-slate-500 block">End Date</label><input type="date" id="inv-rec-end" class="w-full border p-2 rounded-lg"></div>
                            </div>
                            <p class="text-[10px] text-slate-400">Invoice will automatically generate each month.</p>
                        </div>
                    </div>

                    <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold brand-font hover:bg-indigo-700 transition">Preview Invoice</button>
                </form>
            </div>

            <!-- STEP 2: PREVIEW -->
            <div id="inv-step-preview" class="hidden-section">
                <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6 paper-shadow relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-indigo-600"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 brand-font">INVOICE</h2>
                            <p class="text-xs text-slate-400 mt-1">Kozeyy Property Mgmt</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-slate-700" id="prev-date">Oct 24, 2023</p>
                            <p class="text-xs text-slate-500">Bill To: <span id="prev-name">Tenant Name</span></p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Account Summary -->
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div class="flex justify-between text-xs text-slate-500 mb-1"><span>Previous Balance</span><span id="prev-bal-amt">$0.00</span></div>
                            <div class="flex justify-between text-xs text-emerald-600 mb-1"><span>Payments Received</span><span id="prev-pay-amt">-$0.00</span></div>
                            <div class="border-t border-slate-200 my-1"></div>
                            <div class="flex justify-between text-xs font-bold text-slate-700"><span>Forward Balance</span><span id="prev-fwd-amt">$0.00</span></div>
                        </div>

                        <!-- Current Charges -->
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-400 uppercase border-b"><tr><th class="py-2">Description</th><th class="py-2 text-right">Amount</th></tr></thead>
                            <tbody id="prev-items-body" class="text-slate-700"></tbody>
                        </table>
                        
                        <!-- Attachment Indicator -->
                        <div id="prev-attachment" class="hidden-section mt-2 text-xs text-slate-500 flex items-center gap-2">
                             <i class="fas fa-paperclip text-indigo-500"></i> <span>Attachment Included</span>
                        </div>
                        
                        <!-- Total -->
                        <div class="border-t-2 border-slate-800 pt-3 mt-4 flex justify-between items-center">
                            <span class="font-bold text-lg brand-font">Total Due</span>
                            <span class="font-bold text-2xl text-indigo-700 brand-font" id="prev-total-due">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div id="inv-actions-create" class="flex gap-3">
                    <button onclick="logic_backToInput()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50">Back</button>
                    <button onclick="logic_confirmInvoice()" id="btn-confirm-inv" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow hover:bg-emerald-700">Send Invoice</button>
                </div>
                
                <div id="inv-actions-view" class="hidden-section">
                    <button onclick="closeModal('modal-invoice')" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow hover:bg-slate-900">Close</button>
                </div>
            </div>

        </div>
    </div>

    <!-- EXPENSE MODAL -->
    <div id="modal-expense" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative">
            <button onclick="closeModal('modal-expense')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-expense-title">Expense</h3>
            <form onsubmit="act_saveExpense(event)" class="space-y-4">
                <input type="hidden" id="ex-id">
                <select id="ex-prop" class="w-full border p-3 rounded-xl bg-slate-50"></select>
                <input type="date" id="ex-date" class="w-full border p-3 rounded-xl bg-slate-50" required>
                <input id="ex-vendor" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Vendor" required>
                <select id="ex-cat" class="w-full border p-3 rounded-xl bg-slate-50"><option>Repairs</option><option>Utilities</option><option>Tax</option><option>Insurance</option><option>Other</option></select>
                <input id="ex-amount" type="number" step="0.01" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Amount" required>
                
                <!-- Receipt Upload -->
                <div class="mt-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Receipt</label>
                    <div class="flex items-center gap-2">
                        <label for="ex-doc" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-slate-300">
                            <i class="fas fa-camera"></i> <span id="ex-doc-label">Upload</span>
                        </label>
                        <input type="file" id="ex-doc" class="hidden" accept=".pdf, .jpg, .jpeg, .png" onchange="updateFileName('ex-doc', 'ex-doc-label')">
                    </div>
                </div>

                <button class="w-full bg-rose-600 text-white py-3 rounded-xl font-bold brand-font" id="btn-save-expense">Save</button>
            </form>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="modal-pay" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm relative">
            <h3 class="text-xl font-bold mb-4 brand-font">Record Payment</h3>
            <select id="pay-tenant-select" class="w-full border p-3 rounded-xl mb-4 hidden-section"></select>
            <input type="hidden" id="pay-tenant-id">
            <input type="number" id="pay-amount" class="w-full border p-3 rounded-xl mb-4" placeholder="Amount Recieved">
            <input type="date" id="pay-date" class="w-full border p-3 rounded-xl mb-4">
            <div class="flex gap-2">
                <button onclick="closeModal('modal-pay')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">Cancel</button>
                <button onclick="confirmPay()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold">Save</button>
            </div>
        </div>
    </div>
    
    <!-- MAINT DETAIL MODAL -->
    <div id="modal-maint-detail" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4"><div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md relative"><button onclick="closeModal('modal-maint-detail')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button><h3 class="text-xl font-bold mb-2 brand-font">Request</h3><p id="md-issue" class="text-lg font-medium text-slate-800 mb-1 brand-font"></p><p id="md-meta" class="text-sm text-slate-500 mb-4"></p><div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Notes</p><p id="md-notes" class="text-sm text-slate-700 italic">None</p></div><button onclick="closeModal('modal-maint-detail')" class="w-full border border-slate-300 text-slate-600 py-2 rounded-xl font-bold hover:bg-slate-50 brand-font">Close</button></div></div>

    <!-- SCREENING DETAIL MODAL -->
    <div id="modal-screening-detail" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-screening-detail')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-1 brand-font">Applicant Report</h3>
            <h4 id="sd-name" class="text-lg text-slate-600 mb-6"></h4>

            <div class="space-y-4">
                <!-- Status Banner -->
                <div id="sd-banner" class="p-4 rounded-xl border font-bold text-center"></div>

                <!-- Financials -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Financials</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><p class="text-xs text-slate-500">Credit Score</p><p class="font-bold text-lg" id="sd-score">-</p></div>
                        <div><p class="text-xs text-slate-500">Monthly Income</p><p class="font-bold text-lg" id="sd-income">-</p></div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">Rent Coverage: <span id="sd-ratio" class="font-bold text-slate-800"></span>x</div>
                </div>

                <!-- Employment (NEW SECTION) -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Employment</p>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-slate-500">Job Title</span>
                        <span id="sd-job" class="font-bold text-sm text-slate-800">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Verified Status</span>
                        <span id="sd-employ" class="font-bold text-sm">-</span>
                    </div>
                </div>

                <!-- Background -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Background Check</p>
                    <div class="flex justify-between items-center border-b border-slate-200 pb-2 mb-2">
                        <span class="text-sm font-medium">Evictions</span>
                        <span id="sd-evict" class="font-bold text-sm">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium">Criminal History</span>
                        <span id="sd-crim" class="font-bold text-sm">-</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mt-4">
                    <button onclick="act_screenDecision('Approve')" class="bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow">Approve</button>
                    <button onclick="act_screenDecision('Conditional')" class="bg-amber-400 text-white py-3 rounded-xl font-bold text-sm shadow">Conditional</button>
                    <button onclick="act_screenDecision('Deny')" class="bg-rose-600 text-white py-3 rounded-xl font-bold text-sm shadow">Deny</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
        // FIXED: window.supabase is now guaranteed to exist due to updated script source
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- GLOBAL STATE ---
        let state = {
            tenants: [], listings: [], invoices: [], payments: [], expenses: [],
            apps: [], msgs: [], maint: [], settings: {}, recurringInvoices: [],
            lastVarItems: {},
            notifications: { messages: 0, maintenance: 0, screening: 0 }
        };
        
        // Helper to parse SQL Date (YYYY-MM-DD) to JS Date Object for comparison
        function parseDateStr(str) {
            if(!str) return new Date();
            const parts = str.split('-');
            return new Date(parts[0], parts[1]-1, parts[2]);
        }

        let currentChatId = null, invMode = 'fixed', invItems = [], chartInstance = null, monthlyChartInstance = null;
        let editTenantId = null, editListingId = null, editExpenseId = null, currentAppId = null;
        let draftInvoice = null; 
	    let expandedExpId = null;

        // --- INIT DATA FETCH ---
        async function initSystem() {
            try {
                // Fetch all tables in parallel
                const [t, l, i, p, e, m, msg, s, a, r] = await Promise.all([
                    supabase.from('tenants').select('*'),
                    supabase.from('listings').select('*'),
                    supabase.from('invoices').select('*'),
                    supabase.from('payments').select('*'),
                    supabase.from('expenses').select('*'),
                    supabase.from('maintenance').select('*'),
                    supabase.from('msgs').select('*'),
                    supabase.from('settings').select('*').single(),
                    supabase.from('apps').select('*'),
                    supabase.from('recurring_invoices').select('*')
                ]);

                // Populate State
                state.tenants = t.data || [];
                state.listings = l.data || [];
                state.invoices = i.data || [];
                state.payments = p.data || [];
                state.expenses = e.data || [];
                state.maint = m.data || [];
                state.msgs = msg.data || [];
                state.settings = s.data || { screening: { minScore: 650 } };
                state.apps = a.data || [];
                state.recurringInvoices = r.data || [];

                // Calculate Notifications based on unread/active status
                state.notifications.screening = state.apps.filter(x => x.status === 'Pending').length;
                state.notifications.maintenance = state.maint.filter(x => x.status === 'Active').length;
                
                // Initial Render
                initChart();
                renderAll();
            } catch (err) {
                console.error("Initialization failed:", err);
                // Fallback render to show empty state instead of broken UI
                renderAll();
            }
        }

        // --- FINANCIAL ENGINE ---
        function getTenantFinancials(tenantId) {
            let invoices = state.invoices.filter(i => i.tenant_id == tenantId).sort((a,b) => parseDateStr(a.date) - parseDateStr(b.date));
            let payments = state.payments.filter(p => p.tenant_id == tenantId);
            let totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            
            let paymentPool = totalPaid;
            let processedInvoices = [];
            
            invoices.forEach(inv => {
                let paidAmount = 0;
                if (paymentPool > 0) {
                    if (paymentPool >= inv.total) {
                        paidAmount = inv.total;
                        paymentPool -= inv.total;
                    } else {
                        paidAmount = paymentPool;
                        paymentPool = 0;
                    }
                }
                
                let balance = inv.total - paidAmount;
                let status = 'Unpaid';
                if (paidAmount >= inv.total) status = 'Paid';
                else if (paidAmount > 0) status = 'Partial';
                
                processedInvoices.push({ ...inv, paid: paidAmount, balance: balance, status: status });
            });
            
            let openBalance = processedInvoices.reduce((sum, inv) => sum + inv.balance, 0);
            let credit = paymentPool; 
            let net = credit - openBalance;
            
            return {
                invoices: processedInvoices,
                summary: { openBalance, credit, netPosition: net }
            };
        }

        function calculateGlobalStats() {
            let revenue = 0; // Collected THIS MONTH
            let outstanding = 0; // Unpaid Future
            let overdue = 0; // Unpaid Past
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            state.payments.forEach(p => {
                const pDate = parseDateStr(p.date);
                if(pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear) {
                    revenue += p.amount;
                }
            });

            const distinctTenantIds = [...new Set(state.invoices.map(i => i.tenant_id))];
            distinctTenantIds.forEach(tid => {
                const fin = getTenantFinancials(tid);
                fin.invoices.forEach(inv => {
                    if (inv.balance > 0) {
                        const d1 = parseDateStr(inv.date).setHours(0,0,0,0);
                        const d2 = new Date().setHours(0,0,0,0);
                        if (d1 < d2) overdue += inv.balance;
                        else outstanding += inv.balance;
                    }
                });
            });

            return { revenue, outstanding, overdue };
        }

        function getMonthlyFinancials() {
            const months = [];
            const revenueData = [];
            const expenseData = [];
            
            const today = new Date();
            for(let i=5; i>=0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const mKey = d.getMonth();
                const yKey = d.getFullYear();
                months.push(d.toLocaleString('default', { month: 'short' }));
                
                const monthRev = state.payments.reduce((sum, p) => {
                    const pd = parseDateStr(p.date);
                    return (pd.getMonth() === mKey && pd.getFullYear() === yKey) ? sum + p.amount : sum;
                }, 0);
                revenueData.push(monthRev);
                
                const monthExp = state.expenses.reduce((sum, e) => {
                    const ed = parseDateStr(e.date);
                    return (ed.getMonth() === mKey && ed.getFullYear() === yKey) ? sum + e.amount : sum;
                }, 0);
                expenseData.push(monthExp);
            }
            return { labels: months, revenue: revenueData, expenses: expenseData };
        }

        // --- NAVIGATION ---
        function navTo(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-section'));
            document.getElementById('view-' + view).classList.remove('hidden-section');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('sidebar-active'));
            const link = document.getElementById('link-' + view);
            if(link) link.classList.add('sidebar-active');
            
            const titles = { dashboard: 'Portfolio Overview', tenants: 'Tenant Directory', listings: 'Property Listings', financials: 'Payment Records', expenses: 'Expense Tracker', reports: 'Financial Reports', settings: 'System Configuration', screening: 'Applicant Queue', messages: 'Communication Center', maintenance: 'Maintenance Requests' };
            document.getElementById('desktop-page-title').innerText = titles[view] || 'Dashboard';
            if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('mobile-overlay').classList.add('hidden'); }
            
            if(view === 'financials') populateFinFilter();
            if(view === 'expenses') { populateExpenseModal(); populateExpFilter(); }
            if(view === 'messages') { renderChatList(); backToChatList(); }
            if(view === 'tenants' || view === 'listings' || view === 'expenses' || view === 'maintenance' || view === 'screening') renderAll();
            if(view === 'reports') { renderAll(); setTimeout(renderMonthlyChart, 50); }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden-section'); document.getElementById(id).classList.add('flex'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden-section'); document.getElementById(id).classList.remove('flex'); resetForms(); }
        function resetForms() { 
            editTenantId = null; editListingId = null; editExpenseId = null; 
            document.getElementById('btn-save-tenant').innerText="Save Tenant"; 
            document.getElementById('btn-save-listing').innerText="Post Listing"; 
            document.getElementById('btn-save-expense').innerText="Save"; 
            
            document.getElementById('ex-id').value = ""; document.getElementById('ex-amount').value = ""; document.getElementById('ex-vendor').value = ""; document.getElementById('ex-date').value = ""; document.getElementById('ex-doc').value = ""; 
            
            document.getElementById('t-id').value = ""; document.getElementById('t-name').value = ""; document.getElementById('t-email').value = ""; document.getElementById('t-phone').value = ""; document.getElementById('t-unit').value = ""; document.getElementById('t-rent').value = ""; document.getElementById('t-start').value = ""; document.getElementById('t-end').value = ""; document.getElementById('t-addr').value = ""; document.getElementById('t-city').value = ""; document.getElementById('t-state').value = ""; document.getElementById('t-zip').value = "";
            
            document.getElementById('l-addr').value = ""; document.getElementById('l-price').value = ""; document.getElementById('l-sqft').value = ""; document.getElementById('l-beds').value = ""; document.getElementById('l-baths').value = ""; document.getElementById('l-desc').value = ""; document.getElementById('l-amen').value = ""; document.getElementById('l-date').value = "";

            updateFileName('inv-doc', 'inv-doc-label'); updateFileName('ex-doc', 'ex-doc-label'); 
        }

        // Helper to get Last Name for Sorting
        function getLastName(fullName) {
            if(!fullName) return '';
            const parts = fullName.trim().split(' ');
            return parts.length > 1 ? parts[parts.length - 1] : parts[0];
        }

        // --- NEW HELPER: Evaluate Applicant ---
        function evalApplicant(app) {
            const crit = state.settings.screening || { minScore: 600, minIncome: 2.5 };
            const incomeRatio = app.income / app.rent;
            
            // Red Flags (Automatic Fail based on boolean settings)
            if(crit.noEvict && app.evictions) return { status: 'Does Not Meet', color: 'bg-rose-100 text-rose-700 border-rose-200' };
            if(crit.noCrim && app.criminal) return { status: 'Does Not Meet', color: 'bg-rose-100 text-rose-700 border-rose-200' };
            
            // Employment Check
            if(crit.requireJob && !app.employment) return { status: 'Does Not Meet', color: 'bg-rose-100 text-rose-700 border-rose-200' };

            if(app.score < (crit.minScore - 50)) return { status: 'Does Not Meet', color: 'bg-rose-100 text-rose-700 border-rose-200' };

            // Conditional (Close call)
            if(app.score < crit.minScore || incomeRatio < crit.minIncome) {
                return { status: 'Conditional', color: 'bg-amber-100 text-amber-700 border-amber-200' };
            }

            // Green
            return { status: 'Meets Criteria', color: 'bg-emerald-100 text-emerald-700 border-emerald-200' };
        }

        function renderAll() {
            updateBadge('messages', state.notifications.messages); 
            updateBadge('maintenance', state.notifications.maintenance); 
            updateBadge('screening', state.notifications.screening);

            const stats = calculateGlobalStats();
            const validUnits = state.tenants.filter(t => t.status !== 'Archived');
            const activeTenants = validUnits.filter(t => t.status === 'Active').length;
            const totalUnits = validUnits.length;
            const occupancyRate = totalUnits === 0 ? 0 : Math.round((activeTenants / totalUnits) * 100);
            const activeMaint = state.maint.filter(m=>m.status==='Active').length;

            document.getElementById('dash-revenue').innerText = `$${stats.revenue.toLocaleString()}`;
            document.getElementById('dash-maintenance').innerText = activeMaint; 
            document.getElementById('dash-overdue').innerText = `$${stats.overdue.toLocaleString()}`;
            document.getElementById('dash-occupancy').innerText = `${occupancyRate}%`;
            
            // Performance Chart Logic (Restored)
            if(chartInstance) {
                chartInstance.data.datasets[0].data = [stats.revenue, stats.outstanding, stats.overdue];
                chartInstance.update();
            } else if(document.getElementById('revenueChart')) {
                // Initialize if exists but not created (page reload)
                initChart();
                if(chartInstance) {
                    chartInstance.data.datasets[0].data = [stats.revenue, stats.outstanding, stats.overdue];
                    chartInstance.update();
                }
            }

            // Tables Render Logic - SORTED BY LAST NAME
            const tbody = document.getElementById('table-tenants'); tbody.innerHTML = '';
            state.tenants
                .filter(t => t.status !== 'Archived')
                .sort((a, b) => getLastName(a.name || '').localeCompare(getLastName(b.name || ''))) // ADDED SAFETY CHECK
                .forEach(t => { 
                    const st = t.status === 'Active' ? 'bg-emerald-100 text-emerald-700' : (t.status === 'Vacant' ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-500');
                    tbody.innerHTML += `<tr class="border-b border-slate-100">
                        <td class="p-5 font-bold cursor-pointer hover:text-indigo-600 transition" onclick="act_viewTenant(${t.id})">
                            ${t.name}<br>
                            <span class="text-xs text-slate-400 font-normal">${t.email}</span><br>
                            <span class="text-xs text-slate-500 font-normal">${t.phone || '-'}</span>
                        </td>
                        <td class="p-5 text-sm hidden md:table-cell">${t.unit || '-'}</td>
                        <td class="p-5 text-sm hidden md:table-cell">$${parseInt(t.rent).toLocaleString()}</td>
                        <td class="p-5"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${st}">${t.status}</span></td>
                        <td class="p-5 text-right"><div class="flex justify-end gap-3"><button onclick="act_editTenant(${t.id})" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button><button onclick="act_delTenant(${t.id})" class="text-rose-400 hover:text-rose-600"><i class="fas fa-trash"></i></button></div></td>
                    </tr>`; 
            });

            const grid = document.getElementById('grid-listings'); grid.innerHTML = '';
            state.listings.forEach(l => { grid.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 relative group"><div class="absolute top-4 right-4 flex gap-3"><button onclick="act_editListing(${l.id})" class="text-slate-400 hover:text-blue-600"><i class="fas fa-edit"></i></button><button onclick="act_delListing(${l.id})" class="text-slate-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div><h4 class="font-bold text-lg text-slate-800">${l.addr}</h4><p class="text-emerald-600 font-bold">$${parseInt(l.price).toLocaleString()}/mo</p><div class="mt-2 text-xs text-slate-400 flex gap-3"><span><i class="fas fa-bed"></i> ${l.beds}</span><span><i class="fas fa-bath"></i> ${l.baths}</span><span><i class="fas fa-ruler"></i> ${l.sqft}</span></div></div>`; });

            const activeList = document.getElementById('list-maint-active'); const histList = document.getElementById('list-maint-history'); activeList.innerHTML = ''; histList.innerHTML = '';
            const activeMaintItems = state.maint.filter(m => m.status === 'Active');
            if (activeMaintItems.length === 0) { activeList.innerHTML = `<div class="p-8 text-center text-slate-400 italic">None</div>`; } else { activeMaintItems.forEach(m => { const t = state.tenants.find(x=>x.id==m.tenant_id)||{name:'Unknown'}; activeList.innerHTML += `<div class="p-4 flex justify-between items-center bg-white border-b border-slate-100"><div><p class="font-bold text-slate-800">${m.issue}</p><p class="text-xs text-slate-500">${t.name}  ${m.date}</p></div><button onclick="act_completeMaint(${m.id})" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded text-xs font-bold hover:bg-emerald-200">Done</button></div>`; }); }
            state.maint.filter(m => m.status === 'Completed').forEach(m => { histList.innerHTML += `<div class="p-4 flex justify-between items-center opacity-70 border-b border-slate-100"><div><p class="font-medium line-through">${m.issue}</p><p class="text-xs text-slate-400">Completed: ${m.completed_date || 'N/A'}</p></div><button onclick="viewMaintNote(${m.id})" class="text-blue-500 text-xs hover:underline">View Notes</button></div>`; });

            const sT = document.getElementById('table-screening'); sT.innerHTML = '';
            state.apps.forEach(a => { 
                const eval = evalApplicant(a);
                const displayStatus = a.status === 'Pending' ? eval.status : a.status;
                const displayColor = a.status === 'Pending' ? eval.color : 'bg-slate-100 text-slate-600';

                sT.innerHTML += `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition cursor-pointer" onclick="act_viewApp(${a.id})">
                    <td class="p-5">
                        <span class="font-bold text-slate-800">${a.name}</span>
                        <div class="md:hidden flex items-center gap-1 mt-1 text-xs text-indigo-500 font-medium">
                            <i class="fas fa-search"></i> Tap to view report
                        </div>
                    </td>
                    <td class="p-5">
                        <span class="${displayColor} px-3 py-1.5 rounded-lg text-xs font-bold uppercase border whitespace-nowrap">${displayStatus}</span>
                    </td>
                    <td class="p-5 text-right">
                        <div class="flex gap-2 justify-end" onclick="event.stopPropagation()">
                            <button onclick="act_quickDecide(${a.id}, 'Approve')" class="bg-emerald-50 text-emerald-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-emerald-100" title="Approve"><i class="fas fa-check"></i></button>
                            <button onclick="act_quickDecide(${a.id}, 'Conditional')" class="bg-amber-50 text-amber-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-amber-100" title="Conditional"><i class="fas fa-exclamation"></i></button>
                            <button onclick="act_quickDecide(${a.id}, 'Deny')" class="bg-rose-50 text-rose-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-rose-100" title="Deny"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                </tr>`; 
            });

            // --- EXPENSES RENDER START ---
            const exBody = document.getElementById('table-expenses'); 
            exBody.innerHTML = '';
            
            const fid = document.getElementById('filter-expenses') ? document.getElementById('filter-expenses').value : 'all';
            let dEx = state.expenses;
            if (fid !== 'all') dEx = dEx.filter(x => x.prop === fid);
            
            dEx.forEach(x => { 
                const receiptIcon = x.doc ? `<i class="fas fa-paperclip text-slate-400" title="${x.doc}"></i>` : '-';
                const isExpanded = x.id === expandedExpId;
                const detailClass = isExpanded ? '' : 'hidden-section'; 
                const arrowClass = isExpanded ? 'rotate-180' : '';      

                exBody.innerHTML += `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition cursor-pointer md:cursor-default" onclick="toggleExpDetail(${x.id})">
                    <td class="p-5 whitespace-nowrap text-xs md:text-sm">${x.date}</td>
                    <td class="p-5 text-sm font-medium text-slate-600 hidden md:table-cell">${x.prop || 'General'}</td>
                    <td class="p-5 text-sm font-bold truncate max-w-[100px] md:max-w-none">${x.vendor}</td>
                    <td class="p-5 text-sm hidden md:table-cell"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${x.cat}</span></td>
                    <td class="p-5 text-right font-bold text-rose-600">$${x.amount.toLocaleString()}</td>
                    <td class="p-5 text-center hidden md:table-cell">${receiptIcon}</td>
                    <td class="p-5 text-right hidden md:table-cell">
                        <div class="flex justify-end gap-3">
                            <button onclick="act_editExpense(${x.id}); event.stopPropagation();" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-edit"></i></button>
                            <button onclick="act_delExpense(${x.id}); event.stopPropagation();" class="text-slate-400 hover:text-rose-600"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                    <td class="p-5 text-right md:hidden text-slate-400">
                        <i class="fas fa-chevron-down transition-transform duration-300 ${arrowClass}"></i>
                    </td>
                </tr>
                <tr class="${detailClass} bg-slate-50 md:hidden border-b border-slate-200">
                    <td colspan="4" class="p-5">
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm"><span class="text-slate-500">Property:</span> <span class="font-medium">${x.prop || 'General'}</span></div>
                            <div class="flex justify-between text-sm"><span class="text-slate-500">Category:</span> <span class="bg-white border px-2 py-0.5 rounded text-xs font-bold">${x.cat}</span></div>
                            <div class="pt-3 border-t border-slate-200 flex gap-3">
                                <button onclick="act_editExpense(${x.id})" class="flex-1 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-700">Edit</button>
                                <button onclick="act_delExpense(${x.id})" class="flex-1 py-2 bg-rose-50 border border-rose-100 rounded-lg text-sm font-bold text-rose-600">Delete</button>
                            </div>
                        </div>
                    </td>
                </tr>`; 
            });
            // --- EXPENSES RENDER END ---
            const totalExp = dEx.reduce((a,b)=>a+b.amount,0);
            if(document.getElementById('exp-total-display')) document.getElementById('exp-total-display').innerText = `$${totalExp.toLocaleString()}`;

            renderInvoices();
            renderReports(); 
            
            // Ensure settings form populates correctly
            if(document.getElementById('set-min-score') && state.settings.screening) {
                 const scr = state.settings.screening;
                 document.getElementById('set-min-score').value = scr.minScore || 650;
                 document.getElementById('set-min-income').value = scr.minIncome || 3.0;
                 document.getElementById('set-no-evict').checked = scr.noEvict;
                 document.getElementById('set-no-crim').checked = scr.noCrim;
                 document.getElementById('set-req-job').checked = scr.requireJob;
                 document.getElementById('fee-amount').value = state.settings.amount || 50;
                 document.getElementById('fee-grace').value = state.settings.grace || 5;
                 document.getElementById('fee-method').value = state.settings.method || 'flat';
            }
        }

        function toggleExpDetail(id) {
            if(window.innerWidth >= 768) return; 
            if (expandedExpId === id) expandedExpId = null; else expandedExpId = id;
            renderAll(); 
        }

        function renderReports() {
            const now = new Date();
            const currentYear = now.getFullYear();

            // YTD Revenue (Payments)
            let ytdRevenue = 0;
            state.payments.forEach(p => {
                const pd = parseDateStr(p.date);
                if(pd.getFullYear() === currentYear) {
                    ytdRevenue += p.amount;
                }
            });

            // YTD Expenses
            let ytdExpense = 0;
            state.expenses.forEach(e => {
                const ed = parseDateStr(e.date);
                if(ed.getFullYear() === currentYear) {
                    ytdExpense += e.amount;
                }
            });

            const ytdNOI = ytdRevenue - ytdExpense;

            document.getElementById('report-income').innerText = `$${ytdRevenue.toLocaleString()}`;
            document.getElementById('report-expense').innerText = `$${ytdExpense.toLocaleString()}`;
            document.getElementById('report-noi').innerText = `$${ytdNOI.toLocaleString()}`;
        }
        
        function updateBadge(id, count) { const el = document.getElementById('badge-' + id); if(count > 0) { el.innerText = count; el.classList.remove('hidden-section'); } else { el.classList.add('hidden-section'); } }

        function act_openPayModal(tenantId) {
            document.getElementById('pay-amount').value = '';
            document.getElementById('pay-date').valueAsDate = new Date();
            const sel = document.getElementById('pay-tenant-select');
            
            if(tenantId) {
                document.getElementById('pay-tenant-id').value = tenantId;
                sel.classList.add('hidden-section');
            } else {
                // Populate and show select
                sel.classList.remove('hidden-section');
                sel.innerHTML = '<option value="" disabled selected>Select Tenant</option>';
                state.tenants.filter(t => t.status !== 'Archived').forEach(t => {
                    sel.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
                document.getElementById('pay-tenant-id').value = ""; // Reset
            }
            openModal('modal-pay');
        }

        async function confirmPay() {
            let tid = document.getElementById('pay-tenant-id').value;
            const sel = document.getElementById('pay-tenant-select');
            if(!sel.classList.contains('hidden-section') && sel.value) tid = sel.value;
            
            tid = parseInt(tid);
            const amt = parseFloat(document.getElementById('pay-amount').value);
            const date = document.getElementById('pay-date').value;
            
            if(tid && amt > 0) {
                await supabase.from('payments').insert([{ tenant_id: tid, amount: amt, date: date }]);
                closeModal('modal-pay'); 
                initSystem(); 
            } else {
                alert("Please select a tenant and enter a valid amount.");
            }
        }

        function populateFinFilter() {
            const sel = document.getElementById('filter-financials');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="all">All Tenants</option>';
            const uniqueTids = [...new Set(state.invoices.map(i => i.tenant_id))];
            state.tenants.forEach(t => { if(t.status === 'Active' && !uniqueTids.includes(t.id)) uniqueTids.push(t.id); });
            uniqueTids.forEach(tid => { const t = state.tenants.find(x => x.id === tid) || { name: 'Unknown' }; sel.innerHTML += `<option value="${tid}">${t.name}</option>`; });
            sel.value = currentVal;
        }

        function renderInvoices() { 
            const filterVal = document.getElementById('filter-financials').value;
            const t = document.getElementById('table-invoices'); 
            const sumContainer = document.getElementById('fin-summary-container');
            t.innerHTML=''; 
            
            if(filterVal === 'all') sumContainer.classList.add('hidden-section');
            else sumContainer.classList.remove('hidden-section');

            // 2. Collect ALL Raw Ledger Items
            let rawItems = [];
            
            state.invoices.forEach(inv => {
                if(filterVal === 'all' || inv.tenant_id == filterVal) {
                    rawItems.push({
                        type: 'charge',
                        date: inv.date,
                        amount: inv.total,
                        desc: (inv.items && inv.items[0]) ? inv.items[0].desc : 'Charge',
                        tenant_id: inv.tenant_id,
                        tenant_name: inv.tenant_name || 'Unknown',
                        id: inv.id,
                        doc: inv.doc,
                        timestamp: new Date(inv.date).getTime()
                    });
                }
            });

            state.payments.forEach(pay => {
                if(filterVal === 'all' || pay.tenant_id == filterVal) {
                    const tenant = state.tenants.find(x => x.id == pay.tenant_id);
                    rawItems.push({
                        type: 'payment',
                        date: pay.date,
                        amount: pay.amount,
                        desc: 'Payment Received',
                        tenant_id: pay.tenant_id,
                        tenant_name: tenant ? tenant.name : 'Unknown',
                        id: pay.id,
                        timestamp: new Date(pay.date).getTime()
                    });
                }
            });

            // 3. Group by Tenant
            let tenantGroups = {};
            rawItems.forEach(item => {
                if(!tenantGroups[item.tenant_id]) tenantGroups[item.tenant_id] = [];
                tenantGroups[item.tenant_id].push(item);
            });

            // 4. Calculate Running Balance
            let finalLedger = [];
            Object.values(tenantGroups).forEach(group => {
                group.sort((a,b) => a.timestamp - b.timestamp || a.id - b.id);
                let runningBal = 0;
                group.forEach(item => {
                    if(item.type === 'charge') runningBal += item.amount;
                    else runningBal -= item.amount;
                    item.balance = runningBal; 
                });
                finalLedger = finalLedger.concat(group);
            });

            finalLedger.sort((a,b) => b.timestamp - a.timestamp || b.id - a.id);

            if(filterVal !== 'all') {
                const fin = getTenantFinancials(parseInt(filterVal));
                if(fin && fin.summary) document.getElementById('fin-open-bal').innerText = `$${fin.summary.openBalance.toLocaleString()}`;
            }

            finalLedger.forEach(item => {
                let amtDisplay = '', rowBg = '', actionBtn = '';
                if(item.type === 'charge') {
                    amtDisplay = `<span class="font-bold text-slate-800">$${item.amount.toLocaleString()}</span>`;
                    const docIcon = item.doc ? `<i class="fas fa-paperclip text-slate-400 ml-2" title="${item.doc}"></i>` : '';
                    item.desc += docIcon;
                    actionBtn = `<button onclick="act_viewInvoice(${item.id})" class="text-slate-400 hover:text-slate-600" title="View Details"><i class="fas fa-eye"></i></button>`;
                } else {
                    amtDisplay = `<span class="font-bold text-emerald-600">-$${item.amount.toLocaleString()}</span>`;
                    rowBg = 'bg-emerald-50/50';
                    actionBtn = `<span class="text-xs text-emerald-600 font-bold uppercase">Paid</span>`;
                }

                t.innerHTML += `
                <tr class="border-b border-slate-100 ${rowBg}">
                    <td class="p-5 text-sm font-medium text-slate-500">${item.date}</td>
                    <td class="p-5 text-sm font-bold">${item.tenant_name}</td>
                    <td class="p-5 text-sm text-slate-500 flex items-center">${item.desc}</td>
                    <td class="p-5 text-right">${amtDisplay}</td>
                    <td class="p-5 text-right font-medium text-slate-600">$${item.balance.toLocaleString()}</td>
                    <td class="p-5 text-right">
                        <div class="flex gap-2 justify-end items-center">${actionBtn}</div>
                    </td>
                </tr>`;
            });
        }

        // --- INVOICE WIZARD ---
        function openInvoiceModal() { 
            const s = document.getElementById('inv-tenant'); 
            s.innerHTML = '<option value="" disabled selected>Select a Tenant</option>'; 
            state.tenants.filter(t => t.status !== 'Archived' && t.status !== 'Vacant').forEach(t => { 
                s.innerHTML += `<option value="${t.id}">${t.name}</option>`; 
            }); 
            
            document.getElementById('inv-step-input').classList.remove('hidden-section');
            document.getElementById('inv-step-preview').classList.add('hidden-section');
            document.getElementById('inv-actions-create').classList.remove('hidden-section');
            document.getElementById('inv-actions-create').classList.add('flex');
            document.getElementById('inv-actions-view').classList.add('hidden-section');
            document.getElementById('inv-modal-title').innerText = "Create Invoice";
            document.getElementById('inv-date').valueAsDate = new Date();
            document.getElementById('inv-doc').value = "";
            document.getElementById('btn-confirm-inv').disabled = false;
            updateFileName('inv-doc', 'inv-doc-label');
            
            document.getElementById('inv-is-recurring').checked = false;
            document.getElementById('inv-rec-details').classList.add('hidden-section');
            
            openModal('modal-invoice'); 
            logic_invMode('fixed'); 
        }

        function act_viewInvoice(id) {
            const inv = state.invoices.find(x => x.id === id);
            if(!inv) return;

            const snapPrev = inv.snapshot ? inv.snapshot.prevBalance : 0;
            const snapFwd = snapPrev + inv.total;
            const totalDue = snapPrev + inv.total;

            document.getElementById('prev-name').innerText = inv.tenant_name;
            document.getElementById('prev-date').innerText = new Date(inv.date).toLocaleDateString();
            document.getElementById('prev-bal-amt').innerText = `$${snapPrev.toLocaleString()}`;
            document.getElementById('prev-pay-amt').innerText = `$0.00`;
            document.getElementById('prev-fwd-amt').innerText = `$${snapFwd.toLocaleString()}`;
            document.getElementById('prev-total-due').innerText = `$${totalDue.toLocaleString()}`;

            const tbody = document.getElementById('prev-items-body');
            tbody.innerHTML = '';
            inv.items.forEach(i => {
                tbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0"><td class="py-2">${i.desc}</td><td class="py-2 text-right font-medium">$${i.amount.toLocaleString()}</td></tr>`;
            });

            if(inv.doc) {
                document.getElementById('prev-attachment').classList.remove('hidden-section');
                document.getElementById('prev-attachment').innerHTML = `<i class="fas fa-paperclip text-indigo-500"></i> <span>${inv.doc}</span>`;
            } else {
                document.getElementById('prev-attachment').classList.add('hidden-section');
            }

            document.getElementById('inv-modal-title').innerText = "Invoice Details";
            document.getElementById('inv-step-input').classList.add('hidden-section');
            document.getElementById('inv-step-preview').classList.remove('hidden-section');
            document.getElementById('inv-actions-create').classList.add('hidden-section');
            document.getElementById('inv-actions-create').classList.remove('flex');
            document.getElementById('inv-actions-view').classList.remove('hidden-section');

            openModal('modal-invoice');
        }

        function logic_invMode(m) { 
            invMode = m; 
            document.getElementById('btn-fixed').className = m==='fixed' ? "flex-1 py-2 rounded-md font-bold text-sm bg-white shadow text-emerald-700 border" : "flex-1 py-2 rounded-md font-bold text-sm text-slate-500"; 
            document.getElementById('btn-variable').className = m==='variable' ? "flex-1 py-2 rounded-md font-bold text-sm bg-white shadow text-indigo-700 border" : "flex-1 py-2 rounded-md font-bold text-sm text-slate-500"; 
            document.getElementById('btn-add-row').classList.toggle('hidden-section', m==='fixed');
            const recOpts = document.getElementById('inv-recurring-options');
            if(m === 'fixed') recOpts.classList.remove('hidden-section');
            else recOpts.classList.add('hidden-section');
            logic_resetInvoice(); 
        }

        function logic_resetInvoice() { 
            const tid = document.getElementById('inv-tenant').value; 
            invItems = []; 
            if (tid) {
                if (invMode === 'fixed') { 
                    const t = state.tenants.find(x => x.id == tid); 
                    if (t) invItems = [{ desc: 'Monthly Rent', amount: parseFloat(t.rent) }]; 
                } else if (invMode === 'variable') { 
                   logic_addRow(); 
                } 
            }
            renderInvItems(); 
        }

        function logic_addRow() { invItems.push({desc:'', amount:0}); renderInvItems(); }
        function logic_delRow(idx) { invItems.splice(idx, 1); renderInvItems(); }
        function renderInvItems() { 
            const c = document.getElementById('inv-items-container'); c.innerHTML=''; 
            invItems.forEach((r,i) => { 
                const ro = invMode==='fixed'?'readonly':''; 
                const delBtn = invMode!=='fixed' ? `<button type="button" onclick="logic_delRow(${i})" class="text-red-400 px-2"><i class="fas fa-times"></i></button>` : ''; 
                c.innerHTML += `<div class="flex gap-2 mb-2"><input class="flex-grow border p-2 rounded text-sm bg-white" value="${r.desc}" oninput="updateInvItem(${i}, 'desc', this.value)" placeholder="Description" ${ro}><input class="w-24 border p-2 rounded text-sm text-right bg-white" type="number" value="${r.amount}" oninput="updateInvItem(${i}, 'amount', this.value)" placeholder="$" ${ro}>${delBtn}</div>`; 
            }); 
        }
        function updateInvItem(idx, key, val) { invItems[idx][key] = key === 'amount' ? (parseFloat(val) || 0) : val; }

        function logic_generatePreview() {
            const tidSelect = document.getElementById('inv-tenant').value;
            if(!tidSelect) return alert("Please select a tenant");
            const tid = parseInt(tidSelect);
            const tenant = state.tenants.find(t => t.id === tid);
            const date = document.getElementById('inv-date').value;
            const currentTotal = invItems.reduce((a,b)=>a+(b.amount||0),0);
            
            const fin = getTenantFinancials(tid);
            const prevBalance = fin.summary.openBalance; 
            const totalDue = prevBalance + currentTotal;

            const fileInput = document.getElementById('inv-doc');
            const fileName = fileInput.files[0] ? fileInput.files[0].name : null;

            draftInvoice = {
                tenantId: tid,
                tenantName: tenant.name,
                items: JSON.parse(JSON.stringify(invItems)),
                total: currentTotal,
                date: date,
                isRecurring: document.getElementById('inv-is-recurring').checked,
                recDay: document.getElementById('inv-rec-day').value,
                recEnd: document.getElementById('inv-rec-end').value,
                doc: fileName,
                snapshot: { prevBalance: prevBalance }
            };

            document.getElementById('prev-name').innerText = tenant.name;
            document.getElementById('prev-date').innerText = new Date(date).toLocaleDateString();
            document.getElementById('prev-bal-amt').innerText = `$${prevBalance.toLocaleString()}`;
            document.getElementById('prev-pay-amt').innerText = `$0.00`;
            document.getElementById('prev-fwd-amt').innerText = `$${prevBalance.toLocaleString()}`;
            document.getElementById('prev-total-due').innerText = `$${totalDue.toLocaleString()}`;

            const tbody = document.getElementById('prev-items-body'); tbody.innerHTML = '';
            invItems.forEach(i => { tbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0"><td class="py-2">${i.desc}</td><td class="py-2 text-right font-medium">$${i.amount.toLocaleString()}</td></tr>`; });

            if(fileName) { document.getElementById('prev-attachment').classList.remove('hidden-section'); document.getElementById('prev-attachment').innerHTML = `<i class="fas fa-paperclip text-indigo-500"></i> <span>${fileName}</span>`; } else { document.getElementById('prev-attachment').classList.add('hidden-section'); }

            document.getElementById('inv-step-input').classList.add('hidden-section');
            document.getElementById('inv-step-preview').classList.remove('hidden-section');
            document.getElementById('inv-modal-title').innerText = "Review Invoice";
        }

        function logic_backToInput() {
            document.getElementById('inv-step-input').classList.remove('hidden-section');
            document.getElementById('inv-step-preview').classList.add('hidden-section');
            document.getElementById('inv-modal-title').innerText = "Create Invoice";
        }

        async function logic_confirmInvoice() {
            if(!draftInvoice) return;
            document.getElementById('btn-confirm-inv').disabled = true;

            // Save Invoice
            await supabase.from('invoices').insert([{ 
                tenant_id: draftInvoice.tenantId, 
                tenant_name: draftInvoice.tenantName, 
                items: draftInvoice.items, 
                total: draftInvoice.total, 
                balance: draftInvoice.total, 
                date: draftInvoice.date,
                doc: draftInvoice.doc,
                snapshot: draftInvoice.snapshot 
            }]);

            // Save Recurring if checked
            if(invMode === 'fixed' && draftInvoice.isRecurring) {
                await supabase.from('recurring_invoices').insert([{
                    tenant_id: draftInvoice.tenantId,
                    amount: draftInvoice.total,
                    day: parseInt(draftInvoice.recDay),
                    end_date: draftInvoice.recEnd || null,
                    last_run: draftInvoice.date
                }]);
            }

            closeModal('modal-invoice');
            initSystem();
        }

        function updateFileName(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            if(input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.parentElement.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
            } else {
                label.innerText = inputId.includes('ex') ? 'Upload' : 'Choose File';
                label.parentElement.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
            }
        }

        // Toggle Recurring Details UI
        document.getElementById('inv-is-recurring').addEventListener('change', function() {
            const det = document.getElementById('inv-rec-details');
            if(this.checked) det.classList.remove('hidden-section');
            else det.classList.add('hidden-section');
        });

        function populateExpenseModal() {
            const s = document.getElementById('ex-prop'); s.innerHTML = '<option disabled selected>Select Property</option>';
            const props = new Set(); state.tenants.forEach(t => props.add(t.addr)); state.listings.forEach(l => props.add(l.addr));
            props.forEach(p => s.innerHTML += `<option>${p}</option>`);
        }
        function populateExpFilter() {
            const s = document.getElementById('filter-expenses'); s.innerHTML = '<option value="all">All Properties</option>';
            const props = new Set(); state.tenants.forEach(t => props.add(t.addr)); state.listings.forEach(l => props.add(l.addr));
            props.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`);
        }
        
        async function act_saveExpense(e) {
            e.preventDefault();
            const fileInput = document.getElementById('ex-doc');
            const data = {
                date: document.getElementById('ex-date').value,
                vendor: document.getElementById('ex-vendor').value,
                cat: document.getElementById('ex-cat').value,
                prop: document.getElementById('ex-prop').value,
                amount: parseFloat(document.getElementById('ex-amount').value) || 0,
                doc: fileInput.files[0] ? fileInput.files[0].name : null
            };
            
            if(editExpenseId) await supabase.from('expenses').update(data).eq('id', editExpenseId);
            else await supabase.from('expenses').insert([data]);
            
            closeModal('modal-expense'); 
            initSystem();
        }
        
        function act_editExpense(id) {
            editExpenseId = id;
            const e = state.expenses.find(x => x.id === id);
            document.getElementById('modal-expense-title').innerText = "Edit Expense";
            document.getElementById('ex-id').value = id;
            document.getElementById('ex-date').value = e.date;
            document.getElementById('ex-vendor').value = e.vendor;
            document.getElementById('ex-cat').value = e.cat;
            document.getElementById('ex-amount').value = e.amount;
            const s = document.getElementById('ex-prop'); s.innerHTML = '';
            const props = new Set(); state.tenants.forEach(t => props.add(t.addr)); state.listings.forEach(l => props.add(l.addr));
            props.forEach(p => s.innerHTML += `<option ${p === e.prop ? 'selected' : ''}>${p}</option>`);
            openModal('modal-expense');
        }

        async function act_delExpense(id) {
            if(confirm("Delete this expense?")) { await supabase.from('expenses').delete().eq('id', id); initSystem(); }
        }

        async function act_completeMaint(id) { 
            const n = prompt("Notes?")||"Done"; 
            await supabase.from('maintenance').update({ status: 'Completed', completed_date: new Date().toISOString(), notes: n }).eq('id', id);
            initSystem(); 
        }
        function viewMaintNote(id) { const m = state.maint.find(x => x.id == id); document.getElementById('md-issue').innerText = m.issue; document.getElementById('md-meta').innerText = `Completed: ${m.completed_date}`; document.getElementById('md-notes').innerText = m.notes || "No notes."; openModal('modal-maint-detail'); }
        
        function act_viewTenant(id) {
            const t = state.tenants.find(x => x.id === id);
            if(!t) return;
            document.getElementById('vt-name').innerText = t.name;
            document.getElementById('vt-email').innerText = t.email;
            document.getElementById('vt-phone').innerText = t.phone || '-';
            const fullAddress = `${t.addr || ''}, ${t.city || ''} ${t.state || ''} ${t.zip || ''}`;
            document.getElementById('vt-addr').innerText = fullAddress;
            document.getElementById('vt-unit').innerText = t.unit || '-';
            document.getElementById('vt-rent').innerText = `$${parseInt(t.rent).toLocaleString()}`;
            document.getElementById('vt-status').innerText = t.status;
            document.getElementById('vt-start').innerText = t.start_date || '-';
            document.getElementById('vt-end').innerText = t.end_date || '-';
            openModal('modal-view-tenant');
        }

        function act_viewApp(id) {
            currentAppId = id;
            const app = state.apps.find(a => a.id === id);
            const eval = evalApplicant(app);
            const ratio = (app.income / app.rent).toFixed(1);
            document.getElementById('sd-name').innerText = app.name;
            document.getElementById('sd-score').innerText = app.score;
            document.getElementById('sd-income').innerText = `$${app.income.toLocaleString()}`;
            document.getElementById('sd-ratio').innerText = ratio;
            const ban = document.getElementById('sd-banner');
            ban.className = `p-4 rounded-xl border font-bold text-center mb-4 ${eval.color}`;
            ban.innerText = eval.status;
            document.getElementById('sd-evict').innerHTML = app.evictions ? '<span class="text-rose-600 font-bold">Yes</span>' : '<span class="text-emerald-600 font-bold">None</span>';
            document.getElementById('sd-crim').innerHTML = app.criminal ? '<span class="text-rose-600 font-bold">Found</span>' : '<span class="text-emerald-600 font-bold">Clear</span>';
            document.getElementById('sd-job').innerText = app.job || 'Unemployed';
            document.getElementById('sd-employ').innerHTML = app.employment ? '<span class="text-emerald-600 font-bold">Verified</span>' : '<span class="text-amber-600 font-bold">Not Verified</span>';
            openModal('modal-screening-detail');
        }

        async function act_screenDecision(decision) {
            if(currentAppId) { await act_quickDecide(currentAppId, decision); closeModal('modal-screening-detail'); }
        }

        async function act_quickDecide(id, status) {
            await supabase.from('apps').update({ status: status }).eq('id', id);
            initSystem();
        }

        async function act_saveTenant(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('t-name').value,
                email: document.getElementById('t-email').value,
                phone: document.getElementById('t-phone').value,
                unit: document.getElementById('t-unit').value,
                rent: parseFloat(document.getElementById('t-rent').value) || 0,
                start_date: document.getElementById('t-start').value || null,
                end_date: document.getElementById('t-end').value || null,
                status: document.getElementById('t-status').value,
                addr: document.getElementById('t-addr').value,
                city: document.getElementById('t-city').value,
                state: document.getElementById('t-state').value,
                zip: document.getElementById('t-zip').value
            };
            
            if(editTenantId) await supabase.from('tenants').update(data).eq('id', editTenantId);
            else await supabase.from('tenants').insert([data]);
            
            closeModal('modal-tenant'); 
            initSystem();
        }

        function act_editTenant(id) {
            editTenantId = id;
            const t = state.tenants.find(x => x.id === id);
            if(!t) return;
            document.getElementById('modal-tenant-title').innerText = "Edit Tenant";
            document.getElementById('btn-save-tenant').innerText = "Update Tenant";
            document.getElementById('t-id').value = t.id;
            document.getElementById('t-name').value = t.name;
            document.getElementById('t-email').value = t.email;
            document.getElementById('t-phone').value = t.phone || '';
            document.getElementById('t-unit').value = t.unit || '';
            document.getElementById('t-rent').value = t.rent;
            document.getElementById('t-start').value = t.start_date || '';
            document.getElementById('t-end').value = t.end_date || '';
            document.getElementById('t-status').value = t.status;
            document.getElementById('t-addr').value = t.addr || '';
            document.getElementById('t-city').value = t.city || '';
            document.getElementById('t-state').value = t.state || '';
            document.getElementById('t-zip').value = t.zip || '';
            openModal('modal-tenant');
        }

        async function act_delTenant(id) {
            if(confirm("Delete this tenant?")) { await supabase.from('tenants').delete().eq('id', id); initSystem(); }
        }
        
        function act_editListing(id) { 
            editListingId = id; const l = state.listings.find(x => x.id == id); 
            document.getElementById('l-addr').value = l.addr; 
            document.getElementById('l-price').value = l.price; 
            document.getElementById('l-sqft').value = l.sqft; 
            document.getElementById('l-beds').value = l.beds; 
            document.getElementById('l-baths').value = l.baths; 
            document.getElementById('l-desc').value = l.desc; 
            document.getElementById('l-amen').value = l.amen || ''; 
            document.getElementById('l-date').value = l.date; 
            document.getElementById('btn-save-listing').innerText = "Update Listing"; 
            openModal('modal-listing'); 
        }

        async function act_saveListing(e) { 
            e.preventDefault(); 
            const d = { 
                addr: document.getElementById('l-addr').value, 
                price: document.getElementById('l-price').value, 
                sqft: document.getElementById('l-sqft').value, 
                beds: document.getElementById('l-beds').value, 
                baths: document.getElementById('l-baths').value, 
                desc: document.getElementById('l-desc').value, 
                amen: document.getElementById('l-amen').value, 
                date: document.getElementById('l-date').value 
            }; 
            if(editListingId) await supabase.from('listings').update(d).eq('id', editListingId);
            else await supabase.from('listings').insert([d]);
            
            closeModal('modal-listing'); 
            initSystem(); 
        }
        
        async function act_delListing(id) { await supabase.from('listings').delete().eq('id', id); initSystem(); }
        
        async function act_saveSettings(e) { 
            e.preventDefault(); 
            const tType = document.querySelector('input[name="feeTarget"]:checked').value; 
            let tIds = []; 
            // FIXED: Added parseInt to ensure type match
            if(tType === 'select') { document.querySelectorAll('#fee-tenant-select input:checked').forEach(cb => tIds.push(parseInt(cb.value))); } 
            
            const screen = {
                minScore: parseInt(document.getElementById('set-min-score').value) || 600,
                minIncome: parseFloat(document.getElementById('set-min-income').value) || 2.5,
                noEvict: document.getElementById('set-no-evict').checked,
                noCrim: document.getElementById('set-no-crim').checked,
                requireJob: document.getElementById('set-req-job').checked
            };

            await supabase.from('settings').update({
                fee_target: tType,
                targets: tIds,
                method: document.getElementById('fee-method').value,
                amount: document.getElementById('fee-amount').value,
                grace: document.getElementById('fee-grace').value,
                require_insurance: document.getElementById('set-insurance').checked,
                screening: screen
            }).eq('id', 1);

            alert("Configuration Saved"); 
        }

        function toggleFeeTarget() { const v = document.querySelector('input[name="feeTarget"]:checked').value; const c = document.getElementById('fee-tenant-select'); if(v === 'select') { c.classList.remove('hidden-section'); c.innerHTML = ''; state.tenants.forEach(t => { c.innerHTML += `<label class="block mb-2"><input type="checkbox" class="mr-2" value="${t.id}"> ${t.name}</label>`; }); } else { c.classList.add('hidden-section'); } }
        function toggleFeeInput() { document.getElementById('fee-label').innerText = document.getElementById('fee-method').value === 'percent' ? "Percentage (%)" : "Amount ($)"; }
        function toggleSidebar() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('mobile-overlay'); if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); } else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); } }

        // --- CHARTS & CHAT ---
        function initChart() { const ctx = document.getElementById('revenueChart').getContext('2d'); chartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Collected', 'Outstanding', 'Overdue'], datasets: [{ label: 'Financials', data: [0,0,0], backgroundColor: ['#10b981', '#f59e0b', '#f43f5e'], borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }
        
        function renderMonthlyChart() { const ctx = document.getElementById('monthlyChart').getContext('2d'); if(monthlyChartInstance) monthlyChartInstance.destroy(); const fin = getMonthlyFinancials(); monthlyChartInstance = new Chart(ctx, { type: 'bar', data: { labels: fin.labels, datasets: [ { label: 'Revenue', data: fin.revenue, backgroundColor: '#10b981' }, { label: 'Expenses', data: fin.expenses, backgroundColor: '#f43f5e' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { beginAtZero: true } } } }); }

        function renderChatList() { 
            const l = document.getElementById('list-chats'); 
            l.innerHTML = ''; 
            const sortedChats = state.tenants.filter(t => t.status !== 'Vacant').map(t => {
                const msgs = state.msgs.filter(m => m.tenant_id === t.id);
                const lastTime = msgs.length > 0 ? new Date(msgs[msgs.length - 1].created_at).getTime() : 0;
                return { tenant: t, time: lastTime };
            }).sort((a, b) => b.time - a.time); 

            sortedChats.forEach(item => { 
                const t = item.tenant;
                const statusIndicator = t.status === 'Archived' ? '<span class="text-[10px] bg-slate-100 px-1 rounded ml-2">Archived</span>' : ''; 
                l.innerHTML += `<div onclick="openChat(${t.id})" class="p-4 bg-white border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 font-bold text-sm mb-2 shadow-sm flex justify-between items-center transition"><span>${t.name} ${statusIndicator}</span><i class="fas fa-chevron-right text-slate-300 text-xs"></i></div>`; 
            }); 
        }

        function openChat(id) { currentChatId=id; document.getElementById('chat-title').innerText = state.tenants.find(x=>x.id==id).name; renderMessages(); if(window.innerWidth < 768) { document.getElementById('msg-list-panel').classList.add('hidden'); document.getElementById('msg-view-panel').classList.remove('hidden'); document.getElementById('msg-view-panel').classList.add('flex'); } }
        function backToChatList() { if(window.innerWidth < 768) { document.getElementById('msg-view-panel').classList.add('hidden'); document.getElementById('msg-view-panel').classList.remove('flex'); document.getElementById('msg-list-panel').classList.remove('hidden'); } }
        
        function renderMessages() { 
            const b = document.getElementById('box-chat'); b.innerHTML = ''; 
            state.msgs.filter(m => m.tenant_id == currentChatId).sort((a,b)=> new Date(a.created_at) - new Date(b.created_at)).forEach(m => { 
                const d = new Date(m.created_at);
                const timeStr = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                const isToday = d.toDateString() === new Date().toDateString();
                const ts = isToday ? timeStr : `${d.toLocaleDateString([], { month: 'short', day: 'numeric' })}, ${timeStr}`;

                const isOwner = m.from === 'Owner';
                const align = isOwner ? 'items-end' : 'items-start';
                const bubbleStyle = isOwner ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 rounded-bl-none';

                b.innerHTML += `<div class="flex flex-col w-full ${align} mb-4 fade-in"><div class="px-4 py-3 rounded-2xl text-sm shadow-sm max-w-[85%] ${bubbleStyle}">${m.text}</div><span class="text-[10px] text-slate-400 mt-1 mx-1">${ts}</span></div>`; 
            }); 
            b.scrollTop = b.scrollHeight; 
        }
        
        async function sendMsg() { 
            const i=document.getElementById('input-chat'); 
            if(i.value && currentChatId) { 
                await supabase.from('msgs').insert([{tenant_id:currentChatId, from:'Owner', text:i.value, time: new Date().toISOString()}]);
                i.value=''; initSystem(); 
            } 
        }

        // Initialize Application
        initSystem();
    </script>
</body>
</html>


