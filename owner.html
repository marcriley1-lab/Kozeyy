
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Owner Dashboard | Kozeyy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="text/javascript">
   (function(){
      // Replace with your actual Public Key from EmailJS dashboard
      emailjs.init("YOUR_PUBLIC_KEY_HERE"); 
   })();
</script>
    <style> 
        .rotate-180 { transform: rotate(180deg); }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, h4, .brand-font { font-family: 'Outfit', sans-serif; }
        .sidebar-active { background-color: #312e81; border-left: 4px solid #6366f1; color: white !important; }
        .nav-item { color: #94a3b8; }
        .nav-item:hover { color: white; background-color: #312e81; }
        .hidden-section { display: none !important; }
        .fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        #mobile-overlay { background-color: rgba(0,0,0,0.5); }
        .paper-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.05); }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-left: 4px solid #6366f1; transform: translateX(100%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; min-width: 300px; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: #f43f5e; }
        .toast.success { border-left-color: #10b981; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50">

    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 hidden transition-opacity backdrop-blur-sm md:hidden"></div>
    <div id="toast-container"></div>

   <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-indigo-950 flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:static shadow-xl">
        <div class="h-20 flex items-center justify-between px-6 border-b border-indigo-900 bg-indigo-950">
            <div class="flex items-center gap-3">
                <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                    <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                    <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
                </svg>
                <span class="text-xl font-bold text-white tracking-tight brand-font">Kozeyy</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="#" onclick="event.preventDefault(); navTo('dashboard')" id="link-dashboard" class="nav-item flex items-center justify-between px-6 py-3.5 transition sidebar-active">
                <div class="flex items-center"><i class="fas fa-th-large w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Dashboard</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('tenants')" id="link-tenants" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-users w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Tenants</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('listings')" id="link-listings" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-sign w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Listings</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('screening')" id="link-screening" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-user-check w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Screening</span></div>
                <span id="badge-screening" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('messages')" id="link-messages" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-comment-dots w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Messages</span></div>
                <span id="badge-messages" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('maintenance')" id="link-maintenance" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-tools w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Maintenance</span></div>
                <span id="badge-maintenance" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('financials')" id="link-financials" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-money-bill-wave w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Records</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('expenses')" id="link-expenses" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-receipt w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Expenses</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('reports')" id="link-reports" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-chart-pie w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Reports</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('settings')" id="link-settings" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-sliders-h w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Settings</span></div>
            </a>
        </nav>
        
        <div class="p-6 border-t border-indigo-900 bg-indigo-950 flex flex-col gap-3">
    <a href="mailto:support@kozeyy.com?subject=Kozeyy%20Feedback" class="flex items-center text-xs text-indigo-300 hover:text-white transition">
        <i class="fas fa-comment-dots mr-2"></i> Contact & Feedback
    </a>
    
    <button onclick="signOut()" class="flex items-center text-xs text-rose-300 hover:text-white transition w-full text-left">
        <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
    </button>
</div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-10 sticky top-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-700 hover:text-indigo-600 focus:outline-none p-2 -ml-2 rounded-xl hover:bg-slate-50 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 class="text-xl md:text-xl font-bold text-slate-800 brand-font truncate" id="header-title">
                    <span class="md:hidden">Menu</span>
                    <span class="hidden md:inline" id="desktop-page-title">Portfolio Overview</span>
                </h2>
            </div>
            
            <div class="flex items-center gap-3 md:pl-6 md:border-l border-slate-200">
    <div class="text-right hidden md:block">
        <p class="text-sm font-bold text-slate-700 brand-font" id="owner-name-display">Landlord</p>
        <p class="text-xs text-slate-500">Property Owner</p>
    </div>
    
    <div onclick="signOut()" class="w-9 h-9 md:w-10 md:h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-md text-sm brand-font cursor-pointer hover:ring-4 ring-indigo-100 transition" id="owner-initials-display" title="Click to Sign Out">
        LL
    </div>
</div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 scroll-smooth pb-32" id="app-content">
            
            <div id="view-dashboard" class="view-section fade-in-up">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-8">
                    <div class="bg-gradient-to-br from-emerald-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-emerald-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-emerald-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-dollar-sign"></i></div><p class="text-emerald-800 text-[11px] font-bold uppercase tracking-wider brand-font">Revenue (This Month)</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-revenue">$0.00</h3></div>
                    </div>
                    <div class="bg-gradient-to-br from-rose-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-rose-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-rose-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-exclamation"></i></div><p class="text-rose-800 text-[11px] font-bold uppercase tracking-wider brand-font">Overdue</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-overdue">$0.00</h3></div>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-indigo-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-indigo-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-home"></i></div><p class="text-indigo-800 text-[11px] font-bold uppercase tracking-wider brand-font">Occupancy</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-occupancy">0%</h3></div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-amber-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-amber-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-tools"></i></div><p class="text-amber-800 text-[11px] font-bold uppercase tracking-wider brand-font">Repairs</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-maintenance">0</h3></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-80">
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="font-bold text-lg text-slate-800 brand-font" id="chart-title">Performance</h3>
                        </div>
                        <div class="h-64"><canvas id="revenueChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 brand-font">Quick Actions</h3>
                        <div class="space-y-3">
                            <button id="qa-tenant" onclick="openModal('modal-tenant')" class="w-full flex items-center justify-between p-4 bg-blue-50 text-blue-700 rounded-2xl hover:bg-blue-100 transition"><span class="font-bold text-sm brand-font">Add Tenant</span><i class="fas fa-user-plus bg-blue-200 p-2 rounded-full text-xs"></i></button>
                            <button id="qa-invoice" onclick="openInvoiceModal()" class="w-full flex items-center justify-between p-4 bg-emerald-50 text-emerald-700 rounded-2xl hover:bg-emerald-100 transition"><span class="font-bold text-sm brand-font">Create Invoice</span><i class="fas fa-plus bg-emerald-200 p-2 rounded-full text-xs"></i></button>
                            <button onclick="openModal('modal-listing')" class="w-full flex items-center justify-between p-4 bg-indigo-50 text-indigo-700 rounded-2xl hover:bg-indigo-100 transition"><span class="font-bold text-sm brand-font">Post Listing</span><i class="fas fa-home bg-indigo-200 p-2 rounded-full text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-tenants" class="view-section hidden-section fade-in-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Directory</h3>
                    <div class="flex gap-2">
                        <select id="filter-tenant-status" onchange="renderAll()" class="border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white font-medium text-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="Active">Active Tenants</option>
                            <option value="Archived">Archived</option>
                            <option value="all">All Records</option>
                        </select>
                        <button onclick="openModal('modal-tenant')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-blue-700 brand-font">+ Add</button>
                    </div>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-x-auto w-full">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Tenant</th>
                                <th class="p-5 hidden md:table-cell">Address</th>
                                <th class="p-5 hidden md:table-cell">Unit</th>
                                <th class="p-5 hidden md:table-cell">Rent</th>
                                <th class="p-5">Status</th>
                                <th class="p-5 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-tenants" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-listings" class="view-section hidden-section fade-in-up">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 brand-font">Listings</h3><button onclick="openModal('modal-listing')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow hover:bg-indigo-700 brand-font">+ Post</button></div>
                <div id="grid-listings" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            </div>

            <div id="view-screening" class="view-section hidden-section fade-in-up">
                <h3 class="text-xl font-bold text-slate-800 brand-font mb-4">Applicant Queue</h3>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-white text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Applicant</th>
                                <th class="p-5">Condition</th>
                                <th class="p-5">Status</th>
                                <th class="p-5 text-right">Action</th> 
                            </tr>
                        </thead>
                        <tbody id="table-screening" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-messages" class="view-section hidden-section fade-in-up h-[calc(100dvh-90px)]">
                <div class="flex h-full bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden relative">
                    <div id="msg-list-panel" class="w-full md:w-1/3 border-r border-slate-200 bg-slate-50 flex flex-col">
                        <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700 brand-font">Conversations</div>
                        <div id="list-chats" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    </div>
                    <div id="msg-view-panel" class="absolute inset-0 bg-white md:static w-full md:w-2/3 flex-col hidden md:flex z-20">
                        <div id="header-chat" class="p-4 border-b border-slate-200 bg-white font-bold text-slate-800 brand-font flex items-center gap-3">
                            <button onclick="backToChatList()" class="md:hidden text-slate-500 mr-2 p-2 rounded-full hover:bg-slate-100"><i class="fas fa-arrow-left"></i></button>
                            <span id="chat-title">Select a tenant</span>
                        </div>
                        <div id="box-chat" class="flex-1 p-4 md:p-6 overflow-y-auto bg-slate-50 space-y-4 custom-scroll pb-24 md:pb-6"></div>
                        <div class="p-4 border-t border-slate-200 bg-white flex gap-2 fixed bottom-0 left-0 right-0 md:static z-30 pb-[env(safe-area-inset-bottom,1.5rem)] md:pb-4">
                            <input type="text" id="input-chat" class="flex-1 border p-3 rounded-full outline-none focus:ring-2 focus:ring-indigo-500 text-sm font-medium" placeholder="Type a message...">
                            <button onclick="sendMsg()" class="bg-indigo-600 text-white w-12 h-12 rounded-full font-bold flex items-center justify-center shadow-lg hover:bg-indigo-700 transition"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-maintenance" class="view-section hidden-section fade-in-up">
                <h3 class="text-xl font-bold text-slate-800 mb-4 brand-font">Maintenance</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden"><div class="p-6 border-b bg-rose-50 border-rose-100"><h3 class="font-bold text-rose-800 brand-font">Active</h3></div><div id="list-maint-active" class="divide-y divide-slate-100"></div></div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden"><div class="p-6 border-b bg-slate-50 border-slate-100"><h3 class="font-bold text-slate-700 brand-font">History</h3></div><div id="list-maint-history" class="divide-y divide-slate-100"></div></div>
                </div>
            </div>

            <div id="view-financials" class="view-section hidden-section fade-in-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Financial Records</h3>
                    <div class="flex gap-2">
                        <button onclick="act_openPayModal(null)" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-blue-700 brand-font">+ Payment</button>
                        <button onclick="openInvoiceModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-emerald-700 brand-font">+ Invoice</button>
                    </div>
                </div>

                <div id="fin-summary-container" class="mb-6 hidden-section">
                    <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm max-w-xs">
                        <p class="text-xs text-slate-500 font-bold uppercase">Total Outstanding</p>
                        <h4 class="text-xl font-bold text-slate-800" id="fin-open-bal">$0.00</h4>
                    </div>
                </div>

                <div class="mb-4">
                    <select id="filter-financials" onchange="renderFinancials()" class="border p-2 rounded-lg text-sm bg-white"><option value="all">All Tenants</option></select>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                       <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
    <tr>
        <th class="p-5">Date</th>
        <th class="p-5">Tenant</th>
        <th class="p-5">Type</th>
        
        <th class="p-5 hidden md:table-cell">Description</th>
        <th class="p-5 text-right hidden md:table-cell">Amount</th>
        <th class="p-5 text-right hidden md:table-cell">Status</th>
        <th class="p-5 text-right hidden md:table-cell">Action</th>
    </tr>
</thead>
                        <tbody id="table-financials" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-expenses" class="view-section hidden-section fade-in-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Expenses</h3>
                    <div class="flex gap-3 w-full md:w-auto">
                        <select id="filter-expenses" onchange="renderExpenses()" class="border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white flex-1 md:flex-none font-medium text-slate-600"><option value="all">All Properties</option></select>
                        <div class="bg-rose-50 text-rose-700 px-4 py-2 rounded-xl font-bold border border-rose-200 text-sm flex-1 md:flex-none text-center brand-font">Total: <span id="exp-total-display">$0.00</span></div>
                        <button onclick="populateExpenseModal(); openModal('modal-expense')" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-rose-700 flex-none brand-font">+ Add</button>
                    </div>
                </div>

             <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                       <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
    <tr>
        <th class="p-5">Date</th>
        <th class="p-5 hidden md:table-cell">Property</th>
        <th class="p-5">Vendor</th>
        <th class="p-5 hidden md:table-cell">Category</th>
        <th class="p-5 text-right">Amount</th>
        <th class="p-5 text-center hidden md:table-cell">Receipt</th>
        <th class="p-5 text-right">Actions</th>
    </tr>
</thead>
                        <tbody id="table-expenses" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-reports" class="view-section hidden-section fade-in-up">
                <h3 class="text-xl font-bold text-slate-800 brand-font mb-6">Reports</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg text-slate-900 border-b pb-4 mb-4 brand-font">Income Statement (Year to Date)</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center"><span class="text-slate-600">Total Revenue</span><span class="font-bold text-emerald-600 text-lg brand-font" id="report-income">$0.00</span></div>
                            <div class="flex justify-between items-center"><span class="text-slate-600">Total Expenses</span><span class="font-bold text-rose-600 text-lg brand-font" id="report-expense">$0.00</span></div>
                            <div class="border-t pt-4 flex justify-between items-center mt-4"><span class="font-extrabold text-slate-800 brand-font">Net Operating Income</span><span class="font-extrabold text-indigo-900 text-2xl brand-font" id="report-noi">$0.00</span></div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg text-slate-900 mb-4 brand-font">Monthly Breakdown</h4>
                        <div class="h-64"><canvas id="monthlyChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="view-section hidden-section fade-in-up">
                <div class="bg-white rounded-3xl shadow-lg border border-slate-200 p-8 max-w-3xl mx-auto">
                    <h3 class="text-2xl font-bold mb-8 brand-font">System Configuration</h3>
                    <form onsubmit="act_saveSettings(event)" class="space-y-6">
    
    <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
        <h4 class="font-bold text-indigo-900 mb-2 brand-font flex items-center gap-2">
            <i class="fab fa-stripe text-xl"></i> Payments Integration
        </h4>
        <p class="text-xs text-indigo-700 mb-4">Enter your Stripe Connected Account ID to receive payments automatically from tenants.</p>
        <div>
            <label class="block text-xs font-bold text-indigo-800 uppercase mb-1">Stripe Account ID</label>
            <input type="text" id="set-stripe-id" class="w-full border border-indigo-200 p-3 rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm" placeholder="acct_..." value="">
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div>
            <label class="block text-xs font-bold text-slate-500 mb-1">Fee Type & Value</label>
            <div class="bg-white p-4 rounded-xl border border-slate-200 h-full">
                <h4 class="font-bold text-slate-800 mb-4 brand-font">Late Fee Configuration</h4>
                
                <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-100">
                    <label class="text-sm font-bold text-slate-700">Enable Late Fees</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="set-fee-active" class="sr-only peer" onchange="toggleFeeVisibility()">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                </div>

                <div id="fee-inputs-container" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Fee Structure</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <select id="fee-method" class="w-full border p-3 rounded-xl bg-slate-50 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="Fixed">Fixed ($)</option>
                                <option value="Percentage">Percent (%)</option>
                                <option value="Daily">Daily ($)</option>
                            </select>
                            <input type="number" id="fee-amount" class="w-full border p-3 rounded-xl bg-slate-50 text-sm text-center font-bold outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Grace Period (Days)</label>
                        <input type="number" id="fee-grace" class="w-full border p-3 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g. 5">
                    </div>
                </div>
            </div>
        </div>

        <div>
            <label class="block text-xs font-bold text-slate-500 mb-1">Screening Rules</label>
            <div class="bg-white p-4 rounded-xl border border-slate-200 h-full">
                <h4 class="font-bold text-slate-800 mb-4 brand-font">Screening Criteria</h4>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Min Credit Score</label>
                        <input type="number" id="set-min-score" class="w-full border p-3 rounded-xl bg-slate-50 text-center font-bold outline-none focus:ring-2 focus:ring-indigo-500" placeholder="650">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Min Income (x Rent)</label>
                        <input type="number" step="0.1" id="set-min-income" class="w-full border p-3 rounded-xl bg-slate-50 text-center font-bold outline-none focus:ring-2 focus:ring-indigo-500" placeholder="3.0">
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="set-no-evict" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-bold text-slate-700">No Prior Evictions</span>
                        </label>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="set-no-crim" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-bold text-slate-700">No Criminal History</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <button class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg brand-font text-lg">
        Save Configuration
    </button>
</form>
                </div>
            </div>
        </div>
    </main>
<div id="modal-platform-confirm" class="hidden-section fixed inset-0 bg-slate-900/60 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mx-auto mb-4 text-xl">
                <i class="fas fa-question"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 text-slate-900" id="plat-conf-title">Confirm Action</h3>
            <p class="text-sm text-slate-500 mb-6" id="plat-conf-msg">Are you sure you want to proceed?</p>
            <div class="flex gap-3">
                <button onclick="closePlatformConfirm(false)" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold text-sm transition">Cancel</button>
                <button onclick="closePlatformConfirm(true)" class="flex-1 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm transition">Confirm</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt" class="hidden-section fixed inset-0 bg-slate-900/60 z-[70] flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-200">
        <h3 class="text-lg font-bold mb-4 brand-font" id="prompt-title">Enter Value</h3>
        <input type="text" id="prompt-input" class="w-full border p-3 rounded-xl bg-slate-50 mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Type here...">
        <div class="flex gap-2">
            <button onclick="closePrompt(false)" class="flex-1 py-2 bg-slate-100 rounded-xl font-bold text-sm hover:bg-slate-200 transition">Cancel</button>
            <button onclick="closePrompt(true)" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition">Confirm</button>
        </div>
    </div>
</div>

    <div id="modal-share-listing" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl relative overflow-hidden flex flex-col max-h-[90vh]">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
                <h3 class="text-xl font-bold brand-font text-slate-800">Post Your Listing</h3>
                <p class="text-sm text-slate-500">Create once, publish everywhere.</p>
            </div>
            <button onclick="closeModal('modal-share-listing')" class="text-slate-400 hover:text-slate-600 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">1. Copy Description</label>
                        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">Optimized for Zillow</span>
                    </div>
                    <textarea id="share-copy-text" readonly class="w-full h-32 p-3 rounded-xl border border-slate-200 text-xs bg-slate-50 resize-none focus:outline-none mb-2 font-mono leading-relaxed" onclick="this.select()"></textarea>
                    <button onclick="copyMarketingText()" class="w-full bg-slate-800 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-slate-900 transition flex items-center justify-center gap-2">
                        <i class="far fa-copy"></i> Copy Text
                    </button>
                </div>

                <div class="flex flex-col">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2">2. Get Photos</label>
                    <div class="flex-1 bg-slate-50 rounded-xl border border-slate-200 p-4 flex flex-col items-center justify-center text-center">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-images text-lg"></i>
                        </div>
                        <h4 class="text-sm font-bold text-slate-700 mb-1">Listing Photos</h4>
                        <p class="text-xs text-slate-400 mb-4 px-4">Download all your high-res photos in a single ZIP file to upload to portals.</p>
                        <button id="btn-download-photos" onclick="downloadPhotos()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 transition shadow-sm w-full">
                            <i class="fas fa-download mr-1"></i> Download ZIP
                        </button>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">3. Select Platform to Post</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <a href="https://www.zillow.com/rental-manager/" target="_blank" class="flex flex-col items-center p-3 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition group text-center">
                        <img src="https://www.zillowstatic.com/s3/pfs/static/z-logo-default.svg" class="h-5 mb-2 opacity-80 group-hover:opacity-100" alt="Zillow">
                        <span class="text-xs font-bold text-slate-600 group-hover:text-indigo-700">Zillow Manager</span>
                    </a>
                    
                    <a href="https://www.apartments.com/add-listing/" target="_blank" class="flex flex-col items-center p-3 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition group text-center">
                        <div class="h-5 mb-2 font-bold text-slate-800 text-lg leading-none">Apts.com</div>
                        <span class="text-xs font-bold text-slate-600 group-hover:text-indigo-700">Add Listing</span>
                    </a>

                    <a href="https://www.facebook.com/marketplace/create/rental/" target="_blank" class="flex flex-col items-center p-3 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition group text-center">
                        <i class="fab fa-facebook text-blue-600 text-xl mb-1"></i>
                        <span class="text-xs font-bold text-slate-600 group-hover:text-indigo-700">Marketplace</span>
                    </a>

                    <a href="https://post.craigslist.org/" target="_blank" class="flex flex-col items-center p-3 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition group text-center">
                        <div class="h-5 w-5 bg-purple-700 text-white rounded text-xs flex items-center justify-center font-bold font-serif mb-2">CL</div>
                        <span class="text-xs font-bold text-slate-600 group-hover:text-indigo-700">Craigslist</span>
                    </a>
                </div>
                <p class="text-[10px] text-slate-400 mt-3 text-center">
                    <i class="fas fa-info-circle mr-1"></i> These sites require manual verification. We'll open the page for you to paste your details.
                </p>
            </div>
        </div>
        
        <div class="bg-slate-50 p-4 border-t border-slate-200 flex items-center justify-between gap-4">
            <span class="text-xs font-bold text-slate-500 whitespace-nowrap">Direct Link:</span>
            <div class="flex-1 flex items-center bg-white border border-slate-200 rounded-lg px-2 py-1.5">
                <input id="share-link-input" readonly class="bg-transparent text-xs flex-1 text-slate-600 outline-none font-medium">
            </div>
            <button onclick="copyListingLink()" class="text-indigo-600 hover:text-indigo-800 text-xs font-bold">Copy</button>
        </div>
    </div>
</div>

    <div id="modal-tenant" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative">
            <button onclick="closeModal('modal-tenant')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-tenant-title">Add Tenant</h3>
            <form onsubmit="act_saveTenant(event)" class="space-y-4">
                <input type="hidden" id="t-id">
                <div class="grid grid-cols-2 gap-4">
                    <input id="t-name" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Full Name" required>
                    <input id="t-phone" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Phone">
                </div>
                <input id="t-email" type="email" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Email Address" required>
                <input id="t-addr" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Property Address">
                <div class="grid grid-cols-3 gap-4">
                    <input id="t-city" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="City">
                    <input id="t-state" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="State">
                    <input id="t-zip" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Zip">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="t-unit" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Unit #">
                    <input id="t-rent" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Rent Amount" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 ml-1">Lease Start</label><input type="date" id="t-start" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                    <div><label class="text-xs font-bold text-slate-500 ml-1">Lease End</label><input type="date" id="t-end" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                </div>
                 <select id="t-status" class="w-full border p-3 rounded-xl bg-slate-50">
                    <option value="Active">Active</option>
                    <option value="Vacant">Vacant</option>
                    <option value="Archived">Archived</option>
                </select>
                <button class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold brand-font shadow-lg hover:bg-blue-700 transition" id="btn-save-tenant">Save Tenant</button>
            </form>
        </div>
    </div>

    <div id="modal-view-tenant" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative">
            <button onclick="closeModal('modal-view-tenant')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-view-tenant-title">Tenant Details</h3>
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Contact Info</p>
                    <h4 class="text-lg font-bold text-slate-800" id="vt-name"></h4>
                    <p class="text-sm text-slate-600"><i class="fas fa-envelope w-5"></i> <span id="vt-email"></span></p>
                    <p class="text-sm text-slate-600"><i class="fas fa-phone w-5"></i> <span id="vt-phone"></span></p>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Property</p>
                    <p class="text-sm font-medium text-slate-800" id="vt-addr"></p>
                    <div class="flex gap-4 mt-2">
                        <div><p class="text-xs text-slate-500">Unit</p><p class="font-bold" id="vt-unit"></p></div>
                        <div><p class="text-xs text-slate-500">Rent</p><p class="font-bold text-emerald-600" id="vt-rent"></p></div>
                        <div><p class="text-xs text-slate-500">Status</p><p class="font-bold" id="vt-status"></p></div>
                    </div>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Lease Term</p>
                    <div class="flex justify-between">
                        <div><p class="text-xs text-slate-500">Start</p><p class="font-bold text-slate-700" id="vt-start"></p></div>
                        <div><p class="text-xs text-slate-500">End</p><p class="font-bold text-slate-700" id="vt-end"></p></div>
                    </div>
                </div>

                <button onclick="closeModal('modal-view-tenant')" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold brand-font shadow-lg hover:bg-slate-900 transition">Close</button>
            </div>
        </div>
    </div>

    <div id="modal-listing" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-listing')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-listing-title">Property Listing</h3>
            <form onsubmit="act_saveListing(event)" class="space-y-4">
                <input id="l-addr" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Property Address" required>
                <div class="grid grid-cols-2 gap-4">
                    <input id="l-price" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Monthly Price" required>
                    <input id="l-sqft" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Sq Ft">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="l-beds" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Beds">
                    <input id="l-baths" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Baths">
                </div>
                <textarea id="l-desc" class="w-full border p-3 rounded-xl bg-slate-50 h-24" placeholder="Description"></textarea>
                <input id="l-amen" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Amenities (comma separated)">
                
                <input id="l-contact" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Owner Contact (Email or Phone)">
                
                <div class="mt-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Listing Images</label>
                    <div class="flex items-center gap-2">
                        <label for="l-img-file" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-slate-300 w-full justify-center">
                            <i class="fas fa-camera"></i> <span id="l-img-label">Upload Photos</span>
                        </label>
                        <input type="file" id="l-img-file" class="hidden" accept=".jpg, .jpeg, .png, .webp" multiple onchange="updateFileCount()">
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1 text-center" id="l-file-count"></p>
                </div>

                <input type="date" id="l-date" class="w-full border p-3 rounded-xl bg-slate-50" required>
                <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold brand-font shadow-lg hover:bg-indigo-700 transition" id="btn-save-listing">Post Listing</button>
            </form>
        </div>
    </div>

    <div id="modal-invoice" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-invoice')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="inv-modal-title">Create Invoice</h3>
            
            <div id="inv-step-input">
                <form onsubmit="event.preventDefault(); logic_generatePreview();" class="space-y-4">
                    <select id="inv-tenant" onchange="logic_resetInvoice()" class="w-full border p-3 rounded-xl bg-slate-50" required><option value="" disabled selected>Select a Tenant</option></select>
                    
                    <div class="flex gap-2 p-1 bg-slate-100 rounded-xl">
                        <button type="button" onclick="logic_invMode('fixed')" id="btn-fixed" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-emerald-700">Fixed Rent</button>
                        <button type="button" onclick="logic_invMode('variable')" id="btn-variable" class="flex-1 py-2 rounded-lg font-bold text-sm text-slate-500">Variable</button>
                    </div>
                    
                    <div id="inv-items-container" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    <button type="button" id="btn-add-row" onclick="logic_addRow()" class="hidden-section w-full border border-dashed border-slate-300 text-slate-500 py-2 rounded-xl text-sm">+ Add Item</button>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1 brand-font">Attach Document</label>
                        <div class="flex items-center gap-2">
                            <label for="inv-doc" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2 border border-slate-300">
                                <i class="fas fa-paperclip"></i> <span id="inv-doc-label">Choose File</span>
                            </label>
                            <input type="file" id="inv-doc" class="hidden" accept=".pdf, .jpg, .jpeg, .png" onchange="updateFileName('inv-doc', 'inv-doc-label')">
                        </div>
                    </div>

                    <div>
    <label class="block text-xs font-bold text-slate-500 mb-1">Send Invoice On</label>
    <input type="date" id="inv-date" required class="w-full border p-3 rounded-xl bg-slate-50">
</div>

   <div id="inv-recurring-wrapper" class="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200 transition-opacity duration-200">
    <div class="flex items-center justify-between">
        <label class="font-bold text-sm text-slate-700 flex items-center gap-2">
            <i class="fas fa-sync-alt text-indigo-500"></i> Recurring Rent?
            <span id="inv-recur-status" class="hidden-section text-xs text-emerald-600 font-bold ml-1"></span>
        </label>

        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="inv-recurring" class="sr-only peer" onchange="toggleRecurringOptions()">
            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
        </label>
    </div>
    
    <div id="inv-recurring-opts" class="hidden-section space-y-3 pt-3 mt-2 border-t border-slate-200">
        <div>
            <label class="block text-xs font-bold text-slate-500 mb-1">Day of Month</label>
            <input type="number" id="inv-recur-day" oninput="updateNextDate()" class="w-full border p-2 rounded-lg text-sm bg-white" placeholder="1" min="1" max="31">
            <p class="text-[10px] text-slate-400 mt-1">
                Next scheduled run: <span id="inv-recur-next" class="font-bold text-indigo-600">...</span>
            </p>
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 mb-1">End Date (Optional)</label>
            <input type="date" id="inv-recur-end" class="w-full border p-2 rounded-lg text-sm bg-white">
        </div>
    </div>
</div>

                    <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold brand-font hover:bg-indigo-700 transition">Preview Invoice</button>
                </form>
            </div>

            <div id="inv-step-preview" class="hidden-section">
                <!-- Target Area for HTML2PDF -->
                <div id="invoice-download-area" class="bg-white border border-slate-200 rounded-xl p-6 mb-6 paper-shadow relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-indigo-600"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 brand-font">INVOICE</h2>
                            <p class="text-xs text-slate-400 mt-1">Kozeyy Property Mgmt</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-slate-700" id="prev-date">Oct 24, 2023</p>
                            <p class="text-xs text-slate-500">Bill To: <span id="prev-name">Tenant Name</span></p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div class="flex justify-between text-xs font-bold text-slate-700"><span>Total Amount</span><span id="prev-total-due">$0.00</span></div>
                        </div>

                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-400 uppercase border-b"><tr><th class="py-2">Description</th><th class="py-2 text-right">Amount</th></tr></thead>
                            <tbody id="prev-items-body" class="text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="inv-actions-create" class="flex gap-3">
                    <button onclick="logic_backToInput()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50">Back</button>
                    <button onclick="logic_confirmInvoice()" id="btn-confirm-inv" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow hover:bg-emerald-700">Send Invoice</button>
                </div>
                
                <div id="inv-actions-view" class="hidden-section">
                    <!-- Buttons injected dynamically -->
                </div>
            </div>

        </div>
    </div>

    <div id="modal-expense" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative">
            <button onclick="closeModal('modal-expense')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-expense-title">Expense</h3>
            <form onsubmit="act_saveExpense(event)" class="space-y-4">
                <input type="hidden" id="ex-id">
                <select id="ex-prop" class="w-full border p-3 rounded-xl bg-slate-50"></select>
                <input type="date" id="ex-date" class="w-full border p-3 rounded-xl bg-slate-50" required>
                <input id="ex-vendor" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Vendor" required>
                <select id="ex-cat" class="w-full border p-3 rounded-xl bg-slate-50"><option>Repairs</option><option>Utilities</option><option>Tax</option><option>Insurance</option><option>Other</option></select>
                <input id="ex-amount" type="number" step="0.01" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Amount" required>
                
                <div class="mt-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Receipt</label>
                    <div class="flex items-center gap-2">
                        <label for="ex-doc" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-slate-300">
                            <i class="fas fa-camera"></i> <span id="ex-doc-label">Upload</span>
                        </label>
                        <input type="file" id="ex-doc" class="hidden" accept=".pdf, .jpg, .jpeg, .png" onchange="updateFileName('ex-doc', 'ex-doc-label')">
                    </div>
                </div>

                <button class="w-full bg-rose-600 text-white py-3 rounded-xl font-bold brand-font" id="btn-save-expense">Save</button>
            </form>
        </div>
    </div>

    <div id="modal-pay" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm relative">
            <h3 class="text-xl font-bold mb-4 brand-font">Record Payment</h3>
            <select id="pay-tenant-select" class="w-full border p-3 rounded-xl mb-4 hidden-section"></select>
            <input type="hidden" id="pay-tenant-id">
            <input type="number" id="pay-amount" class="w-full border p-3 rounded-xl mb-4" placeholder="Amount Recieved">
            <input type="date" id="pay-date" class="w-full border p-3 rounded-xl mb-4">
            <div class="flex gap-2">
                <button onclick="closeModal('modal-pay')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">Cancel</button>
                <button onclick="confirmPay()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold">Save</button>
            </div>
        </div>
    </div>
    
    <div id="modal-maint-detail" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4"><div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md relative"><button onclick="closeModal('modal-maint-detail')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button><h3 class="text-xl font-bold mb-2 brand-font">Request</h3><p id="md-issue" class="text-lg font-medium text-slate-800 mb-1 brand-font"></p><p id="md-meta" class="text-sm text-slate-500 mb-4"></p><div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Notes</p><p id="md-notes" class="text-sm text-slate-700 italic">None</p></div><button onclick="closeModal('modal-maint-detail')" class="w-full border border-slate-300 text-slate-600 py-2 rounded-xl font-bold hover:bg-slate-50 brand-font">Close</button></div></div>

   <div id="modal-screening-detail" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeModal('modal-screening-detail')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        <h3 class="text-xl font-bold mb-1 brand-font">Applicant Report</h3>
        
        <h4 id="sd-name" ondblclick="toggleAdminPanel()" class="text-lg text-slate-600 mb-6 cursor-pointer select-none" title="Admin: Double-click to verify"></h4>

        <div class="space-y-4">
            <div id="sd-banner" class="hidden-section p-4 rounded-xl border font-bold text-center"></div>

            <div id="sd-pending-msg" class="hidden-section bg-indigo-50 p-6 rounded-xl border border-indigo-100 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-2 -mr-2 w-12 h-12 bg-indigo-100 rounded-full blur-xl"></div>
                <div class="relative z-10">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-indigo-600 mx-auto mb-3 shadow-sm animate-pulse"><i class="fas fa-search"></i></div>
                    <h4 class="font-bold text-indigo-900 mb-1">Screening in Progress</h4>
                    <p class="text-xs text-indigo-600 mb-3">Our team is manually verifying this applicant.</p>
                    <div class="inline-flex items-center gap-2 px-3 py-1 bg-white rounded-full border border-indigo-100 shadow-sm"><div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div><span class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">ETA: < 24 Hours</span></div>
                </div>
            </div>

            <div id="sd-api-start" class="hidden-section bg-emerald-50 p-6 rounded-xl border border-emerald-100 text-center">
                <i class="fas fa-bolt text-3xl text-emerald-500 mb-3"></i>
                <h4 class="font-bold text-emerald-900 mb-1">Ready to Screen</h4>
                <p class="text-xs text-emerald-700 mb-4">Instant background check available.</p>
                <button onclick="runAutoScreening()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">Run Instant Check</button>
            </div>

           <div id="sd-admin-panel" class="hidden-section border-t-2 border-dashed border-slate-200 pt-4 mt-4 bg-slate-50 p-4 rounded-xl">
    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">  Admin Verification Override</p>
    
    <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
            <label class="text-[10px] font-bold text-slate-500">Credit Score</label>
            <input id="input-manual-score" type="number" class="w-full border p-2 rounded-lg text-sm bg-white" placeholder="e.g. 720">
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500">Verified Income ($/mo)</label>
            <input id="input-manual-income" type="number" class="w-full border p-2 rounded-lg text-sm bg-white" placeholder="Monthly $">
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
            <label class="text-[10px] font-bold text-slate-500">Eviction History</label>
            <select id="input-manual-evict" class="w-full border p-2 rounded-lg text-sm bg-white">
                <option value="false"> Clean Record</option>
                <option value="true"> Record Found</option>
            </select>
        </div>
        <div>
            <label class="text-[10px] font-bold text-slate-500">Criminal History</label>
            <select id="input-manual-crim" class="w-full border p-2 rounded-lg text-sm bg-white">
                <option value="false"> Clean Record</option>
                <option value="true"> Record Found</option>
            </select>
        </div>
    </div>

    <button onclick="act_saveScreeningResults()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold hover:bg-slate-900 transition shadow-lg">
        <i class="fas fa-save mr-1"></i> Save & Verify Applicant
    </button>
</div>

            <div id="sd-data-display" class="hidden-section">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-2">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Financials</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><p class="text-xs text-slate-500">Credit Score</p><p class="font-bold text-lg" id="sd-score">-</p></div>
                        <div><p class="text-xs text-slate-500">Monthly Income</p><p class="font-bold text-lg" id="sd-income">-</p></div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">Rent Coverage: <span id="sd-ratio" class="font-bold text-slate-800"></span>x</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-2">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Background Check</p>
                    <div class="flex justify-between items-center border-b border-slate-200 pb-2 mb-2"><span class="text-sm font-medium">Evictions</span><span id="sd-evict" class="font-bold text-sm">-</span></div>
                    <div class="flex justify-between items-center"><span class="text-sm font-medium">Criminal History</span><span id="sd-crim" class="font-bold text-sm">-</span></div>
                </div>
            </div>
            
            <div id="sd-actions" class="hidden-section grid grid-cols-3 gap-2 mt-4">
                <button onclick="act_initiateApproval()" class="bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow">Approve</button>
                <button onclick="act_screenDecision('Conditional')" class="bg-amber-400 text-white py-3 rounded-xl font-bold text-sm shadow">Conditional</button>
                <button onclick="act_screenDecision('Deny')" class="bg-rose-600 text-white py-3 rounded-xl font-bold text-sm shadow">Deny</button>
            </div>
            
            <div id="sd-email-option" class="hidden-section text-center p-4 bg-slate-50 rounded-xl">
                <p class="text-sm text-slate-500 mb-2">Decision Saved.</p>
                <button onclick="closeModal('modal-screening-detail')" class="text-indigo-600 font-bold text-sm hover:underline">Close</button>
            </div>
        </div>
    </div>
</div>
<div id="modal-payment-view" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm relative text-center">
        <button onclick="closeModal('modal-payment-view')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
        <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mx-auto mb-4 text-xl">
            <i class="fas fa-check"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-900 mb-1">Payment Received</h3>
        <p class="text-sm text-slate-500 mb-6" id="mp-date">-</p>
        
        <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 mb-4">
            <p class="text-xs font-bold text-slate-400 uppercase mb-1">Amount</p>
            <h2 class="text-3xl font-extrabold text-emerald-600" id="mp-amount">$0.00</h2>
            <p class="text-sm text-slate-600 font-medium mt-2" id="mp-tenant">-</p>
        </div>
        
        <button onclick="closeModal('modal-payment-view')" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Close</button>
    </div>
</div>
    
<script>
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
    
    let supabaseClient = null;
    try {
        if(window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
    } catch(e) { console.error("Error init Supabase:", e); }

    // --- GLOBAL STATE ---
    let state = {
        tenants: [], listings: [], invoices: [], payments: [], expenses: [],
        apps: [], msgs: [], maint: [], settings: {}, 
        notifications: { messages: 0, maintenance: 0, screening: 0 }
    };
    
    // Persistent View Tracking
    let viewedMaintIds = new Set(JSON.parse(localStorage.getItem('kozeyy_viewed_maint') || '[]').map(String));
    let viewedAppIds = new Set(JSON.parse(localStorage.getItem('kozeyy_viewed_apps') || '[]').map(String));
    let locallyReadMsgIds = new Set(JSON.parse(localStorage.getItem('kozeyy_read_msgs') || '[]').map(String));
    let activeTab = 'dashboard';

    // State Tracking for Diffing
    let lastRenderedState = {
        dashboard: "", tenants: "", listings: "", maint: "", msgs: "", invoices: "", expenses: "", screening: ""
    };

    // Helper Functions
    function parseDateStr(str) { if(!str) return new Date(); const parts = str.split('-'); return new Date(parts[0], parts[1]-1, parts[2]); }
    function getLastName(fullName) { if(!fullName) return ''; const parts = fullName.trim().split(' '); return parts.length > 1 ? parts[parts.length - 1] : parts[0]; }
    function setText(id, text) { const el = document.getElementById(id); if(el && el.innerText !== text) el.innerText = text; }

    // UI State Variables
    let currentChatId = null, invMode = 'fixed', invItems = [], chartInstance = null, monthlyChartInstance = null;
    let editTenantId = null, editListingId = null, editExpenseId = null, currentAppId = null;
    let draftInvoice = null;
    let promptCallback = null;
    let platformConfirmCallback = null;

    // --- 1. INIT & POLLING ---
    async function initSystem() {
        try {
            if(!supabaseClient) throw new Error("Supabase library not loaded.");
            await fetchData();
            renderAll();
            loadUserProfile(); // Populate header
            
            // Check for upload redirect param
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('action') === 'lease_uploaded') {
                navTo('screening');
                showToast("Lease document saved successfully");
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Start Polling
            setInterval(async () => { await fetchData(); renderAll(); }, 4000);
        } catch (err) { console.error("Initialization failed:", err); renderAll(); }
    }

   // --- UPDATED FETCH DATA (Safety Check Added) ---
   async function fetchData() {
        // 1. GET OWNER ID
        const ownerId = localStorage.getItem('kozeyy_user_id');

        if(!ownerId || ownerId.length < 20) {
            console.warn("Invalid or missing Owner ID. Redirecting to login.");
            localStorage.removeItem('kozeyy_user_id'); 
            window.location.href = 'login.html';
            return;
        }

        // 2. EXECUTE REQUESTS
        const [t, l, i, p, e, m, msg, s, a, r] = await Promise.all([
            supabaseClient.from('tenants').select('*').eq('owner_id', ownerId), 
            supabaseClient.from('listings').select('*').eq('owner_id', ownerId),
            supabaseClient.from('invoices').select('*').eq('owner_id', ownerId), 
            supabaseClient.from('payments').select('*').eq('owner_id', ownerId),
            supabaseClient.from('expenses').select('*').eq('owner_id', ownerId),
            supabaseClient.from('maintenance').select('*').eq('owner_id', ownerId),
            supabaseClient.from('msgs').select('*').eq('owner_id', ownerId),
            supabaseClient.from('settings').select('*').eq('owner_id', ownerId).maybeSingle(), 
            supabaseClient.from('apps').select('*').eq('owner_id', ownerId),
            supabaseClient.from('recurring_invoices').select('*').eq('owner_id', ownerId)
        ]);

        // 3. STORE DATA
        state.tenants = t.data || [];
        state.listings = l.data || [];
        state.expenses = e.data || [];
        state.settings = s.data || {};
        state.apps = a.data || [];
        state.recurring_invoices = r.data || [];

        // UPDATE: Removed filter to show all invoices (including from archived/deleted tenants)
        state.invoices = i.data || [];
        
        state.payments = (p.data || []);
        state.maint = (m.data || []);
        
        const serverMsgs = msg.data || [];
        state.msgs = serverMsgs; 
        
        // Mark locally read messages as read in UI
        state.msgs.forEach(x => { 
            if(locallyReadMsgIds.has(String(x.id))) x.read_at = new Date().toISOString(); 
        });

        // Update Notification Counts
        state.notifications.messages = state.msgs.filter(x => x.from === 'Tenant' && !x.read_at).length;
        state.notifications.maintenance = state.maint.filter(x => x.status === 'Active' && !viewedMaintIds.has(String(x.id))).length;
        state.notifications.screening = state.apps.filter(x => x.status === 'Pending' && !viewedAppIds.has(String(x.id))).length;
    }
  function renderAll() {
        // --- 1. Dashboard Stats ---
        const stats = calculateGlobalStats();
        setText('dash-revenue', `$${stats.revenue.toLocaleString()}`);
        setText('dash-overdue', `$${stats.overdue.toLocaleString()}`);
        
        const totalUnits = state.tenants.length + state.listings.length;
        const activeTenants = state.tenants.filter(t => t.status === 'Active').length;
        const occ = totalUnits > 0 ? Math.round((activeTenants / totalUnits) * 100) : 0;
        setText('dash-occupancy', `${occ}%`);
        setText('dash-maintenance', state.maint.filter(m => m.status === 'Active').length);
        
        initChart(stats);

        // --- 2. Tenant Directory ---
        const tBody = document.getElementById('table-tenants');
        if(tBody) {
            tBody.innerHTML = '';
            const filter = document.getElementById('filter-tenant-status') ? document.getElementById('filter-tenant-status').value : 'Active';
            state.tenants.forEach(t => {
                if(filter !== 'all' && t.status !== filter) return;
                
                const statusColor = t.status === 'Active' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500';
                tBody.innerHTML += `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                    <td class="p-5 font-bold text-slate-700"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold">${t.name.charAt(0)}</div>${t.name}</div></td>
                    <td class="p-5 hidden md:table-cell text-slate-500 text-sm">${t.address}</td>
                    <td class="p-5 hidden md:table-cell text-slate-500 text-sm">${t.unit}</td>
                    <td class="p-5 hidden md:table-cell font-bold text-slate-700">$${t.rent_amount}</td>
                    <td class="p-5"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${statusColor}">${t.status}</span></td>
                    <td class="p-5 text-right">
                        <button onclick="act_viewTenant(${t.id})" class="text-slate-400 hover:text-indigo-600 mx-1"><i class="fas fa-eye"></i></button>
                        <button onclick="act_editTenant(${t.id})" class="text-slate-400 hover:text-indigo-600 mx-1"><i class="fas fa-edit"></i></button>
                        <button onclick="act_delTenant(${t.id})" class="text-slate-400 hover:text-rose-600 mx-1"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        // --- 3. Listings Grid ---
        const lGrid = document.getElementById('grid-listings');
        if(lGrid) {
            lGrid.innerHTML = '';
            state.listings.forEach(l => {
                const img = (l.images && l.images[0]) || l.image_url || 'https://via.placeholder.com/300x200?text=No+Image';
                lGrid.innerHTML += `
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden group hover:shadow-md transition">
                    <div class="h-40 bg-slate-200 relative overflow-hidden">
                        <img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                        <div class="absolute top-3 right-3 bg-white/90 backdrop-blur px-2 py-1 rounded-lg text-xs font-bold shadow-sm">$${l.price}/mo</div>
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-slate-800 mb-1 truncate">${l.address}</h4>
                        <div class="flex gap-3 text-xs text-slate-500 mb-4">
                            <span><i class="fas fa-bed mr-1"></i>${l.beds}</span>
                            <span><i class="fas fa-bath mr-1"></i>${l.baths}</span>
                            <span><i class="fas fa-ruler-combined mr-1"></i>${l.sqft}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showShareModal(${l.id})" class="flex-1 bg-indigo-50 text-indigo-700 py-2 rounded-xl text-xs font-bold hover:bg-indigo-100">Share</button>
                            <button onclick="act_editListing(${l.id})" class="w-10 bg-slate-50 text-slate-400 py-2 rounded-xl text-xs hover:text-slate-600"><i class="fas fa-edit"></i></button>
                            <button onclick="act_delListing(${l.id})" class="w-10 bg-slate-50 text-slate-400 py-2 rounded-xl text-xs hover:text-rose-600"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // --- 4. Screening Table (FIXED LOGIC) ---
        const sBody = document.getElementById('table-screening');
        if(sBody) {
            sBody.innerHTML = '';
            state.apps.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at)).forEach(app => {
                let displayStatus = app.status;
                let statusColor = "bg-slate-100 text-slate-500";
                let actionButton = '';

                // DETERMINE STATUS COLORS & ACTIONS
                if(app.status === 'Pending') {
                    displayStatus = 'Pending';
                    actionButton = `<button onclick="act_viewApp(${app.id})" class="text-slate-400 font-bold text-xs"><i class="fas fa-eye"></i> View</button>`;
                }
                else if (app.status === 'Ready for Review') {
                    statusColor = "bg-indigo-100 text-indigo-700";
                    actionButton = `<button onclick="act_viewApp(${app.id})" class="text-indigo-600 font-bold text-sm bg-indigo-50 px-3 py-1 rounded hover:bg-indigo-100">Review</button>`;
                }
                else if (app.status === 'Approved') {
                    statusColor = "bg-emerald-100 text-emerald-700";
                    actionButton = `<a href="lease.html?id=${app.id}&name=${encodeURIComponent(app.name)}" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-emerald-700">Upload Lease</a>`;
                }
                else if (app.status === 'Lease Uploaded') {
                    statusColor = "bg-teal-100 text-teal-700";
                    actionButton = `<button onclick="act_initiateSendLease(${app.id})" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-indigo-700">Send Lease</button>`;
                }
                else if (app.status === 'Lease Sent') {
                    statusColor = "bg-purple-100 text-purple-700";
                    actionButton = `<span class="text-purple-600 text-xs font-bold"><i class="fas fa-clock"></i> Signing...</span>`;
                }
                else if (app.status === 'Lease Signed') {
                    statusColor = "bg-blue-100 text-blue-800";
                    actionButton = `<button onclick="act_openCountersign(${app.id})" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-blue-700 animate-pulse">Countersign</button>`;
                }
                else if (app.status === 'Conditional') {
                    statusColor = "bg-amber-100 text-amber-700";
                    actionButton = `<span class="text-amber-600 text-xs font-bold">Conditional</span>`;
                }
                else if (app.status === 'Active' || app.status === 'Completed') {
                    statusColor = "bg-slate-100 text-slate-600";
                    displayStatus = "Active";
                    actionButton = `<span class="text-emerald-600 font-bold text-xs"><i class="fas fa-check"></i> Active</span>`;
                }
                else if (app.status === 'Deny') {
                    statusColor = "bg-rose-100 text-rose-700";
                    actionButton = `<span class="text-rose-400 font-bold text-xs">Denied</span>`;
                }

                const eval = evalApplicant(app);

                sBody.innerHTML += `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                        <td class="p-5 font-bold cursor-pointer" onclick="act_viewApp(${app.id})">
                            ${app.name}
                            <div class="text-xs text-slate-400 font-normal">Income: $${parseInt(app.income||0).toLocaleString()}</div>
                        </td>
                        <td class="p-5"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${eval.color}">${eval.status}</span></td>
                        <td class="p-5"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${statusColor}">${displayStatus}</span></td>
                        <td class="p-5 text-right">${actionButton}</td>
                    </tr>`;
            });
        }

        // --- 5. Maintenance Lists ---
        const ma = document.getElementById('list-maint-active');
        const mh = document.getElementById('list-maint-history');
        if(ma && mh) {
            ma.innerHTML = ''; mh.innerHTML = '';
            state.maint.forEach(m => {
                const isActive = m.status === 'Active';
                const container = isActive ? ma : mh;
                const date = m.created_at ? new Date(m.created_at).toLocaleDateString() : 'Unknown';
                const action = isActive ? `<button onclick="act_completeMaint(${m.id})" class="text-emerald-600 font-bold text-xs">Resolve</button>` : `<button onclick="viewMaintNote(${m.id})" class="text-slate-400 text-xs">View Note</button>`;
                
                container.innerHTML += `
                <div class="p-4 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition flex justify-between items-center">
                    <div><h4 class="font-bold text-sm text-slate-800">${m.issue}</h4><p class="text-xs text-slate-500">${m.category}  ${date}</p></div>
                    ${action}
                </div>`;
            });
            if(ma.innerHTML === '') ma.innerHTML = '<div class="p-6 text-center text-slate-400 text-sm italic">No active requests</div>';
        }

        // --- 6. Notifications ---
        updateBadge('screening', state.notifications.screening);
        updateBadge('maintenance', state.notifications.maintenance);
        updateBadge('messages', state.notifications.messages);
          renderFinancials();
        renderExpenses();
        renderReports();
    }

    function renderReports() {
        const totalRev = state.payments.reduce((sum, p) => sum + (p.amount || 0), 0);
        const totalExp = state.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        const noi = totalRev - totalExp;
        setText('report-income', `$${totalRev.toLocaleString()}`);
        setText('report-expense', `$${totalExp.toLocaleString()}`);
        setText('report-noi', `$${noi.toLocaleString()}`);
    }

    // --- UTILS ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? '<i class="fas fa-check-circle text-emerald-500 text-xl"></i>' : '<i class="fas fa-exclamation-circle text-rose-500 text-xl"></i>';
        toast.innerHTML = `${icon}<span class="font-bold text-sm text-slate-700">${message}</span>`;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // Generic Platform Modal Functions
    function openPlatformConfirm(title, message, callback) {
        setText('plat-conf-title', title);
        setText('plat-conf-msg', message);
        document.getElementById('modal-platform-confirm').classList.remove('hidden-section');
        document.getElementById('modal-platform-confirm').classList.add('flex');
        platformConfirmCallback = callback;
    }

    function closePlatformConfirm(confirmed) {
        document.getElementById('modal-platform-confirm').classList.add('hidden-section');
        document.getElementById('modal-platform-confirm').classList.remove('flex');
        if(confirmed && platformConfirmCallback) {
            platformConfirmCallback();
        }
        platformConfirmCallback = null;
    }

    function openPrompt(title, callback) {
        setText('prompt-title', title);
        document.getElementById('prompt-input').value = '';
        document.getElementById('modal-prompt').classList.remove('hidden-section');
        document.getElementById('modal-prompt').classList.add('flex');
        promptCallback = callback;
    }

    function closePrompt(confirmed) {
        document.getElementById('modal-prompt').classList.add('hidden-section');
        document.getElementById('modal-prompt').classList.remove('flex');
        if (confirmed && promptCallback) {
            const val = document.getElementById('prompt-input').value;
            promptCallback(val);
        }
        promptCallback = null;
    }

  // --- VIEW PUBLIC LISTING LINK ---
   // --- SYNDICATION & MARKETING LOGIC ---
    
    let currentShareId = null; // Track which listing is open

    function showShareModal(id) {
        currentShareId = id;
        const l = state.listings.find(x => x.id === id);
        if(!l) return;

        // 1. Generate Public URL
        let currentPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
        const url = `${currentPath}/index.html?page=rentals&highlight=${id}`;
        document.getElementById('share-link-input').value = url;

        // 2. Generate Optimized Ad Copy
        // We include the Direct Link at the bottom so traffic comes back to you
        const amenities = l.amenities ? `\n\nFEATURES:\n${l.amenities}` : '';
        const descShort = l.description || 'Great property available for rent.';
        const contact = l.contact_info ? `\n\nCONTACT: ${l.contact_info}` : '';
        
        const marketingText = `FOR RENT: ${l.beds} Bed ${l.baths} Bath in ${l.address.split(',')[1] || 'Town'} - $${l.price.toLocaleString()}/mo\n\n${descShort}${amenities}${contact}\n\n APPLY / VIEW PHOTOS: ${url}`;
        
        document.getElementById('share-copy-text').value = marketingText;
        
        // 3. Reset Button State
        const btn = document.getElementById('btn-download-photos');
        btn.innerHTML = `<i class="fas fa-download mr-1"></i> Download ZIP`;
        btn.disabled = false;

        openModal('modal-share-listing');
    }

    function copyMarketingText() {
        const copyText = document.getElementById("share-copy-text");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        document.execCommand("copy");
        showToast("Ad text copied! Ready to paste.");
    }

    function copyListingLink() {
        const input = document.getElementById('share-link-input');
        input.select();
        document.execCommand('copy');
        showToast("Link copied!");
    }

    // --- PHOTO ZIPPER FUNCTION ---
    async function downloadPhotos() {
        if(!currentShareId) return;
        const l = state.listings.find(x => x.id === currentShareId);
        if(!l) return;

        // Gather all images (handling array or single string format)
        let images = [];
        if(l.images && Array.isArray(l.images) && l.images.length > 0) {
            images = l.images;
        } else if(l.image_url) {
            images = [l.image_url]; // Fallback for legacy data
        }

        if(images.length === 0) {
            showToast("No photos to download", "error");
            return;
        }

        const btn = document.getElementById('btn-download-photos');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-1"></i> Zipping...`;
        btn.disabled = true;

        try {
            const zip = new JSZip();
            const folderName = `photos-${l.address.split(',')[0].trim().replace(/\s+/g, '-')}`;
            const folder = zip.folder(folderName);

            // Fetch and add each image to the zip
            const promises = images.map(async (url, i) => {
                try {
                    // Fetch the image data
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Failed to fetch ${url}`);
                    const blob = await response.blob();
                    
                    // Determine extension
                    let ext = 'jpg';
                    const type = blob.type; 
                    if (type === 'image/png') ext = 'png';
                    else if (type === 'image/jpeg') ext = 'jpg';
                    else if (type === 'image/webp') ext = 'webp';

                    // Add to zip folder
                    folder.file(`photo_${i+1}.${ext}`, blob);
                } catch(e) {
                    console.warn("Failed to fetch image:", url, e);
                }
            });

            // Wait for ALL images to be fetched and added to zip object
            await Promise.all(promises);

            // Generate the zip file
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, `listing-photos-${l.id}.zip`);
            
            showToast("Photos downloaded successfully!");

        } catch(err) {
            console.error(err);
            showToast("Error creating ZIP file", "error");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    async function uploadFile(file, bucket) {
        if (!file) return null;
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
        const { error: uploadError } = await supabaseClient.storage.from(bucket).upload(fileName, file);
        if (uploadError) {
            showToast(`Upload failed: ${uploadError.message}`, 'error');
            return null;
        }
        const { data: { publicUrl } } = supabaseClient.storage.from(bucket).getPublicUrl(fileName);
        return publicUrl;
    }

   async function act_completeMaint(id) { 
        // 1. Prompt for notes
        openPrompt("Resolution Notes (Optional):", async (n) => {
            const note = n || "Completed";
            
            // 2. Update Database
            const { data, error } = await supabaseClient
                .from('maintenance')
                .update({ status: 'Completed', completed_date: new Date().toISOString(), notes: note })
                .eq('id', id)
                .select()
                .single(); 
            
            if (error) { 
                showToast("Update failed: " + error.message, 'error'); 
            } else {
                // 3. SEND EMAIL TO TENANT (UPDATED)
                const maintReq = data;
                if(maintReq && maintReq.tenant_id) {
                    const tenant = state.tenants.find(t => t.id === maintReq.tenant_id);
                    if(tenant && tenant.email) {
                        await sendEmail(
                            tenant.email, 
                            "Maintenance Request Completed", 
                            'alert', 
                            { 
                                title: "Maintenance Completed",
                                message: `Your request for "${maintReq.issue}" has been marked as completed. Notes: ${note}`,
                                actionLink: "https://kozeyy.com/tenant.html"
                            }
                        );
                    }
                }

                await fetchData(); 
                renderAll();
                showToast("Request completed and Tenant notified");
            }
        });
    }
    
    function updateBadge(id, count) { 
        const el = document.getElementById('badge-' + id); 
        if(!el) return;
        const isViewing = activeTab === id;
        if(count > 0 && !isViewing) { el.innerText = count; el.classList.remove('hidden-section'); } 
        else { el.classList.add('hidden-section'); } 
    }

   function calculateGlobalStats() {
        let revenue = 0, overdue = 0, outstanding = 0;
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        const s = state.settings || {};
        const globalGrace = parseInt(s.grace_period || 0);
        const globalFeeVal = parseFloat(s.late_fee_amount || 0);
        const globalFeeType = s.late_fee_method || 'Fixed';

        // 1. Calculate Revenue
        state.payments.forEach(p => { 
            const pDate = parseDateStr(p.date); 
            if(pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear) {
                revenue += p.amount; 
            }
        });

        // 2. Calculate Outstanding vs Overdue
        state.invoices.forEach(inv => { 
            if(inv.status !== 'Paid') { 
                const invDate = parseDateStr(inv.date);
                
                const grace = inv.grace_period !== undefined ? inv.grace_period : globalGrace;
                const dueDate = new Date(invDate);
                dueDate.setDate(dueDate.getDate() + grace);
                
                let bal = inv.total - (inv.amount_paid || 0);
                const isOverdue = now > dueDate;

                if (isOverdue) {
                    const iFeeVal = inv.fee_value !== undefined ? inv.fee_value : globalFeeVal;
                    const iFeeType = inv.fee_type || globalFeeType;
                    let fee = iFeeVal;
                    if(iFeeType === 'Percentage') fee = inv.total * (iFeeVal/100);
                    bal += fee;
                }
                
                if(bal > 0) { 
                    if(isOverdue) {
                        overdue += bal;
                    } else {
                        // FIX: Count as outstanding if it's unpaid and NOT overdue.
                        // We remove the strict month check so late-month invoices don't vanish.
                        outstanding += bal;
                    }
                } 
            } 
        });
        return { revenue, overdue, outstanding };
    }
    function navTo(view) {
        activeTab = view;
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-section'));
        document.getElementById('view-' + view).classList.remove('hidden-section');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('sidebar-active'));
        const link = document.getElementById('link-' + view);
        if(link) link.classList.add('sidebar-active');
        
        const titles = { dashboard: 'Portfolio Overview', tenants: 'Tenant Directory', listings: 'Property Listings', financials: 'Payment Records', expenses: 'Expense Tracker', reports: 'Financial Reports', settings: 'System Configuration', screening: 'Applicant Queue', messages: 'Communication Center', maintenance: 'Maintenance Requests' };
        setText('desktop-page-title', titles[view] || 'Dashboard');
        
        if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('mobile-overlay').classList.add('hidden'); }
        
        if(view === 'maintenance') {
            state.maint.filter(m => m.status === 'Active').forEach(m => viewedMaintIds.add(String(m.id)));
            localStorage.setItem('kozeyy_viewed_maint', JSON.stringify([...viewedMaintIds]));
            updateBadge('maintenance', 0);
        }
        if(view === 'screening') {
            state.apps.filter(a => a.status === 'Pending').forEach(a => viewedAppIds.add(String(a.id)));
            localStorage.setItem('kozeyy_viewed_apps', JSON.stringify([...viewedAppIds]));
            updateBadge('screening', 0);
        }
        
        if(view === 'financials') populateFinFilter();
        if(view === 'expenses') { populateExpenseModal(); populateExpFilter(); }
        if(view === 'messages') { renderChatList(); backToChatList(); }
        if(view === 'reports') { setTimeout(renderMonthlyChart, 50); }
        if(view === 'settings') { renderSettings(); } 
    }

function toggleFeeVisibility() {
    const isActive = document.getElementById('set-fee-active').checked;
    const container = document.getElementById('fee-inputs-container');
    if(isActive) {
        container.classList.remove('opacity-50', 'pointer-events-none');
    } else {
        container.classList.add('opacity-50', 'pointer-events-none');
    }
}
    
   function renderSettings() {
        const s = state.settings;
        if(!s) return;
        if(document.getElementById('set-stripe-id')) document.getElementById('set-stripe-id').value = s.stripe_connect_id || '';
        
        // Fee Settings
        if(document.getElementById('set-fee-active')) {
            const isActive = s.late_fee_enabled !== false; // Default true
            document.getElementById('set-fee-active').checked = isActive;
            toggleFeeVisibility();
        }
        if(document.getElementById('fee-amount')) document.getElementById('fee-amount').value = s.late_fee_amount || 50; 
        if(document.getElementById('fee-grace')) document.getElementById('fee-grace').value = s.grace_period || 5; 
        if(document.getElementById('fee-method')) document.getElementById('fee-method').value = s.late_fee_method || 'Fixed';

        // Screening
        if(document.getElementById('set-min-score')) document.getElementById('set-min-score').value = s.min_credit_score || 650;
        if(document.getElementById('set-min-income')) document.getElementById('set-min-income').value = s.min_income_ratio || 3.0;
        if(document.getElementById('set-no-evict')) document.getElementById('set-no-evict').checked = !!s.require_no_evictions;
        if(document.getElementById('set-no-crim')) document.getElementById('set-no-crim').checked = !!s.require_no_criminal_history;
    }

    function viewMaintNote(id) { 
        const m = state.maint.find(x => x.id == id); 
        setText('md-issue', m.issue); 
        setText('md-meta', `Completed: ${m.completed_date ? new Date(m.completed_date).toLocaleDateString() : 'Unknown'}`); 
        setText('md-notes', m.notes || "No notes."); 
        openModal('modal-maint-detail'); 
    }

    function renderChatList() { 
        const l = document.getElementById('list-chats'); 
        if(!l) return;
        l.innerHTML = ''; 
        const sortedChats = state.tenants.filter(t => t.status !== 'Vacant').map(t => {
            const msgs = state.msgs.filter(m => m.tenant_id === t.id);
            const lastTime = msgs.length > 0 ? new Date(msgs[msgs.length - 1].created_at).getTime() : 0;
            const unread = msgs.filter(m => m.from === 'Tenant' && !m.read_at).length;
            return { tenant: t, time: lastTime, unread: unread };
        }).sort((a, b) => b.time - a.time); 

        sortedChats.forEach(item => { 
            const t = item.tenant;
            const badge = item.unread > 0 ? `<span class="bg-rose-500 text-white text-[10px] px-2 py-0.5 rounded-full">${item.unread}</span>` : '';
            l.innerHTML += `<div onclick="openChat(${t.id})" class="p-4 bg-white border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 font-bold text-sm mb-2 shadow-sm flex justify-between items-center transition"><div><span>${t.name}</span></div><div class="flex items-center gap-2">${badge}<i class="fas fa-chevron-right text-slate-300 text-xs"></i></div></div>`; 
        }); 
    }

    async function openChat(id) { 
        currentChatId=id; 
        setText('chat-title', state.tenants.find(x=>x.id==id).name); 
        renderMessages(true);
        const unreadIds = state.msgs.filter(m => m.tenant_id === id && m.from === 'Tenant' && !m.read_at).map(m => m.id);
        if(unreadIds.length > 0) {
            unreadIds.forEach(uid => locallyReadMsgIds.add(String(uid)));
            localStorage.setItem('kozeyy_read_msgs', JSON.stringify([...locallyReadMsgIds]));
            state.msgs.forEach(m => { if(unreadIds.includes(m.id)) m.read_at = new Date().toISOString(); });
            await supabaseClient.from('msgs').update({ read_at: new Date().toISOString() }).in('id', unreadIds);
            renderAll(); 
        }
        if(window.innerWidth < 768) { document.getElementById('msg-list-panel').classList.add('hidden'); document.getElementById('msg-view-panel').classList.remove('hidden'); document.getElementById('msg-view-panel').classList.add('flex'); } 
    }

    function renderMessages(force = false) { 
        const b = document.getElementById('box-chat'); 
        if(!b) return;
        const relevantMsgs = state.msgs.filter(m => m.tenant_id == currentChatId).sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
        const hash = JSON.stringify(relevantMsgs);
        if(!force && hash === lastRenderedState.msgs) return;
        lastRenderedState.msgs = hash;
        b.innerHTML = ''; 
        relevantMsgs.forEach(m => { 
            const d = new Date(m.created_at);
            const ts = d.toDateString() === new Date().toDateString() ? d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) : d.toLocaleDateString();
            const isOwner = m.from === 'Owner';
            b.innerHTML += `<div class="flex flex-col w-full ${isOwner ? 'items-end' : 'items-start'} mb-4 fade-in"><div class="px-4 py-3 rounded-2xl text-sm shadow-sm max-w-[85%] ${isOwner ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 rounded-bl-none'}">${m.text}</div><span class="text-[10px] text-slate-400 mt-1 mx-1">${ts}</span></div>`; 
        }); 
        b.scrollTop = b.scrollHeight; 
    }
    
    async function sendMsg() { 
        const i = document.getElementById('input-chat'); 
        const ownerId = localStorage.getItem('kozeyy_user_id'); // Get Owner ID

        if(i.value && currentChatId && ownerId) { 
            const newMsg = {
                owner_id: ownerId,      // ADDED: Owner ID
                tenant_id: currentChatId, 
                from: 'Owner', 
                text: i.value, 
                time: new Date().toISOString(), 
                created_at: new Date().toISOString() 
            };
            
            // Optimistic UI Update
            state.msgs.push(newMsg);
            renderMessages(true);
            
            const val = i.value; 
            i.value = ''; 
            
            // Send to Backend
            const { error } = await supabaseClient.from('msgs').insert([newMsg]);
            if(error) console.error("Message send failed:", error);
            
            await fetchData(); 
        } 
    }

    // Modal/CRUD
    function openModal(id) { document.getElementById(id).classList.remove('hidden-section'); document.getElementById(id).classList.add('flex'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden-section'); document.getElementById(id).classList.remove('flex'); resetForms(); }
   function resetForms() {
        editTenantId = null;
        editListingId = null;
        editExpenseId = null;
        // recurring cleanup
        editingRecurringId = null;

        setText('btn-save-tenant', "Save Tenant");
        setText('btn-save-listing', "Post Listing");
        setText('btn-save-expense', "Save");

        ['ex-id', 'ex-amount', 'ex-vendor', 'ex-date', 'ex-doc',
         't-id', 't-name', 't-email', 't-phone', 't-unit', 't-rent', 't-start', 't-end', 't-addr', 't-city', 't-state', 't-zip',
         'l-addr', 'l-price', 'l-sqft', 'l-beds', 'l-baths', 'l-desc', 'l-amen', 'l-contact', 'l-date', 'l-img'
        ].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });

        // UPDATE: Explicitly clear Invoice Document & Styles
        const invDoc = document.getElementById('inv-doc');
        if(invDoc) invDoc.value = "";
        
        const invLabel = document.getElementById('inv-doc-label');
        if(invLabel) {
            invLabel.innerText = "Choose File";
            invLabel.parentElement.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
        }

        updateFileName('ex-doc', 'ex-doc-label');
    }
    function toggleSidebar() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('mobile-overlay'); if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); } else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); } }
    
    // Screening Logic
    function evalApplicant(app) {
        if (!app.score || app.score === 0) {
            return { status: 'Pending', color: 'bg-slate-100 text-slate-500 border-slate-200' };
        }

        const crit = state.settings || { min_credit_score: 600, min_income_ratio: 2.5 };
        const incomeRatio = app.income / app.rent;
        
        if(app.score < (crit.min_credit_score - 50)) return { status: 'Does Not Meet', color: 'bg-rose-100 text-rose-700 border-rose-200' };
        if(app.score < crit.min_credit_score || incomeRatio < crit.min_income_ratio) return { status: 'Conditional', color: 'bg-amber-100 text-amber-700 border-amber-200' };
        return { status: 'Meets Criteria', color: 'bg-emerald-100 text-emerald-700 border-emerald-200' };
    }
    
    // CRUD Functions
    
    async function act_saveTenant(e) { 
        e.preventDefault(); 
        const ownerId = localStorage.getItem('kozeyy_user_id');
        if (!ownerId) { showToast("Error: No owner logged in", 'error'); return; }

        const data = { 
            owner_id: ownerId, 
            name: document.getElementById('t-name').value, 
            email: document.getElementById('t-email').value, 
            phone: document.getElementById('t-phone').value, 
            unit: document.getElementById('t-unit').value, 
            rent_amount: parseFloat(document.getElementById('t-rent').value)||0, 
            lease_start: document.getElementById('t-start').value||null, 
            lease_end: document.getElementById('t-end').value||null, 
            status: document.getElementById('t-status').value, 
            address: document.getElementById('t-addr').value, 
            city: document.getElementById('t-city').value, 
            state: document.getElementById('t-state').value, 
            zip: document.getElementById('t-zip').value 
        }; 

        if(editTenantId) {
            await supabaseClient.from('tenants').update(data).eq('id', editTenantId); 
        } else {
            await supabaseClient.from('tenants').insert([data]); 
        }
        
        closeModal('modal-tenant'); 
        await fetchData(); 
        renderAll(); 
    }
    
    async function act_moveOut(id) {
        openPlatformConfirm("Archive Tenant?", "This will move the tenant to archives and mark the unit as Vacant.", async () => {
            const t = state.tenants.find(x => x.id === id);
            if(!t) return;
            await supabaseClient.from('tenants').update({ status: 'Archived' }).eq('id', id);
            const newUnit = { 
                owner_id: localStorage.getItem('kozeyy_user_id'), 
                name: '(Vacant)', email: '', phone: '', address: t.address, unit: t.unit, city: t.city, state: t.state, zip: t.zip, rent_amount: t.rent_amount, status: 'Vacant', lease_start: null, lease_end: null 
            };
            await supabaseClient.from('tenants').insert([newUnit]);
            await fetchData(); renderAll(); showToast("Tenant archived and unit marked Vacant");
        });
    }

    function act_editTenant(id) { editTenantId = id; const t = state.tenants.find(x => x.id === id); setText('modal-tenant-title',"Edit Tenant"); setText('btn-save-tenant',"Update Tenant"); document.getElementById('t-id').value = t.id; document.getElementById('t-name').value = t.name; document.getElementById('t-email').value = t.email; document.getElementById('t-phone').value = t.phone||''; document.getElementById('t-unit').value = t.unit||''; document.getElementById('t-rent').value = t.rent_amount; document.getElementById('t-start').value = t.lease_start||''; document.getElementById('t-end').value = t.lease_end||''; document.getElementById('t-addr').value = t.address||''; document.getElementById('t-status').value = t.status; document.getElementById('t-city').value = t.city||''; document.getElementById('t-state').value = t.state||''; document.getElementById('t-zip').value = t.zip||''; openModal('modal-tenant'); }
    async function act_delTenant(id) { openPlatformConfirm("Delete Tenant?", "This cannot be undone.", async () => { await supabaseClient.from('tenants').delete().eq('id', id); await fetchData(); renderAll(); }); }
    
    async function act_saveListing(e) { 
        e.preventDefault(); 
        
        // --- VALIDATION: Require Contact Info ---
        const contactInfo = document.getElementById('l-contact').value;
        if (!contactInfo || contactInfo.trim() === "") {
            showToast("Contact info is required", "error");
            document.getElementById('l-contact').focus();
            return;
        }

        const btn = document.getElementById('btn-save-listing');
        const originalText = btn.innerText;
        btn.innerText = "Uploading Images...";
        btn.disabled = true;

        const files = document.getElementById('l-img-file').files;
        let imageUrls = [];
        
        try {
            if (files && files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${i}.${fileExt}`;
                    
                    const { error: uploadError } = await supabaseClient.storage.from('listings').upload(fileName, file);
                    if (uploadError) throw uploadError;
                    
                    const { data } = supabaseClient.storage.from('listings').getPublicUrl(fileName);
                    imageUrls.push(data.publicUrl);
                }
            }

            let ownerId = localStorage.getItem('kozeyy_user_id');
            if (!ownerId) throw new Error("No owner logged in");

            const listingData = { 
                owner_id: ownerId, 
                address: document.getElementById('l-addr').value, 
                price: parseFloat(document.getElementById('l-price').value), 
                sqft: parseInt(document.getElementById('l-sqft').value), 
                beds: parseInt(document.getElementById('l-beds').value), 
                baths: parseFloat(document.getElementById('l-baths').value), 
                description: document.getElementById('l-desc').value, 
                amenities: document.getElementById('l-amen').value, 
                contact_info: contactInfo, // Use the validated variable
                date_available: document.getElementById('l-date').value,
                images: imageUrls, 
                image_url: imageUrls.length > 0 ? imageUrls[0] : null
            }; 
            
            if(editListingId) {
                // If editing and no new images uploaded, don't overwrite existing ones
                if(imageUrls.length === 0) { delete listingData.images; delete listingData.image_url; }
                const { error } = await supabaseClient.from('listings').update(listingData).eq('id', editListingId);
                if(error) throw error;
            } else {
                const { data, error } = await supabaseClient.from('listings').insert([listingData]).select(); 
                if(error) throw error;
                if(data && data[0]) showShareModal(data[0].id);
            }
            
            closeModal('modal-listing'); 
            await fetchData(); 
            renderAll();
            if(!editListingId) showToast("Listing saved!");

        } catch (err) {
            console.error(err);
            showToast("Error: " + err.message, 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    
    function act_editListing(id) { editListingId = id; const l = state.listings.find(x => x.id == id); document.getElementById('l-addr').value = l.address; document.getElementById('l-price').value = l.price; document.getElementById('l-sqft').value = l.sqft; document.getElementById('l-beds').value = l.beds; document.getElementById('l-baths').value = l.baths; document.getElementById('l-desc').value = l.description; document.getElementById('l-amen').value = l.amenities||''; document.getElementById('l-date').value = l.date_available; setText('btn-save-listing',"Update Listing"); openModal('modal-listing'); }
    async function act_delListing(id) { await supabaseClient.from('listings').delete().eq('id', id); await fetchData(); renderAll(); }

    async function act_saveExpense(e) { 
        e.preventDefault(); 
        const btn = document.getElementById('btn-save-expense');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        try {
            const ownerId = localStorage.getItem('kozeyy_user_id');
            
            // 1. Handle File Upload
            const file = document.getElementById('ex-doc').files[0];
            let docUrl = null;
            if (file) docUrl = await uploadFile(file, 'receipts'); 
            
            // 2. Prepare Data Object
            const data = { 
                owner_id: ownerId, 
                date: document.getElementById('ex-date').value, 
                vendor: document.getElementById('ex-vendor').value, 
                category: document.getElementById('ex-cat').value, 
                property_address: document.getElementById('ex-prop').value, 
                amount: parseFloat(document.getElementById('ex-amount').value)||0
            }; 
            
            // 3. Only include receipt_url if a new file was uploaded (Fix for Issue #5)
            if (docUrl) {
                data.receipt_url = docUrl;
            }
            // Note: If no new file (docUrl is null), we simply omit the key, 
            // causing Supabase to keep the existing value during UPDATE.
            
            let result;
            if(editExpenseId) {
                result = await supabaseClient.from('expenses').update(data).eq('id', editExpenseId); 
            } else {
                // For inserts, we need to explicitly set URL if it exists, otherwise it's null by default
                if(docUrl) data.receipt_url = docUrl;
                result = await supabaseClient.from('expenses').insert([data]); 
            }

            if (result.error) throw result.error;
            
            closeModal('modal-expense'); 
            await fetchData(); 
            renderAll(); 
            showToast("Expense saved");

        } catch (err) {
            console.error(err);
            showToast("Error saving expense: " + err.message, 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    function act_editExpense(id) { editExpenseId = id; const e = state.expenses.find(x => x.id === id); setText('modal-expense-title',"Edit Expense"); document.getElementById('ex-id').value = id; document.getElementById('ex-date').value = e.date; document.getElementById('ex-vendor').value = e.vendor; document.getElementById('ex-cat').value = e.category; document.getElementById('ex-amount').value = e.amount; populateExpenseModal(); const s = document.getElementById('ex-prop'); s.value = e.property_address; openModal('modal-expense'); }
    async function act_delExpense(id) { openPlatformConfirm("Delete Expense?", "Confirm deletion.", async () => { await supabaseClient.from('expenses').delete().eq('id', id); await fetchData(); renderAll(); }); }

    function act_viewTenant(id) { const t = state.tenants.find(x => x.id === id); if(!t) return; setText('vt-name', t.name); setText('vt-email', t.email); setText('vt-phone', t.phone||'-'); setText('vt-addr', `${t.address||''}, ${t.city||''} ${t.state||''} ${t.zip||''}`); setText('vt-unit', t.unit||'-'); setText('vt-rent', `$${parseInt(t.rent_amount || 0).toLocaleString()}`); setText('vt-status', t.status); setText('vt-start', t.lease_start||'-'); setText('vt-end', t.lease_end||'-'); openModal('modal-view-tenant'); }
    
    // --- 1. Toggle Secret Admin Panel ---
    function toggleAdminPanel() { 
        document.getElementById('sd-admin-panel').classList.toggle('hidden-section'); 
    }

    // --- 2. View Applicant (Decides Concierge vs API view) ---
function act_viewApp(id) {
        currentAppId = id;
        const app = state.apps.find(a => a.id === id);
        
        // ... (Keep existing populate data logic for name, income, score, etc.) ...
        setText('sd-name', app.name);
        const isVerified = (app.score && app.score > 0) || ['Lease Signed', 'Active', 'Completed'].includes(app.status);
        const incomeLabel = isVerified ? "(Verified)" : "(Self-Reported)";
        setText('sd-income', `$${(app.income||0).toLocaleString()} ${incomeLabel}`);
        const ratio = app.rent > 0 ? (app.income / app.rent).toFixed(1) : '0';
        setText('sd-ratio', ratio);

        // ... (Keep existing background check display logic) ...

        // --- RESET UI ---
        ['sd-pending-msg', 'sd-api-start', 'sd-admin-panel', 'sd-actions', 'sd-email-option', 'sd-banner'].forEach(eid => document.getElementById(eid).classList.add('hidden-section'));
        document.getElementById('sd-data-display').classList.remove('hidden-section');

        // --- DETERMINE STATE ---
        const banner = document.getElementById('sd-banner');
        const emailOpt = document.getElementById('sd-email-option'); 
        const emailBtn = emailOpt.querySelector('button');

        if (app.status === 'Approved') {
            // STEP 1: APPROVED -> UPLOAD
            banner.classList.remove('hidden-section');
            banner.className = "p-4 rounded-xl border font-bold text-center mb-4 bg-emerald-100 text-emerald-700 border-emerald-200";
            banner.innerText = "Application Approved";
            
            emailOpt.classList.remove('hidden-section');
            emailOpt.querySelector('p').innerText = "Next Step: Upload Lease Agreement.";
            emailBtn.classList.remove('hidden-section');
            emailBtn.innerText = "Upload Lease";
            emailBtn.onclick = () => window.location.href = `lease.html?id=${currentAppId}&name=${encodeURIComponent(app.name)}`;

        } else if (app.status === 'Lease Uploaded') {
            // STEP 2: UPLOADED -> SEND
            banner.classList.remove('hidden-section');
            banner.className = "p-4 rounded-xl border font-bold text-center mb-4 bg-teal-100 text-teal-700 border-teal-200";
            banner.innerText = "Lease Document Ready";
            
            emailOpt.classList.remove('hidden-section');
            emailOpt.querySelector('p').innerText = "Lease uploaded. Ready to send to tenant.";
            emailBtn.classList.remove('hidden-section');
            emailBtn.innerText = "Send Lease Now";
            emailBtn.onclick = () => act_initiateSendLease(currentAppId);

        } else if (app.status === 'Lease Sent') {
            // STEP 3: SENT -> WAITING
            banner.classList.remove('hidden-section');
            banner.className = "p-4 rounded-xl border font-bold text-center mb-4 bg-purple-50 text-purple-700 border-purple-200";
            banner.innerHTML = `<i class="fas fa-clock mr-2"></i> Lease Sent - Waiting for Signature`;
            
            emailOpt.classList.remove('hidden-section');
            emailOpt.querySelector('p').innerText = "Tenant notified.";
            emailBtn.classList.add('hidden-section'); // No action needed

        } else if (app.status === 'Lease Signed') {
            // STEP 4: SIGNED -> COUNTERSIGN
            banner.classList.remove('hidden-section');
            banner.className = "p-4 rounded-xl border font-bold text-center mb-4 bg-blue-50 text-blue-700 border-blue-200";
            banner.innerHTML = `<i class="fas fa-pen-fancy mr-2"></i> Signed by Tenant`;
            
            emailOpt.classList.remove('hidden-section');
            emailOpt.querySelector('p').innerText = "Review and finalize.";
            emailBtn.classList.remove('hidden-section');
            emailBtn.innerText = "Countersign Lease";
            emailBtn.onclick = () => act_openCountersign(currentAppId);
            
        } else if (app.status === 'Deny') {
            banner.classList.remove('hidden-section');
            banner.className = "p-4 rounded-xl border font-bold text-center mb-4 bg-rose-100 text-rose-700 border-rose-200";
            banner.innerText = "Application Denied";

        } else if (app.status === 'Conditional') {
            banner.classList.remove('hidden-section');
            banner.className = "p-4 rounded-xl border font-bold text-center mb-4 bg-amber-100 text-amber-700 border-amber-200";
            banner.innerText = app.notes ? `Condition: ${app.notes}` : "Conditional Offer Sent";
            
        } else {
            // PENDING / REVIEW
             if (!app.score) {
                // ... (Keep existing API/Pending logic) ...
                 const hasApiKey = state.settings.rentprep_api_key && state.settings.rentprep_api_key.trim() !== '';
                if (hasApiKey) document.getElementById('sd-api-start').classList.remove('hidden-section');
                else document.getElementById('sd-pending-msg').classList.remove('hidden-section');
                document.getElementById('sd-actions').classList.add('hidden-section');
            } else {
                document.getElementById('sd-actions').classList.remove('hidden-section');
            }
        }

        openModal('modal-screening-detail');
    }
    // --- 3. Save Manual Results (Concierge Action) ---
  async function act_saveScreeningResults() {
        const score = document.getElementById('input-manual-score').value;
        const income = document.getElementById('input-manual-income').value;
        // UPDATE: Read specific values
        const evictVal = document.getElementById('input-manual-evict').value === 'true';
        const crimVal = document.getElementById('input-manual-crim').value === 'true';
        
        if(!score) return showToast("Please enter score", 'error');

        const { error } = await supabaseClient.from('apps').update({
            score: parseInt(score),
            income: parseFloat(income),
            evictions: evictVal, // Save actual value
            criminal: crimVal,   // Save actual value
            status: 'Ready for Review' 
        }).eq('id', currentAppId);
        
        if(error) {
            showToast("Error saving: " + error.message, 'error');
        } else {
            showToast("Report Verified manually");
            await fetchData();
            act_viewApp(currentAppId); // Refresh modal to show data and enable buttons
        }
    }

    // Placeholder for when you get the API key
    function runAutoScreening() { 
        showToast("Connecting to Screening API...", 'success');
    }
    
    function act_initiateApproval() {
        openPlatformConfirm("Approve Applicant?", "This will mark the applicant as approved.", async () => {
             await act_screenDecision('Approved');
             
             // SEND EMAIL (UPDATED)
             const app = state.apps.find(a => a.id === currentAppId);
             if(app && app.email) {
                 await sendEmail(
                     app.email, 
                     "Application Approved! - Next Steps", 
                     'alert',
                     {
                         title: `Congratulations, ${app.name}!`,
                         message: `Your application for the property at $${app.rent}/mo has been approved. Please log in to view the next steps.`,
                         actionLink: "https://kozeyy.com/applicantportal.html"
                     }
                 );
             }
        });
    }

    async function act_screenDecision(decision) {
        if (!currentAppId) return;

        let conditionNote = null;

        // 1. If Conditional, ASK FOR DETAILS
        if (decision === 'Conditional') {
            // We use the existing 'openPrompt' helper you already have
            openPrompt("Enter Condition (e.g. Double Deposit):", async (val) => {
                if (!val) return showToast("Condition required", 'error');
                
                // Save decision WITH the note
                await saveDecisionToDB('Conditional', val);
            });
            return; // Stop here, wait for prompt callback
        }

        // 2. If Approve/Deny, just save immediately
        await saveDecisionToDB(decision, null);
    }

    // Helper to actually save to Supabase
    async function saveDecisionToDB(status, note) {
        // Update the app status AND store the condition note
        // (Ensure you have a 'notes' column in your 'apps' table, or just use a generic field)
        const updateData = { status: status };
        if(note) updateData.notes = note; // We'll save the condition in 'notes'

        const { error } = await supabaseClient.from('apps').update(updateData).eq('id', currentAppId);

        if (error) {
            showToast("Error saving: " + error.message, 'error');
        } else {
            closeModal('modal-screening-detail');
            await fetchData();
            renderAll();
            
            if (status === 'Conditional') showToast("Conditional Offer Saved");
            else showToast(`Application ${status}`);
        }
    }

  function act_initiateSendLease(appId) {
        openPlatformConfirm("Send Lease?", "This will email the lease to the applicant for signature.", async () => {
            
            // 1. Update DB Status
            const { error } = await supabaseClient.from('apps').update({ status: 'Lease Sent' }).eq('id', appId);
            
            if(error) {
                showToast("Error updating status: " + error.message, "error");
                return;
            }

            // 2. SEND EMAIL
            const app = state.apps.find(a => a.id === appId);
            if(app && app.email) {
                 await sendEmail(
                     app.email, 
                     "Action Required: Sign Your Lease", 
                     'alert',
                     {
                         title: "Lease Ready for Signature",
                         message: "Your lease agreement is ready for review. Please sign it digitally to finalize your move-in.",
                         actionLink: "https://kozeyy.com/applicantportal.html"
                     }
                 );
            }

            await fetchData();
            renderAll();
            closeModal('modal-screening-detail'); // Close modal after sending
            showToast("Lease notification sent successfully");
        });
    }
    function act_initiateFinalize(appId) {
        openPlatformConfirm("Finalize Tenant?", "Confirm lease signed. Converts applicant to Active tenant.", async () => {
            const app = state.apps.find(a => a.id === appId);
            if(!app) return;
            
            await supabaseClient.from('apps').update({ status: 'Completed' }).eq('id', appId);
            const ownerId = localStorage.getItem('kozeyy_user_id');

            const existing = state.tenants.find(t => t.email === app.email);
            if(existing) {
                await supabaseClient.from('tenants').update({ status: 'Active', owner_id: ownerId }).eq('id', existing.id);
            } else {
                await supabaseClient.from('tenants').insert([{
                    name: app.name,
                    email: app.email,
                    rent_amount: app.rent,
                    status: 'Active',
                    owner_id: ownerId
                }]);
            }
            
            // SEND EMAIL (UPDATED - Uses 'welcome' template)
            if(app.email) {
                await sendEmail(
                    app.email, 
                    "Welcome to Kozeyy!", 
                    'welcome',
                    {
                        name: app.name,
                        link: "https://kozeyy.com/tenant.html"
                    }
                );
            }
            
            await fetchData();
            renderAll();
            showToast("Tenant finalized and Welcome email sent!");
        });
    }
    
   async function act_saveSettings(e) { 
        e.preventDefault(); 
        const ownerId = localStorage.getItem('kozeyy_user_id');
        const stripeId = document.getElementById('set-stripe-id').value;
        
        const { error } = await supabaseClient.from('settings').upsert({ 
            owner_id: ownerId, 
            stripe_connect_id: stripeId, 
            late_fee_enabled: document.getElementById('set-fee-active').checked,
            late_fee_method: document.getElementById('fee-method').value, 
            late_fee_amount: parseFloat(document.getElementById('fee-amount').value) || 0, 
            grace_period: parseInt(document.getElementById('fee-grace').value) || 0,     
            min_credit_score: parseInt(document.getElementById('set-min-score').value) || 600,
            min_income_ratio: parseFloat(document.getElementById('set-min-income').value) || 2.5,
            require_no_evictions: document.getElementById('set-no-evict').checked,
            require_no_criminal_history: document.getElementById('set-no-crim').checked,
            require_insurance: false
        }, { onConflict: 'owner_id' });
        
        if (error) { 
            showToast("Save Failed: " + error.message, 'error'); 
        } else { 
            // UPDATE: Retroactively enable payments for existing unpaid invoices
            if(stripeId && stripeId.trim() !== '') {
                await supabaseClient
                    .from('invoices')
                    .update({ landlord_stripe_id: stripeId })
                    .eq('owner_id', ownerId)
                    .eq('status', 'Unpaid')
                    .is('landlord_stripe_id', null);
            }

            showToast("Configuration Saved & Active Invoices Updated"); 
            await fetchData(); 
        }
    }
    function backToChatList() { if(window.innerWidth < 768) { document.getElementById('msg-view-panel').classList.add('hidden'); document.getElementById('msg-view-panel').classList.remove('flex'); document.getElementById('msg-list-panel').classList.remove('hidden'); } }

   function initChart(stats = {revenue:0, overdue:0}) { 
        const ctx = document.getElementById('revenueChart'); 
        if(!ctx) return; 
        
        // FIX: Update existing chart instead of destroying it
        if (chartInstance) {
            chartInstance.data.datasets[0].data = [stats.revenue, stats.outstanding, stats.overdue];
            chartInstance.update();
            return;
        }

        const context = ctx.getContext('2d'); 
        chartInstance = new Chart(context, { 
            type: 'bar', 
            data: { 
                labels: ['Collected', 'Outstanding', 'Overdue'], 
                datasets: [{ 
                    label: 'Financials', 
                    // Use the stats values passed in
                    data: [stats.revenue, stats.outstanding, stats.overdue], 
                    backgroundColor: ['#10b981', '#f59e0b', '#f43f5e'], 
                    borderRadius: 6 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } } 
            } 
        }); 
    }
    function renderMonthlyChart() { const ctx = document.getElementById('monthlyChart'); if(!ctx) return; const context = ctx.getContext('2d'); if(monthlyChartInstance) monthlyChartInstance.destroy(); const fin = getMonthlyFinancials(); monthlyChartInstance = new Chart(context, { type: 'bar', data: { labels: fin.labels, datasets: [ { label: 'Revenue', data: fin.revenue, backgroundColor: '#10b981' }, { label: 'Expenses', data: fin.expenses, backgroundColor: '#f43f5e' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { beginAtZero: true } } } }); }
    function getMonthlyFinancials() { const months = [], revenueData = [], expenseData = []; const today = new Date(); for(let i=5; i>=0; i--) { const d = new Date(today.getFullYear(), today.getMonth() - i, 1); const mKey = d.getMonth(); const yKey = d.getFullYear(); months.push(d.toLocaleString('default', { month: 'short' })); const monthRev = state.payments.reduce((sum, p) => { const pd = parseDateStr(p.date); return (pd.getMonth() === mKey && pd.getFullYear() === yKey) ? sum + p.amount : sum; }, 0); revenueData.push(monthRev); const monthExp = state.expenses.reduce((sum, e) => { const ed = parseDateStr(e.date); return (ed.getMonth() === mKey && ed.getFullYear() === yKey) ? sum + e.amount : sum; }, 0); expenseData.push(monthExp); } return { labels: months, revenue: revenueData, expenses: expenseData }; }

    function act_openPayModal(tenantId) { document.getElementById('pay-amount').value = ''; document.getElementById('pay-date').valueAsDate = new Date(); const sel = document.getElementById('pay-tenant-select'); if(tenantId) { document.getElementById('pay-tenant-id').value = tenantId; sel.classList.add('hidden-section'); } else { sel.classList.remove('hidden-section'); sel.innerHTML = '<option value="" disabled selected>Select Tenant</option>'; state.tenants.filter(t => t.status === 'Active').forEach(t => { sel.innerHTML += `<option value="${t.id}">${t.name}</option>`; }); document.getElementById('pay-tenant-id').value = ""; } openModal('modal-pay'); }
    
async function confirmPay() { 
        let tid = document.getElementById('pay-tenant-id').value; 
        const sel = document.getElementById('pay-tenant-select'); 
        const ownerId = localStorage.getItem('kozeyy_user_id'); 

        if(!sel.classList.contains('hidden-section') && sel.value) tid = sel.value; 
        tid = parseInt(tid); 
        let amt = parseFloat(document.getElementById('pay-amount').value); 
        
        if(tid && amt > 0 && ownerId) { 
            // 1. Insert Payment Record
            const { error } = await supabaseClient.from('payments').insert([{ 
                owner_id: ownerId,
                tenant_id: tid, 
                amount: amt, 
                date: document.getElementById('pay-date').value 
            }]);

            if (error) { 
                showToast("Payment Failed: " + error.message, 'error'); 
                return; 
            }

            // 2. Apply to Invoices (Existing Logic)
            const openInvoices = state.invoices
                .filter(i => i.tenant_id === tid && i.status !== 'Paid')
                .sort((a,b) => new Date(a.date) - new Date(b.date)); 
            
            let remainingAmt = amt;
            for(const inv of openInvoices) { 
                if (remainingAmt <= 0) break; 
                const due = inv.total - (inv.amount_paid || 0); 
                const pay = Math.min(remainingAmt, due); 
                const newPaid = (inv.amount_paid || 0) + pay; 
                const newStatus = newPaid >= inv.total ? 'Paid' : 'Unpaid'; 
                
                const updateData = { amount_paid: newPaid, status: newStatus };
                if (newStatus === 'Paid') updateData.paid_date = new Date().toISOString();

                await supabaseClient.from('invoices').update(updateData).eq('id', inv.id); 
                remainingAmt -= pay; 
            } 
            
            // 3. SEND RECEIPT EMAIL (UPDATED)
            const tenant = state.tenants.find(t => t.id === tid);
            if(tenant && tenant.email) {
                 await sendEmail(
                     tenant.email, 
                     "Rent Payment Receipt", 
                     'receipt', 
                     { 
                        name: tenant.name, 
                        amount: amt.toLocaleString(undefined, {minimumFractionDigits: 2}), 
                        date: new Date().toLocaleDateString(),
                        link: "https://kozeyy.com/tenant.html"
                     }
                 );
            }

            closeModal('modal-pay'); 
            await initSystem(); 
            showToast("Payment Recorded & Receipt Sent"); 
        } 
    }
    
    function populateFinFilter() { const sel = document.getElementById('filter-financials'); const currentVal = sel.value; sel.innerHTML = '<option value="all">All Tenants</option>'; state.tenants.filter(t => t.status !== 'Vacant').forEach(t => { sel.innerHTML += `<option value="${t.id}">${t.name}</option>`; }); sel.value = currentVal; }
    
   function renderFinancials() {
        const filterVal = document.getElementById('filter-financials').value;
        const tbody = document.getElementById('table-financials');
        const sumContainer = document.getElementById('fin-summary-container');
        const balanceDisplay = document.getElementById('fin-open-bal');

        tbody.innerHTML = '';
        let transactions = [];
        const s = state.settings || {};
        const globalGrace = parseInt(s.grace_period || 0);
        const globalFeeVal = parseFloat(s.late_fee_amount || 0);
        const globalFeeType = s.late_fee_method || 'Fixed';
        const now = new Date();

        // Gather Data
        state.invoices.forEach(inv => {
            if (filterVal === 'all' || inv.tenant_id == filterVal) {
                transactions.push({ type: 'invoice', data: inv, sortTime: new Date(inv.created_at).getTime(), displayDate: new Date(inv.date || inv.created_at).toLocaleDateString() });
            }
        });
        state.payments.forEach(pay => {
            if (filterVal === 'all' || pay.tenant_id == filterVal) {
                transactions.push({ type: 'payment', data: pay, sortTime: new Date(pay.created_at).getTime(), displayDate: new Date(pay.date || pay.created_at).toLocaleDateString() });
            }
        });

        transactions.sort((a, b) => b.sortTime - a.sortTime);
        let totalOutstandingDebt = 0;

        transactions.forEach(item => {
            const isInv = item.type === 'invoice';
            const record = item.data;
            const tenant = state.tenants.find(t => t.id == record.tenant_id) || { name: 'Unknown' };
            const dateStr = item.displayDate;
            let rowHtml = '';

            // Common classes for hidden columns on mobile
            const hiddenClass = "hidden md:table-cell";

            if (isInv) {
                // Debt Calculation
                const invDate = parseDateStr(record.date);
                const grace = record.grace_period !== undefined ? record.grace_period : globalGrace;
                const dueDate = new Date(invDate);
                dueDate.setDate(dueDate.getDate() + grace);
                const isOverdue = now > dueDate && record.status !== 'Paid';
                const baseBal = (record.total || 0) - (record.amount_paid || 0);
                let currentDebtOnThis = baseBal;
                if (isOverdue && baseBal > 0) {
                    const iFeeVal = record.fee_value !== undefined ? record.fee_value : globalFeeVal;
                    const iFeeType = record.fee_type || globalFeeType;
                    const fee = iFeeType === 'Percentage' ? record.total * (iFeeVal/100) : iFeeVal;
                    currentDebtOnThis += fee;
                }
                if (record.status !== 'Paid') totalOutstandingDebt += currentDebtOnThis;

                // UI Variables
                const statusLabel = record.status === 'Paid' ? 'Paid' : (isOverdue ? 'Overdue' : 'Unpaid');
                const statusColor = record.status === 'Paid' ? 'text-emerald-600 bg-emerald-50' : (isOverdue ? 'text-rose-600 bg-rose-50' : 'text-amber-600 bg-amber-50');
                const displayAmount = record.total; 
                const desc = (record.items && record.items[0]) ? record.items[0].desc : 'Invoice';
                
                // INVOICE ROW: Click triggers act_viewInvoice
                rowHtml = `
                <tr onclick="act_viewInvoice(${record.id})" class="hover:bg-slate-50 transition border-b border-slate-100 cursor-pointer active:bg-slate-100">
                    <td class="p-5 text-sm font-medium text-slate-500">${dateStr}</td>
                    <td class="p-5 text-sm font-bold text-slate-700">${tenant.name}</td>
                    <td class="p-5"><span class="px-2 py-1 rounded text-xs font-bold bg-indigo-50 text-indigo-600">INVOICE</span></td>
                    
                    <td class="p-5 text-sm text-slate-500 ${hiddenClass}">${desc}</td>
                    <td class="p-5 text-right font-bold text-slate-800 ${hiddenClass}">$${(displayAmount||0).toLocaleString()}</td>
                    <td class="p-5 text-right ${hiddenClass}"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${statusColor}">${statusLabel}</span></td>
                    <td class="p-5 text-right ${hiddenClass}"><button class="text-slate-400 hover:text-indigo-600"><i class="fas fa-eye"></i></button></td>
                </tr>`;
            } else {
                // PAYMENT ROW: Click triggers act_viewPayment
                rowHtml = `
                <tr onclick="act_viewPayment(${record.id})" class="hover:bg-slate-50 transition border-b border-slate-100 cursor-pointer active:bg-slate-100">
                    <td class="p-5 text-sm font-medium text-slate-500">${dateStr}</td>
                    <td class="p-5 text-sm font-bold text-slate-700">${tenant.name}</td>
                    <td class="p-5"><span class="px-2 py-1 rounded text-xs font-bold bg-emerald-50 text-emerald-600">PAYMENT</span></td>
                    
                    <td class="p-5 text-sm text-slate-400 italic ${hiddenClass}">Payment Received</td>
                    <td class="p-5 text-right font-bold text-emerald-600 ${hiddenClass}">+$${(record.amount||0).toLocaleString()}</td>
                    <td class="p-5 text-right text-xs text-slate-400 ${hiddenClass}">-</td>
                    <td class="p-5 text-right text-xs text-slate-400 ${hiddenClass}">-</td>
                </tr>`;
            }
            tbody.innerHTML += rowHtml;
        });

        balanceDisplay.innerText = `$${totalOutstandingDebt.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        sumContainer.classList.remove('hidden-section');
        if (transactions.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400 italic">No records found</td></tr>'; }
    }

    // New Helper Function for Mobile Payment Details
    function act_viewPayment(id) {
        const p = state.payments.find(x => x.id === id);
        if(!p) return;
        const tenant = state.tenants.find(t => t.id === p.tenant_id) || {name: 'Unknown'};
        
        setText('mp-date', new Date(p.date || p.created_at).toLocaleDateString());
        setText('mp-amount', `+$${p.amount.toLocaleString()}`);
        setText('mp-tenant', `From: ${tenant.name}`);
        
        openModal('modal-payment-view');
    }
    
   function openInvoiceModal() { 
        const s = document.getElementById('inv-tenant');
        s.innerHTML = '<option value="" disabled selected>Select a Tenant</option>';
        state.tenants.filter(t => t.status === 'Active').forEach(t => {
            s.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });

        document.getElementById('inv-step-input').classList.remove('hidden-section');
        document.getElementById('inv-step-preview').classList.add('hidden-section');
        document.getElementById('inv-actions-create').classList.remove('hidden-section');
        document.getElementById('inv-actions-create').classList.add('flex');
        document.getElementById('inv-actions-view').classList.add('hidden-section');
        
        setText('inv-modal-title', "Create Invoice");
        
        // UPDATE: Block past dates
        // NEW CODE (Fixes the date to your Local Time)
        const dateInput = document.getElementById('inv-date');
        const now = new Date();
        // Manually format YYYY-MM-DD in local time to avoid UTC shifts
        const localDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        
        dateInput.value = localDate;
        dateInput.min = localDate;

        openModal('modal-invoice');
        logic_invMode('fixed');
    }

  function act_viewInvoice(id) {
        const inv = state.invoices.find(i => i.id === id);
        if(!inv) return;

        // 1. Determine Dates & Grace Period
        // Use snapshot grace period if available, otherwise global default
        const grace = inv.grace_period !== undefined ? inv.grace_period : (parseInt(state.settings.grace_period || 0));
        const now = new Date();
        const invDate = parseDateStr(inv.date);
        const dueDate = new Date(invDate);
        dueDate.setDate(dueDate.getDate() + grace);
        
        // 2. Determine Overdue Status & Days
        const isOverdue = now > dueDate && inv.status !== 'Paid';
        let daysOverdue = 0;
        if(isOverdue) {
            const diffTime = Math.abs(now - dueDate);
            daysOverdue = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        }

        // 3. Calculate Fee using new logic (passing daysOverdue)
        const lateFee = calculateLateFee(inv.total, inv, daysOverdue);

        setText('prev-name', inv.tenant_name || 'Unknown');
        setText('prev-date', new Date(inv.date).toLocaleDateString());
        
        const currentBal = inv.total + (isOverdue ? lateFee : 0);
        setText('prev-total-due', `$${currentBal.toLocaleString(undefined, {minimumFractionDigits: 2})}`);
        setText('inv-modal-title', `Invoice #${inv.id}`);

        const tbody = document.getElementById('prev-items-body');
        tbody.innerHTML = '';
        (inv.items || []).forEach(item => {
            tbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0"><td class="py-2 text-slate-600">${item.desc}</td><td class="py-2 text-right font-medium text-slate-800">$${(item.amount||0).toLocaleString()}</td></tr>`;
        });
        
        // 4. Update the Label Logic for "Daily", "Percentage", or "Fixed"
        if (isOverdue && lateFee > 0) {
            const type = inv.fee_type || 'Fixed';
            const val = inv.fee_value || 0;
            
            let feeLabel = `Late Fee`;
            if (type === 'Percentage') feeLabel = `Late Fee (${val}%)`;
            if (type === 'Daily') feeLabel = `Late Fee ($${val}/day x ${daysOverdue} days)`;

            tbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0 text-rose-600 font-bold"><td class="py-2">${feeLabel}</td><td class="py-2 text-right">+$${lateFee.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
        }

        document.getElementById('inv-step-input').classList.add('hidden-section');
        document.getElementById('inv-step-preview').classList.remove('hidden-section');
        document.getElementById('inv-actions-create').classList.remove('flex');
        document.getElementById('inv-actions-create').classList.add('hidden-section');
        
        const viewActions = document.getElementById('inv-actions-view');
        viewActions.classList.remove('hidden-section');
        viewActions.innerHTML = `
            <div class="flex gap-2">
                <button onclick="downloadOwnerInvoicePDF('Invoice_${id}')" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-sm hover:bg-indigo-700">
                    <i class="fas fa-download mr-2"></i> Download PDF
                </button>
                <button onclick="closeModal('modal-invoice')" class="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold shadow hover:bg-slate-900">
                    Close
                </button>
            </div>
        `;

        openModal('modal-invoice');
    }
    function downloadOwnerInvoicePDF(filename) {
        const element = document.getElementById('invoice-download-area'); 
        const opt = {
            margin:       0.5,
            filename:     `${filename}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    function toggleRecurringOptions() {
        const checkbox = document.getElementById('inv-recurring');
        const isRecurring = checkbox.checked;
        const opts = document.getElementById('inv-recurring-opts');
        const dateInput = document.getElementById('inv-date');
        const statusEl = document.getElementById('inv-recur-status');
        
        // CASE 1: Turning OFF an existing recurring schedule
        // We check editingRecurringId OR if the logic knows a schedule exists
        if (!isRecurring && editingRecurringId) {
            // 1. Visually revert immediately so it doesn't look "Off" until confirmed
            checkbox.checked = true;

            // 2. Trigger Platform Confirm
            openPlatformConfirm(
                "Stop Recurring Billing?", 
                "This will cancel future automatic invoices for this tenant.",
                async () => {
                    try {
                        // 3. Update DB
                        const { error } = await supabaseClient
                            .from('recurring_invoices')
                            .update({ active: false })
                            .eq('id', editingRecurringId);
                        
                        if(error) throw error;
                        
                        showToast("Recurring billing stopped.");
                        
                        // 4. Update UI State to reflect "Stopped"
                        editingRecurringId = null; 
                        checkbox.checked = false; // Now uncheck for real
                        opts.classList.add('hidden-section');
                        
                        // 5. Reset Date Input to Today (Fix for Issue #3)
                        dateInput.disabled = false;
                        dateInput.parentElement.classList.remove('opacity-50');
                        dateInput.value = new Date().toISOString().split('T')[0];
                        
                        // 6. Clear "Next Scheduled" text (Fix for Issue #3 & #4)
                        if(statusEl) {
                            statusEl.innerText = "";
                            statusEl.classList.add('hidden-section');
                        }
                        document.getElementById('inv-recur-next').innerText = "...";

                        // 7. Refresh Data to persist state
                        await fetchData();
                        
                    } catch(err) {
                        console.error(err);
                        showToast("Error: " + err.message, "error");
                        // Revert checkbox if error
                        checkbox.checked = true; 
                    }
                }
            );
            return; 
        }

        // CASE 2: Standard Toggle (Creating New or Viewing)
        if (isRecurring) {
            opts.classList.remove('hidden-section');
            dateInput.disabled = true;
            dateInput.parentElement.classList.add('opacity-50');
            
            if(editingRecurringId && state.recurring_invoices) {
                const existing = state.recurring_invoices.find(r => r.id === editingRecurringId);
                if(existing) {
                    document.getElementById('inv-recur-day').value = existing.day;
                    document.getElementById('inv-recur-end').value = existing.end_date || '';
                }
            } else {
                if(!document.getElementById('inv-recur-day').value) document.getElementById('inv-recur-day').value = 1;
            }
            updateNextDate();

        } else {
            // Unchecked (Clean slate / New Invoice)
            opts.classList.add('hidden-section');
            dateInput.disabled = false;
            dateInput.parentElement.classList.remove('opacity-50');
            dateInput.value = new Date().toISOString().split('T')[0]; // Ensure fresh date
            
            if(statusEl) statusEl.classList.add('hidden-section');
            document.getElementById('inv-recur-next').innerText = "...";
        }
    }
// FIX #4: Visual Countersigning Flow
    function act_openCountersign(appId) {
        currentAppId = appId;
        const app = state.apps.find(a => a.id === appId);
        
        // Close detail modal, open Platform Confirm styled as a Lease Review
        closeModal('modal-screening-detail');
        
        // We use the Platform Confirm modal but inject custom HTML for the "Signature" experience
        const confirmModal = document.getElementById('modal-platform-confirm');
        const contentDiv = confirmModal.querySelector('div'); // The white box
        
        // Temporarily store original content to restore later if needed (optional, or just hardcode restore)
        
        contentDiv.innerHTML = `
            <div class="text-left">
                <div class="flex items-center justify-between mb-4 border-b pb-2">
                    <h3 class="text-xl font-bold brand-font">Lease Finalization</h3>
                    <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold">Signed by Tenant</span>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 h-64 overflow-y-auto mb-4 text-xs text-slate-600 font-serif leading-relaxed relative">
                    <p class="mb-4 text-center font-bold text-sm">RESIDENTIAL LEASE AGREEMENT</p>
                    <p>This agreement is made between <strong>${document.getElementById('owner-name-display').innerText}</strong> (Landlord) and <strong>${app.name}</strong> (Tenant) for the property at ${app.rent_addr || 'the premise'}.</p>
                    <p class="mt-2">Monthly Rent: $${app.rent}</p>
                    <p class="mt-4">... [Lease Terms Redacted for Preview] ...</p>
                    
                    <div class="mt-8 border-t border-slate-300 pt-4 flex justify-between items-end">
                        <div>
                            <p class="font-dancing text-xl text-blue-900">${app.name}</p>
                            <p class="border-t border-slate-400 w-32 mt-1"></p>
                            <p class="text-[10px] uppercase">Tenant Signature</p>
                            <p class="text-[10px] text-slate-400">${new Date().toLocaleDateString()}</p>
                        </div>
                        
                        <div id="landlord-sig-area" class="cursor-pointer hover:bg-indigo-50 p-2 rounded transition" onclick="applyLandlordSig()">
                            <p class="text-indigo-600 font-bold text-sm" id="click-sign-prompt"><i class="fas fa-pen mr-1"></i> Click to Sign</p>
                            <div id="real-sig" class="hidden-section">
                                <p class="font-dancing text-xl text-indigo-900 font-bold">Approved</p>
                                <p class="border-t border-slate-400 w-32 mt-1"></p>
                                <p class="text-[10px] uppercase">Landlord Signature</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="window.location.reload()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">Cancel</button>
                    <button id="btn-finalize-lease" disabled onclick="processLeaseFinalization()" class="flex-1 py-3 bg-slate-300 text-white rounded-xl font-bold text-sm transition">Finalize Lease</button>
                </div>
            </div>
        `;
        
        confirmModal.classList.remove('hidden-section');
        confirmModal.classList.add('flex');
    }

    function applyLandlordSig() {
        document.getElementById('click-sign-prompt').classList.add('hidden-section');
        document.getElementById('real-sig').classList.remove('hidden-section');
        
        const btn = document.getElementById('btn-finalize-lease');
        btn.disabled = false;
        btn.classList.remove('bg-slate-300');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'shadow-lg');
    }

    async function processLeaseFinalization() {
        // Trigger the existing finalize logic but from this new UI
        const app = state.apps.find(a => a.id === currentAppId);
        if(!app) return;
        
        const btn = document.getElementById('btn-finalize-lease');
        btn.innerText = "Processing...";
        
        await supabaseClient.from('apps').update({ status: 'Completed' }).eq('id', currentAppId);
        const ownerId = localStorage.getItem('kozeyy_user_id');

        // Create/Update Tenant Record
        const existing = state.tenants.find(t => t.email === app.email);
        if(existing) {
            await supabaseClient.from('tenants').update({ status: 'Active', owner_id: ownerId }).eq('id', existing.id);
        } else {
            await supabaseClient.from('tenants').insert([{
                name: app.name,
                email: app.email,
                rent_amount: app.rent,
                status: 'Active',
                owner_id: ownerId
            }]);
        }
        
        // Send Welcome Email
        await sendEmail(app.email, "Welcome to Kozeyy!", 'welcome', { name: app.name, link: "https://kozeyy.com/tenant.html" });
        
        document.getElementById('modal-platform-confirm').classList.add('hidden-section');
        document.getElementById('modal-platform-confirm').classList.remove('flex');
        
        await fetchData();
        renderAll();
        showToast("Lease Countersigned & Tenant Activated!");
        
        // Restore default modal HTML (Clean up) for next time
        setTimeout(() => window.location.reload(), 1500); // Simple reload to reset the modal HTML structure cleanly
    }
    
   function logic_invMode(m) { 
        invMode = m; 
        
        // 1. Update Buttons Visuals
        document.getElementById('btn-fixed').className = m==='fixed' ? "flex-1 py-2 rounded-md font-bold text-sm bg-white shadow text-emerald-700 border" : "flex-1 py-2 rounded-md font-bold text-sm text-slate-500"; 
        document.getElementById('btn-variable').className = m==='variable' ? "flex-1 py-2 rounded-md font-bold text-sm bg-white shadow text-indigo-700 border" : "flex-1 py-2 rounded-md font-bold text-sm text-slate-500"; 
        
        // 2. Show/Hide "Add Item" button
        document.getElementById('btn-add-row').classList.toggle('hidden-section', m==='fixed'); 
        
        // 3. SAFETY CHECK: Disable Recurring for Variable
        const recurWrapper = document.getElementById('inv-recurring-wrapper');
        const recurInput = document.getElementById('inv-recurring');
        
        if (m === 'variable') {
            recurInput.checked = false;    // Force uncheck
            recurInput.disabled = true;    // Prevent clicking
            recurWrapper.classList.add('opacity-50', 'pointer-events-none'); // Visual feedback
        } else {
            recurInput.disabled = false;   // Re-enable
            recurWrapper.classList.remove('opacity-50', 'pointer-events-none');
        }
        
        // Ensure options hide if we just forced it unchecked
        toggleRecurringOptions();
        
        // 4. Reset Items
        logic_resetInvoice(); 
    }
function logic_resetInvoice() { 
        const tid = document.getElementById('inv-tenant').value; 
        
        // 1. Standard Reset (Rent Items)
        invItems = []; 
        if (tid && invMode === 'fixed') { 
            const t = state.tenants.find(x => x.id == tid); 
            if (t) invItems = [{ desc: 'Monthly Rent', amount: parseFloat(t.rent_amount || 0) }]; 
        } else if (invMode === 'variable') logic_addRow(); 
        renderInvItems(); 

        // 2. RECURRING LOGIC
        editingRecurringId = null;
        const statusEl = document.getElementById('inv-recur-status');
        const checkbox = document.getElementById('inv-recurring');
        
        // Reset defaults (Start hidden and unchecked)
        if(statusEl) statusEl.classList.add('hidden-section');
        checkbox.checked = false; 
        
        // 3. Check for Existing Schedule
        if(tid && state.recurring_invoices) {
            const existing = state.recurring_invoices.find(r => r.tenant_id == tid && r.active);
            
            if(existing) {
                editingRecurringId = existing.id; 
                
                // A. Auto-Turn ON the Toggle
                // Only for Fixed mode, as variable doesn't support recurring in this logic
                if (invMode === 'fixed') {
                    checkbox.checked = true;
                }

                // B. Calculate the exact Next Scheduled Date
                const dayInput = parseInt(existing.day) || 1;
                const now = new Date();
                let nextRun = new Date(now.getFullYear(), now.getMonth(), dayInput);
                
                // If today is past the scheduled day (or is today), move to next month
                // Note: Cron usually runs early morning. If it's the same day, we assume it runs next month
                if (now.getDate() >= dayInput) {
                    nextRun.setMonth(nextRun.getMonth() + 1);
                }
                
                const dateStr = nextRun.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });

                // C. Update the Label to show specific date
                if(statusEl) {
                    statusEl.innerText = `(Next Scheduled: ${dateStr})`;
                    statusEl.classList.remove('hidden-section');
                }
            }
        }

        // 4. SYNC UI 
        // This ensures the input fields appear immediately because we set checked = true above
        toggleRecurringOptions(); 
    }

    function updateNextDate() {
        const dayInput = parseInt(document.getElementById('inv-recur-day').value) || 1;
        const now = new Date();
        let nextRun = new Date(now.getFullYear(), now.getMonth(), dayInput);

        // Logic: If today is the 15th and they pick the 5th, send NEXT month.
        if (now.getDate() >= dayInput) {
            nextRun.setMonth(nextRun.getMonth() + 1);
        }

        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById('inv-recur-next').innerText = nextRun.toLocaleDateString(undefined, options);
    }
    
    function logic_addRow() { invItems.push({desc:'', amount:0}); renderInvItems(); }
    function logic_delRow(idx) { invItems.splice(idx, 1); renderInvItems(); }
    function renderInvItems() { const c = document.getElementById('inv-items-container'); c.innerHTML=''; invItems.forEach((r,i) => { const ro = invMode==='fixed'?'readonly':''; const delBtn = invMode!=='fixed' ? `<button type="button" onclick="logic_delRow(${i})" class="text-red-400 px-2"><i class="fas fa-times"></i></button>` : ''; c.innerHTML += `<div class="flex gap-2 mb-2"><input class="flex-grow border p-2 rounded text-sm bg-white" value="${r.desc}" oninput="updateInvItem(${i}, 'desc', this.value)" placeholder="Description" ${ro}><input class="w-24 border p-2 rounded text-sm text-right bg-white" type="number" value="${r.amount}" oninput="updateInvItem(${i}, 'amount', this.value)" placeholder="$" ${ro}>${delBtn}</div>`; }); }
    function updateInvItem(idx, key, val) { invItems[idx][key] = key === 'amount' ? (parseFloat(val) || 0) : val; }
    
    function logic_generatePreview() { 
        const tidSelect = document.getElementById('inv-tenant').value; 
        if(!tidSelect) return showToast("Please select a tenant", 'error'); 
        
        const tenant = state.tenants.find(t => t.id == tidSelect); 
        const dateStr = document.getElementById('inv-date').value; 
        if(!dateStr) return showToast("Please select a date", 'error');

        // 1. Calculate Base Total from Line Items
        const baseTotal = invItems.reduce((a,b)=>a+(b.amount||0),0); 
        
        // 2. PREVIEW LOGIC: Calculate Potential Late Fee
        // We assume the settings currently in the state will be applied to this invoice
        const s = state.settings || {};
        const mockInvForCalc = {
            fee_type: s.late_fee_method || 'Fixed',
            fee_value: parseFloat(s.late_fee_amount) || 0
        };
        
        const lateFee = calculateLateFee(baseTotal, mockInvForCalc);
        const grace = parseInt(s.grace_period || 0);
        
        // Check if the drafted "Send On" date is already overdue
        const now = new Date();
        const draftDate = parseDateStr(dateStr);
        const dueDate = new Date(draftDate);
        dueDate.setDate(dueDate.getDate() + grace);
        
        // If today > (Draft Date + Grace), show the fee in the preview
        const isOverdue = now > dueDate;
        const displayTotal = baseTotal + (isOverdue ? lateFee : 0);

        // 3. Save Draft State
        draftInvoice = { 
            tenantId: parseInt(tidSelect), 
            tenantName: tenant.name, 
            items: JSON.parse(JSON.stringify(invItems)), 
            total: baseTotal, // IMPORTANT: We still only save the BASE total to DB
            date: dateStr 
        }; 
        
        setText('prev-name', tenant.name); 
        setText('prev-date', new Date(dateStr).toLocaleDateString()); 
        setText('prev-total-due', `$${displayTotal.toLocaleString()}`); // Show Grand Total with Fee
        
        const tbody = document.getElementById('prev-items-body'); 
        tbody.innerHTML = ''; 
        
        // Render Standard Items
        invItems.forEach(i => { 
            tbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0"><td class="py-2">${i.desc}</td><td class="py-2 text-right font-medium">$${i.amount.toLocaleString()}</td></tr>`; 
        }); 
        
        // Render Late Fee Row (if overdue)
        if(isOverdue) {
            const feeLabel = mockInvForCalc.fee_type === 'Percentage' 
                ? `Late Fee (${mockInvForCalc.fee_value}%)` 
                : `Late Fee`;
            
            tbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0 text-rose-600 font-bold"><td class="py-2">${feeLabel} <span class="text-xs font-normal text-rose-400 ml-1">(Est.)</span></td><td class="py-2 text-right">+$${lateFee.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
        }
        
        document.getElementById('inv-step-input').classList.add('hidden-section'); 
        document.getElementById('inv-step-preview').classList.remove('hidden-section'); 
        setText('inv-modal-title',"Review Invoice"); 
    }

    function logic_backToInput() { document.getElementById('inv-step-input').classList.remove('hidden-section'); document.getElementById('inv-step-preview').classList.add('hidden-section'); setText('inv-modal-title',"Create Invoice"); }
    
   // Track the ID if we are editing an existing one
    let editingRecurringId = null; 

    async function logic_confirmInvoice() { 
        if(!draftInvoice) return; 
        
        const btn = document.getElementById('btn-confirm-inv');
        const originalText = btn.innerText; 
        btn.disabled = true; 
        btn.innerText = "Processing...";

        try {
            const ownerId = localStorage.getItem('kozeyy_user_id');
            const settings = state.settings || {};
            const isRecurring = document.getElementById('inv-recurring').checked;

            const file = document.getElementById('inv-doc').files[0]; 
            let docUrl = null; 
            if (file) docUrl = await uploadFile(file, 'invoices'); 

            if (isRecurring) {
                // --- PATH A: SAVE/UPDATE RECURRING ---
                const recurDay = parseInt(document.getElementById('inv-recur-day').value) || 1;
                const recurEnd = document.getElementById('inv-recur-end').value || null;

                const recurData = {
                    owner_id: ownerId,
                    tenant_id: draftInvoice.tenantId,
                    amount: draftInvoice.total,
                    day: recurDay,
                    end_date: recurEnd,
                    doc_url: docUrl,
                    active: true
                };

                let error;
                if(editingRecurringId) {
                    // UPDATE existing
                    const res = await supabaseClient.from('recurring_invoices').update(recurData).eq('id', editingRecurringId);
                    error = res.error;
                    showToast("Recurring Schedule Updated");
                } else {
                    // INSERT new
                    const res = await supabaseClient.from('recurring_invoices').insert([recurData]);
                    error = res.error;
                    showToast("Recurring Invoice Scheduled");
                }
                
                if(error) throw error;

            } else {
                // --- PATH B: STANDARD ONE-TIME INVOICE ---
                const { error } = await supabaseClient.from('invoices').insert([{ 
                    owner_id: ownerId, 
                    tenant_id: draftInvoice.tenantId, 
                    tenant_name: draftInvoice.tenantName, 
                    items: draftInvoice.items, 
                    total: draftInvoice.total, 
                    date: draftInvoice.date, 
                    status: 'Unpaid', 
                    landlord_stripe_id: settings.stripe_connect_id || null, 
                    doc_url: docUrl,                         
                    fee_type: settings.late_fee_method || 'Fixed',
                    fee_value: parseFloat(settings.late_fee_amount) || 0,
                    grace_period: parseInt(settings.grace_period) || 0,
                    fee_enabled: settings.late_fee_enabled !== false
                }]); 

                if(error) throw error;
                showToast("Invoice Sent Successfully"); 
            }

            closeModal('modal-invoice'); 
            await initSystem(); 
            
        } catch(err) {
            console.error(err);
            showToast("Error: " + err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
    
    function updateFileName(inputId, labelId) { const input = document.getElementById(inputId); const label = document.getElementById(labelId); if(input.files && input.files[0]) { label.innerText = input.files[0].name; label.parentElement.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-200'); } else { label.innerText = inputId.includes('ex') ? 'Upload' : 'Choose File'; label.parentElement.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-200'); } }
    
    function updateFileCount() {
        const input = document.getElementById('l-img-file');
        const label = document.getElementById('l-file-count');
        if (input.files && input.files.length > 0) label.innerText = `${input.files.length} file(s) selected`;
        else label.innerText = '';
    }

    function populateExpenseModal() { const s = document.getElementById('ex-prop'); s.innerHTML = '<option disabled selected>Select Property</option>'; const props = new Set(); state.tenants.forEach(t => { if(t.address) props.add(t.address); }); state.listings.forEach(l => { if(l.address) props.add(l.address); }); props.forEach(p => s.innerHTML += `<option>${p}</option>`); }
    function populateExpFilter() { const s = document.getElementById('filter-expenses'); s.innerHTML = '<option value="all">All Properties</option>'; const props = new Set(); state.tenants.forEach(t => { if(t.address) props.add(t.address); }); state.listings.forEach(l => { if(l.address) props.add(l.address); }); props.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`); }
    
    function loadUserProfile() { 
        const savedProfile = localStorage.getItem('kozeyy_profile'); 
        if (savedProfile) { 
            const user = JSON.parse(savedProfile); 
            const nameDisplay = user.username ? user.username : (user.name || 'Owner'); 
            setText('owner-name-display', nameDisplay); 
            const initialBox = document.getElementById('owner-initials-display'); 
            if(initialBox) initialBox.innerText = user.initials || 'LL'; 
        } 
    }
function calculateLateFee(total, invoice, daysOverdue = 1) {
    // 1. Check if fees are enabled on this invoice
    // (We check strict false because old data might be null/undefined, defaulting to true)
    if (invoice.fee_enabled === false) return 0;

    const type = invoice.fee_type || 'Fixed'; 
    const value = parseFloat(invoice.fee_value || 0);

    if (type === 'Percentage') {
        return total * (value / 100);
    }
    if (type === 'Daily') {
        return value * daysOverdue;
    }
    return value; // Fixed
}

    function renderExpenses() {
        const filterVal = document.getElementById('filter-expenses').value;
        const tbody = document.getElementById('table-expenses');
        const totalDisplay = document.getElementById('exp-total-display');
        
        if(!tbody) return;

        tbody.innerHTML = '';
        let total = 0;

        state.expenses.forEach(e => {
            // Filter logic: 'all' or matches property address
            if(filterVal !== 'all' && e.property_address !== filterVal) return;

            total += (e.amount || 0);
            
            const date = e.date ? new Date(e.date).toLocaleDateString() : '-';
            const receiptHtml = e.receipt_url 
                ? `<a href="${e.receipt_url}" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-bold text-xs"><i class="fas fa-file-invoice mr-1"></i> View</a>` 
                : `<span class="text-slate-400 text-xs">-</span>`;

            tbody.innerHTML += `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                    <td class="p-5 text-sm font-medium text-slate-500">${date}</td>
                    <td class="p-5 text-sm font-bold text-slate-700 hidden md:table-cell">${e.property_address || '-'}</td>
                    <td class="p-5 text-sm text-slate-700">${e.vendor || '-'}</td>
                    <td class="p-5 text-sm text-slate-500 hidden md:table-cell"><span class="px-2 py-1 bg-slate-100 rounded text-xs">${e.category}</span></td>
                    <td class="p-5 text-right font-bold text-rose-600">-$${(e.amount||0).toLocaleString()}</td>
                    <td class="p-5 text-center hidden md:table-cell">${receiptHtml}</td>
                    <td class="p-5 text-right">
                        <button onclick="act_editExpense(${e.id})" class="text-slate-400 hover:text-indigo-600 mx-1"><i class="fas fa-edit"></i></button>
                        <button onclick="act_delExpense(${e.id})" class="text-slate-400 hover:text-rose-600 mx-1"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        if(state.expenses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400 italic">No expenses recorded</td></tr>';
        }
        
        if(totalDisplay) totalDisplay.innerText = `$${total.toLocaleString()}`;
    }
    
// --- EMAIL HELPER FUNCTION (Supabase Edge Function) ---
    async function sendEmail(to, subject, type, data) {
        if (!to || !to.includes('@')) {
            console.warn("Skipping email: Invalid address", to);
            return;
        }
        
        console.log(`Sending ${type} email to ${to}...`);
        
        try {
            const { data: result, error } = await supabaseClient.functions.invoke('send-email', {
                body: { to, subject, type, data }
            });

            if (error) throw error;
            console.log("Email sent successfully!", result);
        } catch (e) {
            console.error("Email failed:", e);
            showToast("Notification email failed to send", "error");
        }
    }

function signOut() {
        openPlatformConfirm(
            "Sign Out?", 
            "Are you sure you want to log out of your account?", 
            () => {
                localStorage.removeItem('kozeyy_user_id');
                window.location.href = 'login.html';
            }
        );
    }
    
    initSystem();
</script>
</body>
</html>






























































