<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Owner Dashboard | Kozeyy</title>
    <!-- Tailwind CSS for modern utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for professional iconography -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Inter for UI, Outfit for branding -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <!-- External Libraries for Charts, Backend, and PDF generation -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style> 
        .rotate-180 { transform: rotate(180deg); }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, h4, .brand-font { font-family: 'Outfit', sans-serif; }
        .sidebar-active { background-color: #312e81; border-left: 4px solid #6366f1; color: white !important; }
        .nav-item { color: #94a3b8; }
        .nav-item:hover { color: white; background-color: #312e81; }
        .hidden-section { display: none !important; }
        .fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        #mobile-overlay { background-color: rgba(0,0,0,0.5); }
        .paper-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.05); }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-left: 4px solid #6366f1; transform: translateX(100%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; min-width: 300px; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: #f43f5e; }
        .toast.success { border-left-color: #10b981; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50">

    <!-- Mobile Overlay for Sidebar Navigation -->
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 hidden transition-opacity backdrop-blur-sm md:hidden"></div>
    
    <!-- Container for dynamic notifications -->
    <div id="toast-container"></div>

    <!-- MAIN SIDEBAR NAVIGATION -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-indigo-950 flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:static shadow-xl">
        <div class="h-20 flex items-center justify-between px-6 border-b border-indigo-900 bg-indigo-950">
            <div class="flex items-center gap-3">
                <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                    <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                    <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
                </svg>
                <span class="text-xl font-bold text-white tracking-tight brand-font">Kozeyy</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="#" onclick="event.preventDefault(); navTo('dashboard')" id="link-dashboard" class="nav-item flex items-center justify-between px-6 py-3.5 transition sidebar-active">
                <div class="flex items-center"><i class="fas fa-th-large w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Dashboard</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('tenants')" id="link-tenants" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-users w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Tenants</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('listings')" id="link-listings" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-sign w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Listings</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('screening')" id="link-screening" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-user-check w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Screening</span></div>
                <span id="badge-screening" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('messages')" id="link-messages" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-comment-dots w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Messages</span></div>
                <span id="badge-messages" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('maintenance')" id="link-maintenance" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-tools w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Maintenance</span></div>
                <span id="badge-maintenance" class="hidden-section bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('financials')" id="link-financials" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-money-bill-wave w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Records</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('expenses')" id="link-expenses" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-receipt w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Expenses</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('reports')" id="link-reports" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-chart-pie w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Reports</span></div>
            </a>
            <a href="#" onclick="event.preventDefault(); navTo('settings')" id="link-settings" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-sliders-h w-5"></i> <span class="font-medium ml-3 text-sm brand-font">Settings</span></div>
            </a>
        </nav>
        
        <div class="p-6 border-t border-indigo-900 bg-indigo-950 flex flex-col gap-2">
            <button onclick="initSystem()" class="flex items-center text-xs text-indigo-300 hover:text-white transition"><i class="fas fa-sync-alt mr-2"></i> Refresh Data</button>
            <a href="login.html" class="flex items-center text-xs text-rose-300 hover:text-white transition"><i class="fas fa-sign-out-alt mr-2"></i> Sign Out</a>
        </div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <!-- Dashboard Header -->
        <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-10 sticky top-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-700 hover:text-indigo-600 focus:outline-none p-2 -ml-2 rounded-xl hover:bg-slate-50 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 class="text-xl md:text-xl font-bold text-slate-800 brand-font truncate" id="header-title">
                    <span class="md:hidden">Menu</span>
                    <span class="hidden md:inline" id="desktop-page-title">Portfolio Overview</span>
                </h2>
            </div>
            
            <div class="flex items-center gap-4 md:gap-6">
                <div class="flex items-center gap-3 md:pl-6 md:border-l border-slate-200">
                    <div class="text-right hidden md:block">
                        <!-- REQUIREMENT: Owner name in top right -->
                        <p class="text-sm font-bold text-slate-700 brand-font" id="owner-name-display">Loading...</p>
                        <p class="text-xs text-slate-500">Property Owner</p>
                    </div>
                    <div class="w-9 h-9 md:w-10 md:h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-md text-sm brand-font" id="owner-initials-display">LL</div>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Scroller -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 scroll-smooth pb-32" id="app-content">
            
            <!-- SECTION: DASHBOARD -->
            <div id="view-dashboard" class="view-section fade-in-up">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-8">
                    <div class="bg-gradient-to-br from-emerald-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-emerald-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-emerald-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-dollar-sign"></i></div><p class="text-emerald-800 text-[11px] font-bold uppercase tracking-wider brand-font">Revenue (This Month)</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-revenue">$0.00</h3></div>
                    </div>
                    <div class="bg-gradient-to-br from-rose-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-rose-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-rose-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-exclamation"></i></div><p class="text-rose-800 text-[11px] font-bold uppercase tracking-wider brand-font">Overdue</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-overdue">$0.00</h3></div>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-indigo-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-indigo-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-home"></i></div><p class="text-indigo-800 text-[11px] font-bold uppercase tracking-wider brand-font">Occupancy</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-occupancy">0%</h3></div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-50 to-white p-4 md:p-6 rounded-3xl shadow-sm border border-amber-100 flex flex-col justify-between h-36 relative overflow-hidden">
                        <div class="absolute -right-3 -top-3 w-16 h-16 bg-amber-100 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10"><div class="w-8 h-8 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-xs mb-2"><i class="fas fa-tools"></i></div><p class="text-amber-800 text-[11px] font-bold uppercase tracking-wider brand-font">Repairs</p><h3 class="text-2xl md:text-3xl font-extrabold text-slate-900 brand-font" id="dash-maintenance">0</h3></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- REQUIREMENT: Performance Charts -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-80">
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="font-bold text-lg text-slate-800 brand-font" id="chart-title">Portfolio Performance</h3>
                        </div>
                        <div class="h-64"><canvas id="revenueChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 brand-font">Quick Actions</h3>
                        <div class="space-y-3">
                            <button id="qa-tenant" onclick="openModal('modal-tenant')" class="w-full flex items-center justify-between p-4 bg-blue-50 text-blue-700 rounded-2xl hover:bg-blue-100 transition"><span class="font-bold text-sm brand-font">Add Tenant</span><i class="fas fa-user-plus bg-blue-200 p-2 rounded-full text-xs"></i></button>
                            <button id="qa-invoice" onclick="openInvoiceModal()" class="w-full flex items-center justify-between p-4 bg-emerald-50 text-emerald-700 rounded-2xl hover:bg-emerald-100 transition"><span class="font-bold text-sm brand-font">Create Invoice</span><i class="fas fa-plus bg-emerald-200 p-2 rounded-full text-xs"></i></button>
                            <button onclick="openModal('modal-listing')" class="w-full flex items-center justify-between p-4 bg-indigo-50 text-indigo-700 rounded-2xl hover:bg-indigo-100 transition"><span class="font-bold text-sm brand-font">Post Listing</span><i class="fas fa-home bg-indigo-200 p-2 rounded-full text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: TENANTS -->
            <div id="view-tenants" class="view-section hidden-section fade-in-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Directory</h3>
                    <div class="flex gap-2">
                        <select id="filter-tenant-status" onchange="renderAll()" class="border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white font-medium text-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="Active">Active Tenants</option>
                            <option value="Archived">Archived</option>
                            <option value="all">All Records</option>
                        </select>
                        <button onclick="openModal('modal-tenant')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-blue-700 brand-font">+ Add</button>
                    </div>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-x-auto w-full">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Tenant</th>
                                <th class="p-5 hidden md:table-cell">Address</th>
                                <th class="p-5 hidden md:table-cell">Unit</th>
                                <th class="p-5 hidden md:table-cell">Rent</th>
                                <th class="p-5">Status</th>
                                <th class="p-5 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-tenants" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: LISTINGS -->
            <div id="view-listings" class="view-section hidden-section fade-in-up">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 brand-font">Listings</h3><button onclick="openModal('modal-listing')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow hover:bg-indigo-700 brand-font">+ Post</button></div>
                <div id="grid-listings" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            </div>

            <!-- SECTION: SCREENING -->
            <div id="view-screening" class="view-section hidden-section fade-in-up">
                <h3 class="text-xl font-bold text-slate-800 brand-font mb-4">Applicant Queue</h3>
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-white text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Applicant</th>
                                <th class="p-5">Condition</th>
                                <th class="p-5">Status</th>
                                <th class="p-5 text-right">Action</th> 
                            </tr>
                        </thead>
                        <tbody id="table-screening" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: MESSAGES -->
            <div id="view-messages" class="view-section hidden-section fade-in-up h-[calc(100dvh-90px)]">
                <div class="flex h-full bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden relative">
                    <div id="msg-list-panel" class="w-full md:w-1/3 border-r border-slate-200 bg-slate-50 flex flex-col">
                        <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700 brand-font">Conversations</div>
                        <div id="list-chats" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    </div>
                    <div id="msg-view-panel" class="absolute inset-0 bg-white md:static w-full md:w-2/3 flex-col hidden md:flex z-20">
                        <div id="header-chat" class="p-4 border-b border-slate-200 bg-white font-bold text-slate-800 brand-font flex items-center gap-3">
                            <button onclick="backToChatList()" class="md:hidden text-slate-500 mr-2 p-2 rounded-full hover:bg-slate-100"><i class="fas fa-arrow-left"></i></button>
                            <span id="chat-title">Select a tenant</span>
                        </div>
                        <div id="box-chat" class="flex-1 p-4 md:p-6 overflow-y-auto bg-slate-50 space-y-4 custom-scroll pb-24 md:pb-6"></div>
                        <div class="p-4 border-t border-slate-200 bg-white flex gap-2 fixed bottom-0 left-0 right-0 md:static z-30 pb-[env(safe-area-inset-bottom,1.5rem)] md:pb-4">
                            <input type="text" id="input-chat" class="flex-1 border p-3 rounded-full outline-none focus:ring-2 focus:ring-indigo-500 text-sm font-medium" placeholder="Type a message...">
                            <button onclick="sendMsg()" class="bg-indigo-600 text-white w-12 h-12 rounded-full font-bold flex items-center justify-center shadow-lg hover:bg-indigo-700 transition"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: MAINTENANCE -->
            <div id="view-maintenance" class="view-section hidden-section fade-in-up">
                <h3 class="text-xl font-bold text-slate-800 mb-4 brand-font">Maintenance</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden"><div class="p-6 border-b bg-rose-50 border-rose-100"><h3 class="font-bold text-rose-800 brand-font">Active Requests</h3></div><div id="list-maint-active" class="divide-y divide-slate-100"></div></div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden"><div class="p-6 border-b bg-slate-50 border-slate-100"><h3 class="font-bold text-slate-700 brand-font">Service History</h3></div><div id="list-maint-history" class="divide-y divide-slate-100"></div></div>
                </div>
            </div>

            <!-- SECTION: FINANCIALS (RECORDS) -->
            <div id="view-financials" class="view-section hidden-section fade-in-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Payment Records</h3>
                    <div class="flex gap-2">
                        <button onclick="act_openPayModal(null)" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-blue-700 brand-font">+ Record Payment</button>
                        <button onclick="openInvoiceModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-emerald-700 brand-font">+ New Invoice</button>
                    </div>
                </div>

                <div id="fin-summary-container" class="mb-6 hidden-section">
                    <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm max-w-xs">
                        <p class="text-xs text-slate-500 font-bold uppercase">Portfolio Outstanding</p>
                        <h4 class="text-xl font-bold text-slate-800" id="fin-open-bal">$0.00</h4>
                    </div>
                </div>

                <div class="mb-4">
                    <select id="filter-financials" onchange="renderFinancials()" class="border p-2 rounded-lg text-sm bg-white"><option value="all">All Tenants</option></select>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font">
                            <tr>
                                <th class="p-5">Date</th>
                                <th class="p-5">Tenant</th>
                                <th class="p-5">Type</th>
                                <th class="p-5">Description</th>
                                <th class="p-5 text-right">Amount</th>
                                <th class="p-5 text-right">Status</th>
                                <th class="p-5 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-financials" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: EXPENSES -->
            <div id="view-expenses" class="view-section hidden-section fade-in-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h3 class="text-xl font-bold text-slate-800 brand-font">Business Expenses</h3>
                    <div class="flex gap-3 w-full md:w-auto">
                        <select id="filter-expenses" onchange="renderExpenses()" class="border border-slate-300 rounded-xl px-3 py-2 text-sm bg-white flex-1 md:flex-none font-medium text-slate-600"><option value="all">All Properties</option></select>
                        <div class="bg-rose-50 text-rose-700 px-4 py-2 rounded-xl font-bold border border-rose-200 text-sm flex-1 md:flex-none text-center brand-font">Total: <span id="exp-total-display">$0.00</span></div>
                        <button onclick="populateExpenseModal(); openModal('modal-expense')" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-rose-700 flex-none brand-font">+ Log Expense</button>
                    </div>
                </div>

             <div class="bg-white rounded-3xl shadow-sm border border-slate-200 w-full overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200 brand-font"><tr><th class="p-5">Date</th><th class="p-5">Property</th><th class="p-5">Vendor</th><th class="p-5">Category</th><th class="p-5 text-right">Amount</th><th class="p-5 text-center">Receipt</th><th class="p-5 text-right">Actions</th></tr></thead>
                        <tbody id="table-expenses" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: REPORTS -->
            <div id="view-reports" class="view-section hidden-section fade-in-up">
                <h3 class="text-xl font-bold text-slate-800 brand-font mb-6">Financial Intelligence</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- REQUIREMENT: Income Statement -->
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg text-slate-900 border-b pb-4 mb-4 brand-font">Income Statement (Year to Date)</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center"><span class="text-slate-600">Total Gross Income</span><span class="font-bold text-emerald-600 text-lg brand-font" id="report-income">$0.00</span></div>
                            <div class="flex justify-between items-center"><span class="text-slate-600">Total Operating Expenses</span><span class="font-bold text-rose-600 text-lg brand-font" id="report-expense">$0.00</span></div>
                            <div class="border-t pt-4 flex justify-between items-center mt-4"><span class="font-extrabold text-slate-800 brand-font">Net Operating Income (NOI)</span><span class="font-extrabold text-indigo-900 text-2xl brand-font" id="report-noi">$0.00</span></div>
                        </div>
                    </div>
                    <!-- REQUIREMENT: Monthly Breakdown -->
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-lg text-slate-900 mb-4 brand-font">Monthly Cashflow Breakdown</h4>
                        <div class="h-64"><canvas id="monthlyChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- SECTION: SETTINGS -->
            <div id="view-settings" class="view-section hidden-section fade-in-up">
                <div class="bg-white rounded-3xl shadow-lg border border-slate-200 p-8 max-w-3xl mx-auto">
                    <h3 class="text-2xl font-bold mb-8 brand-font">System Configuration</h3>
                    <form onsubmit="act_saveSettings(event)" class="space-y-6">
                        
                        <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-2 brand-font flex items-center gap-2"><i class="fab fa-stripe text-xl"></i> Payments Integration</h4>
                            <p class="text-xs text-indigo-700 mb-4">Enter your Stripe Connected Account ID to receive payments automatically from tenants.</p>
                            <div>
                                <label class="block text-xs font-bold text-indigo-800 uppercase mb-1">Stripe Account ID</label>
                                <input type="text" id="set-stripe-id" class="w-full border border-indigo-200 p-3 rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm" placeholder="acct_..." value="">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Late Fees Configuration</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">Fee Amount ($)</label><input type="number" id="fee-amount" class="w-full border p-3 rounded-xl bg-slate-50" value="50"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">Grace Period (Days)</label><input type="number" id="fee-grace" class="w-full border p-3 rounded-xl bg-slate-50" value="5"></div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="font-bold text-lg text-slate-800 mb-4 brand-font">Auto-Screening Criteria</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Min Credit Score</label><input type="number" id="set-min-score" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="e.g. 650"></div>
                                <div><label class="block text-sm font-bold text-slate-700 mb-2 brand-font">Min Income (Ratio x Rent)</label><input type="number" step="0.1" id="set-min-income" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="e.g. 3.0"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="set-no-evict" class="text-indigo-600 rounded"><span class="text-sm font-medium">Require No Evictions</span></label></div>
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="set-no-crim" class="text-indigo-600 rounded"><span class="text-sm font-medium">Require Clean Criminal Hist.</span></label></div>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg brand-font">Save System Configuration</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- UI MODALS: GLOBAL PLATFORM COMPONENTS -->

    <!-- Platform Confirm Modal -->
    <div id="modal-platform-confirm" class="hidden-section fixed inset-0 bg-slate-900/60 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mx-auto mb-4 text-xl">
                <i class="fas fa-question"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 text-slate-900" id="plat-conf-title">Confirm Action</h3>
            <p class="text-sm text-slate-500 mb-6" id="plat-conf-msg">Are you sure you want to proceed with this operation?</p>
            <div class="flex gap-3">
                <button onclick="closePlatformConfirm(false)" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold text-sm transition">Cancel</button>
                <button onclick="closePlatformConfirm(true)" class="flex-1 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Platform Prompt Modal -->
    <div id="modal-prompt" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="prompt-title">Input Required</h3>
            <input type="text" id="prompt-input" class="w-full border p-3 rounded-xl bg-slate-50 mb-4 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter value here...">
            <div class="flex gap-2">
                <button onclick="closePrompt(false)" class="flex-1 py-2 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold text-sm transition">Cancel</button>
                <button onclick="closePrompt(true)" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm transition">Submit</button>
            </div>
        </div>
    </div>

    <!-- Tenant Management Modal -->
    <div id="modal-tenant" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-tenant')" class="absolute top-4 right-4 text-gray-400 hover:text-slate-800"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="modal-tenant-title">Add New Tenant</h3>
            <form onsubmit="act_saveTenant(event)" class="space-y-4">
                <input type="hidden" id="t-id">
                <div class="grid grid-cols-2 gap-4">
                    <input id="t-name" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Full Name" required>
                    <input id="t-phone" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Phone Number">
                </div>
                <input id="t-email" type="email" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Email Address" required>
                <input id="t-addr" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Property Address (Street)">
                <div class="grid grid-cols-3 gap-4">
                    <input id="t-city" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="City">
                    <input id="t-state" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="State">
                    <input id="t-zip" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Zip Code">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input id="t-unit" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Unit / Suite #">
                    <input id="t-rent" type="number" class="w-full border p-3 rounded-xl bg-slate-50" placeholder="Rent Amount" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 ml-1">Lease Start Date</label><input type="date" id="t-start" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                    <div><label class="text-xs font-bold text-slate-500 ml-1">Lease End Date</label><input type="date" id="t-end" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">Account Status</label>
                    <select id="t-status" class="w-full border p-3 rounded-xl bg-slate-50">
                        <option value="Active">Active</option>
                        <option value="Vacant">Vacant</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold brand-font shadow-lg hover:bg-blue-700 transition" id="btn-save-tenant">Save Tenant Record</button>
            </form>
        </div>
    </div>

    <!-- Invoice Wizard Modal -->
    <div id="modal-invoice" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-invoice')" class="absolute top-4 right-4 text-gray-400 hover:text-slate-800 transition"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6 brand-font" id="inv-modal-title">Draft New Invoice</h3>
            
            <div id="inv-step-input">
                <form onsubmit="event.preventDefault(); logic_generatePreview();" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Select Resident</label>
                        <select id="inv-tenant" onchange="logic_resetInvoice()" class="w-full border p-3 rounded-xl bg-slate-50 font-medium" required>
                            <option value="" disabled selected>Choose a Tenant...</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2 p-1 bg-slate-100 rounded-xl">
                        <button type="button" onclick="logic_invMode('fixed')" id="btn-fixed" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-emerald-700">Monthly Rent (Fixed)</button>
                        <button type="button" onclick="logic_invMode('variable')" id="btn-variable" class="flex-1 py-2 rounded-lg font-bold text-sm text-slate-500">Custom / Variable</button>
                    </div>

                    <!-- REQUIREMENT: Recurring Invoices Logic -->
                    <div id="recurring-section" class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-bold text-indigo-900">Enable Recurring Billing?</label>
                            <input type="checkbox" id="inv-is-recurring" onchange="logic_toggleRecurring()" class="w-5 h-5 accent-indigo-600 rounded">
                        </div>
                        <div id="recurring-dates" class="hidden-section grid grid-cols-2 gap-3 pt-2">
                            <div>
                                <label class="text-[10px] font-bold text-indigo-400 uppercase">First Invoice Date</label>
                                <input type="date" id="inv-rec-start" class="w-full border p-2 rounded-lg text-sm bg-white">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-indigo-400 uppercase">Final End Date</label>
                                <input type="date" id="inv-rec-end" class="w-full border p-2 rounded-lg text-sm bg-white">
                            </div>
                        </div>
                        <p class="text-[10px] text-indigo-400 italic">When active, an invoice will be generated on this day every month.</p>
                    </div>
                    
                    <div id="inv-items-container" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
                    <button type="button" id="btn-add-row" onclick="logic_addRow()" class="hidden-section w-full border border-dashed border-slate-300 text-slate-500 py-2.5 rounded-xl text-sm hover:bg-slate-50 transition">+ Add Item Line</button>
                    
                    <div id="send-on-section">
                        <!-- REQUIREMENT: Send invoice on specific date -->
                        <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Send Invoice On</label>
                        <input type="date" id="inv-date" required class="w-full border p-3 rounded-xl bg-slate-50 outline-none">
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold brand-font hover:bg-indigo-700 transition shadow-lg">Generate Preview & Verify</button>
                </form>
            </div>

            <div id="inv-step-preview" class="hidden-section">
                <!-- Target Area for HTML2PDF High Res Export -->
                <div id="invoice-download-container" class="bg-white border border-slate-200 rounded-xl p-8 mb-6 paper-shadow relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-indigo-600"></div>
                    <div class="flex justify-between items-start mb-10">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 brand-font tracking-tight">INVOICE</h2>
                            <p class="text-xs text-slate-400 mt-2 font-medium">Kozeyy Real Estate Portfolio Management</p>
                        </div>
                        <div class="text-right">
                            <!-- REQUIREMENT: Date must match send date -->
                            <p class="text-sm font-bold text-slate-700" id="prev-date">---</p>
                            <p class="text-xs text-slate-500 mt-1 uppercase tracking-tighter">Bill To:</p>
                            <p class="text-sm font-extrabold text-slate-800" id="prev-name">---</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-400 uppercase border-b border-slate-100">
                                <tr><th class="py-4 font-bold">Line Description</th><th class="py-4 text-right font-bold">Amount</th></tr>
                            </thead>
                            <tbody id="prev-items-body" class="text-slate-700 divide-y divide-slate-50"></tbody>
                        </table>
                        <div class="flex justify-end pt-6 border-t border-slate-100">
                            <div class="bg-slate-50 px-8 py-5 rounded-2xl border border-slate-100 min-w-[180px] text-right">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Total Balance Due</p>
                                <p class="text-2xl font-black text-slate-900 brand-font" id="prev-total-due">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="inv-actions-create" class="flex gap-3">
                    <button onclick="logic_backToInput()" class="flex-1 py-3.5 border border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition">Go Back</button>
                    <button onclick="logic_confirmInvoice()" id="btn-confirm-inv" class="flex-1 py-3.5 bg-emerald-600 text-white rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">Confirm & Dispatch</button>
                </div>
                
                <div id="inv-actions-view" class="hidden-section">
                    <!-- REQUIREMENT: Download by PDF -->
                    <button onclick="downloadOwnerInvoicePDF()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-xl hover:bg-indigo-700 mb-3 transition">
                        <i class="fas fa-file-pdf mr-2"></i> Download as PDF Document
                    </button>
                    <button onclick="closeModal('modal-invoice')" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold shadow hover:bg-slate-900 transition">Close Viewer</button>
                </div>
            </div>
        </div>
    </div>
    <script>
    // --- DATABASE & PLATFORM CONFIGURATION ---
    const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
    
    let supabaseClient = null;
    try {
        if(window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
    } catch(e) {
        console.error("Supabase library initialization failure:", e);
    }

    // --- APPLICATION STATE CONTAINER ---
    let state = {
        tenants: [], 
        listings: [], 
        invoices: [], 
        payments: [], 
        expenses: [],
        apps: [], 
        msgs: [], 
        maint: [], 
        settings: {}, 
        notifications: { messages: 0, maintenance: 0, screening: 0 }
    };
    
    // Persistent View and Session Tracking
    let viewedMaintIds = new Set(JSON.parse(localStorage.getItem('kozeyy_viewed_maint') || '[]').map(String));
    let viewedAppIds = new Set(JSON.parse(localStorage.getItem('kozeyy_viewed_apps') || '[]').map(String));
    let locallyReadMsgIds = new Set(JSON.parse(localStorage.getItem('kozeyy_read_msgs') || '[]').map(String));
    let activeTab = 'dashboard';

    // UI state trackers
    let chartInstance = null, 
        monthlyChartInstance = null, 
        currentChatId = null, 
        invMode = 'fixed', 
        invItems = [], 
        editTenantId = null, 
        editListingId = null, 
        draftInvoice = null, 
        promptCallback = null, 
        platformConfirmCallback = null;

    // --- HELPER FUNCTIONS ---

    /**
     * REQUIREMENT 2: MATCHING DATES EXACTLY
     * Fixes timezone shift bug where Date objects default to UTC and show the "day before" in local display.
     */
    function parseLocalDate(str) {
        if(!str) return new Date();
        const parts = str.split('-');
        // Creates date using local timezone constructor (Y, M-1, D)
        return new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0);
    }

    function formatDisplayDate(str) {
        if(!str) return '-';
        const dateObj = parseLocalDate(str);
        return dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function setText(id, text) { 
        const el = document.getElementById(id); 
        if(el && el.innerText !== text) el.innerText = text; 
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? '<i class="fas fa-check-circle text-emerald-500 text-xl"></i>' : '<i class="fas fa-exclamation-circle text-rose-500 text-xl"></i>';
        toast.innerHTML = `${icon}<span class="font-bold text-sm text-slate-700">${message}</span>`;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // --- DATA HANDLING & FETCHING ---

    async function initSystem() {
        try {
            await fetchData();
            renderAll();
            loadUserProfile(); // Sync owner name and initials
            
            // Background polling loop
            setInterval(async () => { 
                await fetchData(); 
                renderAll(); 
            }, 6000);
        } catch (err) { 
            console.error("Portfolio init error:", err); 
        }
    }

    async function fetchData() {
        const ownerId = localStorage.getItem('kozeyy_user_id');
        if(!ownerId) { window.location.href = 'login.html'; return; }

        const [t, l, i, p, e, m, msg, s, a] = await Promise.all([
            supabaseClient.from('tenants').select('*').eq('owner_id', ownerId),
            supabaseClient.from('listings').select('*').eq('owner_id', ownerId),
            supabaseClient.from('invoices').select('*').eq('owner_id', ownerId),
            supabaseClient.from('payments').select('*'),
            supabaseClient.from('expenses').select('*').eq('owner_id', ownerId),
            supabaseClient.from('maintenance').select('*'),
            supabaseClient.from('msgs').select('*'),
            supabaseClient.from('settings').select('*').eq('owner_id', ownerId).maybeSingle(),
            supabaseClient.from('apps').select('*').eq('owner_id', ownerId)
        ]);

        state.tenants = t.data || [];
        state.listings = l.data || [];
        state.expenses = e.data || [];
        state.settings = s.data || {};
        state.apps = a.data || [];
        
        const myTenantIds = new Set(state.tenants.map(tn => tn.id));
        state.invoices = (i.data || []).filter(x => myTenantIds.has(x.tenant_id));
        state.payments = (p.data || []).filter(x => myTenantIds.has(x.tenant_id));
        state.maint = (m.data || []).filter(x => myTenantIds.has(x.tenant_id));
        state.msgs = (msg.data || []).filter(x => myTenantIds.has(x.tenant_id));
        
        // Notification counts for unread/new data
        state.notifications.messages = state.msgs.filter(x => x.from === 'Tenant' && !x.read_at).length;
        state.notifications.maintenance = state.maint.filter(x => x.status === 'Active' && !viewedMaintIds.has(String(x.id))).length;
        state.notifications.screening = state.apps.filter(x => x.status === 'Pending' && !viewedAppIds.has(String(x.id))).length;
    }

    // --- REQUIREMENT 3: LATE FEE LOGIC ---

    function calculateGlobalStats() {
        let revenue = 0, overdue = 0;
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const lateFee = parseFloat(state.settings.late_fee_amount || 0);
        const grace = parseInt(state.settings.grace_period || 0);

        // Revenue tracking
        state.payments.forEach(pay => { 
            const payDate = parseLocalDate(pay.date); 
            if(payDate.getMonth() === currentMonth && payDate.getFullYear() === currentYear) {
                revenue += pay.amount; 
            }
        });

        // Overdue tracking with grace period logic
        state.invoices.forEach(inv => { 
            const invDate = parseLocalDate(inv.date);
            // REQUIREMENT 3: If scheduled in future, don't count as overdue/dash stat
            if(invDate > now) return;

            if(inv.status !== 'Paid') { 
                const dueDate = new Date(invDate);
                dueDate.setDate(dueDate.getDate() + grace);
                
                let balance = inv.total - (inv.amount_paid || 0);
                if (now > dueDate) {
                    balance += lateFee; // Apply late fee from settings
                }
                
                if(balance > 0) overdue += balance; 
            } 
        });
        return { revenue, overdue };
    }

    // --- RENDERING HANDLERS ---

    function renderAll() {
        const stats = calculateGlobalStats();
        setText('dash-revenue', `$${stats.revenue.toLocaleString()}`);
        setText('dash-overdue', `$${stats.overdue.toLocaleString()}`);
        setText('dash-occupancy', state.tenants.length > 0 ? `${Math.round((state.tenants.filter(t=>t.status==='Active').length / state.tenants.length)*100)}%` : '0%');
        setText('dash-maintenance', state.maint.filter(m=>m.status==='Active').length);

        initPerformanceChart(stats);
        renderTenants();
        renderFinancials();
        renderListings();
        renderScreening();
        renderMaint();
        renderExpenses();
        renderReports();
        
        updateBadge('messages', state.notifications.messages); 
        updateBadge('maintenance', state.notifications.maintenance); 
        updateBadge('screening', state.notifications.screening);
    }

    /**
     * REQUIREMENT: Performance Charts
     */
    function initPerformanceChart(stats) {
        const ctx = document.getElementById('revenueChart');
        if(!ctx) return;
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: ['Revenue (Curr. Mo)', 'Portfolio Overdue'], 
                datasets: [{ 
                    label: 'Portfolio Value', 
                    data: [stats.revenue, stats.overdue], 
                    backgroundColor: ['#10b981', '#f43f5e'], 
                    borderRadius: 12 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toLocaleString() } } }
            }
        });
    }

    /**
     * REQUIREMENT: Monthly Cashflow Breakdown Chart
     */
    function renderMonthlyChart() {
        const ctx = document.getElementById('monthlyChart');
        if(!ctx) return;
        if(monthlyChartInstance) monthlyChartInstance.destroy();

        const labels = [], revenueData = [], expenseData = [];
        const today = new Date();
        for(let i=5; i>=0; i--) {
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            labels.push(d.toLocaleString('default', { month: 'short' }));
            
            const monthRev = state.payments.filter(p => {
                const pd = parseLocalDate(p.date);
                return pd.getMonth() === d.getMonth() && pd.getFullYear() === d.getFullYear();
            }).reduce((sum, p) => sum + p.amount, 0);
            revenueData.push(monthRev);

            const monthExp = state.expenses.filter(e => {
                const ed = parseLocalDate(e.date);
                return ed.getMonth() === d.getMonth() && ed.getFullYear() === d.getFullYear();
            }).reduce((sum, e) => sum + e.amount, 0);
            expenseData.push(monthExp);
        }

        monthlyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: labels, 
                datasets: [
                    { label: 'Revenue', data: revenueData, backgroundColor: '#10b981', borderRadius: 6 },
                    { label: 'Expenses', data: expenseData, backgroundColor: '#f43f5e', borderRadius: 6 }
                ] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { y: { ticks: { callback: (v) => '$' + v } } }
            }
        });
    }

    function renderFinancials() {
        const filterVal = document.getElementById('filter-financials').value;
        const tbody = document.getElementById('table-financials');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const lateFee = parseFloat(state.settings.late_fee_amount || 0);
        const grace = parseInt(state.settings.grace_period || 0);
        let totalOut = 0;

        // Merge and sort all transaction types
        const allTransactions = [
            ...state.invoices.map(inv => ({ ...inv, sortTime: parseLocalDate(inv.date), type: 'invoice' })),
            ...state.payments.map(pay => ({ ...pay, sortTime: parseLocalDate(pay.date), type: 'payment' }))
        ].sort((a, b) => b.sortTime - a.sortTime);

        allTransactions.forEach(item => {
            if (filterVal !== 'all' && item.tenant_id != filterVal) return;
            
            // REQUIREMENT: Do not add scheduled invoices until send by date
            if (item.sortTime > now) return;

            if(item.type === 'invoice') {
                const dueDate = new Date(item.sortTime);
                dueDate.setDate(dueDate.getDate() + grace);
                
                const isOverdue = now > dueDate && item.status !== 'Paid';
                const bal = (item.total || 0) - (item.amount_paid || 0);
                const displayBalance = isOverdue ? bal + lateFee : bal;
                
                if(item.status !== 'Paid') totalOut += displayBalance;

                const stColor = item.status === 'Paid' ? 'bg-emerald-50 text-emerald-600' : (isOverdue ? 'bg-rose-50 text-rose-600' : 'bg-amber-50 text-amber-600');
                const stLabel = item.status === 'Paid' ? 'Paid' : (isOverdue ? 'Overdue' : 'Unpaid');

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                        <td class="p-5 text-sm">${formatDisplayDate(item.date)}</td>
                        <td class="p-5 text-sm font-bold text-slate-700">${item.tenant_name}</td>
                        <td class="p-5"><span class="px-2 py-1 rounded text-[10px] font-bold bg-indigo-50 text-indigo-600">INVOICE</span></td>
                        <td class="p-5 text-sm text-slate-500 truncate max-w-[150px]">${item.items[0].desc}</td>
                        <td class="p-5 text-right font-bold text-slate-800">$${displayBalance.toLocaleString()}</td>
                        <td class="p-5 text-right"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${stColor}">${stLabel}</span></td>
                        <td class="p-5 text-right"><button onclick="act_viewInvoice(${item.id})" class="text-slate-400 hover:text-indigo-600 transition" title="View & Download PDF"><i class="fas fa-eye"></i></button></td>
                    </tr>`;
            } else {
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                        <td class="p-5 text-sm">${formatDisplayDate(item.date)}</td>
                        <td class="p-5 text-sm font-bold text-slate-700">${state.tenants.find(t=>t.id==item.tenant_id)?.name || 'Resident'}</td>
                        <td class="p-5"><span class="px-2 py-1 rounded text-[10px] font-bold bg-emerald-50 text-emerald-600">PAYMENT</span></td>
                        <td class="p-5 text-sm text-slate-400 italic">Electronic Payment Received</td>
                        <td class="p-5 text-right font-bold text-emerald-600">+$${item.amount.toLocaleString()}</td>
                        <td class="p-5 text-right text-xs text-slate-400">-</td>
                        <td class="p-5 text-right text-xs text-slate-400">-</td>
                    </tr>`;
            }
        });

        setText('fin-open-bal', `$${totalOut.toLocaleString()}`);
        document.getElementById('fin-summary-container').classList.remove('hidden-section');
    }

    // --- INVOICE WIZARD & RECURRING SCHEDULER ---

    function openInvoiceModal() { 
        const s = document.getElementById('inv-tenant');
        s.innerHTML = '<option value="" disabled selected>Select a Tenant Account...</option>';
        state.tenants.filter(t => t.status === 'Active').forEach(t => { 
            s.innerHTML += `<option value="${t.id}">${t.name}</option>`; 
        });

        // Initialize Wizard View
        document.getElementById('inv-step-input').classList.remove('hidden-section');
        document.getElementById('inv-step-preview').classList.add('hidden-section');
        document.getElementById('inv-actions-create').classList.remove('hidden-section');
        document.getElementById('inv-actions-create').classList.add('flex');
        document.getElementById('inv-actions-view').classList.add('hidden-section');
        
        // Reset Recurring States
        document.getElementById('inv-is-recurring').checked = false;
        document.getElementById('recurring-dates').classList.add('hidden-section');
        document.getElementById('send-on-section').classList.remove('hidden-section');

        setText('inv-modal-title', "Draft Property Invoice");
        document.getElementById('inv-date').valueAsDate = new Date();
        openModal('modal-invoice');
        logic_invMode('fixed');
    }

    function logic_toggleRecurring() {
        const isRec = document.getElementById('inv-is-recurring').checked;
        document.getElementById('recurring-dates').classList.toggle('hidden-section', !isRec);
        document.getElementById('send-on-section').classList.toggle('hidden-section', isRec);
    }

    function logic_generatePreview() {
        const tid = document.getElementById('inv-tenant').value;
        if(!tid) return showToast("Please choose a resident first", 'error');
        
        const resident = state.tenants.find(t => t.id == tid);
        const isRec = document.getElementById('inv-is-recurring').checked;
        const sendDateStr = isRec ? document.getElementById('inv-rec-start').value : document.getElementById('inv-date').value;
        
        const total = invItems.reduce((sum, item) => sum + (item.amount || 0), 0);
        
        draftInvoice = { 
            tenantId: parseInt(tid), 
            tenantName: resident.name, 
            items: JSON.parse(JSON.stringify(invItems)), 
            total: total, 
            date: sendDateStr,
            isRec: isRec,
            recEnd: document.getElementById('inv-rec-end').value
        };

        // REQUIREMENT: Date matches Send date exactly
        setText('prev-name', resident.name);
        setText('prev-date', formatDisplayDate(sendDateStr)); 
        setText('prev-total-due', `$${total.toLocaleString()}`);
        
        const tbody = document.getElementById('prev-items-body');
        tbody.innerHTML = '';
        invItems.forEach(i => {
            tbody.innerHTML += `
                <tr>
                    <td class="py-4 text-slate-600 font-medium">${i.desc}</td>
                    <td class="py-4 text-right font-extrabold text-slate-800">$${i.amount.toLocaleString()}</td>
                </tr>`;
        });

        // Determine Button Label based on date
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const targetDate = parseLocalDate(sendDateStr);
        const btn = document.getElementById('btn-confirm-inv');
        
        if(targetDate > now) {
            btn.innerText = `Confirm: Schedule for ${formatDisplayDate(sendDateStr)}`;
            btn.classList.replace('bg-emerald-600', 'bg-indigo-600');
        } else {
            btn.innerText = "Confirm: Send Immediately";
            btn.classList.replace('bg-indigo-600', 'bg-emerald-600');
        }

        document.getElementById('inv-step-input').classList.add('hidden-section');
        document.getElementById('inv-step-preview').classList.remove('hidden-section');
    }

    async function logic_confirmInvoice() {
        if(!draftInvoice) return;
        const btn = document.getElementById('btn-confirm-inv');
        btn.disabled = true;
        
        const ownerId = localStorage.getItem('kozeyy_user_id');
        try {
            // Log recurring schedule if enabled
            if(draftInvoice.isRec) {
                await supabaseClient.from('recurring_invoices').insert([{
                    owner_id: ownerId, 
                    tenant_id: draftInvoice.tenantId, 
                    amount: draftInvoice.total, 
                    start_date: draftInvoice.date, 
                    end_date: draftInvoice.recEnd, 
                    status: 'Active'
                }]);
            }

            // Save standard invoice record
            const { error } = await supabaseClient.from('invoices').insert([{
                owner_id: ownerId,
                tenant_id: draftInvoice.tenantId,
                tenant_name: draftInvoice.tenantName,
                items: draftInvoice.items,
                total: draftInvoice.total,
                date: draftInvoice.date,
                status: 'Unpaid'
            }]);

            if(error) throw error;
            
            showToast("Success! Financial record has been saved.");
            closeModal('modal-invoice');
            fetchData();
            renderAll();
        } catch(e) { 
            showToast("Database Error: " + e.message, 'error'); 
            btn.disabled = false; 
        }
    }

    function act_viewInvoice(id) {
        const inv = state.invoices.find(i => i.id == id);
        if(!inv) return;
        
        setText('prev-name', inv.tenant_name);
        setText('prev-date', formatDisplayDate(inv.date));
        setText('prev-total-due', `$${inv.total.toLocaleString()}`);
        
        const tbody = document.getElementById('prev-items-body');
        tbody.innerHTML = '';
        inv.items.forEach(i => {
            tbody.innerHTML += `
                <tr class="border-b border-slate-50 last:border-0">
                    <td class="py-4 font-medium text-slate-600">${i.desc}</td>
                    <td class="py-4 text-right font-bold text-slate-800">$${i.amount.toLocaleString()}</td>
                </tr>`;
        });

        document.getElementById('inv-step-input').classList.add('hidden-section');
        document.getElementById('inv-step-preview').classList.remove('hidden-section');
        document.getElementById('inv-actions-create').classList.add('hidden-section');
        document.getElementById('inv-actions-view').classList.remove('hidden-section');
        openModal('modal-invoice');
    }

    /**
     * REQUIREMENT: Download by PDF
     */
    function downloadOwnerInvoicePDF() {
        const element = document.getElementById('invoice-download-container');
        const options = {
            margin: 0.5,
            filename: `Kozeyy_Invoice_${Date.now()}.pdf`,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(options).from(element).save();
    }

    // --- REQUIREMENT: SETTINGS BACKEND SYNC ---

    async function act_saveSettings(e) {
        e.preventDefault();
        const ownerId = localStorage.getItem('kozeyy_user_id');
        
        // Exact mapping to Supabase columns in your screenshot
        const settingsPayload = {
            owner_id: ownerId,
            stripe_connect_id: document.getElementById('set-stripe-id').value,
            late_fee_amount: parseFloat(document.getElementById('fee-amount').value) || 0,
            grace_period: parseInt(document.getElementById('fee-grace').value) || 0,
            min_credit_score: parseInt(document.getElementById('set-min-score').value) || 600,
            min_income_ratio: parseFloat(document.getElementById('set-min-income').value) || 2.5,
            require_no_evictions: document.getElementById('set-no-evict').checked,
            require_no_criminal_history: document.getElementById('set-no-crim').checked,
            require_insurance: false,
            late_fee_method: 'Fixed'
        };

        const { error } = await supabaseClient.from('settings').upsert(settingsPayload, { onConflict: 'owner_id' });
        
        if (error) {
            showToast("Settings Save Failed: " + error.message, 'error');
        } else {
            showToast("System Configuration Successfully Synced");
            await fetchData();
            renderAll();
        }
    }

    function renderSettings() {
        const s = state.settings;
        if(!s) return;
        document.getElementById('set-stripe-id').value = s.stripe_connect_id || '';
        document.getElementById('fee-amount').value = s.late_fee_amount || 50;
        document.getElementById('fee-grace').value = s.grace_period || 5;
        document.getElementById('set-min-score').value = s.min_credit_score || 600;
        document.getElementById('set-min-income').value = s.min_income_ratio || 2.5;
        document.getElementById('set-no-evict').checked = !!s.require_no_evictions;
        document.getElementById('set-no-crim').checked = !!s.require_no_criminal_history;
    }

    // --- REQUIREMENT: OWNER NAME TOP RIGHT ---

    function loadUserProfile() {
        const profileStr = localStorage.getItem('kozeyy_profile');
        if (profileStr) {
            const user = JSON.parse(profileStr);
            const name = user.username || user.name || 'Property Landlord';
            setText('owner-name-display', name);
            
            // Generate initials for the avatar
            const initials = name.split(' ').map(n=>n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('owner-initials-display').innerText = initials || 'LL';
        }
    }

    // --- CRUD OPERATIONS: ALL CATEGORIES (TENANTS, LISTINGS, EXPENSES) ---

    async function act_saveTenant(e) { 
        e.preventDefault(); 
        const ownerId = localStorage.getItem('kozeyy_user_id');
        const data = { 
            owner_id: ownerId, 
            name: document.getElementById('t-name').value, 
            email: document.getElementById('t-email').value, 
            phone: document.getElementById('t-phone').value, 
            unit: document.getElementById('t-unit').value, 
            rent_amount: parseFloat(document.getElementById('t-rent').value)||0, 
            lease_start: document.getElementById('t-start').value||null, 
            lease_end: document.getElementById('t-end').value||null, 
            status: document.getElementById('t-status').value, 
            address: document.getElementById('t-addr').value, 
            city: document.getElementById('t-city').value, 
            state: document.getElementById('t-state').value, 
            zip: document.getElementById('t-zip').value 
        }; 

        if(editTenantId) {
            await supabaseClient.from('tenants').update(data).eq('id', editTenantId); 
        } else {
            await supabaseClient.from('tenants').insert([data]); 
        }
        
        closeModal('modal-tenant'); 
        await fetchData(); 
        renderAll(); 
    }

    async function act_delTenant(id) {
        openPlatformConfirm("Delete Resident?", "This will permanently remove the resident record and history.", async () => {
            await supabaseClient.from('tenants').delete().eq('id', id);
            await fetchData();
            renderAll();
            showToast("Tenant record removed.");
        });
    }

    function act_editTenant(id) { 
        editTenantId = id; 
        const t = state.tenants.find(x => x.id === id); 
        setText('modal-tenant-title',"Modify Tenant Data"); 
        document.getElementById('t-name').value = t.name; 
        document.getElementById('t-email').value = t.email; 
        document.getElementById('t-phone').value = t.phone || ''; 
        document.getElementById('t-unit').value = t.unit || ''; 
        document.getElementById('t-rent').value = t.rent_amount; 
        document.getElementById('t-addr').value = t.address || '';
        document.getElementById('t-status').value = t.status;
        openModal('modal-tenant'); 
    }

    // --- OTHER CORE SYSTEM FUNCTIONS ---

    function navTo(view) {
        activeTab = view;
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-section'));
        document.getElementById('view-' + view).classList.remove('hidden-section');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('sidebar-active'));
        const link = document.getElementById('link-' + view);
        if(link) link.classList.add('sidebar-active');
        
        // Dynamic Header Title
        const titles = { dashboard: 'Portfolio Overview', tenants: 'Resident Directory', listings: 'Leasing Listings', screening: 'Applicant Screening', messages: 'Resident Communication', maintenance: 'Property Maintenance', financials: 'Financial Ledgers', expenses: 'Business Expenses', reports: 'Performance Reports', settings: 'System Configuration' };
        setText('desktop-page-title', titles[view] || 'Dashboard');

        if(view === 'settings') renderSettings();
        if(view === 'reports') setTimeout(renderMonthlyChart, 50);
        renderAll();
    }

    // REQUIREMENT: Platform UI helpers replacing browser natives
    function openModal(id) { document.getElementById(id).classList.remove('hidden-section'); document.getElementById(id).classList.add('flex'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden-section'); document.getElementById(id).classList.remove('flex'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('mobile-overlay').classList.toggle('hidden'); }
    function openPrompt(title, cb) { setText('prompt-title', title); document.getElementById('prompt-input').value = ''; openModal('modal-prompt'); promptCallback = cb; }
    function closePrompt(conf) { closeModal('modal-prompt'); if(conf && promptCallback) promptCallback(document.getElementById('prompt-input').value); promptCallback = null; }
    function openPlatformConfirm(title, msg, cb) { setText('plat-conf-title', title); setText('plat-conf-msg', msg); openModal('modal-platform-confirm'); platformConfirmCallback = cb; }
    function closePlatformConfirm(conf) { closeModal('modal-platform-confirm'); if(conf && platformConfirmCallback) platformConfirmCallback(); platformConfirmCallback = null; }

    function updateBadge(id, count) { 
        const el = document.getElementById('badge-' + id); 
        if(!el) return;
        if(count > 0) { el.innerText = count; el.classList.remove('hidden-section'); } 
        else { el.classList.add('hidden-section'); } 
    }

    initSystem();
</script>
</body>
</html>
