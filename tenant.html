<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resident Portal | Kozeyy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .brand-font { font-family: 'Outfit', sans-serif; }
        .sidebar-active { background-color: #312e81; border-left: 4px solid #6366f1; color: white !important; }
        .mobile-active { color: #4F46E5 !important; }
        .nav-item { color: #94a3b8; }
        .nav-item:hover { color: white; background-color: #312e81; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50">

    <aside class="w-64 bg-indigo-950 flex-col transition-all duration-300 hidden md:flex shadow-xl z-20">
        <div class="h-20 flex items-center px-6 border-b border-indigo-900 bg-indigo-950 gap-3">
            <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
            </svg>
            <span class="text-xl font-bold text-white tracking-tight brand-font">Kozeyy</span>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="#" onclick="switchTab('home')" id="nav-home" class="nav-item flex items-center px-6 py-3.5 transition sidebar-active">
                <i class="fas fa-home w-6"></i> <span class="font-medium ml-3">Home</span>
            </a>
            <a href="#" onclick="switchTab('payments')" id="nav-payments" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-credit-card w-6"></i> <span class="font-medium ml-3">Payments</span>
            </a>
            <a href="#" onclick="switchTab('messages')" id="nav-messages" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-comment w-6"></i> <span class="font-medium ml-3">Messages</span></div>
                <span id="desk-notif-dot" class="hidden-section w-2.5 h-2.5 bg-red-500 rounded-full"></span>
            </a>
            <a href="#" onclick="switchTab('maintenance')" id="nav-maintenance" class="nav-item flex items-center px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-tools w-6"></i> <span class="font-medium ml-3">Maintenance</span></div>
            </a>
            <a href="#" onclick="switchTab('insurance')" id="nav-insurance" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-shield-alt w-6"></i> <span class="font-medium ml-3">Insurance</span>
            </a>
            <a href="#" onclick="switchTab('settings')" id="nav-settings" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-cog w-6"></i> <span class="font-medium ml-3">Settings</span>
            </a>
        </nav>
        <div class="p-6 border-t border-indigo-900 bg-indigo-950 flex flex-col gap-2">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-xs display-initials">U</div>
                <div>
                    <p class="font-bold text-white text-sm" id="user-name">Loading...</p>
                    <p class="text-xs text-indigo-300">Resident</p>
                </div>
            </div>
            <a href="login.html" class="text-xs text-indigo-400 hover:text-white mt-2 flex items-center"><i class="fas fa-sign-out-alt mr-2"></i> Sign Out</a>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative pb-20 md:pb-0 h-[100dvh]">
        <header class="hidden md:flex h-20 bg-white border-b border-slate-200 items-center justify-between px-8 shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800 brand-font" id="page-title">Resident Portal</h2>
            <div class="flex items-center gap-6">
                <div class="relative cursor-pointer hover:text-indigo-600 transition" onclick="switchTab('messages')">
                    <i class="fas fa-bell text-lg text-slate-400"></i>
                </div>
            </div>
        </header>

        <header class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-30 flex-none">
            <div class="flex items-center gap-2">
                <svg width="28" height="28" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                    <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                    <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
                </svg>
                <h2 class="text-lg font-bold text-slate-800 brand-font">Kozeyy</h2>
            </div>
            <div class="flex items-center gap-3" onclick="switchTab('settings')">
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold display-initials cursor-pointer border border-indigo-200">U</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth no-scrollbar">
            
            <div id="view-home" class="view-section fade-in pb-24">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 brand-font">Hi, <span class="display-name">...</span> ðŸ‘‹</h1>
                        <p id="unit-info-container" class="text-slate-500 text-sm mt-1 hidden-section">Unit <span id="display-unit">...</span></p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-500 text-xs uppercase tracking-wider">Current Balance</h3>
                            <div class="text-4xl font-extrabold text-slate-900 mt-2 brand-font" id="total-balance">$0.00</div>
                        </div>
                        <span id="payment-status-badge" class="bg-emerald-100 text-emerald-700 text-xs px-3 py-1 rounded-full font-bold uppercase">All Paid</span>
                    </div>
                    <p class="text-slate-500 text-sm mb-6" id="payment-due-date">No upcoming payments</p>
                    <button onclick="switchTab('payments')" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/20 active:scale-95 transform duration-100 flex items-center justify-center gap-2">
                        <span>Make a Payment</span>
                        <i class="fas fa-arrow-right text-xs"></i>
                    </button>
                </div>

                <div id="credit-banner" class="hidden-section bg-gradient-to-r from-slate-800 to-indigo-900 rounded-2xl p-6 text-white flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg mb-6 gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2"><i class="fas fa-chart-line text-indigo-300"></i><span class="text-xs font-bold uppercase tracking-wide opacity-80">Credit Builder</span></div>
                        <h3 class="font-bold text-lg brand-font">Boost Your Score</h3>
                        <p class="text-indigo-200 text-xs md:text-sm mt-1">Report on-time rent payments to bureaus.</p>
                    </div>
                    <button onclick="switchTab('settings')" class="w-full md:w-auto bg-white text-indigo-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-50 transition">Enable in Settings</button>
                </div>
            </div>

            <div id="view-payments" class="view-section hidden-section fade-in pb-24">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold brand-font">Payments</h1>
                    <div class="flex items-center gap-1 text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded border border-indigo-100">
                        <i class="fab fa-stripe"></i> <span>Secured by Stripe</span>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-700">Due Now</h3></div>
                    <div id="unpaid-container" class="divide-y divide-slate-100"></div>
                </div>
                <h2 class="text-lg font-bold mb-3 brand-font text-slate-700">History</h2>
                <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500"><tr><th class="p-4">Date</th><th class="p-4">Description</th><th class="p-4">Amount</th><th class="p-4 text-right">Action</th></tr></thead>
                        <tbody id="history-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-3" id="history-mobile"></div>
            </div>

            <div id="view-messages" class="view-section hidden-section absolute inset-0 pt-16 pb-20 md:pt-0 md:pb-0 z-0 bg-slate-50 flex flex-col fade-in">
                <div class="flex flex-col h-full bg-white md:rounded-xl shadow-sm border-0 md:border border-slate-200 overflow-hidden relative">
                    <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700 flex justify-between items-center shadow-sm z-10 flex-none">
                        <span>Property Manager</span>
                        <span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full font-bold">Online</span>
                    </div>
                    <div id="chat-messages" class="flex-1 p-4 pt-6 overflow-y-auto bg-slate-50 space-y-3">
                    </div>
                    <div class="p-3 border-t border-slate-200 bg-white flex gap-2 flex-none">
                        <input type="text" id="chat-input" class="flex-1 border border-slate-300 p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Type a message...">
                        <button onclick="sendMessage()" class="bg-indigo-600 text-white w-12 h-12 rounded-full font-bold hover:bg-indigo-700 transition flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <div id="view-maintenance" class="view-section hidden-section fade-in pb-24">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold brand-font">Maintenance</h1>
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm" onclick="toggleModal('requestModal')">+ Request</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700">History</div>
                    <div id="maint-list" class="divide-y divide-slate-100"></div>
                </div>
            </div>

            <div id="view-insurance" class="view-section hidden-section fade-in pb-24">
                <h1 class="text-2xl font-bold mb-4 brand-font">Insurance</h1>
                <div id="insurance-missing" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Upload Policy</h3>
                        <p class="text-slate-500 text-sm mb-4" id="ins-req-text">Upload your declaration page here.</p>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 transition active:bg-slate-100" onclick="uploadInsurance()">
                            <i class="fas fa-cloud-upload-alt text-3xl text-indigo-400 mb-2"></i>
                            <p class="text-sm font-bold text-slate-600">Tap to Upload</p>
                        </div>
                    </div>
                </div>
                <div id="insurance-verified" class="hidden-section bg-white p-6 rounded-2xl shadow-sm border border-slate-200 border-l-4 border-l-emerald-500">
                     <div class="flex justify-between items-start mb-4"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600"><i class="fas fa-check"></i></div><div><h3 class="font-bold text-slate-800">Verified</h3><p class="text-xs text-slate-500" id="ins-date">Oct 12, 2023</p></div></div><span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-[10px] font-bold uppercase">Active</span></div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center gap-3"><i class="fas fa-file-pdf text-red-500 text-xl"></i><p class="text-sm font-medium text-slate-800">policy_doc.pdf</p></div>
                    <button onclick="resetInsurance()" class="mt-4 text-xs text-red-400 hover:text-red-500 underline w-full text-center">Remove Policy</button>
                </div>
            </div>

            <div id="view-settings" class="view-section hidden-section fade-in pb-24">
                <h1 class="text-2xl font-bold mb-6 brand-font">Account Settings</h1>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <div class="flex items-center justify-between mb-4 border-b border-slate-100 pb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-lg font-bold display-initials">U</div>
                            <div>
                                <h3 class="font-bold text-slate-800 display-name">User</h3>
                                <p class="text-sm text-slate-500">Resident</p>
                            </div>
                        </div>
                        <button onclick="toggleModal('settingsModal')" class="text-indigo-600 text-sm font-bold hover:underline">Edit</button>
                    </div>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Email</label><p class="text-sm font-medium text-slate-800" id="set-email">...</p></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Phone</label><p class="text-sm font-medium text-slate-800" id="set-phone">...</p></div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <h3 class="font-bold text-slate-800 mb-2">Credit Reporting</h3>
                    <div class="flex items-center justify-between">
                        <div><p class="font-bold text-sm text-indigo-900">Enable Reporting</p><p class="text-xs text-slate-400">$10.00/month</p></div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="toggle-credit" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" onclick="handleCreditToggle()"/><label for="toggle-credit" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div>
                    </div>
                </div>
                <div class="mt-8 text-center"><a href="login.html" class="text-red-500 text-sm font-medium hover:underline">Sign Out</a></div>
            </div>
        </div>
    </main>
    
    <div id="settingsModal" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm relative">
            <button onclick="toggleModal('settingsModal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-4 brand-font">Edit Profile</h2>
            <form onsubmit="handleSettingsUpdate(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Email</label><input id="edit-email" type="email" class="w-full border p-3 rounded-xl bg-slate-50" required></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Phone</label><input id="edit-phone" type="tel" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="processingModal" class="hidden-section fixed inset-0 bg-slate-900/80 z-[60] flex flex-col items-center justify-center backdrop-blur-sm text-white">
        <div class="loader mb-4 border-t-white"></div>
        <h2 class="text-xl font-bold mb-2">Processing...</h2>
    </div>

    <script>
        const storedId = localStorage.getItem('kozeyy_user_id');
        if (!storedId) window.location.href = 'login.html';
        const USER_ID = storedId;

        const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
        let supabaseClient = null;
        if(window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let globalData = { user: null, invoices: [], msgs: [], maint: [] };
        
        // --- DATA FETCH ---
        async function render(skipFetch = false) {
            if(!supabaseClient) return;
            if(!skipFetch) {
                const [u, i, m, mt] = await Promise.all([
                   supabaseClient.from('tenants').select('*').eq('id', USER_ID).single(),
                   supabaseClient.from('invoices').select('*').eq('tenant_id', USER_ID),
                   supabaseClient.from('msgs').select('*').eq('tenant_id', USER_ID),
                   supabaseClient.from('maintenance').select('*').eq('tenant_id', USER_ID)
                ]);
                globalData.user = u.data;
                globalData.invoices = i.data || [];
                globalData.msgs = m.data || [];
                globalData.maint = mt.data || [];
            }
            // Populate UI
            const { user } = globalData;
            if(user) {
                document.getElementById('user-name').innerText = user.name;
                document.querySelectorAll('.display-name').forEach(el => el.innerText = user.name);
                document.querySelectorAll('.display-initials').forEach(el => el.innerText = user.name.charAt(0));
                document.getElementById('set-email').innerText = user.email;
                document.getElementById('set-phone').innerText = user.phone;
                // Pre-fill edit modal
                document.getElementById('edit-email').value = user.email;
                document.getElementById('edit-phone').value = user.phone;
            }
            // ... (Rest of render logic for payments/maintenance/messages same as previous) ...
        }

        // --- FIX #9: CHAT ---
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            // Fix #9: Ensure owner_id is passed if available in tenant record
            const ownerId = globalData.user ? globalData.user.owner_id : null;

            const newMsg = { 
                tenant_id: USER_ID, 
                owner_id: ownerId, 
                from: 'Tenant', 
                text: text, 
                created_at: new Date().toISOString() 
            };
            
            globalData.msgs.push(newMsg);
            renderMessages(); // Optimistic UI update
            input.value = '';
            
            try { await supabaseClient.from('msgs').insert([newMsg]); } 
            catch(e) { console.error(e); }
        }

        function renderMessages() {
            const chatBox = document.getElementById('chat-messages'); 
            const msgs = globalData.msgs.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
            chatBox.innerHTML = '';
            msgs.forEach(m => {
                const align = m.from === 'Tenant' ? 'justify-end' : 'justify-start'; 
                const color = m.from === 'Tenant' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'; 
                const d = new Date(m.created_at);
                const ts = d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
                chatBox.innerHTML += `<div class="flex ${align} mb-3 fade-in"><div class="flex flex-col ${m.from === 'Tenant' ? 'items-end' : 'items-start'} max-w-[85%]"><div class="px-4 py-2 rounded-2xl ${color} text-sm shadow-sm">${m.text}</div><span class="text-[10px] text-slate-400 mt-1 mx-1">${ts}</span></div></div>`;
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- FIX #2: SETTINGS UPDATE ---
        async function handleSettingsUpdate(e) {
            e.preventDefault();
            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;
            toggleModal('processingModal');
            
            const { error } = await supabaseClient.from('tenants').update({ email, phone }).eq('id', USER_ID);
            
            toggleModal('processingModal');
            if(error) alert("Error updating profile: " + error.message);
            else { toggleModal('settingsModal'); render(false); }
        }

        function toggleModal(id) { const el = document.getElementById(id); if(el) el.classList.toggle('hidden-section'); }
        function switchTab(t) { 
            // ... (Tab switching logic same as previous) ...
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-section')); 
            document.getElementById(`view-${t}`).classList.remove('hidden-section'); 
            if(t==='messages') { setTimeout(()=>{ renderMessages(); }, 100); }
        }
        
        // Init
        render(false);
        setInterval(() => render(false), 4000); // Polling
    </script>
</body>
</html>
