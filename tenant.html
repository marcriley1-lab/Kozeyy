<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resident Portal | Kozeyy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .brand-font { font-family: 'Outfit', sans-serif; }
        .sidebar-active { background-color: #312e81; border-left: 4px solid #6366f1; color: white !important; }
        .mobile-active { color: #4F46E5 !important; }
        .nav-item { color: #94a3b8; }
        .nav-item:hover { color: white; background-color: #312e81; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50">

    <!-- DESKTOP SIDEBAR -->
    <aside class="w-64 bg-indigo-950 flex-col transition-all duration-300 hidden md:flex shadow-xl z-20">
        <div class="h-20 flex items-center px-6 border-b border-indigo-900 bg-indigo-950 gap-3">
            <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
            </svg>
            <span class="text-xl font-bold text-white tracking-tight brand-font">Kozeyy</span>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="#" onclick="switchTab('home')" id="nav-home" class="nav-item flex items-center px-6 py-3.5 transition sidebar-active">
                <i class="fas fa-home w-6"></i> <span class="font-medium ml-3">Home</span>
            </a>
            <a href="#" onclick="switchTab('payments')" id="nav-payments" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-credit-card w-6"></i> <span class="font-medium ml-3">Payments</span>
            </a>
            <a href="#" onclick="switchTab('messages')" id="nav-messages" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-comment w-6"></i> <span class="font-medium ml-3">Messages</span></div>
                <span id="desk-notif-dot" class="hidden-section w-2.5 h-2.5 bg-red-500 rounded-full"></span>
            </a>
            <a href="#" onclick="switchTab('maintenance')" id="nav-maintenance" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-tools w-6"></i> <span class="font-medium ml-3">Maintenance</span>
            </a>
            <a href="#" onclick="switchTab('insurance')" id="nav-insurance" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-shield-alt w-6"></i> <span class="font-medium ml-3">Insurance</span>
            </a>
            <a href="#" onclick="switchTab('settings')" id="nav-settings" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-cog w-6"></i> <span class="font-medium ml-3">Settings</span>
            </a>
        </nav>

        <div class="p-6 border-t border-indigo-900 bg-indigo-950">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-xs"><i class="fas fa-user"></i></div>
                <div>
                    <p class="font-bold text-white text-sm" id="user-name">Loading...</p>
                    <p class="text-xs text-indigo-300">Resident</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden relative pb-20 md:pb-0">
        <!-- Desktop Header -->
        <header class="hidden md:flex h-20 bg-white border-b border-slate-200 items-center justify-between px-8 shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800 brand-font" id="page-title">Resident Portal</h2>
            <div class="flex items-center gap-6">
                <div class="relative cursor-pointer hover:text-indigo-600 transition" onclick="switchTab('messages')">
                    <i class="fas fa-bell text-lg text-slate-400"></i>
                </div>
            </div>
        </header>

        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-30">
            <div class="flex items-center gap-2">
                <svg width="28" height="28" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                    <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                    <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
                </svg>
                <h2 class="text-lg font-bold text-slate-800 brand-font">Kozeyy</h2>
            </div>
            <div class="flex items-center gap-3" onclick="switchTab('settings')">
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold display-initials cursor-pointer border border-indigo-200">U</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth no-scrollbar">
            
            <!-- 1. HOME TAB -->
            <div id="view-home" class="view-section fade-in pb-4">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 brand-font">Hi, <span class="display-name">...</span> ðŸ‘‹</h1>
                        <p id="unit-info-container" class="text-slate-500 text-sm mt-1 hidden-section">Unit <span id="display-unit">...</span></p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-500 text-xs uppercase tracking-wider">Current Balance</h3>
                            <div class="text-4xl font-extrabold text-slate-900 mt-2 brand-font" id="total-balance">$0.00</div>
                        </div>
                        <span id="payment-status-badge" class="bg-emerald-100 text-emerald-700 text-xs px-3 py-1 rounded-full font-bold uppercase">All Paid</span>
                    </div>
                    <p class="text-slate-500 text-sm mb-6" id="payment-due-date">No upcoming payments</p>
                    <button onclick="switchTab('payments')" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/20 active:scale-95 transform duration-100">Make a Payment</button>
                </div>

                <div id="credit-banner" class="bg-gradient-to-r from-slate-800 to-indigo-900 rounded-2xl p-6 text-white flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg mb-6 gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2"><i class="fas fa-chart-line text-indigo-300"></i><span class="text-xs font-bold uppercase tracking-wide opacity-80">Credit Builder</span></div>
                        <h3 class="font-bold text-lg brand-font">Boost Your Score</h3>
                        <p class="text-indigo-200 text-xs md:text-sm mt-1">Report on-time rent payments to bureaus.</p>
                    </div>
                    <button onclick="switchTab('settings')" class="w-full md:w-auto bg-white text-indigo-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-50 transition">Enable in Settings</button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-700 mb-4 brand-font">Recent Activity</h3>
                    <div class="space-y-4" id="recent-activity-list">
                        <!-- CHANGED: Default text is now "No recent activity" instead of "Loading..." -->
                        <div class="text-gray-400 text-sm italic">No recent activity</div>
                    </div>
                </div>
            </div>

            <!-- 2. PAYMENTS TAB -->
            <div id="view-payments" class="view-section hidden-section fade-in pb-4">
                <h1 class="text-2xl font-bold mb-4 brand-font">Payments</h1>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-700">Due Now</h3></div>
                    <div id="unpaid-container" class="divide-y divide-slate-100"></div>
                </div>
                <h2 class="text-lg font-bold mb-3 brand-font text-slate-700">History</h2>
                <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500"><tr><th class="p-4">Date</th><th class="p-4">Description</th><th class="p-4">Amount</th><th class="p-4 text-right">Status</th></tr></thead>
                        <tbody id="history-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-3" id="history-mobile"></div>
            </div>

            <!-- 3. MESSAGES TAB -->
            <div id="view-messages" class="view-section hidden-section h-[calc(100vh-140px)] md:h-[calc(100vh-140px)] fade-in">
                <div class="flex flex-col h-full bg-white md:rounded-xl shadow-sm border border-slate-200 overflow-hidden absolute inset-0 md:relative bottom-16 md:bottom-0">
                    <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700 flex justify-between items-center shadow-sm z-10">
                        <span>Property Manager</span>
                        <span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full font-bold">Online</span>
                    </div>
                    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 space-y-3 pb-20"></div>
                    <div class="p-3 border-t border-slate-200 bg-white flex gap-2 absolute bottom-0 w-full md:relative">
                        <input type="text" id="chat-input" class="flex-1 border border-slate-300 p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Type a message...">
                        <button onclick="sendMessage()" class="bg-indigo-600 text-white w-12 h-12 rounded-full font-bold hover:bg-indigo-700 transition flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- 4. MAINTENANCE TAB -->
            <div id="view-maintenance" class="view-section hidden-section fade-in pb-4">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold brand-font">Maintenance</h1>
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm" onclick="toggleModal('requestModal')">+ Request</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700">History</div>
                    <div id="maint-list" class="divide-y divide-slate-100"></div>
                </div>
            </div>

            <!-- 5. INSURANCE TAB -->
            <div id="view-insurance" class="view-section hidden-section fade-in pb-4">
                <h1 class="text-2xl font-bold mb-4 brand-font">Insurance</h1>
                <div id="insurance-missing" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Upload Policy</h3>
                        <p class="text-slate-500 text-sm mb-4" id="ins-req-text">Upload your declaration page here.</p>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 transition active:bg-slate-100" onclick="uploadInsurance()">
                            <i class="fas fa-cloud-upload-alt text-3xl text-indigo-400 mb-2"></i>
                            <p class="text-sm font-bold text-slate-600">Tap to Upload</p>
                        </div>
                    </div>
                    <div class="bg-indigo-950 p-6 rounded-2xl shadow-lg text-white">
                        <div class="flex items-center gap-2 mb-3"><span class="bg-indigo-500/30 text-indigo-200 text-xs font-bold px-2 py-1 rounded uppercase">Partner</span></div>
                        <h3 class="text-xl font-bold mb-2 brand-font">Need coverage?</h3>
                        <div class="space-y-3">
                            <a href="https://www.lemonade.com" target="_blank" class="block w-full bg-[#FF0083] text-white text-center py-3 rounded-xl font-bold hover:bg-[#D5006D] transition">Get Lemonade Quote</a>
                            <a href="https://www.insurify.com" target="_blank" class="block w-full bg-blue-500 text-white text-center py-3 rounded-xl font-bold hover:bg-blue-600 transition">Compare on Insurify</a>
                        </div>
                    </div>
                </div>
                <div id="insurance-verified" class="hidden-section bg-white p-6 rounded-2xl shadow-sm border border-slate-200 border-l-4 border-l-emerald-500">
                    <div class="flex justify-between items-start mb-4"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600"><i class="fas fa-check"></i></div><div><h3 class="font-bold text-slate-800">Verified</h3><p class="text-xs text-slate-500" id="ins-date">Oct 12, 2023</p></div></div><span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-[10px] font-bold uppercase">Active</span></div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center gap-3"><i class="fas fa-file-pdf text-red-500 text-xl"></i><p class="text-sm font-medium text-slate-800">policy_doc.pdf</p></div>
                    <button onclick="resetInsurance()" class="mt-4 text-xs text-red-400 hover:text-red-500 underline w-full text-center">Remove Policy</button>
                </div>
            </div>

            <!-- 6. SETTINGS TAB -->
            <div id="view-settings" class="view-section hidden-section fade-in pb-4">
                <h1 class="text-2xl font-bold mb-6 brand-font">Account Settings</h1>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <div class="flex items-center gap-4 mb-4 border-b border-slate-100 pb-4">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-lg font-bold display-initials">U</div>
                        <div>
                            <h3 class="font-bold text-slate-800 display-name">User</h3>
                            <p class="text-sm text-slate-500">Resident</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Email</label><p class="text-sm font-medium text-slate-800" id="set-email">...</p></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Phone</label><p class="text-sm font-medium text-slate-800" id="set-phone">...</p></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <h3 class="font-bold text-slate-800 mb-4">Payment Method</h3>
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 mb-3">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-university text-slate-400 text-xl"></i>
                            <div>
                                <p class="font-bold text-sm text-slate-700">Chase Checking</p>
                                <p class="text-xs text-slate-400">**** 4291</p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">Primary</span>
                    </div>
                    <div class="p-3 bg-amber-50 rounded-lg border border-amber-100 flex items-start gap-3">
                        <i class="fas fa-info-circle text-amber-500 mt-0.5"></i>
                        <p class="text-xs text-amber-800 leading-relaxed"><strong>ACH Fee:</strong> A collection fee of <strong>$2.00</strong> applies to all bank transfers.</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-2">Credit Reporting</h3>
                    <p class="text-sm text-slate-500 mb-4">Report your rent payments to credit bureaus to build your history.</p>
                    <div class="flex items-center justify-between">
                        <div><p class="font-bold text-sm text-indigo-900">Enable Reporting</p><p class="text-xs text-slate-400">$10.00/month</p></div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="toggle-credit" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" onclick="handleCreditToggle()"/><label for="toggle-credit" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div>
                    </div>
                </div>
                <div class="mt-8 text-center"><button class="text-red-500 text-sm font-medium hover:underline">Sign Out</button><p class="text-xs text-slate-300 mt-4">Version 3.2.0</p></div>
            </div>
        </div>
    </main>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around py-3 z-40 pb-safe">
        <button onclick="switchTab('home')" id="mob-home" class="flex flex-col items-center gap-1 text-slate-400 mobile-active">
            <i class="fas fa-home text-xl"></i><span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="switchTab('payments')" id="mob-payments" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-credit-card text-xl"></i><span class="text-[10px] font-medium">Pay</span>
        </button>
        <button onclick="switchTab('messages')" id="mob-messages" class="flex flex-col items-center gap-1 text-slate-400 relative">
            <i class="fas fa-comment text-xl"></i><span class="text-[10px] font-medium">Chat</span>
            <span id="mob-notif-dot" class="hidden-section absolute top-0 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
        </button>
        <button onclick="switchTab('maintenance')" id="mob-maintenance" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-tools text-xl"></i><span class="text-[10px] font-medium">Fix</span>
        </button>
        <button onclick="switchTab('insurance')" id="mob-insurance" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-shield-alt text-xl"></i><span class="text-[10px] font-medium">Insure</span>
        </button>
    </nav>

    <!-- Maintenance Modal -->
    <div id="requestModal" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md relative">
            <button onclick="toggleModal('requestModal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-4 brand-font">Request Maintenance</h2>
            <form onsubmit="handleMaintSubmit(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Category</label><select id="m-cat" class="w-full border p-3 rounded-xl bg-slate-50 outline-none"><option>Plumbing</option><option>Electrical</option><option>Appliance</option><option>General</option></select></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Description</label><textarea id="m-desc" class="w-full border p-3 rounded-xl bg-slate-50 h-24 outline-none resize-none" placeholder="Describe the issue..." required></textarea></div>
                <div class="flex items-center gap-2"><input type="checkbox" id="entry" class="rounded text-indigo-600 w-5 h-5"><label for="entry" class="text-sm text-slate-600">Permission to enter if I am not home</label></div>
                <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Submit Request</button>
            </form>
        </div>
    </div>

    <script>
        const DB_KEY = 'kozeyy_data_final_v32'; 
        const USER_ID = 1; 

        // UPDATED: Standalone Data Init (Fallback if Owner.html hasn't run)
        const DB = { 
            get: () => { 
                try { 
                    const data = JSON.parse(localStorage.getItem(DB_KEY));
                    if (!data) return DB.init(); // Auto-init if missing
                    return data;
                } catch(e){ return DB.init(); } 
            }, 
            set: (data) => localStorage.setItem(DB_KEY, JSON.stringify(data)),
            init: () => {
                const dummy = {
                    tenants: [{ id: 1, name: 'Demo User', email: 'demo@example.com', phone: '555-0101', unit: '101', insurance: false, creditReporting: false }],
                    invoices: [], msgs: [], maint: [], settings: { requireInsurance: true }
                };
                localStorage.setItem(DB_KEY, JSON.stringify(dummy));
                return dummy;
            }
        };
        
        let isCreditEnabled = false;

        function render() {
            const data = DB.get();
            if(!data) return; // Should not happen with new DB.init

            const user = data.tenants.find(t => t.id == USER_ID) || {name: 'Unknown User', unit: '', insurance: false};
            const myInvoices = data.invoices.filter(i => i.tenantId == USER_ID);
            const myMsgs = data.msgs.filter(m => m.tenantId == USER_ID);
            const myMaint = data.maint.filter(m => m.tenantId == USER_ID);

            // User Info
            document.getElementById('user-name').innerText = user.name;
            document.querySelectorAll('.display-name').forEach(el => el.innerText = user.name.split(' ')[0]);
            document.querySelectorAll('.display-initials').forEach(el => el.innerText = user.name.charAt(0));
            document.getElementById('set-email').innerText = user.email || 'N/A';
            document.getElementById('set-phone').innerText = user.phone || 'N/A';
            
            // Unit Logic
            const unitContainer = document.getElementById('unit-info-container');
            if (user.unit && user.unit.trim() !== '') {
                unitContainer.classList.remove('hidden-section');
                document.getElementById('display-unit').innerText = user.unit;
            } else {
                unitContainer.classList.add('hidden-section');
            }

            // Credit Toggle State
            if(user.creditReporting) {
                document.getElementById('toggle-credit').checked = true;
                document.getElementById('credit-banner').classList.add('hidden-section'); 
            } else {
                document.getElementById('toggle-credit').checked = false;
                document.getElementById('credit-banner').classList.remove('hidden-section');
            }

            // Financials
            const unpaid = myInvoices.filter(i => i.status === 'Unpaid' || i.status === 'Partial');
            const totalDue = unpaid.reduce((sum, i) => sum + (i.total - (i.amountPaid || 0)), 0);
            document.getElementById('total-balance').innerText = `$${totalDue.toLocaleString()}`;
            const badge = document.getElementById('payment-status-badge');
            if(totalDue > 0) { 
                badge.className = "bg-rose-100 text-rose-700 text-xs px-3 py-1 rounded-full font-bold uppercase"; badge.innerText = `${unpaid.length} Due`; 
                document.getElementById('payment-due-date').innerText = `Due: ${unpaid[0].date || 'Immediately'}`; 
            } else { 
                badge.className = "bg-emerald-100 text-emerald-700 text-xs px-3 py-1 rounded-full font-bold uppercase"; badge.innerText = "All Paid"; 
                document.getElementById('payment-due-date').innerText = "No upcoming payments"; 
            }

            // Unpaid Container
            const uCont = document.getElementById('unpaid-container'); 
            uCont.innerHTML = unpaid.length ? '' : `<div class="p-8 text-center text-slate-400 italic text-sm">No active invoices</div>`;
            unpaid.forEach(i => { 
                const remaining = i.total - (i.amountPaid || 0);
                let itemsHtml = `<ul class="text-xs text-slate-500 mt-2 space-y-1">`; 
                const items = i.items || [{desc: 'Balance', amount: i.total}]; 
                items.forEach(item => { itemsHtml += `<li class="flex justify-between w-full max-w-xs border-b border-dashed border-slate-200 pb-1"><span>${item.desc}</span> <span>$${item.amount}</span></li>`; }); 
                itemsHtml += `</ul>`; 
                let statusText = i.status === 'Partial' ? `<span class="text-amber-600 text-xs font-bold mb-1 block">Partial Payment</span>` : '';
                uCont.innerHTML += `
                <div class="p-4 md:p-6 flex flex-col md:flex-row justify-between items-start md:items-center hover:bg-slate-50 transition border-b border-slate-100 gap-4">
                    <div class="w-full md:w-auto">${statusText}<p class="font-bold text-lg text-slate-800">Invoice #${i.id}</p>${itemsHtml}<p class="text-xs text-rose-500 mt-2 font-bold">Due: ${i.date || 'Immediate'}</p></div>
                    <div class="flex items-center justify-between w-full md:w-auto gap-4">
                        <div class="text-right md:text-left"><span class="font-extrabold text-2xl text-slate-900">$${remaining.toLocaleString()}</span></div>
                        <button onclick="payInvoice(${i.id}, ${remaining})" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm">Pay Now</button>
                    </div>
                </div>`; 
            });

            // History & Activity
            const hBody = document.getElementById('history-body'); const hMob = document.getElementById('history-mobile');
            hBody.innerHTML = ''; hMob.innerHTML = '';
            const historyItems = myInvoices.filter(i => i.status === 'Paid');
            if(historyItems.length === 0) hMob.innerHTML = '<div class="text-center text-slate-400 text-sm py-4">No payment history</div>';
            historyItems.forEach(i => { 
                hBody.innerHTML += `<tr class="hover:bg-slate-50 transition border-b border-slate-100"><td class="p-4 text-slate-500">${i.paidDate || i.date || '-'}</td><td class="p-4 text-slate-800 font-medium">Invoice #${i.id}</td><td class="p-4 font-bold">$${i.total.toLocaleString()}</td><td class="p-4 text-right"><span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold uppercase">Paid</span></td></tr>`; 
                hMob.innerHTML += `<div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center"><div><p class="font-bold text-slate-800 text-sm">Invoice #${i.id}</p><p class="text-xs text-slate-500">${i.paidDate || i.date}</p></div><div class="text-right"><p class="font-bold text-slate-900">$${i.total.toLocaleString()}</p><span class="text-[10px] font-bold text-emerald-600 uppercase">Paid</span></div></div>`;
            });

            // UPDATED: Activity Feed with Safety Checks
            const activityList = document.getElementById('recent-activity-list'); 
            const feed = [
                ...myInvoices.filter(i=>i.status==='Paid').map(x => ({type:'pay', date: x.paidDate || 'Recent', txt: `Paid Invoice #${x.id}`})), 
                ...myMaint.map(x => ({type:'maint', date: x.date, txt: `Request: ${(x.issue || 'Request').split(':')[0]} (${x.status})`}))
            ].sort((a,b) => b.date > a.date ? 1 : -1).slice(0, 3);
            
            if(feed.length > 0) {
                activityList.innerHTML = '';
                feed.forEach(item => { 
                    const icon = item.type === 'pay' ? '<div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-xs"><i class="fas fa-check"></i></div>' : '<div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs"><i class="fas fa-tools"></i></div>'; 
                    activityList.innerHTML += `<div class="flex items-center gap-3 pb-3 border-b border-slate-50 last:border-0 last:pb-0">${icon}<div><p class="font-bold text-sm text-slate-800">${item.txt}</p><p class="text-xs text-slate-500">${item.date}</p></div></div>`; 
                });
            } else {
                // Ensure placeholder text stays if feed is empty
                activityList.innerHTML = '<div class="text-gray-400 text-sm italic">No recent activity</div>';
            }

            // Insurance & Messages
            const settings = data.settings || { requireInsurance: true };
            document.getElementById('ins-req-text').innerText = settings.requireInsurance ? "Your lease requires active renter's insurance." : "Protect your belongings with a policy.";
            if(user.insurance) { document.getElementById('insurance-missing').classList.add('hidden-section'); document.getElementById('insurance-verified').classList.remove('hidden-section'); if(user.insuranceDate) document.getElementById('ins-date').innerText = user.insuranceDate; } else { document.getElementById('insurance-missing').classList.remove('hidden-section'); document.getElementById('insurance-verified').classList.add('hidden-section'); }
            
            const chatBox = document.getElementById('chat-messages'); chatBox.innerHTML = '';
            myMsgs.forEach(m => { 
                const align = m.from === 'Tenant' ? 'justify-end' : 'justify-start'; 
                const color = m.from === 'Tenant' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'; 
                chatBox.innerHTML += `<div class="flex ${align}"><div class="max-w-[80%] px-4 py-2 rounded-2xl ${color} text-sm shadow-sm">${m.text}</div></div>`; 
            });
            
            const maintList = document.getElementById('maint-list'); maintList.innerHTML = myMaint.length ? '' : `<div class="p-8 text-center text-slate-400 italic text-sm">No requests filed</div>`;
            myMaint.forEach(m => { const statusColor = m.status === 'Active' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'; const notes = m.notes ? `<p class="text-xs text-slate-500 mt-1 italic border-l-2 border-slate-300 pl-2">"${m.notes}"</p>` : ''; maintList.innerHTML += `<div class="p-4 flex flex-col hover:bg-slate-50 transition border-b border-slate-100"><div class="flex justify-between items-start"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 text-xs"><i class="fas fa-wrench"></i></div><div><h4 class="font-bold text-sm text-slate-800">${m.issue}</h4><p class="text-xs text-slate-400">${m.date}</p></div></div><span class="${statusColor} px-2 py-1 rounded-full text-[10px] font-bold uppercase">${m.status}</span></div>${notes}</div>`; });
        }

        function switchTab(t) { 
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-section')); 
            document.getElementById(`view-${t}`).classList.remove('hidden-section'); 
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('sidebar-active')); 
            const deskLink = document.getElementById(`nav-${t}`);
            if(deskLink) deskLink.classList.add('sidebar-active');
            document.querySelectorAll('.md\\:hidden button').forEach(e => e.classList.remove('mobile-active', 'text-indigo-600'));
            document.querySelectorAll('.md\\:hidden button').forEach(e => e.classList.add('text-slate-400'));
            const mobBtn = document.getElementById(`mob-${t}`);
            if(mobBtn) { mobBtn.classList.add('mobile-active'); mobBtn.classList.remove('text-slate-400'); }
            const titles = { home:'Resident Portal', payments:'Payments', messages:'Messages', maintenance:'Maintenance', insurance:'Insurance', settings:'Account Settings' };
            const titleEl = document.getElementById('page-title');
            if(titleEl) titleEl.innerText = titles[t] || 'Kozeyy';
        }

        function toggleModal(id) { const el = document.getElementById(id); if(el) el.classList.toggle('hidden-section'); }
        
        function handleCreditToggle() {
            const checkBox = document.getElementById('toggle-credit');
            const data = DB.get();
            const tenantIndex = data.tenants.findIndex(t => t.id == USER_ID);
            if(tenantIndex > -1) {
                data.tenants[tenantIndex].creditReporting = checkBox.checked;
                DB.set(data);
                if(checkBox.checked) alert("Credit Reporting Enabled! $10 will be added to your monthly invoice.");
                else alert("Credit Reporting Disabled.");
                render();
            }
        }

        function uploadInsurance() { const input = document.createElement('input'); input.type = 'file'; input.onchange = () => { alert("File successfully uploaded!"); const data = DB.get(); const tenantIndex = data.tenants.findIndex(t => t.id == USER_ID); if(tenantIndex > -1) { data.tenants[tenantIndex].insurance = true; data.tenants[tenantIndex].insuranceDate = new Date().toLocaleDateString(); DB.set(data); render(); } }; input.click(); }
        function resetInsurance() { if(confirm("Remove this policy?")) { const data = DB.get(); const tenantIndex = data.tenants.findIndex(t => t.id == USER_ID); if(tenantIndex > -1) { data.tenants[tenantIndex].insurance = false; DB.set(data); render(); } } }
        
        function payInvoice(id, amount) { 
            const achFee = 2.00;
            const total = amount + achFee;
            if(confirm(`Confirm Payment:\n\nInvoice Balance: $${amount.toLocaleString()}\nACH Collection Fee: $${achFee.toFixed(2)}\n\nTOTAL: $${total.toLocaleString()}\n\nProceed with payment?`)) { 
                const data = DB.get(); 
                const inv = data.invoices.find(i => i.id === id); 
                if(inv) { 
                    inv.amountPaid = inv.total; 
                    inv.status = 'Paid'; 
                    inv.paidDate = new Date().toLocaleDateString(); 
                    DB.set(data); 
                    render(); 
                } 
            } 
        }
        
        function sendMessage() { const input = document.getElementById('chat-input'); const txt = input.value.trim(); if(txt) { const data = DB.get(); data.msgs.push({ id: Date.now(), tenantId: USER_ID, from: 'Tenant', text: txt, time: new Date().toLocaleTimeString() }); if(!data.notifications) data.notifications = { messages: 0 }; data.notifications.messages = (data.notifications.messages || 0) + 1; DB.set(data); input.value = ''; render(); } }
        function handleMaintSubmit(e) { e.preventDefault(); const desc = document.getElementById('m-desc').value; const cat = document.getElementById('m-cat').value; if(desc) { const data = DB.get(); data.maint.push({ id: Date.now(), tenantId: USER_ID, issue: `${cat}: ${desc}`, status: 'Active', date: new Date().toLocaleDateString(), notes: '' }); if(!data.notifications) data.notifications = { maintenance: 0 }; data.notifications.maintenance = (data.notifications.maintenance || 0) + 1; DB.set(data); toggleModal('requestModal'); e.target.reset(); render(); } }

        render();
        setInterval(render, 3000); 

    </script>
</body>
</html>