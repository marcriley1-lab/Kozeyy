<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resident Portal | Kozeyy</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .brand-font { font-family: 'Outfit', sans-serif; }
        
        .sidebar-active { background-color: #312e81; border-left: 4px solid #6366f1; color: white !important; }
        .mobile-active { color: #4F46E5 !important; }
        .nav-item { color: #94a3b8; }
        .nav-item:hover { color: white; background-color: #312e81; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50">

    <!-- DESKTOP SIDEBAR -->
    <aside class="w-64 bg-indigo-950 flex-col transition-all duration-300 hidden md:flex shadow-xl z-20">
        <div class="h-20 flex items-center px-6 border-b border-indigo-900 bg-indigo-950 gap-3">
            <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
            </svg>
            <span class="text-xl font-bold text-white tracking-tight brand-font">Kozeyy</span>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="#" onclick="switchTab('home')" id="nav-home" class="nav-item flex items-center px-6 py-3.5 transition sidebar-active">
                <i class="fas fa-home w-6"></i> <span class="font-medium ml-3">Home</span>
            </a>
            <a href="#" onclick="switchTab('payments')" id="nav-payments" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-credit-card w-6"></i> <span class="font-medium ml-3">Payments</span>
            </a>
            <a href="#" onclick="switchTab('messages')" id="nav-messages" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-comment w-6"></i> <span class="font-medium ml-3">Messages</span></div>
                <span id="desk-notif-dot" class="hidden-section w-2.5 h-2.5 bg-red-500 rounded-full"></span>
            </a>
            <a href="#" onclick="switchTab('maintenance')" id="nav-maintenance" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-tools w-6"></i> <span class="font-medium ml-3">Maintenance</span>
            </a>
            <a href="#" onclick="switchTab('insurance')" id="nav-insurance" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-shield-alt w-6"></i> <span class="font-medium ml-3">Insurance</span>
            </a>
            <a href="#" onclick="switchTab('settings')" id="nav-settings" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-cog w-6"></i> <span class="font-medium ml-3">Settings</span>
            </a>
        </nav>

        <div class="p-6 border-t border-indigo-900 bg-indigo-950 flex flex-col gap-2">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-xs display-initials">U</div>
                <div>
                    <p class="font-bold text-white text-sm" id="user-name">Loading...</p>
                    <p class="text-xs text-indigo-300">Resident</p>
                </div>
            </div>
            <a href="login.html" class="text-xs text-indigo-400 hover:text-white mt-2 flex items-center"><i class="fas fa-sign-out-alt mr-2"></i> Sign Out</a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden relative pb-20 md:pb-0 h-[100dvh]">
        <!-- Desktop Header -->
        <header class="hidden md:flex h-20 bg-white border-b border-slate-200 items-center justify-between px-8 shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800 brand-font" id="page-title">Resident Portal</h2>
            <div class="flex items-center gap-6">
                <div class="relative cursor-pointer hover:text-indigo-600 transition" onclick="switchTab('messages')">
                    <i class="fas fa-bell text-lg text-slate-400"></i>
                </div>
            </div>
        </header>

        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-30 flex-none">
            <div class="flex items-center gap-2">
                <svg width="28" height="28" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                    <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                    <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
                </svg>
                <h2 class="text-lg font-bold text-slate-800 brand-font">Kozeyy</h2>
            </div>
            <div class="flex items-center gap-3" onclick="switchTab('settings')">
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold display-initials cursor-pointer border border-indigo-200">U</div>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth no-scrollbar">
            
            <!-- 1. HOME TAB -->
            <div id="view-home" class="view-section fade-in pb-24">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 brand-font">Hi, <span class="display-name">...</span> ðŸ‘‹</h1>
                        <p id="unit-info-container" class="text-slate-500 text-sm mt-1 hidden-section">Unit <span id="display-unit">...</span></p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-500 text-xs uppercase tracking-wider">Current Balance</h3>
                            <div class="text-4xl font-extrabold text-slate-900 mt-2 brand-font" id="total-balance">$0.00</div>
                        </div>
                        <span id="payment-status-badge" class="bg-emerald-100 text-emerald-700 text-xs px-3 py-1 rounded-full font-bold uppercase">All Paid</span>
                    </div>
                    <p class="text-slate-500 text-sm mb-6" id="payment-due-date">No upcoming payments</p>
                    <button onclick="switchTab('payments')" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/20 active:scale-95 transform duration-100 flex items-center justify-center gap-2">
                        <span>Make a Payment</span>
                        <i class="fas fa-arrow-right text-xs"></i>
                    </button>
                </div>

                <div id="credit-banner" class="hidden-section bg-gradient-to-r from-slate-800 to-indigo-900 rounded-2xl p-6 text-white flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg mb-6 gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2"><i class="fas fa-chart-line text-indigo-300"></i><span class="text-xs font-bold uppercase tracking-wide opacity-80">Credit Builder</span></div>
                        <h3 class="font-bold text-lg brand-font">Boost Your Score</h3>
                        <p class="text-indigo-200 text-xs md:text-sm mt-1">Report on-time rent payments to bureaus.</p>
                    </div>
                    <button onclick="switchTab('settings')" class="w-full md:w-auto bg-white text-indigo-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-50 transition">Enable in Settings</button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-700 mb-4 brand-font">Recent Activity</h3>
                    <div class="space-y-4" id="recent-activity-list">
                        <div class="text-gray-400 text-sm italic">No recent activity</div>
                    </div>
                </div>
            </div>

            <!-- 2. PAYMENTS TAB -->
            <div id="view-payments" class="view-section hidden-section fade-in pb-24">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold brand-font">Payments</h1>
                    <div class="flex items-center gap-1 text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded border border-indigo-100">
                        <i class="fab fa-stripe"></i> <span>Secured by Stripe</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-700">Due Now</h3></div>
                    <div id="unpaid-container" class="divide-y divide-slate-100">
                        <!-- JS INJECTS HERE -->
                    </div>
                </div>
                <h2 class="text-lg font-bold mb-3 brand-font text-slate-700">History</h2>
                <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500"><tr><th class="p-4">Date</th><th class="p-4">Description</th><th class="p-4">Amount</th><th class="p-4 text-right">Action</th></tr></thead>
                        <tbody id="history-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-3" id="history-mobile"></div>
            </div>

            <!-- 3. MESSAGES TAB -->
            <div id="view-messages" class="view-section hidden-section absolute inset-0 pt-16 pb-20 md:pt-0 md:pb-0 z-0 bg-slate-50 flex flex-col fade-in">
                <div class="flex flex-col h-full bg-white md:rounded-xl shadow-sm border-0 md:border border-slate-200 overflow-hidden relative">
                    <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700 flex justify-between items-center shadow-sm z-10 flex-none">
                        <span>Property Manager</span>
                        <span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full font-bold">Online</span>
                    </div>
                    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 space-y-3">
                        <!-- JS INJECTS HERE -->
                    </div>
                    <div class="p-3 border-t border-slate-200 bg-white flex gap-2 flex-none">
                        <input type="text" id="chat-input" class="flex-1 border border-slate-300 p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Type a message...">
                        <button onclick="sendMessage()" class="bg-indigo-600 text-white w-12 h-12 rounded-full font-bold hover:bg-indigo-700 transition flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- 4. MAINTENANCE TAB -->
            <div id="view-maintenance" class="view-section hidden-section fade-in pb-24">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold brand-font">Maintenance</h1>
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm" onclick="toggleModal('requestModal')">+ Request</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700">History</div>
                    <div id="maint-list" class="divide-y divide-slate-100">
                        <!-- JS INJECTS HERE -->
                    </div>
                </div>
            </div>

            <!-- 5. INSURANCE TAB -->
            <div id="view-insurance" class="view-section hidden-section fade-in pb-24">
                <h1 class="text-2xl font-bold mb-4 brand-font">Insurance</h1>
                <div id="insurance-missing" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Upload Policy</h3>
                        <p class="text-slate-500 text-sm mb-4" id="ins-req-text">Upload your declaration page here.</p>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 transition active:bg-slate-100" onclick="uploadInsurance()">
                            <i class="fas fa-cloud-upload-alt text-3xl text-indigo-400 mb-2"></i>
                            <p class="text-sm font-bold text-slate-600">Tap to Upload</p>
                        </div>
                    </div>
                    <div class="bg-indigo-950 p-6 rounded-2xl shadow-lg text-white">
                        <div class="flex items-center gap-2 mb-3"><span class="bg-indigo-500/30 text-indigo-200 text-xs font-bold px-2 py-1 rounded uppercase">Partner</span></div>
                        <h3 class="text-xl font-bold mb-2 brand-font">Need coverage?</h3>
                        <div class="space-y-3">
                            <a href="https://www.lemonade.com" target="_blank" class="block w-full bg-[#FF0083] text-white text-center py-3 rounded-xl font-bold hover:bg-[#D5006D] transition">Get Lemonade Quote</a>
                            <a href="https://www.insurify.com" target="_blank" class="block w-full bg-blue-500 text-white text-center py-3 rounded-xl font-bold hover:bg-blue-600 transition">Compare on Insurify</a>
                        </div>
                    </div>
                </div>
                <div id="insurance-verified" class="hidden-section bg-white p-6 rounded-2xl shadow-sm border border-slate-200 border-l-4 border-l-emerald-500">
                    <div class="flex justify-between items-start mb-4"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600"><i class="fas fa-check"></i></div><div><h3 class="font-bold text-slate-800">Verified</h3><p class="text-xs text-slate-500" id="ins-date">Oct 12, 2023</p></div></div><span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-[10px] font-bold uppercase">Active</span></div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center gap-3"><i class="fas fa-file-pdf text-red-500 text-xl"></i><p class="text-sm font-medium text-slate-800">policy_doc.pdf</p></div>
                    <button onclick="resetInsurance()" class="mt-4 text-xs text-red-400 hover:text-red-500 underline w-full text-center">Remove Policy</button>
                </div>
            </div>

            <!-- 6. SETTINGS TAB -->
            <div id="view-settings" class="view-section hidden-section fade-in pb-24">
                <h1 class="text-2xl font-bold mb-6 brand-font">Account Settings</h1>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <div class="flex items-center gap-4 mb-4 border-b border-slate-100 pb-4">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-lg font-bold display-initials">U</div>
                        <div>
                            <h3 class="font-bold text-slate-800 display-name">User</h3>
                            <p class="text-sm text-slate-500">Resident</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Email</label><p class="text-sm font-medium text-slate-800" id="set-email">...</p></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Phone</label><p class="text-sm font-medium text-slate-800" id="set-phone">...</p></div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">Payment Methods</h3>
                        <i class="fab fa-stripe text-indigo-600 text-2xl"></i>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4 text-center">
                         <p class="text-sm text-slate-600 mb-2">Manage cards and bank accounts securely.</p>
                         <button class="w-full bg-indigo-600 text-white text-sm font-bold rounded-xl py-3 hover:bg-indigo-700 transition" onclick="openStripePortal()">
                            Open Billing Portal
                         </button>
                    </div>
                    
                    <p class="text-xs text-slate-400 mt-2 text-center">
                        <i class="fas fa-lock"></i> Payments are processed securely by Stripe. Kozeyy does not store your card details.
                    </p>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-2">Credit Reporting</h3>
                    <p class="text-sm text-slate-500 mb-4">Report your rent payments to credit bureaus to build your history.</p>
                    <div class="flex items-center justify-between">
                        <div><p class="font-bold text-sm text-indigo-900">Enable Reporting</p><p class="text-xs text-slate-400">$10.00/month</p></div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="toggle-credit" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" onclick="handleCreditToggle()"/><label for="toggle-credit" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div>
                    </div>
                </div>
                <div class="mt-8 text-center"><a href="login.html" class="text-red-500 text-sm font-medium hover:underline">Sign Out</a><p class="text-xs text-slate-300 mt-4">Version 3.6.0 (Calculated Balance)</p></div>
            </div>
        </div>
    </main>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around py-3 z-40 pb-safe">
        <button onclick="switchTab('home')" id="mob-home" class="flex flex-col items-center gap-1 text-slate-400 mobile-active">
            <i class="fas fa-home text-xl"></i><span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="switchTab('payments')" id="mob-payments" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-credit-card text-xl"></i><span class="text-[10px] font-medium">Pay</span>
        </button>
        <button onclick="switchTab('messages')" id="mob-messages" class="flex flex-col items-center gap-1 text-slate-400 relative">
            <i class="fas fa-comment text-xl"></i><span class="text-[10px] font-medium">Chat</span>
            <span id="mob-notif-dot" class="hidden-section absolute top-0 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
        </button>
        <button onclick="switchTab('maintenance')" id="mob-maintenance" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-tools text-xl"></i><span class="text-[10px] font-medium">Fix</span>
        </button>
        <button onclick="switchTab('insurance')" id="mob-insurance" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-shield-alt text-xl"></i><span class="text-[10px] font-medium">Insure</span>
        </button>
    </nav>

    <!-- Maintenance Modal -->
    <div id="requestModal" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md relative">
            <button onclick="toggleModal('requestModal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-4 brand-font">Request Maintenance</h2>
            <form onsubmit="handleMaintSubmit(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Category</label><select id="m-cat" class="w-full border p-3 rounded-xl bg-slate-50 outline-none"><option>Plumbing</option><option>Electrical</option><option>Appliance</option><option>General</option></select></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Description</label><textarea id="m-desc" class="w-full border p-3 rounded-xl bg-slate-50 h-24 outline-none resize-none" placeholder="Describe the issue..." required></textarea></div>
                <div class="flex items-center gap-2"><input type="checkbox" id="entry" class="rounded text-indigo-600 w-5 h-5"><label for="entry" class="text-sm text-slate-600">Permission to enter if I am not home</label></div>
                <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Submit Request</button>
            </form>
        </div>
    </div>

    <!-- INVOICE DETAILS MODAL -->
    <div id="invoiceModal" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="toggleModal('invoiceModal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-1 brand-font">Invoice #<span id="inv-id"></span></h2>
            <p class="text-sm text-slate-500 mb-6" id="inv-date">Oct 24, 2023</p>
            
            <div class="space-y-4">
                <!-- Balance Summary -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between text-xs text-slate-500 mb-1"><span>Rent / Fees</span><span id="inv-prev-bal">$0.00</span></div>
                    <div class="flex justify-between text-xs text-emerald-600 mb-1"><span>Credits Applied</span><span id="inv-prev-pay">$0.00</span></div>
                    <div class="border-t border-slate-200 my-2"></div>
                    <div class="flex justify-between text-sm font-bold text-slate-700"><span>Subtotal</span><span id="inv-fwd-bal">$0.00</span></div>
                </div>

                <!-- Line Items -->
                <div class="border rounded-xl overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase"><tr><th class="p-3">Description</th><th class="p-3 text-right">Amount</th></tr></thead>
                        <tbody id="inv-items-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>

                <!-- Attachment -->
                <div id="inv-attachment" class="hidden-section flex items-center gap-2 text-sm text-indigo-600 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                    <i class="fas fa-paperclip"></i> <span id="inv-doc-name">Document.pdf</span>
                </div>
                
                <!-- Fees Breakdown for Stripe -->
                <div id="inv-fees-section" class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs space-y-1">
                     <div class="flex justify-between text-slate-500">
                         <span>Payment Processing (Stripe)</span>
                         <span id="inv-stripe-fee">$2.99</span>
                     </div>
                </div>

                <!-- Total -->
                <div class="flex justify-between items-center pt-2">
                    <span class="font-bold text-lg text-slate-800">Total Due</span>
                    <span class="font-extrabold text-2xl text-indigo-700" id="inv-total">$0.00</span>
                </div>
                
                <div id="inv-pay-btn-container"></div>
            </div>
        </div>
    </div>

    <!-- Processing Modal -->
    <div id="processingModal" class="hidden-section fixed inset-0 bg-slate-900/80 z-[60] flex flex-col items-center justify-center backdrop-blur-sm text-white">
        <div class="loader mb-4 border-t-white"></div>
        <h2 class="text-xl font-bold mb-2">Connecting to Stripe</h2>
        <p class="text-sm opacity-80">Do not close this window...</p>
    </div>

    <script>
        // --- CONFIG ---
        const FUNCTION_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co/functions/v1/quick-action';
        
        const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
        
        // ** IMPORTANT: REPLACE WITH YOUR STRIPE PUBLISHABLE KEY **
        const STRIPE_PK = 'pk_test_51Sjto1Pss9fRgCwA8IwK1oX4kY4jaAwsPKWE3hCVTCpuv0xmv1iQxOoJ0EFmU1JuKCSnfCYmn8UR1Ygxhp2d0Gyg001o4lzsne'; 
        
        let stripe = null;
        try { stripe = Stripe(STRIPE_PK); } catch(e) { console.error('Stripe Init Error', e); }
        
        let supabaseClient = null;
        if(window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const USER_ID = localStorage.getItem('kozeyy_user_id') || 1; 
        let globalData = { user: null, invoices: [] };

        async function render() {
            if(!supabaseClient) return;

            const [u, i, m, mt] = await Promise.all([
               supabaseClient.from('tenants').select('*').eq('id', USER_ID).single(),
               supabaseClient.from('invoices').select('*').eq('tenant_id', USER_ID),
               supabaseClient.from('msgs').select('*').eq('tenant_id', USER_ID),
               supabaseClient.from('maintenance').select('*').eq('tenant_id', USER_ID)
            ]);

            let user = u.data || { name: "Guest User", email: "guest@example.com", phone: "", unit: "N/A", credit_reporting: false, insurance: false };
            const invoices = i.data || [];
            const msgs = m.data || [];
            const maint = mt.data || [];
            
            globalData.user = user;
            globalData.invoices = invoices;

            const savedProfile = localStorage.getItem('kozeyy_profile');
            let displayName = user.name;
            let displayInitials = user.name ? user.name.charAt(0) : 'U';

            if (savedProfile) {
                try {
                    const profile = JSON.parse(savedProfile);
                    if(profile.role === 'tenant') {
                        displayName = profile.username || user.name;
                        displayInitials = profile.initials || displayInitials;
                    }
                } catch(e) {}
            }

            document.getElementById('user-name').innerText = displayName;
            document.querySelectorAll('.display-name').forEach(el => el.innerText = displayName);
            document.querySelectorAll('.display-initials').forEach(el => el.innerText = displayInitials);
            document.getElementById('set-email').innerText = user.email || 'N/A';
            document.getElementById('set-phone').innerText = user.phone || 'N/A';
            
            if(user.unit && user.unit.trim() !== '') {
                document.getElementById('unit-info-container').classList.remove('hidden-section');
                document.getElementById('display-unit').innerText = user.unit;
            } else {
                document.getElementById('unit-info-container').classList.add('hidden-section');
            }

            if(user.insurance) {
                 document.getElementById('insurance-missing').classList.add('hidden-section');
                 document.getElementById('insurance-verified').classList.remove('hidden-section');
            } else {
                 document.getElementById('insurance-missing').classList.remove('hidden-section');
                 document.getElementById('insurance-verified').classList.add('hidden-section');
            }
            
            // --- UPDATED CREDIT LOGIC IN RENDER ---
            document.getElementById('toggle-credit').checked = user.credit_reporting;
            
            if(user.credit_reporting) {
                document.getElementById('credit-banner').classList.add('hidden-section');
            } else {
                document.getElementById('credit-banner').classList.remove('hidden-section');
            }

            // --- CALCULATE UNPAID BALANCE (TOTAL - AMOUNT_PAID) ---
            const unpaid = invoices.filter(i => {
                const bal = i.total - (i.amount_paid || 0);
                return bal > 0 && i.status !== 'Paid';
            });
            const totalDue = unpaid.reduce((sum, i) => sum + (i.total - (i.amount_paid || 0)), 0);

            document.getElementById('total-balance').innerText = `$${totalDue.toLocaleString()}`;
            const badge = document.getElementById('payment-status-badge');
            const uCont = document.getElementById('unpaid-container'); 
            
            if(totalDue > 0) { 
                badge.className = "bg-rose-100 text-rose-700 text-xs px-3 py-1 rounded-full font-bold uppercase"; badge.innerText = `${unpaid.length} Due`; 
                document.getElementById('payment-due-date').innerText = `Due: ${unpaid[0].date || 'Immediately'}`; 
                
                uCont.innerHTML = '';
                unpaid.forEach(i => { 
                    const currentBalance = i.total - (i.amount_paid || 0);
                    
                    let itemsHtml = `<ul class="text-xs text-slate-500 mt-2 space-y-1">`; 
                    const items = i.items || [{desc: 'Balance', amount: i.total}]; 
                    items.slice(0, 2).forEach(item => { itemsHtml += `<li class="flex justify-between w-full max-w-xs border-b border-dashed border-slate-200 pb-1"><span>${item.desc}</span> <span>$${item.amount}</span></li>`; });
                    if (items.length > 2) itemsHtml += `<li class="text-[10px] text-slate-400 italic">+ ${items.length - 2} more items</li>`;
                    itemsHtml += `</ul>`; 
                    
                    uCont.innerHTML += `
                    <div class="p-4 md:p-6 flex flex-col md:flex-row justify-between items-start md:items-center hover:bg-slate-50 transition border-b border-slate-100 gap-4">
                        <div class="w-full md:w-auto">
                            <div class="flex items-center gap-2">
                                <p class="font-bold text-lg text-slate-800">Invoice #${i.id}</p>
                                <button onclick="viewInvoice(${i.id})" class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded text-slate-600 font-bold transition"><i class="fas fa-eye mr-1"></i> View Details</button>
                            </div>
                            ${itemsHtml}
                            <p class="text-xs text-rose-500 mt-2 font-bold">Due: ${i.date || 'Immediate'}</p>
                        </div>
                        <div class="flex items-center justify-between w-full md:w-auto gap-4">
                            <div class="text-right md:text-left"><span class="font-extrabold text-2xl text-slate-900">$${currentBalance.toLocaleString()}</span></div>
                            <button onclick="initStripePayment(${i.id}, ${currentBalance})" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm flex items-center gap-2">
                                <span>Pay Now</span>
                                <i class="fas fa-lock text-[10px] opacity-70"></i>
                            </button>
                        </div>
                    </div>`; 
                });
            } else { 
                badge.className = "bg-emerald-100 text-emerald-700 text-xs px-3 py-1 rounded-full font-bold uppercase"; badge.innerText = "All Paid"; 
                document.getElementById('payment-due-date').innerText = "No upcoming payments";
                
                uCont.innerHTML = `
                <div class="p-8 text-center text-slate-400 flex flex-col items-center">
                    <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-check text-emerald-400 text-xl"></i>
                    </div>
                    <p class="text-sm font-medium text-slate-600">You're all caught up!</p>
                    <p class="text-xs text-slate-400">No payments due.</p>
                </div>`;
            }

            const hBody = document.getElementById('history-body'); const hMob = document.getElementById('history-mobile');
            hBody.innerHTML = ''; hMob.innerHTML = '';
            const historyItems = invoices.filter(i => i.status === 'Paid');
            if(historyItems.length === 0) {
                hMob.innerHTML = '<div class="text-center text-slate-400 text-sm py-4">No payment history</div>';
                hBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">No payment history</td></tr>';
            } else {
                historyItems.forEach(i => { 
                    // History just shows Total paid
                    const totalAmt = i.total; 
                    hBody.innerHTML += `<tr class="hover:bg-slate-50 transition border-b border-slate-100"><td class="p-4 text-slate-500">${i.paid_date || i.date || '-'}</td><td class="p-4 text-slate-800 font-medium">Invoice #${i.id}</td><td class="p-4 font-bold">$${totalAmt.toLocaleString()}</td><td class="p-4 text-right"><button onclick="viewInvoice(${i.id})" class="text-indigo-600 font-bold text-xs hover:underline">View</button> <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold uppercase ml-2">Paid</span></td></tr>`; 
                    hMob.innerHTML += `<div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center" onclick="viewInvoice(${i.id})"><div><p class="font-bold text-slate-800 text-sm">Invoice #${i.id}</p><p class="text-xs text-slate-500">${i.paid_date || i.date}</p></div><div class="text-right"><p class="font-bold text-slate-900">$${totalAmt.toLocaleString()}</p><span class="text-[10px] font-bold text-emerald-600 uppercase">Paid</span></div></div>`;
                });
            }

            const chatBox = document.getElementById('chat-messages'); 
            if(msgs.length === 0) {
                chatBox.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-400 opacity-60"><i class="fas fa-comment-slash text-4xl mb-2"></i><p class="text-sm">No messages yet</p></div>`;
            } else {
                const newChatHTML = msgs.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at)).map(m => {
                    const align = m.from === 'Tenant' ? 'justify-end' : 'justify-start'; 
                    const color = m.from === 'Tenant' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'; 
                    return `<div class="flex ${align}"><div class="max-w-[80%] px-4 py-2 rounded-2xl ${color} text-sm shadow-sm">${m.text}</div></div>`;
                }).join('');
                if (chatBox.innerHTML !== newChatHTML) { chatBox.innerHTML = newChatHTML; chatBox.scrollTop = chatBox.scrollHeight; }
            }

            const maintList = document.getElementById('maint-list'); 
            if (maint.length === 0) { 
                maintList.innerHTML = `<div class="p-8 text-center text-slate-400 flex flex-col items-center"><i class="fas fa-check-circle text-3xl text-emerald-100 mb-2"></i><p class="text-sm">No maintenance requests found</p></div>`; 
            } else {
                maintList.innerHTML = '';
                maint.forEach(m => { const statusColor = m.status === 'Active' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'; const notes = m.notes ? `<p class="text-xs text-slate-500 mt-1 italic border-l-2 border-slate-300 pl-2">"${m.notes}"</p>` : ''; maintList.innerHTML += `<div class="p-4 flex flex-col hover:bg-slate-50 transition border-b border-slate-100"><div class="flex justify-between items-start"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 text-xs"><i class="fas fa-wrench"></i></div><div><h4 class="font-bold text-sm text-slate-800">${m.issue}</h4><p class="text-xs text-slate-400">${m.date}</p></div></div><span class="${statusColor} px-2 py-1 rounded-full text-[10px] font-bold uppercase">${m.status}</span></div>${notes}</div>`; });
            }
        }

        // --- NEW: HANDLE URL RETURNS (UPDATE DB ON SUCCESS) ---
        async function checkReturnParams() {
            const params = new URLSearchParams(window.location.search);
            
            // 1. CREDIT SUBSCRIPTION SUCCESS
            if (params.get('sub') === 'active') {
                toggleModal('processingModal'); // Briefly show loading
                try {
                    // Update Database
                    await supabaseClient.from('tenants').update({ credit_reporting: true }).eq('id', USER_ID);
                    
                    // Update Local State immediately for speed
                    if (globalData.user) globalData.user.credit_reporting = true;
                    
                    alert("Credit Reporting Activated Successfully! ðŸš€\nYour on-time payments will now be reported.");
                    
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Refresh View
                    render();
                } catch(e) { console.error(e); }
                toggleModal('processingModal'); // Hide loading
            }
            
            // 2. RENT PAYMENT SUCCESS
            if (params.get('success') === 'true') {
                alert("Payment Successful! Thank you.");
                window.history.replaceState({}, document.title, window.location.pathname);
                render();
            }
        }

        function viewInvoice(id) {
            const inv = globalData.invoices.find(i => i.id === id);
            if(!inv) return;

            document.getElementById('inv-id').innerText = inv.id;
            document.getElementById('inv-date').innerText = new Date(inv.date).toLocaleDateString();
            
            const prevBal = 0; // Using 0 for simplicity if snapshot missing
            const currentBalance = inv.total - (inv.amount_paid || 0);
            const stripeFee = 2.99; 
            
            // Update Modal UI with calculated balance
            document.getElementById('inv-prev-bal').innerText = `$${prevBal.toLocaleString()}`;
            document.getElementById('inv-prev-pay').innerText = `$${(inv.amount_paid || 0).toLocaleString()}`;
            document.getElementById('inv-fwd-bal').innerText = `$${currentBalance.toLocaleString()}`;
            
            const tbody = document.getElementById('inv-items-body');
            tbody.innerHTML = '';
            (inv.items || []).forEach(item => {
                tbody.innerHTML += `<tr><td class="p-3 text-slate-700">${item.desc}</td><td class="p-3 text-right font-medium">$${item.amount.toLocaleString()}</td></tr>`;
            });

            const attEl = document.getElementById('inv-attachment');
            if(inv.doc) {
                attEl.classList.remove('hidden-section');
                document.getElementById('inv-doc-name').innerText = inv.doc;
            } else {
                attEl.classList.add('hidden-section');
            }

            const feeSection = document.getElementById('inv-fees-section');
            const totalEl = document.getElementById('inv-total');
            
            if(currentBalance <= 0 || inv.status === 'Paid') {
                feeSection.classList.add('hidden-section');
                totalEl.innerText = `$0.00`;
                document.getElementById('inv-pay-btn-container').innerHTML = `<div class="w-full bg-emerald-100 text-emerald-700 text-center py-3 rounded-xl font-bold uppercase mt-4">Paid on ${inv.paid_date || 'Unknown'}</div>`;
            } else {
                feeSection.classList.remove('hidden-section');
                totalEl.innerText = `$${(currentBalance + stripeFee).toLocaleString()}`;
                document.getElementById('inv-stripe-fee').innerText = `$${stripeFee.toFixed(2)}`;
                document.getElementById('inv-pay-btn-container').innerHTML = `
                <button onclick="initStripePayment(${inv.id}, ${currentBalance})" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold mt-4 hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-2"><i class="fas fa-lock"></i> Pay with Stripe</button>
                <button onclick="toggleModal('invoiceModal')" class="w-full text-slate-400 text-xs font-bold mt-3 hover:text-slate-600">Cancel</button>`;
            }
            toggleModal('invoiceModal');
        }

        // --- REAL STRIPE ACTIONS (SUPABASE EDGE) ---

        async function initStripePayment(invoiceId, baseAmount) {
            toggleModal('invoiceModal');
            toggleModal('processingModal');

            try {
                const response = await fetch(FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}` 
                    },
                    body: JSON.stringify({
                        action: 'create-checkout-session',
                        invoiceId: invoiceId,
                        amount: baseAmount,
                        tenantId: USER_ID
                    })
                });

                const session = await response.json();
                if(session.error) throw new Error(session.error);

                const result = await stripe.redirectToCheckout({ sessionId: session.id });
                if (result.error) throw new Error(result.error.message);

            } catch (err) {
                toggleModal('processingModal');
                alert("Payment Error: " + err.message);
            }
        }

       async function handleCreditToggle() {
            const checkBox = document.getElementById('toggle-credit');
            
            // CASE 1: TURNING ON (Subscribe)
            if (checkBox.checked) {
                const msg = "Activate Credit Reporting ($10/mo)?\nProceed to secure payment?";
                if(confirm(msg)) {
                    toggleModal('processingModal');
                    try {
                        const response = await fetch(FUNCTION_URL, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_KEY}` 
                            },
                            body: JSON.stringify({ action: 'subscribe', tenantId: USER_ID })
                        });
                        
                        const data = await response.json();

                        // --- NEW: CATCH BACKEND ERRORS SPECIFICALLY ---
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        if(data.url) window.location.href = data.url; 
                        else throw new Error("No URL returned from Stripe");

                    } catch(err) {
                        toggleModal('processingModal');
                        alert("Error: " + err.message); // <--- THIS WILL NOW SHOW THE REAL REASON
                        checkBox.checked = false; // Reset UI
                    }
                } else {
                    checkBox.checked = false; 
                }
            } 
            
            // CASE 2: TURNING OFF (Cancel)
            else {
                checkBox.checked = true; 
                const msg = "To prevent accidental double-billing, please cancel directly in the Billing Portal.\n\nYour subscription will remain active until the end of the current billing period.";
                if(confirm(msg)) {
                    openStripePortal();
                }
            }
        }

        async function openStripePortal() {
            toggleModal('processingModal');
            try {
                const response = await fetch(FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${SUPABASE_KEY}` 
                    },
                    body: JSON.stringify({ action: 'create-portal-session', tenantId: USER_ID })
                });
                const data = await response.json();
                if(data.url) window.location.href = data.url;
                else throw new Error("Failed to create portal session");
            } catch(err) {
                toggleModal('processingModal');
                alert("Error: " + err.message);
            }
        }
        
        // --- OTHER ACTIONS ---

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            if(input.value.trim()) {
                await supabaseClient.from('msgs').insert([{ tenant_id: USER_ID, from: 'Tenant', text: input.value.trim(), time: new Date().toISOString() }]);
                input.value = ''; render();
            }
        }

        async function handleMaintSubmit(e) {
            e.preventDefault();
            const desc = document.getElementById('m-desc').value;
            const cat = document.getElementById('m-cat').value;
            if(desc) {
                await supabaseClient.from('maintenance').insert([{ tenant_id: USER_ID, issue: `${cat}: ${desc}`, status: 'Active', date: new Date().toISOString(), notes: '' }]);
                toggleModal('requestModal'); e.target.reset(); render();
            }
        }
        
        async function uploadInsurance() {
            const input = document.createElement('input'); input.type = 'file'; 
            input.onchange = async () => { await supabaseClient.from('tenants').update({ insurance: true }).eq('id', USER_ID); alert("Uploaded!"); render(); }; 
            input.click();
        }

        async function resetInsurance() {
            if(confirm("Remove policy?")) { await supabaseClient.from('tenants').update({ insurance: false }).eq('id', USER_ID); render(); }
        }

        function switchTab(t) { 
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-section')); 
            document.getElementById(`view-${t}`).classList.remove('hidden-section'); 
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('sidebar-active')); 
            const deskLink = document.getElementById(`nav-${t}`); if(deskLink) deskLink.classList.add('sidebar-active');
            document.querySelectorAll('.md\\:hidden button').forEach(e => e.classList.remove('mobile-active', 'text-indigo-600'));
            document.querySelectorAll('.md\\:hidden button').forEach(e => e.classList.add('text-slate-400'));
            const mobBtn = document.getElementById(`mob-${t}`); if(mobBtn) { mobBtn.classList.add('mobile-active'); mobBtn.classList.remove('text-slate-400'); }
            const titles = { home:'Resident Portal', payments:'Payments', messages:'Messages', maintenance:'Maintenance', insurance:'Insurance', settings:'Account Settings' };
            const titleEl = document.getElementById('page-title'); if(titleEl) titleEl.innerText = titles[t] || 'Kozeyy';
        }

        function toggleModal(id) { const el = document.getElementById(id); if(el) el.classList.toggle('hidden-section'); }

        // Start App
        render();
        // Check for returns from Stripe immediately
        checkReturnParams();

    </script>
</body>
</html>
