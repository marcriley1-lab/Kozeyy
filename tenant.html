
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resident Portal | Kozeyy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .brand-font { font-family: 'Outfit', sans-serif; }
        
        .sidebar-active { background-color: #312e81; border-left: 4px solid #6366f1; color: white !important; }
        .mobile-active { color: #4F46E5 !important; }
        .nav-item { color: #94a3b8; }
        .nav-item:hover { color: white; background-color: #312e81; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50">

    <aside class="w-64 bg-indigo-950 flex-col transition-all duration-300 hidden md:flex shadow-xl z-20">
        <div class="h-20 flex items-center px-6 border-b border-indigo-900 bg-indigo-950 gap-3">
            <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
            </svg>
            <span class="text-xl font-bold text-white tracking-tight brand-font">Kozeyy</span>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="#" onclick="switchTab('home')" id="nav-home" class="nav-item flex items-center px-6 py-3.5 transition sidebar-active">
                <i class="fas fa-home w-6"></i> <span class="font-medium ml-3">Home</span>
            </a>
            <a href="#" onclick="switchTab('payments')" id="nav-payments" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-credit-card w-6"></i> <span class="font-medium ml-3">Payments</span>
            </a>
            <a href="#" onclick="switchTab('messages')" id="nav-messages" class="nav-item flex items-center justify-between px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-comment w-6"></i> <span class="font-medium ml-3">Messages</span></div>
                <span id="desk-notif-dot" class="hidden-section w-2.5 h-2.5 bg-red-500 rounded-full"></span>
            </a>
            <a href="#" onclick="switchTab('maintenance')" id="nav-maintenance" class="nav-item flex items-center px-6 py-3.5 transition">
                <div class="flex items-center"><i class="fas fa-tools w-6"></i> <span class="font-medium ml-3">Maintenance</span></div>
            </a>
            <a href="#" onclick="switchTab('insurance')" id="nav-insurance" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-shield-alt w-6"></i> <span class="font-medium ml-3">Insurance</span>
            </a>
            <a href="#" onclick="switchTab('settings')" id="nav-settings" class="nav-item flex items-center px-6 py-3.5 transition">
                <i class="fas fa-cog w-6"></i> <span class="font-medium ml-3">Settings</span>
            </a>
        </nav>

        <div class="p-6 border-t border-indigo-900 bg-indigo-950 flex flex-col gap-2">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-xs display-initials">U</div>
                <div>
                    <p class="font-bold text-white text-sm" id="user-name">Loading...</p>
                    <p class="text-xs text-indigo-300">Resident</p>
                </div>
            </div>
            <a href="login.html" class="text-xs text-indigo-400 hover:text-white mt-2 flex items-center"><i class="fas fa-sign-out-alt mr-2"></i> Sign Out</a>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative pb-20 md:pb-0 h-[100dvh]">
        <header class="hidden md:flex h-20 bg-white border-b border-slate-200 items-center justify-between px-8 shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800 brand-font" id="page-title">Resident Portal</h2>
            <div class="flex items-center gap-6">
                <div class="relative cursor-pointer hover:text-indigo-600 transition" onclick="switchTab('messages')">
                    <i class="fas fa-bell text-lg text-slate-400"></i>
                </div>
            </div>
        </header>

        <header class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-30 flex-none">
            <div class="flex items-center gap-2">
                <svg width="28" height="28" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="6" width="10" height="28" rx="2" fill="#6366f1" />
                    <path d="M18 18L30 6H34C35.1046 6 36 6.89543 36 8V10L22 22H18V18Z" fill="#6366f1" fill-opacity="0.8" />
                    <path d="M22 24L36 38V40C36 41.1046 35.1046 42 34 42H30L18 30V24H22Z" transform="translate(0 -2)" fill="#6366f1" fill-opacity="0.9" />
                </svg>
                <h2 class="text-lg font-bold text-slate-800 brand-font">Kozeyy</h2>
            </div>
            <div class="flex items-center gap-3" onclick="switchTab('settings')">
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold display-initials cursor-pointer border border-indigo-200">U</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth no-scrollbar">
            
            <div id="view-home" class="view-section fade-in pb-24">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 brand-font">Hi, <span class="display-name">...</span> ðŸ‘‹</h1>
                        <p id="unit-info-container" class="text-slate-500 text-sm mt-1 hidden-section">Unit <span id="display-unit">...</span></p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-500 text-xs uppercase tracking-wider">Current Balance</h3>
                            <div class="text-4xl font-extrabold text-slate-900 mt-2 brand-font" id="total-balance">$0.00</div>
                        </div>
                        <span id="payment-status-badge" class="bg-emerald-100 text-emerald-700 text-xs px-3 py-1 rounded-full font-bold uppercase">All Paid</span>
                    </div>
                    <p class="text-slate-500 text-sm mb-6" id="payment-due-date">No upcoming payments</p>
                    <button onclick="switchTab('payments')" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/20 active:scale-95 transform duration-100 flex items-center justify-center gap-2">
                        <span>Make a Payment</span>
                        <i class="fas fa-arrow-right text-xs"></i>
                    </button>
                </div>

                <div id="credit-banner" class="hidden-section bg-gradient-to-r from-slate-800 to-indigo-900 rounded-2xl p-6 text-white flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg mb-6 gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2"><i class="fas fa-chart-line text-indigo-300"></i><span class="text-xs font-bold uppercase tracking-wide opacity-80">Credit Builder</span></div>
                        <h3 class="font-bold text-lg brand-font">Boost Your Score</h3>
                        <p class="text-indigo-200 text-xs md:text-sm mt-1">Report on-time rent payments to bureaus.</p>
                    </div>
                    <button onclick="switchTab('settings')" class="w-full md:w-auto bg-white text-indigo-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-50 transition">Enable in Settings</button>
                </div>

            </div>

            <div id="view-payments" class="view-section hidden-section fade-in pb-24">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold brand-font">Payments</h1>
                    <div class="flex items-center gap-1 text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded border border-indigo-100">
                        <i class="fab fa-stripe"></i> <span>Secured by Stripe</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-700">Due Now</h3></div>
                    <div id="unpaid-container" class="divide-y divide-slate-100">
                        </div>
                </div>
                <h2 class="text-lg font-bold mb-3 brand-font text-slate-700">History</h2>
                <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500"><tr><th class="p-4">Date</th><th class="p-4">Description</th><th class="p-4">Amount</th><th class="p-4 text-right">Action</th></tr></thead>
                        <tbody id="history-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-3" id="history-mobile"></div>
            </div>

            <div id="view-messages" class="view-section hidden-section absolute inset-0 pt-16 pb-20 md:pt-0 md:pb-0 z-0 bg-slate-50 flex flex-col fade-in">
                <div class="flex flex-col h-full bg-white md:rounded-xl shadow-sm border-0 md:border border-slate-200 overflow-hidden relative">
                    <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700 flex justify-between items-center shadow-sm z-10 flex-none">
                        <span id="msg-header-name">Property Manager</span>
                        <span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full font-bold">Online</span>
                    </div>
                    <div id="chat-messages" class="flex-1 p-6 pt-10 overflow-y-auto bg-slate-50 space-y-3">
                        </div>
                    <div class="p-3 border-t border-slate-200 bg-white flex gap-2 flex-none">
                        <input type="text" id="chat-input" class="flex-1 border border-slate-300 p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Type a message...">
                        <button onclick="sendMessage()" class="bg-indigo-600 text-white w-12 h-12 rounded-full font-bold hover:bg-indigo-700 transition flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <div id="view-maintenance" class="view-section hidden-section fade-in pb-24">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold brand-font">Maintenance</h1>
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm" onclick="toggleModal('requestModal')">+ Request</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700">History</div>
                    <div id="maint-list" class="divide-y divide-slate-100">
                        </div>
                </div>
            </div>

            <div id="view-insurance" class="view-section hidden-section fade-in pb-24">
                <h1 class="text-2xl font-bold mb-4 brand-font">Insurance</h1>
                <div id="insurance-missing" class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Upload Policy</h3>
                        <p class="text-slate-500 text-sm mb-4" id="ins-req-text">Upload your declaration page here.</p>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 transition active:bg-slate-100" onclick="uploadInsurance()">
                            <i class="fas fa-cloud-upload-alt text-3xl text-indigo-400 mb-2"></i>
                            <p class="text-sm font-bold text-slate-600">Tap to Upload</p>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-950 p-6 rounded-2xl shadow-lg text-white">
                        <h3 class="text-xl font-bold mb-4 brand-font">Need coverage?</h3>
                        
                        <div class="space-y-3">
                            <a href="https://www.lemonade.com" target="_blank" class="block w-full bg-[#FF0083] text-white text-center py-3 rounded-xl font-bold hover:bg-[#D5006D] transition">
                                Get Lemonade Quote
                            </a>
                            <a href="https://www.insurify.com" target="_blank" class="block w-full bg-blue-500 text-white text-center py-3 rounded-xl font-bold hover:bg-blue-600 transition">
                                Compare on Insurify
                            </a>
                        </div>

                        <p class="text-[10px] text-indigo-300 mt-4 text-center opacity-70 leading-tight">
                            * Disclosure: Kozeyy may receive a commission if you purchase a policy through these links. This helps support our platform.
                        </p>
                    </div>
                </div>
                
                <div id="insurance-verified" class="hidden-section bg-white p-6 rounded-2xl shadow-sm border border-slate-200 border-l-4 border-l-emerald-500">
                    <div class="flex justify-between items-start mb-4"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600"><i class="fas fa-check"></i></div><div><h3 class="font-bold text-slate-800">Verified</h3><p class="text-xs text-slate-500" id="ins-date">Oct 12, 2023</p></div></div><span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-[10px] font-bold uppercase">Active</span></div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center gap-3"><i class="fas fa-file-pdf text-red-500 text-xl"></i><p class="text-sm font-medium text-slate-800">policy_doc.pdf</p></div>
                    <button onclick="resetInsurance()" class="mt-4 text-xs text-red-400 hover:text-red-500 underline w-full text-center">Remove Policy</button>
                </div>
            </div>

            <div id="view-settings" class="view-section hidden-section fade-in pb-24">
                <h1 class="text-2xl font-bold mb-6 brand-font">Account Settings</h1>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <div class="flex items-center gap-4 mb-4 border-b border-slate-100 pb-4">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-lg font-bold display-initials">U</div>
                        <div>
                            <h3 class="font-bold text-slate-800 display-name">User</h3>
                            <p class="text-sm text-slate-500">Resident</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Email</label><p class="text-sm font-medium text-slate-800" id="set-email">...</p></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Phone</label><p class="text-sm font-medium text-slate-800" id="set-phone">...</p></div>
                    </div>
                    <div class="mt-4 border-t border-slate-100 pt-4">
                        <button onclick="toggleModal('settingsModal')" class="text-indigo-600 text-sm font-bold hover:underline">Edit Profile</button>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">Payment Methods</h3>
                        <i class="fab fa-stripe text-indigo-600 text-2xl"></i>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4 text-center">
                         <p class="text-sm text-slate-600 mb-2">Manage cards and bank accounts securely.</p>
                         <button class="w-full bg-indigo-600 text-white text-sm font-bold rounded-xl py-3 hover:bg-indigo-700 transition" onclick="openStripePortal()">
                            Open Billing Portal
                         </button>
                    </div>
                    
                    <p class="text-xs text-slate-400 mt-2 text-center">
                        <i class="fas fa-lock"></i> Payments are processed securely by Stripe. Kozeyy does not store your card details.
                    </p>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-2">Credit Reporting</h3>
                    <p class="text-sm text-slate-500 mb-4">Report your rent payments to credit bureaus to build your history.</p>
                    <div class="flex items-center justify-between">
                        <div><p class="font-bold text-sm text-indigo-900">Enable Reporting</p><p class="text-xs text-slate-400">$10.00/month</p></div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="toggle-credit" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" onclick="handleCreditToggle()"/><label for="toggle-credit" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div>
                    </div>
                </div>
                <div class="mt-8 text-center"><a href="login.html" class="text-red-500 text-sm font-medium hover:underline">Sign Out</a><p class="text-xs text-slate-300 mt-4">Version 3.8.0 (Live Chat)</p></div>
            </div>
        </div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around py-3 z-40 pb-safe">
        <button onclick="switchTab('home')" id="mob-home" class="flex flex-col items-center gap-1 text-slate-400 mobile-active">
            <i class="fas fa-home text-xl"></i><span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="switchTab('payments')" id="mob-payments" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-credit-card text-xl"></i><span class="text-[10px] font-medium">Pay</span>
        </button>
        <button onclick="switchTab('messages')" id="mob-messages" class="flex flex-col items-center gap-1 text-slate-400 relative">
            <i class="fas fa-comment text-xl"></i><span class="text-[10px] font-medium">Chat</span>
            <span id="mob-notif-dot" class="hidden-section absolute top-0 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
        </button>
        <button onclick="switchTab('maintenance')" id="mob-maintenance" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-tools text-xl"></i><span class="text-[10px] font-medium">Fix</span>
        </button>
        <button onclick="switchTab('insurance')" id="mob-insurance" class="flex flex-col items-center gap-1 text-slate-400">
            <i class="fas fa-shield-alt text-xl"></i><span class="text-[10px] font-medium">Insure</span>
        </button>
    </nav>

    <div id="requestModal" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md relative">
            <button onclick="toggleModal('requestModal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-4 brand-font">Request Maintenance</h2>
            <form onsubmit="handleMaintSubmit(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Category</label><select id="m-cat" class="w-full border p-3 rounded-xl bg-slate-50 outline-none"><option>Plumbing</option><option>Electrical</option><option>Appliance</option><option>General</option></select></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Description</label><textarea id="m-desc" class="w-full border p-3 rounded-xl bg-slate-50 h-24 outline-none resize-none" placeholder="Describe the issue..." required></textarea></div>
                <div class="flex items-center gap-2"><input type="checkbox" id="entry" class="rounded text-indigo-600 w-5 h-5"><label for="entry" class="text-sm text-slate-600">Permission to enter if I am not home</label></div>
                <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Submit Request</button>
            </form>
        </div>
    </div>

    <div id="invoiceModal" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button onclick="toggleModal('invoiceModal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-10"><i class="fas fa-times text-xl"></i></button>
            
            <div id="invoice-paper" class="p-4">
                <div class="flex justify-between items-start border-b border-slate-100 pb-4 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold brand-font text-slate-800">INVOICE</h2>
                        <p class="text-xs text-slate-500 uppercase tracking-wide">Kozeyy Property Mgmt</p>
                    </div>
                    <div class="text-right">
                        <h2 class="text-lg font-bold text-slate-600 mb-1">#<span id="inv-id"></span></h2>
                        <p class="text-sm text-slate-500" id="inv-date">Oct 24, 2023</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="flex justify-between text-xs text-slate-500 mb-1"><span>Total</span><span id="inv-prev-bal">$0.00</span></div>
                        <div class="flex justify-between text-xs text-emerald-600 mb-1"><span>Paid</span><span id="inv-prev-pay">$0.00</span></div>
                        <div class="border-t border-slate-200 my-2"></div>
                        <div class="flex justify-between text-sm font-bold text-slate-700"><span>Due</span><span id="inv-fwd-bal">$0.00</span></div>
                    </div>

                    <div class="border rounded-xl overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase"><tr><th class="p-3">Description</th><th class="p-3 text-right">Amount</th></tr></thead>
                            <tbody id="inv-items-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-8 pt-4 border-t border-slate-100 text-center">
                        <p class="text-xs text-slate-400">Thank you for your timely payment.</p>
                    </div>
                </div>
            </div>
            <div id="inv-attachment" class="hidden-section flex items-center gap-2 text-sm text-indigo-600 bg-indigo-50 p-3 rounded-lg border border-indigo-100 mt-4">
                <i class="fas fa-paperclip"></i> <span id="inv-doc-name">Document.pdf</span>
            </div>
            
            <div id="inv-fees-section" class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs space-y-2 mt-4">
                 <div class="flex justify-between text-slate-500 font-bold border-b border-slate-200 pb-1">
                     <span>Payment Options & Fees</span>
                 </div>
                 <div class="text-slate-500">
                    <div class="flex justify-between"><span>â€¢ Bank Transfer (ACH)</span> <span>+$2.50</span></div>
                    <div class="flex justify-between"><span>â€¢ Credit/Debit Card</span> <span>+2.9%</span></div>
                 </div>
            </div>

            <div class="flex justify-between items-center pt-4 mt-2">
                <span class="font-bold text-lg text-slate-800">Total Due</span>
                <span class="font-extrabold text-2xl text-slate-700" id="inv-total">$0.00</span>
            </div>
            
            <button onclick="downloadInvoicePDF()" class="w-full mt-3 border border-slate-300 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-50 flex items-center justify-center gap-2">
                <i class="fas fa-download"></i> Download PDF
            </button>

            <div id="inv-pay-btn-container" class="mt-2"></div>
        </div>
    </div>

    <div id="settingsModal" class="hidden-section fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm relative">
            <button onclick="toggleModal('settingsModal')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-4 brand-font">Edit Profile</h2>
            <form onsubmit="handleSettingsUpdate(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Email</label><input id="edit-email" type="email" class="w-full border p-3 rounded-xl bg-slate-50" required></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Phone</label><input id="edit-phone" type="tel" class="w-full border p-3 rounded-xl bg-slate-50"></div>
                <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="processingModal" class="hidden-section fixed inset-0 bg-slate-900/80 z-[60] flex flex-col items-center justify-center backdrop-blur-sm text-white">
        <div class="loader mb-4 border-t-white"></div>
        <h2 class="text-xl font-bold mb-2">Connecting to Stripe</h2>
        <p class="text-sm opacity-80">Do not close this window...</p>
    </div>

    <script>
        const storedId = localStorage.getItem('kozeyy_user_id');
        const storedRole = localStorage.getItem('kozeyy_role');

        if (!storedId || storedRole !== 'tenant') {
            window.location.href = 'login.html';
        }
        
        // --- CONFIG ---
        const FUNCTION_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co/functions/v1/quick-action';
        const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
        // ** REPLACE WITH LIVE KEY WHEN READY **
        const STRIPE_PK = 'pk_test_51Sjto1Pss9fRgCwA8IwK1oX4kY4jaAwsPKWE3hCVTCpuv0xmv1iQxOoJ0EFmU1JuKCSnfCYmn8UR1Ygxhp2d0Gyg001o4lzsne'; 
        
        let stripe = null;
        try { stripe = Stripe(STRIPE_PK); } catch(e) { console.error('Stripe Init Error', e); }
        
        let supabaseClient = null;
        if(window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // --- USER ID LOGIC ---
        const USER_ID = localStorage.getItem('kozeyy_user_id'); 
        
        let globalData = { user: null, invoices: [], msgs: [], maint: [] };
        let locallyReadIds = new Map(JSON.parse(localStorage.getItem('kozeyy_read_map') || '[]'));
        let optimisticMaint = JSON.parse(localStorage.getItem('kozeyy_opt_maint') || '[]');
        
        let lastRenderedState = { invoices: "", msgs: "", maint: "", user: "" };
        let notifications = { messages: false, maintenance: false };
        let lastMaintHash = "";
        let activeTab = "home"; 

        // --- MAIN RENDER FUNCTION ---
        async function render(skipFetch = false) {
            if(!supabaseClient) return;

            if(!skipFetch) {
                const [u, i, m, mt] = await Promise.all([
                   supabaseClient.from('tenants').select('*').eq('id', USER_ID).single(),
                   supabaseClient.from('invoices').select('*').eq('tenant_id', USER_ID),
                   supabaseClient.from('msgs').select('*').eq('tenant_id', USER_ID),
                   supabaseClient.from('maintenance').select('*').eq('tenant_id', USER_ID)
                ]);

                globalData.user = u.data || { name: "Guest User", email: "", phone: "", unit: "N/A", credit_reporting: false, insurance: false };
                globalData.invoices = i.data || [];
                
                // Fetch Owner Name Logic
                if (globalData.user && globalData.user.owner_id) {
                    const { data: owner } = await supabaseClient.from('owners').select('name').eq('id', globalData.user.owner_id).maybeSingle();
                    if (owner && owner.name) {
                        const headerName = document.getElementById('msg-header-name');
                        if (headerName) headerName.innerText = owner.name;
                    }
                }
                
                // Message Merge
                const serverMsgs = m.data || [];
                serverMsgs.forEach(msg => {
                    if(locallyReadIds.has(msg.id)) {
                        if(msg.read_at) { locallyReadIds.delete(msg.id); localStorage.setItem('kozeyy_read_map', JSON.stringify([...locallyReadIds])); } 
                        else { msg.read_at = locallyReadIds.get(msg.id); }
                    }
                });
                globalData.msgs = serverMsgs;
                
                // Maintenance Merge
                globalData.maint = mt.data || [];
                if(optimisticMaint.length > 0) {
                     const serverDates = new Set(globalData.maint.map(m => m.created_at));
                     const serverIssues = new Set(globalData.maint.map(m => m.issue));
                     const filteredOptimistic = optimisticMaint.filter(m => !serverDates.has(m.created_at) && !serverIssues.has(m.issue));
                     if(filteredOptimistic.length !== optimisticMaint.length) {
                         optimisticMaint = filteredOptimistic;
                         localStorage.setItem('kozeyy_opt_maint', JSON.stringify(optimisticMaint));
                     }
                     globalData.maint = [...globalData.maint, ...optimisticMaint];
                }
            }

            const { user, invoices, msgs, maint } = globalData;

            if(activeTab === 'messages') {
                const unreadIds = msgs.filter(m => m.from === 'Owner' && !m.read_at).map(m => m.id);
                if(unreadIds.length > 0) {
                    supabaseClient.from('msgs').update({ read_at: new Date().toISOString() }).in('id', unreadIds).then(()=>{});
                    const now = new Date().toISOString();
                    let updatedMap = false;
                    unreadIds.forEach(id => { if(!locallyReadIds.has(id)) { locallyReadIds.set(id, now); updatedMap = true; } });
                    if(updatedMap) localStorage.setItem('kozeyy_read_map', JSON.stringify([...locallyReadIds]));
                    globalData.msgs.forEach(m => { if(unreadIds.includes(m.id)) m.read_at = locallyReadIds.get(m.id); });
                }
            }

            const unreadMsgCount = globalData.msgs.filter(m => m.from === 'Owner' && !m.read_at).length;
            notifications.messages = unreadMsgCount > 0 && activeTab !== 'messages';
            updateBadge('messages', notifications.messages);

            const currentMaintHash = JSON.stringify(maint.map(m => ({id: m.id, status: m.status})).sort((a,b)=>a.id-b.id));
            if(lastMaintHash && lastMaintHash !== currentMaintHash) {
                if(activeTab !== 'maintenance') { notifications.maintenance = true; updateBadge('maintenance', true); }
            }
            lastMaintHash = currentMaintHash;

            if(user.name && user.name !== document.getElementById('user-name').innerText) {
                document.getElementById('user-name').innerText = user.name;
                document.querySelectorAll('.display-name').forEach(el => el.innerText = user.name);
                document.querySelectorAll('.display-initials').forEach(el => el.innerText = user.name.charAt(0));
            }
            if(user.email) document.getElementById('set-email').innerText = user.email;
            if(user.phone) document.getElementById('set-phone').innerText = user.phone;
            
            // PRE-FILL EDIT MODAL INPUTS (CONDITIONAL UPDATE)
            const settingsModal = document.getElementById('settingsModal');
            // Only update the input fields if the modal is CLOSED.
            // This prevents overwriting what the user is typing if the modal is currently open.
            if (settingsModal && settingsModal.classList.contains('hidden-section')) {
                document.getElementById('edit-email').value = user.email || '';
                document.getElementById('edit-phone').value = user.phone || '';
            }
            
            if(user.unit && user.unit.trim() !== '') {
                document.getElementById('unit-info-container').classList.remove('hidden-section');
                document.getElementById('display-unit').innerText = user.unit;
            } else { document.getElementById('unit-info-container').classList.add('hidden-section'); }

            if(user.insurance) {
                 document.getElementById('insurance-missing').classList.add('hidden-section');
                 document.getElementById('insurance-verified').classList.remove('hidden-section');
            } else {
                 document.getElementById('insurance-missing').classList.remove('hidden-section');
                 document.getElementById('insurance-verified').classList.add('hidden-section');
            }
            
            const toggle = document.getElementById('toggle-credit');
            if(toggle && toggle.checked !== user.credit_reporting) toggle.checked = user.credit_reporting;
            
            if(user.credit_reporting) document.getElementById('credit-banner').classList.add('hidden-section');
            else document.getElementById('credit-banner').classList.remove('hidden-section');

            const currentInvStr = JSON.stringify(invoices);
            if (currentInvStr !== lastRenderedState.invoices) {
                // 1. Filter Unpaid Invoices
                const unpaid = invoices.filter(i => { 
                    const bal = i.total - (i.amount_paid || 0); 
                    return bal > 0 && i.status !== 'Paid'; 
                });

                // 2. Calculate Grand Total (Base + Fees) & Generate HTML
                let grandTotal = 0;
                const now = new Date();
                
                const uCont = document.getElementById('unpaid-container'); 
                uCont.innerHTML = ''; // Clear list
                
                if(unpaid.length > 0) { 
                    unpaid.forEach(i => { 
                        // A. Calculate Base
                        const currentBaseBalance = i.total - (i.amount_paid || 0);

                        // B. Calculate Late Fee (Same logic as viewInvoice)
                        const invDate = new Date(i.date);
                        const grace = i.grace_period !== undefined ? i.grace_period : 5;
                        const dueDate = new Date(invDate);
                        dueDate.setDate(dueDate.getDate() + grace);

                        const isOverdue = now > dueDate;
                        let daysOverdue = 0;
                        if(isOverdue) {
                            const diffTime = Math.abs(now - dueDate);
                            daysOverdue = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        }

                        // Use the helper function we added earlier
                        const lateFee = isOverdue ? calculateLateFee(i.total, i, daysOverdue) : 0;
                        const finalDisplayAmount = currentBaseBalance + lateFee;
                        
                        // Add to Grand Total
                        grandTotal += finalDisplayAmount;

                        // C. Render Row with Final Amount
                        uCont.innerHTML += `
                        <div class="p-4 md:p-6 flex flex-col md:flex-row justify-between items-start md:items-center hover:bg-slate-50 transition border-b border-slate-100 gap-4">
                            <div class="w-full md:w-auto">
                                <div class="flex items-center gap-2">
                                    <p class="font-bold text-lg text-slate-800">Invoice #${i.id}</p>
                                    <button onclick="viewInvoice(${i.id})" class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded text-slate-600 font-bold transition"><i class="fas fa-eye mr-1"></i> Details</button>
                                </div>
                                <p class="text-xs ${isOverdue ? 'text-rose-500 font-bold' : 'text-slate-400'} mt-2">
                                    ${isOverdue ? `Overdue (Includes $${lateFee.toFixed(2)} fee)` : `Due: ${i.date}`}
                                </p>
                            </div>
                            <div class="flex items-center justify-between w-full md:w-auto gap-4">
                                <div class="text-right md:text-left">
                                    <span class="font-extrabold text-2xl text-slate-900">$${finalDisplayAmount.toLocaleString()}</span>
                                </div>
                                <button onclick="viewInvoice(${i.id})" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition text-sm flex items-center gap-2">
                                    <span>Pay Now</span>
                                    <i class="fas fa-lock text-[10px] opacity-70"></i>
                                </button>
                            </div>
                        </div>`; 
                    });

                    // Update Top "Current Balance" Card with the accurate total
                    document.getElementById('total-balance').innerText = `$${grandTotal.toLocaleString()}`;
                    
                    const badge = document.getElementById('payment-status-badge');
                    badge.className = "bg-rose-100 text-rose-700 text-xs px-3 py-1 rounded-full font-bold uppercase"; 
                    badge.innerText = `${unpaid.length} Due`; 
                    document.getElementById('payment-due-date').innerText = `Total Due Now`;

                } else { 
                    // No Unpaid Invoices
                    document.getElementById('total-balance').innerText = `$0.00`;
                    const badge = document.getElementById('payment-status-badge');
                    badge.className = "bg-emerald-100 text-emerald-700 text-xs px-3 py-1 rounded-full font-bold uppercase"; 
                    badge.innerText = "All Paid"; 
                    document.getElementById('payment-due-date').innerText = "No upcoming payments";
                    uCont.innerHTML = `<div class="p-8 text-center text-slate-400 flex flex-col items-center"><div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center mb-3"><i class="fas fa-check text-emerald-400 text-xl"></i></div><p class="text-sm font-medium text-slate-600">You're all caught up!</p></div>`;
                }

                // Render History (Paid Items)
                const hBody = document.getElementById('history-body'); const hMob = document.getElementById('history-mobile');
                hBody.innerHTML = ''; hMob.innerHTML = '';
                const historyItems = invoices.filter(i => i.status === 'Paid');
                if(historyItems.length === 0) {
                    hMob.innerHTML = '<div class="text-center text-slate-400 text-sm py-4">No payment history</div>';
                    hBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">No payment history</td></tr>';
                } else {
                    historyItems.forEach(i => { 
                        const totalAmt = i.total; // Paid items don't strictly need recalculation of past fees for display history, relying on stored totals
                        hBody.innerHTML += `<tr class="hover:bg-slate-50 transition border-b border-slate-100"><td class="p-4 text-slate-500">${i.paid_date || i.date || '-'}</td><td class="p-4 text-slate-800 font-medium">Invoice #${i.id}</td><td class="p-4 font-bold">$${totalAmt.toLocaleString()}</td><td class="p-4 text-right"><button onclick="viewInvoice(${i.id})" class="text-indigo-600 font-bold text-xs hover:underline">View</button> <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold uppercase ml-2">Paid</span></td></tr>`; 
                        hMob.innerHTML += `<div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center" onclick="viewInvoice(${i.id})"><div><p class="font-bold text-slate-800 text-sm">Invoice #${i.id}</p><p class="text-xs text-slate-500">${i.paid_date || i.date}</p></div><div class="text-right"><p class="font-bold text-slate-900">$${totalAmt.toLocaleString()}</p><span class="text-[10px] font-bold text-emerald-600 uppercase">Paid</span></div></div>`;
                    });
                }
                lastRenderedState.invoices = currentInvStr;
            }

            const currentMaintStr = JSON.stringify(maint);
            if(currentMaintStr !== lastRenderedState.maint) {
                const maintList = document.getElementById('maint-list'); 
                if (maint.length === 0) { 
                    maintList.innerHTML = `<div class="p-8 text-center text-slate-400 flex flex-col items-center"><i class="fas fa-check-circle text-3xl text-emerald-100 mb-2"></i><p class="text-sm">No maintenance requests found</p></div>`; 
                } else {
                    maintList.innerHTML = '';
                    const sortedMaint = maint.sort((a,b) => {
                        if(a.status === 'Active' && b.status !== 'Active') return -1;
                        if(a.status !== 'Active' && b.status === 'Active') return 1;
                        return new Date(b.created_at) - new Date(a.created_at);
                    });
                    sortedMaint.forEach(m => { 
                        const isActive = m.status === 'Active';
                        const statusColor = isActive ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'; 
                        const opacity = isActive ? '' : 'opacity-70';
                        const displayDate = m.created_at ? new Date(m.created_at).toLocaleDateString() : 'Just now';
                        maintList.innerHTML += `
                        <div class="p-4 flex flex-col hover:bg-slate-50 transition border-b border-slate-100 ${opacity}">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 text-xs"><i class="fas fa-${isActive ? 'wrench' : 'check'}"></i></div>
                                    <div><h4 class="font-bold text-sm text-slate-800">${m.issue}</h4><p class="text-xs text-slate-400">${displayDate}</p></div>
                                </div>
                                <span class="${statusColor} px-2 py-1 rounded-full text-[10px] font-bold uppercase">${m.status}</span>
                            </div>
                        </div>`; 
                    });
                }
                lastRenderedState.maint = currentMaintStr;
            }
            if (activeTab === 'messages') renderMessages();
        }

        function updateBadge(type, show) {
            const mobBtn = document.getElementById(`mob-${type}`);
            if(type === 'messages') {
                const d = document.getElementById('desk-notif-dot');
                const mDot = document.getElementById('mob-notif-dot'); 
                if(show) { if(d) d.classList.remove('hidden-section'); if(mDot) mDot.classList.remove('hidden-section'); } 
                else { if(d) d.classList.add('hidden-section'); if(mDot) mDot.classList.add('hidden-section'); }
            }
            if(type === 'maintenance') {
                const dLink = document.getElementById('nav-maintenance');
                let dDot = dLink.querySelector('.maint-dot');
                if(!dDot) { dDot = document.createElement('span'); dDot.className = "maint-dot w-2.5 h-2.5 bg-red-500 rounded-full ml-auto hidden-section"; dLink.appendChild(dDot); }
                let mDot = mobBtn.querySelector('.maint-dot-mob');
                if(!mDot) { mDot = document.createElement('span'); mDot.className = "maint-dot-mob absolute top-0 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden-section"; mobBtn.classList.add('relative'); mobBtn.appendChild(mDot); }
                if(show) { dDot.classList.remove('hidden-section'); mDot.classList.remove('hidden-section'); } 
                else { dDot.classList.add('hidden-section'); mDot.classList.add('hidden-section'); }
            }
        }

        function switchTab(t) { 
            activeTab = t; 
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-section')); 
            document.getElementById(`view-${t}`).classList.remove('hidden-section'); 
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('sidebar-active')); 
            const deskLink = document.getElementById(`nav-${t}`); if(deskLink) deskLink.classList.add('sidebar-active');
            document.querySelectorAll('.md\\:hidden button').forEach(e => e.classList.remove('mobile-active', 'text-indigo-600'));
            document.querySelectorAll('.md\\:hidden button').forEach(e => e.classList.add('text-slate-400'));
            const mobBtn = document.getElementById(`mob-${t}`); if(mobBtn) { mobBtn.classList.add('mobile-active'); mobBtn.classList.remove('text-slate-400'); }
            const titles = { home:'Resident Portal', payments:'Payments', messages:'Messages', maintenance:'Maintenance', insurance:'Insurance', settings:'Account Settings' };
            const titleEl = document.getElementById('page-title'); if(titleEl) titleEl.innerText = titles[t] || 'Kozeyy';
            
            if(t === 'messages') { notifications.messages = false; updateBadge('messages', false); render(false); renderMessages(); }
            if(t === 'maintenance') { notifications.maintenance = false; updateBadge('maintenance', false); }
        }

        function startLiveUpdates() { setInterval(() => { render(false); }, 4000); }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            const newMsg = { tenant_id: USER_ID, from: 'Tenant', text: text, time: new Date().toISOString(), created_at: new Date().toISOString() };
            globalData.msgs.push(newMsg);
            const b = document.getElementById('chat-messages');
            const d = new Date();
            const ts = d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
            b.innerHTML += `<div class="flex justify-end fade-in"><div class="max-w-[80%] px-4 py-2 rounded-2xl bg-indigo-600 text-white rounded-br-none text-sm shadow-sm">${text}</div></div>`;
            b.scrollTop = b.scrollHeight;
            input.value = '';
            try { await supabaseClient.from('msgs').insert([newMsg]); } catch(e) { console.error(e); }
        }

        function renderMessages(force = false) {
            const chatBox = document.getElementById('chat-messages'); 
            if(!chatBox) return;
            const msgs = globalData.msgs.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
            const msgHash = JSON.stringify(msgs);
            if(msgHash === lastRenderedState.msgs) return;
            lastRenderedState.msgs = msgHash;
            const wasAtBottom = chatBox.scrollHeight - chatBox.scrollTop === chatBox.clientHeight;
            chatBox.innerHTML = '';
            if(msgs.length === 0) { chatBox.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-400 opacity-60"><i class="fas fa-comment-slash text-4xl mb-2"></i><p class="text-sm">No messages yet</p></div>`; } 
            else {
                msgs.forEach(m => {
                    const align = m.from === 'Tenant' ? 'justify-end' : 'justify-start'; 
                    const color = m.from === 'Tenant' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none'; 
                    const d = new Date(m.created_at);
                    const ts = d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
                    chatBox.innerHTML += `<div class="flex ${align} mb-3 fade-in"><div class="flex flex-col ${m.from === 'Tenant' ? 'items-end' : 'items-start'} max-w-[85%]"><div class="px-4 py-2 rounded-2xl ${color} text-sm shadow-sm">${m.text}</div><span class="text-[10px] text-slate-400 mt-1 mx-1">${ts}</span></div></div>`;
                });
                if(wasAtBottom) chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

    // --- EMAIL HELPER (Edge Function) ---
    async function sendEmail(to, subject, type, data) {
        if(!to || !to.includes('@')) return;
        
        console.log(`Sending ${type} email to ${to}...`);
        
        try {
            const { data: result, error } = await supabaseClient.functions.invoke('send-email', {
                body: { to, subject, type, data }
            });

            if (error) throw error;
            console.log("Email sent!", result);
        } catch (e) { 
            console.error("Email error:", e); 
        }
    }

  async function handleMaintSubmit(e) {
        e.preventDefault();
        const desc = document.getElementById('m-desc').value;
        const cat = document.getElementById('m-cat').value;
        const allowEntry = document.getElementById('entry').checked; 

        // 1. Get User & Owner Info
        const tenantName = globalData.user ? globalData.user.name : "Tenant";
        const ownerId = globalData.user ? globalData.user.owner_id : null;

        if(desc && ownerId) { 
            // Formatted Description for Database
            const permText = allowEntry ? "[Entry Permitted]" : "[Call for Entry]";
            const fullDesc = `${desc} \n\n${permText}`;
            const issueTitle = `${cat}: ${desc.substring(0, 30)}...`;

            // 2. Optimistic UI Update
            const dateIso = new Date().toISOString();
            const newReq = { 
                tenant_id: USER_ID, 
                issue: issueTitle, 
                category: cat, 
                description: fullDesc, 
                status: 'Active', 
                created_at: dateIso 
            };
            optimisticMaint.push(newReq);
            localStorage.setItem('kozeyy_opt_maint', JSON.stringify(optimisticMaint));
            
            toggleModal('requestModal'); 
            e.target.reset(); 
            render(true); 

            // 3. Save to Database
            try {
                const { error } = await supabaseClient.from('maintenance').insert([{ 
                    tenant_id: USER_ID, 
                    owner_id: ownerId, 
                    issue: issueTitle, 
                    category: cat, 
                    description: fullDesc, 
                    status: 'Active' 
                }]);
                if (error) throw error;

                // 4. SEND EMAIL TO OWNER (Updated)
                const { data: owner } = await supabaseClient.from('owners').select('email').eq('id', ownerId).single();
                
                if(owner && owner.email) {
                    await sendEmail(
                        owner.email, 
                        "New Maintenance Request", 
                        'alert', 
                        {
                            title: `New Request from ${tenantName}`,
                            message: `<strong>Category:</strong> ${cat}<br><strong>Issue:</strong> ${desc}<br><br><strong>Entry Permission:</strong> ${allowEntry ? 'YES âœ…' : 'NO âŒ'}`,
                            actionLink: "https://kozeyy.com/owner.html"
                        }
                    );
                }

            } catch(err) {
                console.error("Maintenance submit error:", err);
                alert("Saved locally, but network error occurred.");
            }
        }
    }
        
        async function checkReturnParams() {
        const params = new URLSearchParams(window.location.search);
        
        // 1. Handle Credit Reporting Subscription Return
        if (params.get('sub') === 'active') {
            toggleModal('processingModal'); 
            try { 
                await supabaseClient.from('tenants').update({ credit_reporting: true }).eq('id', USER_ID); 
                if (globalData.user) globalData.user.credit_reporting = true; 
                alert("Credit Reporting Activated Successfully! ðŸš€"); 
                window.history.replaceState({}, document.title, window.location.pathname); 
                render(false); 
            } catch(e) { 
                console.error(e); 
            } 
            toggleModal('processingModal'); 
        }

        // 2. Handle Stripe Payment Success Return
        if (params.get('success') === 'true') {
            const paidInvoiceId = params.get('invoice_id');
            if(paidInvoiceId) {
                toggleModal('processingModal');
                try { 
                    // Fetch invoice details first to get the amount for the email
                    const { data: inv } = await supabaseClient.from('invoices').select('total, tenant_id').eq('id', paidInvoiceId).single(); 
                    
                    if(inv) { 
                        // A. Update Invoice Status in Database
                        await supabaseClient.from('invoices').update({ 
                            status: 'Paid', 
                            amount_paid: inv.total, 
                            paid_date: new Date().toISOString() 
                        }).eq('id', paidInvoiceId); 
                        
                        // B. SEND RECEIPT EMAIL (New Edge Function Logic)
                        if(globalData.user && globalData.user.email) {
                            await sendEmail(
                                globalData.user.email,
                                "Payment Confirmation",
                                'receipt',
                                {
                                    name: globalData.user.name,
                                    amount: inv.total.toLocaleString(undefined, {minimumFractionDigits: 2}),
                                    date: new Date().toLocaleDateString(),
                                    link: "https://kozeyy.com/tenant.html"
                                }
                            );
                        }
                        
                        alert("Payment Successful! A receipt has been emailed to you."); 
                    } 
                } catch(e) { 
                    console.error("Update failed", e); 
                } 
                toggleModal('processingModal');
            }
            // Clear URL params so refresh doesn't re-trigger
            window.history.replaceState({}, document.title, window.location.pathname);
            render(false);
        }
    }
        
       function viewInvoice(id) {
        const inv = globalData.invoices.find(i => i.id === id);
        if(!inv) return;
        
        // --- 1. LATE FEE LOGIC ---
        const now = new Date();
        const invDate = new Date(inv.date);
        const grace = inv.grace_period !== undefined ? inv.grace_period : 5;
        
        const dueDate = new Date(invDate);
        dueDate.setDate(dueDate.getDate() + grace);
        
        const currentBaseBalance = inv.total - (inv.amount_paid || 0);
        const isOverdue = now > dueDate && currentBaseBalance > 0 && inv.status !== 'Paid';
        
        let daysOverdue = 0;
        if(isOverdue) {
            const diffTime = Math.abs(now - dueDate);
            daysOverdue = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        }

        const lateFee = isOverdue ? calculateLateFee(inv.total, inv, daysOverdue) : 0;
        const finalTotalDue = currentBaseBalance + lateFee;

        // --- 2. RENDER UI ---
        document.getElementById('inv-id').innerText = inv.id;
        document.getElementById('inv-date').innerText = new Date(inv.date).toLocaleDateString();
        document.getElementById('inv-prev-bal').innerText = `$${inv.total.toLocaleString()}`; 
        document.getElementById('inv-prev-pay').innerText = `$${(inv.amount_paid||0).toLocaleString()}`;
        document.getElementById('inv-fwd-bal').innerText = `$${currentBaseBalance.toLocaleString()}`;
        
        const tbody = document.getElementById('inv-items-body'); 
        tbody.innerHTML = '';
        (inv.items || []).forEach(item => { 
            tbody.innerHTML += `<tr><td class="p-3 text-slate-700">${item.desc}</td><td class="p-3 text-right font-medium">$${item.amount.toLocaleString()}</td></tr>`; 
        });
        
        if(lateFee > 0) {
             const type = inv.fee_type || 'Fixed';
             let label = "Late Fee";
             if(type === 'Daily') label += ` (${daysOverdue} days overdue)`;
             if(type === 'Percentage') label += ` (${inv.fee_value}%)`;
             tbody.innerHTML += `<tr class="bg-rose-50"><td class="p-3 text-rose-600 font-bold">${label}</td><td class="p-3 text-right font-bold text-rose-600">+$${lateFee.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
        }

        const attEl = document.getElementById('inv-attachment'); 
        const docLink = inv.doc_url || inv.doc;
        if(docLink) { 
            attEl.classList.remove('hidden-section'); 
            document.getElementById('inv-doc-name').innerHTML = `<a href="${docLink}" target="_blank" class="hover:underline">View Document</a>`;
        } else { attEl.classList.add('hidden-section'); }
        
        const feeSection = document.getElementById('inv-fees-section'); 
        const totalEl = document.getElementById('inv-total');
        const payBtnContainer = document.getElementById('inv-pay-btn-container');

        if(currentBaseBalance <= 0 || inv.status === 'Paid') { 
            feeSection.classList.add('hidden-section'); 
            totalEl.innerText = `$0.00`; 
            payBtnContainer.innerHTML = `<div class="w-full bg-emerald-100 text-emerald-700 text-center py-3 rounded-xl font-bold uppercase mt-4">Paid on ${inv.paid_date ? new Date(inv.paid_date).toLocaleDateString() : 'Unknown'}</div>`; 
        } else { 
            // Display Total (Rent + Late Fee)
            totalEl.innerText = `$${finalTotalDue.toLocaleString(undefined, {minimumFractionDigits: 2})}`; 
            
            if (inv.landlord_stripe_id) {
                feeSection.classList.remove('hidden-section');
                
                // --- FEE CONFIGURATION ---
                const achFee = 2.50; // Flat fee
                const cardFee = (finalTotalDue * 0.03); // 3% to cover Stripe's 2.9% + 30c
                
                const achTotal = finalTotalDue + achFee;
                const cardTotal = finalTotalDue + cardFee;
                
                payBtnContainer.innerHTML = `
                    <div class="space-y-3 mt-4">
                        <button onclick="initStripePayment(${inv.id}, ${finalTotalDue}, 'us_bank_account', ${achFee})" class="w-full bg-indigo-50 border-2 border-indigo-100 text-indigo-700 py-3 rounded-xl font-bold hover:bg-indigo-100 transition flex items-center justify-between px-4 group">
                            <div class="flex items-center gap-2"><i class="fas fa-university"></i> Bank Transfer (ACH)</div>
                            <span class="text-sm group-hover:scale-105 transition">$${achTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </button>
                        <button onclick="initStripePayment(${inv.id}, ${finalTotalDue}, 'card', ${cardFee})" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg transition flex items-center justify-between px-4 group">
                            <div class="flex items-center gap-2"><i class="far fa-credit-card"></i> Card Payment</div>
                            <span class="text-sm group-hover:scale-105 transition">$${cardTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </button>
                        <button onclick="toggleModal('invoiceModal')" class="w-full text-slate-400 text-xs font-bold hover:text-slate-600">Cancel</button>
                    </div>`;
            } else {
                feeSection.classList.add('hidden-section');
                payBtnContainer.innerHTML = `
                    <div class="mt-6 p-4 bg-orange-50 border border-orange-100 rounded-xl text-center">
                        <p class="text-orange-800 font-bold text-sm mb-1"><i class="fas fa-info-circle"></i> Online Payment Unavailable</p>
                        <p class="text-orange-600 text-xs">The owner has not enabled online payments for this invoice.</p>
                    </div>
                    <button onclick="toggleModal('invoiceModal')" class="w-full text-slate-400 text-xs font-bold hover:text-slate-600 mt-4">Close</button>
                `;
            }
        }
        toggleModal('invoiceModal');
    }

        async function initStripePayment(invoiceId, baseAmount, method, fee) {
            toggleModal('invoiceModal'); 
            toggleModal('processingModal');
            try {
                const totalAmount = baseAmount + fee;
                const response = await fetch(FUNCTION_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` }, 
                    body: JSON.stringify({ action: 'create-checkout-session', invoiceId: invoiceId, amount: totalAmount, tenantId: USER_ID, paymentMethod: method }) 
                });
                const session = await response.json(); if(session.error) throw new Error(session.error);
                const result = await stripe.redirectToCheckout({ sessionId: session.id }); if (result.error) throw new Error(result.error.message);
            } catch (err) { toggleModal('processingModal'); alert("Payment Error: " + err.message); }
        }

        function downloadInvoicePDF() {
            const element = document.getElementById('invoice-paper');
            const invId = document.getElementById('inv-id').innerText;
            const opt = { margin: 0.5, filename: `Invoice_${invId}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save();
        }

        async function handleCreditToggle() {
            const checkBox = document.getElementById('toggle-credit');
            if (checkBox.checked) {
                if(confirm("Activate Credit Reporting ($10/mo)?\nProceed to secure payment?")) {
                    toggleModal('processingModal');
                    try {
                        const response = await fetch(FUNCTION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` }, body: JSON.stringify({ action: 'subscribe', tenantId: USER_ID }) });
                        const data = await response.json(); if (data.error) throw new Error(data.error); if(data.url) window.location.href = data.url; else throw new Error("No URL returned");
                    } catch(err) { toggleModal('processingModal'); alert("Error: " + err.message); checkBox.checked = false; }
                } else { checkBox.checked = false; }
            } else {
                checkBox.checked = true; 
                if(confirm("To prevent accidental double-billing, please cancel directly in the Billing Portal.\n\nYour subscription will remain active until the end of the current billing period.")) { openStripePortal(); }
            }
        }

        async function openStripePortal() {
            toggleModal('processingModal');
            try {
                const response = await fetch(FUNCTION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` }, body: JSON.stringify({ action: 'create-portal-session', tenantId: USER_ID }) });
                const data = await response.json(); if(data.url) window.location.href = data.url; else throw new Error("Failed to create portal session");
            } catch(err) { toggleModal('processingModal'); alert("Error: " + err.message); }
        }
        
        async function uploadInsurance() { const input = document.createElement('input'); input.type = 'file'; input.onchange = async () => { await supabaseClient.from('tenants').update({ insurance: true }).eq('id', USER_ID); alert("Uploaded!"); render(false); }; input.click(); }
        async function resetInsurance() { if(confirm("Remove policy?")) { await supabaseClient.from('tenants').update({ insurance: false }).eq('id', USER_ID); render(false); } }
        function toggleModal(id) { const el = document.getElementById(id); if(el) el.classList.toggle('hidden-section'); }

        // --- ACCOUNT EDIT LOGIC ---
        async function handleSettingsUpdate(e) {
            e.preventDefault();
            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;
            toggleModal('processingModal');
            
            const { error } = await supabaseClient.from('tenants').update({ email, phone }).eq('id', USER_ID);
            
            toggleModal('processingModal');
            if(error) alert("Error updating profile: " + error.message);
            else { 
                toggleModal('settingsModal'); 
                render(false); 
            }
        }

// --- HELPER: LATE FEE CALCULATION ---
    function calculateLateFee(total, invoice, daysOverdue = 1) {
        // If fees are disabled or not configured on this invoice, return 0
        if (invoice.fee_enabled === false) return 0;

        const type = invoice.fee_type || 'Fixed'; 
        const value = parseFloat(invoice.fee_value || 0);

        if (type === 'Percentage') {
            return total * (value / 100);
        }
        if (type === 'Daily') {
            return value * daysOverdue;
        }
        return value; // Fixed
    }
        // Init
        render(false);
        checkReturnParams();
        startLiveUpdates();

    </script>
</body>
</html>




