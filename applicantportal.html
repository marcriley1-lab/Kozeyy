<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Portal | Kozeyy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .brand-font { font-family: 'Outfit', sans-serif; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-modal { display: none !important; }
        
        /* Glass Effect for Dashboard */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-[url('https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?ixlib=rb-4.0.3&auto=format&fit=crop&w=2666&q=80')] bg-cover bg-center bg-fixed bg-no-repeat">

    <div class="fixed inset-0 bg-slate-900/50 pointer-events-none z-0"></div>

    <nav class="relative z-10 bg-slate-900/60 backdrop-blur-md border-b border-white/10 text-white p-4 px-6 md:px-10 flex justify-between items-center shadow-2xl">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center font-bold text-white shadow-lg shadow-indigo-500/30">
                <i class="fas fa-home"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-xl font-bold brand-font tracking-wide">Kozeyy</span>
                <span class="text-[10px] uppercase tracking-widest text-indigo-200 font-bold">Application Portal</span>
            </div>
        </div>
        
        <button onclick="logout()" class="text-xs font-bold bg-white/10 hover:bg-white/20 border border-white/20 px-4 py-2 rounded-lg transition flex items-center gap-2">
            <span>Log Out</span> <i class="fas fa-sign-out-alt"></i>
        </button>
    </nav>

    <main class="relative z-10 flex-1 flex flex-col items-center justify-center p-4 md:p-8">
        
        <div id="view-loading" class="text-center text-white">
            <div class="w-16 h-16 border-4 border-indigo-400 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold mb-2">Accessing Portal...</h2>
            <p class="text-indigo-200">Retrieving your application details securely.</p>
        </div>

        <div id="view-dashboard" class="hidden-section w-full max-w-3xl glass-panel rounded-[2.5rem] shadow-2xl overflow-hidden fade-in">
            
            <div class="p-8 md:p-10 border-b border-slate-100 bg-white/50">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <p class="text-slate-500 text-sm font-bold uppercase tracking-wider mb-1">Welcome Back</p>
                        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 brand-font flex items-center gap-2">
                            <span id="dash-name">User</span> 
                            <i class="fas fa-check-circle text-emerald-500 text-xl" title="Verified Applicant"></i>
                        </h1>
                    </div>
                    <div class="bg-slate-100 px-4 py-2 rounded-xl border border-slate-200 text-right">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Application ID</p>
                        <p class="text-lg font-mono font-bold text-slate-700">#<span id="dash-id">...</span></p>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 bg-white/60">
                
                <div id="status-banner" class="bg-white p-8 rounded-3xl shadow-lg border border-slate-100 mb-8 relative overflow-hidden group transition-all hover:shadow-xl">
                    <div class="relative z-10 flex flex-col md:flex-row gap-6 items-start md:items-center">
                        <div id="status-icon-bg" class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center flex-shrink-0 text-2xl text-slate-400">
                            <i id="status-icon" class="fas fa-spinner fa-spin"></i>
                        </div>
                        
                        <div class="flex-1">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Current Status</p>
                            <h2 class="text-3xl font-extrabold text-slate-800 brand-font mb-2" id="status-text">Processing</h2>
                            <p class="text-slate-600 font-medium leading-relaxed" id="status-desc">Your application is currently under review by our leasing team.</p>
                            
                            <button id="btn-adverse-action" onclick="openAdverseAction()" class="hidden-section mt-4 text-xs font-bold text-rose-600 hover:text-rose-800 underline decoration-rose-300 underline-offset-4">
                                <i class="fas fa-file-contract mr-1"></i> View Adverse Action Notice
                            </button>
                        </div>
                    </div>
                    
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-gradient-to-br from-slate-50 to-transparent rounded-full opacity-50"></div>
                </div>

                <div id="condition-card" class="bg-amber-500 text-white p-8 rounded-3xl shadow-xl shadow-amber-200 hidden-section relative overflow-hidden mb-8">
                    <div class="relative z-10">
                        <div class="flex flex-col md:flex-row items-start gap-6">
                            <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-2xl border border-white/20 shrink-0">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold mb-2">Action Required: Conditional Approval</h3>
                                <p class="text-amber-50 text-sm mb-4">Your application is approved pending the following condition from the property owner:</p>
                                
                                <div class="bg-white/10 border border-white/20 p-4 rounded-xl mb-6 font-medium italic">
                                    "<span id="condition-note-text">Loading...</span>"
                                </div>

                                <div class="flex flex-wrap gap-3">
                                    <button onclick="respondToCondition('Accept')" class="bg-white text-amber-700 px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-amber-50 transition flex items-center gap-2">
                                        <i class="fas fa-check-circle"></i> I Accept Condition
                                    </button>
                                    <button onclick="respondToCondition('Reject')" class="bg-amber-700 text-white border border-amber-600 px-6 py-3 rounded-xl font-bold hover:bg-amber-800 transition">
                                        Withdraw Application
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="absolute -right-10 -bottom-20 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl pointer-events-none"></div>
                </div>

                <div id="action-card" class="bg-indigo-600 text-white p-8 rounded-3xl shadow-xl shadow-indigo-200 hidden-section relative overflow-hidden">
                    <div class="relative z-10 flex flex-col md:flex-row items-center gap-6 justify-between">
                        <div class="flex items-center gap-5">
                            <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-2xl border border-white/20">
                                <i class="fas fa-file-signature"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">Lease Ready for Signature</h3>
                                <p class="text-indigo-100 text-sm opacity-90">The owner has approved your application.</p>
                            </div>
                        </div>
                        <button onclick="openSigningModal()" class="bg-white text-indigo-700 px-8 py-3.5 rounded-xl font-bold shadow-lg hover:bg-indigo-50 hover:scale-105 transition w-full md:w-auto flex items-center justify-center gap-2">
                            <span>Review Lease</span> <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div id="tenant-card" class="bg-gradient-to-br from-emerald-500 to-teal-600 p-8 rounded-3xl shadow-xl shadow-emerald-200 text-white hidden-section relative overflow-hidden">
                    <div class="relative z-10 text-center py-4">
                        <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm mx-auto mb-6 text-3xl shadow-inner">
                            <i class="fas fa-key"></i>
                        </div>
                        <h3 class="text-3xl font-bold brand-font mb-2">Welcome Home!</h3>
                        <p class="mb-8 text-emerald-50 font-medium text-lg">You are now an active tenant. Access your dashboard to pay rent and view details.</p>
                        <a href="tenant.html" class="inline-block bg-white text-emerald-700 px-8 py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-50 transition transform hover:-translate-y-1">
                            Go to Tenant Portal
                        </a>
                    </div>
                </div>

            </div>
            
            <div class="bg-slate-50 border-t border-slate-200 p-6 text-center">
                <p class="text-xs text-slate-400 font-medium">Need help? Contact support at <span class="text-indigo-500">help@kozeyy.com</span></p>
            </div>
        </div>
    </main>

    <div id="modal-sign" class="hidden-section fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center backdrop-blur-md p-4 fade-in">
        <div class="bg-white w-full max-w-4xl h-[90vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-white/20">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <h3 class="font-bold text-slate-700">Lease Agreement Review</h3>
                </div>
                <button onclick="closeSigningModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 bg-slate-100 p-0 relative">
                <div id="lease-loading" class="absolute inset-0 flex items-center justify-center text-slate-400">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p class="text-xs font-bold uppercase">Loading Document...</p>
                    </div>
                </div>
                
                <iframe id="lease-frame" class="w-full h-full relative z-10 hidden-section"></iframe>

                <div id="lease-text-fallback" class="bg-white min-h-full p-8 md:p-12 shadow-sm mx-auto max-w-2xl hidden-section overflow-y-auto">
                    <h2 class="text-center font-serif font-bold text-3xl mb-1 text-slate-900">RESIDENTIAL LEASE AGREEMENT</h2>
                    <p class="text-center text-slate-400 text-xs uppercase tracking-widest mb-10">State of Georgia</p>
                    <div class="space-y-6 text-slate-700 text-sm leading-relaxed font-serif">
                        <p>This Lease Agreement (the "Agreement") is made and entered into on this day by and between <strong>Kozeyy Property Management</strong> ("Landlord") and <strong id="lease-name" class="bg-yellow-100 px-1">Tenant Name</strong> ("Tenant").</p>
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 my-6 font-sans">
                            <h4 class="font-bold text-slate-900 mb-4 border-b pb-2">Lease Summary</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><p class="text-xs text-slate-400 uppercase font-bold">Monthly Rent</p><p class="font-bold text-lg text-slate-800" id="lease-rent">$0.00</p></div>
                                <div><p class="text-xs text-slate-400 uppercase font-bold">Lease Term</p><p class="font-bold text-lg text-slate-800">12 Months</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-5 border-t bg-white flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-xs text-slate-400 font-medium">
                    <i class="fas fa-lock text-emerald-500 mr-1"></i> Document secured by Kozeyy Signâ„¢
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <a id="btn-download-lease" href="#" target="_blank" class="hidden-section flex-1 md:flex-none px-6 py-3 rounded-xl font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 transition text-center">
                        <i class="fas fa-download mr-1"></i> Download
                    </a>
                    <button onclick="closeSigningModal()" class="flex-1 md:flex-none px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition">Cancel</button>
                    <button onclick="signLease()" class="flex-1 md:flex-none bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-pen-nib"></i> I Agree & Sign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-adverse" class="hidden-modal fixed inset-0 bg-slate-900/80 z-[80] flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-6 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800 brand-font">Statement of Denial (Adverse Action)</h3>
            </div>
            <div class="p-8 overflow-y-auto text-sm text-slate-600 space-y-4">
                <p>Dear Applicant,</p>
                <p>Thank you for your application to rent housing at our property. We regret to inform you that your application has been denied.</p>
                
                <div class="bg-rose-50 p-4 rounded-xl border border-rose-100 text-rose-800 font-bold">
                    Reason: Does not meet screening criteria (Credit Score, Income Ratio, or Background History).
                </div>

                <h4 class="font-bold text-slate-800 mt-4">Fair Credit Reporting Act Disclosure</h4>
                <p>If this decision was based, in whole or in part, on information contained in a consumer credit report, you have the right to obtain a free copy of your credit report from the consumer reporting agency that compiled the report. You generally have the right to receive a free copy of the report if you request it within 60 days of receiving this notice.</p>
                
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-xs">
                    <p class="font-bold">Consumer Reporting Agency:</p>
                    <p>RentPrep / TransUnion</p>
                    <p>P.O. Box 2000, Chester, PA 19016</p>
                    <p>www.transunion.com/myoptions</p>
                </div>
                
                <p>You also have the right to dispute the accuracy or completeness of any information contained in the report directly with the consumer reporting agency.</p>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 text-right">
                <button onclick="document.getElementById('modal-adverse').classList.add('hidden-modal')" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-900 transition">Close Notice</button>
            </div>
        </div>
    </div>

    <div id="platform-modal" class="hidden-modal fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center transform scale-100 transition-all">
            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mx-auto mb-6 text-2xl animate-bounce">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2 text-slate-900 brand-font" id="modal-title">Info</h3>
            <p class="text-slate-500 mb-8 leading-relaxed" id="modal-msg">Message.</p>
            <button onclick="closeModal()" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">Got it, thanks!</button>
        </div>
    </div>

    <div id="modal-confirm" class="hidden-modal fixed inset-0 bg-slate-900/80 z-[70] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-2 text-slate-900 brand-font" id="confirm-title">Confirm</h3>
            <p class="text-slate-500 mb-8" id="confirm-msg">Are you sure?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold transition">Cancel</button>
                <button onclick="closeConfirm(true)" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition">Confirm</button>
            </div>
        </div>
    </div>

   <script>
        const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
        
        let supabaseClient = null;
        try { if(window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}

        let currentUserApp = null;
        const userId = localStorage.getItem('kozeyy_user_id');

        window.onload = async function() {
            if(!userId) { window.location.href = 'login.html'; return; }
            await fetchApplication();
            setInterval(fetchApplication, 5000);
        };

        async function fetchApplication() {
            if(!supabaseClient) return;
            const { data, error } = await supabaseClient.from('apps').select('*').eq('user_id', userId).order('created_at', {ascending:false}).limit(1).maybeSingle();
            
            if(data) {
                // Check if status changed to force re-render
                if(!currentUserApp || currentUserApp.status !== data.status || currentUserApp.id !== data.id) {
                    currentUserApp = data;
                    renderDashboard();
                }
                currentUserApp = data; // Keep sync
            } else {
                document.getElementById('view-loading').innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md p-8 rounded-3xl border border-white/20 inline-block">
                        <i class="fas fa-search text-4xl text-white/50 mb-4"></i>
                        <h2 class="text-xl font-bold text-white mb-2">No Application Found</h2>
                        <p class="text-indigo-200 mb-6">We couldn't find an active application linked to this device.</p>
                        <a href="index.html" class="bg-white text-indigo-900 px-6 py-3 rounded-xl font-bold hover:bg-indigo-50 transition">Browse Listings</a>
                    </div>`;
            }
        }

        function renderDashboard() {
            if(!currentUserApp) return;
            document.getElementById('view-loading').classList.add('hidden-section');
            document.getElementById('view-dashboard').classList.remove('hidden-section');
            document.getElementById('dash-name').innerText = currentUserApp.name;
            document.getElementById('dash-id').innerText = currentUserApp.id;
            
            // Lease Modal Values (Fallback text updates)
            const leaseName = document.getElementById('lease-name');
            if(leaseName) leaseName.innerText = currentUserApp.name;
            
            const leaseRent = document.getElementById('lease-rent');
            if(leaseRent) leaseRent.innerText = `$${parseInt(currentUserApp.rent || 0).toLocaleString()}`;

            const banner = document.getElementById('status-banner');
            const statusText = document.getElementById('status-text');
            const statusDesc = document.getElementById('status-desc');
            const statusIcon = document.getElementById('status-icon');
            const statusIconBg = document.getElementById('status-icon-bg');
            const btnAdverse = document.getElementById('btn-adverse-action');
            
            const actionCard = document.getElementById('action-card');
            const tenantCard = document.getElementById('tenant-card');
            const conditionCard = document.getElementById('condition-card');

            // Reset UI
            banner.classList.remove('hidden-section');
            actionCard.classList.add('hidden-section');
            tenantCard.classList.add('hidden-section');
            if(conditionCard) conditionCard.classList.add('hidden-section');
            btnAdverse.classList.add('hidden-section'); // Hide by default

            switch(currentUserApp.status) {
                case 'Pending':
                case 'Unpaid':
                case 'Paid':
                case 'Ready for Review': 
                    statusText.innerText = "Under Review";
                    statusText.className = "text-3xl font-extrabold text-slate-800 brand-font mb-2";
                    statusDesc.innerText = "The property owner is currently reviewing your application details and background check.";
                    statusIcon.className = "fas fa-sync fa-spin";
                    statusIconBg.className = "w-16 h-16 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center flex-shrink-0 text-2xl";
                    break;
                    
                case 'Conditional':
                    statusText.innerText = "Pending Your Response";
                    statusText.className = "text-3xl font-extrabold text-amber-500 brand-font mb-2";
                    statusDesc.innerText = "The owner has set a condition for your approval. Please review and respond below.";
                    statusIcon.className = "fas fa-clipboard-check";
                    statusIconBg.className = "w-16 h-16 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center flex-shrink-0 text-2xl animate-pulse";
                    
                    if(conditionCard) {
                        conditionCard.classList.remove('hidden-section');
                        const note = currentUserApp.notes || "Additional security deposit required.";
                        document.getElementById('condition-note-text').innerText = note;
                    }
                    break;

                case 'Approved':
                case 'Lease Uploaded':
                    statusText.innerText = "Approved!";
                    statusText.className = "text-3xl font-extrabold text-emerald-600 brand-font mb-2";
                    statusDesc.innerText = "Congratulations! Your application has been approved. Please wait while the owner prepares your lease.";
                    statusIcon.className = "fas fa-check";
                    statusIconBg.className = "w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center flex-shrink-0 text-2xl";
                    break;

                case 'Lease Sent':
                    statusText.innerText = "Action Required";
                    statusText.className = "text-3xl font-extrabold text-indigo-600 brand-font mb-2";
                    statusDesc.innerText = "A lease agreement has been sent to you. Please review and sign to finalize your move-in.";
                    statusIcon.className = "fas fa-exclamation";
                    statusIconBg.className = "w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center flex-shrink-0 text-2xl animate-pulse";
                    actionCard.classList.remove('hidden-section');
                    break;

                // NEW: Handle Signed State Correctly
                case 'Lease Signed':
                    statusText.innerText = "Lease Signed";
                    statusText.className = "text-3xl font-extrabold text-purple-600 brand-font mb-2";
                    statusDesc.innerText = "You have signed the lease! We are now waiting for the landlord to countersign and finalize the agreement.";
                    statusIcon.className = "fas fa-file-signature";
                    statusIconBg.className = "w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center flex-shrink-0 text-2xl";
                    break;

                case 'Completed':
                case 'Active':
                    banner.classList.add('hidden-section');
                    tenantCard.classList.remove('hidden-section');
                    break;

                // NEW: Explicit Denial with Adverse Action
                case 'Deny':
                    statusText.innerText = "Application Denied";
                    statusText.className = "text-3xl font-extrabold text-rose-600 brand-font mb-2";
                    statusDesc.innerText = "We regret to inform you that your application has been declined based on our screening criteria.";
                    statusIcon.className = "fas fa-times";
                    statusIconBg.className = "w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center flex-shrink-0 text-2xl";
                    btnAdverse.classList.remove('hidden-section'); // Show the button
                    break;

                case 'Withdrawn':
                    statusText.innerText = "Withdrawn";
                    statusText.className = "text-3xl font-extrabold text-slate-400 brand-font mb-2";
                    statusDesc.innerText = "This application was withdrawn by the applicant.";
                    statusIcon.className = "fas fa-minus-circle";
                    statusIconBg.className = "w-16 h-16 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center flex-shrink-0 text-2xl";
                    break;
            }
        }

        // --- NEW: Adverse Action Modal ---
        function openAdverseAction() {
            document.getElementById('modal-adverse').classList.remove('hidden-modal');
        }

        function openSigningModal() {
            const frame = document.getElementById('lease-frame');
            const fallback = document.getElementById('lease-text-fallback');
            const loader = document.getElementById('lease-loading');
            const btnDown = document.getElementById('btn-download-lease');

            document.getElementById('modal-sign').classList.remove('hidden-section');
            document.getElementById('modal-sign').classList.add('flex');
            
            // Logic to show Real File vs Mock Text
            if(currentUserApp && currentUserApp.lease_url) {
                // Show Real PDF
                fallback.classList.add('hidden-section');
                frame.classList.remove('hidden-section');
                frame.src = currentUserApp.lease_url;
                
                // Set download link
                btnDown.href = currentUserApp.lease_url;
                btnDown.classList.remove('hidden-section');

                // Hide loader after a moment
                frame.onload = () => loader.classList.add('hidden-section');
            } else {
                // Show Fallback
                loader.classList.add('hidden-section');
                frame.classList.add('hidden-section');
                btnDown.classList.add('hidden-section');
                fallback.classList.remove('hidden-section');
            }
        }

        function closeSigningModal() {
            document.getElementById('modal-sign').classList.add('hidden-section');
            document.getElementById('modal-sign').classList.remove('flex');
            // Clear src to stop processing/playing if it was media
            document.getElementById('lease-frame').src = "";
        }

        // --- NEW EMAIL HELPER (Uses Supabase Edge Function) ---
        async function sendEmail(to, subject, type, data) {
            try {
                const { data: result, error } = await supabaseClient.functions.invoke('send-email', {
                    body: { to, subject, type, data }
                });
                if (error) throw error;
                console.log("Email sent:", result);
            } catch (e) { 
                console.error("Email failed:", e); 
            }
        }

        async function signLease() {
            closeSigningModal();
            if(!currentUserApp) return;
            
            // Optimistic UI Update immediately
            currentUserApp.status = 'Lease Signed';
            renderDashboard();

            // 1. Update Database Status
            await supabaseClient.from('apps').update({ status: 'Lease Signed' }).eq('id', currentUserApp.id);
            
            // Update Tenant Record (if exists)
            const { data: tenant } = await supabaseClient.from('tenants').select('id').eq('email', currentUserApp.email).maybeSingle();
            if(tenant) {
                await supabaseClient.from('tenants').update({ status: 'Lease Signed' }).eq('id', tenant.id);
            }

            // 2. Notify Owner
            if(currentUserApp.owner_id) {
                 const { data: owner } = await supabaseClient.from('owners').select('email').eq('id', currentUserApp.owner_id).single();
                 if(owner && owner.email) {
                     await sendEmail(
                         owner.email, 
                         "Action Required: Lease Signed", 
                         'alert', 
                         {
                            title: `Lease Signed by ${currentUserApp.name}`,
                            message: `The applicant has digitally signed the lease agreement. Please log in to countersign and finalize the move-in.`,
                            actionLink: "https://kozeyy.com/owner.html"
                         }
                     );
                 }
            }

            showModal("Signature Received!", "You have successfully signed the lease. The owner has been notified to finalize the agreement.");
            
            // Re-fetch to ensure sync
            setTimeout(fetchApplication, 2000);
        }

        async function respondToCondition(response) {
            if (!currentUserApp) return;

            let newStatus, title, msg;

            if (response === 'Accept') {
                newStatus = 'Approved';
                title = "Condition Accepted";
                msg = "Great! We have notified the property owner. You will receive a lease agreement shortly.";
            } else {
                newStatus = 'Withdrawn';
                title = "Application Withdrawn";
                msg = "Your application has been withdrawn. Best of luck in your search.";
            }

            openConfirm(
                `Confirm ${response}?`, 
                `Are you sure you want to ${response.toLowerCase()} this condition?`, 
                async () => {
                    document.getElementById('condition-card').classList.add('hidden-section');
                    document.getElementById('view-loading').classList.remove('hidden-section');
                    document.getElementById('view-dashboard').classList.add('hidden-section');

                    try {
                        const { error } = await supabaseClient
                            .from('apps')
                            .update({ status: newStatus })
                            .eq('id', currentUserApp.id);

                        if (error) throw error;

                        setTimeout(() => {
                            showModal(title, msg);
                            fetchApplication(); 
                        }, 1000);

                    } catch (err) {
                        console.error(err);
                        showModal("Error", "Error updating status: " + err.message);
                        fetchApplication(); 
                    }
                }
            );
        }

        // --- UI HELPERS ---
        function showModal(title, msg) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('platform-modal').classList.remove('hidden-modal');
        }
        function closeModal() {
            document.getElementById('platform-modal').classList.add('hidden-modal');
        }

        function logout() {
            if(confirm("Are you sure you want to log out?")) {
                localStorage.removeItem('kozeyy_user_id');
                window.location.href = 'login.html';
            }
        }

        // Confirm Modal Logic
        let confirmCallback = null;
        function openConfirm(title, msg, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('modal-confirm').classList.remove('hidden-modal');
            confirmCallback = callback;
        }
        function closeConfirm(val) {
            document.getElementById('modal-confirm').classList.add('hidden-modal');
            if(val && confirmCallback) confirmCallback();
            confirmCallback = null;
        }
    </script>
</body>
</html>
