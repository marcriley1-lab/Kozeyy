<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account | Kozeyy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .brand-font { font-family: 'Outfit', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .bg-image { background-image: url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80'); background-size: cover; background-position: center; }
        .role-selected { border-color: #4F46E5; background-color: #EEF2FF; color: #4338CA; }
        .role-default { border-color: #E2E8F0; background-color: #F8FAFC; color: #64748B; }
        .scroll-y::-webkit-scrollbar { width: 4px; }
        .scroll-y::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .hidden-modal { display: none !important; }
        .hidden-option { display: none !important; }
    </style>
</head>
<body class="bg-image min-h-screen flex items-center justify-center p-4 relative">

    <div class="absolute inset-0 bg-indigo-950/40 backdrop-blur-[2px]"></div>

    <div class="glass-panel w-full max-w-[500px] rounded-3xl shadow-2xl relative z-10 overflow-hidden max-h-[90vh] flex flex-col">
        <div class="h-2 w-full bg-gradient-to-r from-emerald-500 to-teal-500 flex-none"></div>

        <div class="p-8 md:p-10 overflow-y-auto scroll-y">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center gap-2 mb-4 bg-white/50 p-2 pr-4 rounded-full border border-slate-100 shadow-sm">
                    <div class="bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center">K</div>
                    <span class="text-xl font-bold text-slate-800 brand-font tracking-tight">Kozeyy</span>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 brand-font">Create Account</h2>
                <p class="text-sm text-slate-500 mt-2" id="subtitle-text">Join the future of property management</p>
            </div>

            <div id="error-banner" class="hidden mb-6 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl text-sm font-medium flex items-start gap-2">
                <i class="fas fa-exclamation-circle mt-0.5"></i> <span id="error-text"></span>
            </div>

            <form onsubmit="handleSignup(event)" class="space-y-5" novalidate>
                
                <div class="grid grid-cols-2 gap-4 mb-2" id="role-selector">
                    <label class="cursor-pointer">
                        <input type="radio" name="role" value="owner" class="hidden" checked onchange="toggleRole(this)">
                        <div id="role-owner" class="role-selected border-2 rounded-xl p-3 text-center transition">
                            <i class="fas fa-building mb-1 text-lg"></i>
                            <p class="text-xs font-bold uppercase">Landlord</p>
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="role" value="tenant" class="hidden" onchange="toggleRole(this)">
                        <div id="role-tenant" class="role-default border-2 rounded-xl p-3 text-center transition">
                            <i class="fas fa-key mb-1 text-lg"></i>
                            <p class="text-xs font-bold uppercase">Resident</p>
                        </div>
                    </label>
                </div>

                <div class="space-y-3 pt-2">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-1">Account Info</p>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Username</label><input type="text" id="username" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700" placeholder="jdalton88" required></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Email</label><input type="email" id="email" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700" placeholder="you@mail.com" required></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Password</label><input type="password" id="password" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700" placeholder="••••••••" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Confirm</label><input type="password" id="confirm-password" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700" placeholder="••••••••" required></div>
                    </div>
                </div>

                <div class="space-y-3 pt-2">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-1">Contact</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">First Name</label><input type="text" id="fname" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700" placeholder="James" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Last Name</label><input type="text" id="lname" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700" placeholder="Dalton" required></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">Phone</label><input type="tel" id="phone" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700" placeholder="(555) 123-4567" required></div>
                </div>

                <div class="pt-2">
                    <label class="flex items-start gap-3 cursor-pointer group">
                        <input type="checkbox" id="agree-terms" class="mt-1 w-5 h-5 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 cursor-pointer">
                        <span class="text-xs text-slate-500 leading-snug group-hover:text-slate-700">
                            I agree to the <a href="https://app.termly.io/policy-viewer/policy.html?policyUUID=43dc6ca4-366c-45de-b151-1091d7e77ec7" target="_blank" class="text-indigo-600 font-bold hover:underline">Terms of Service</a> and <a href="https://app.termly.io/policy-viewer/policy.html?policyUUID=b2a9fb2d-f565-41df-b672-d594e28d7f75" target="_blank" class="text-indigo-600 font-bold hover:underline">Privacy Policy</a>.
                        </span>
                    </label>
                </div>

                <button type="submit" id="btn-signup" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-emerald-600 active:scale-[0.98] transition shadow-lg shadow-slate-900/20 text-base flex items-center justify-center gap-2 mt-6">Complete Registration</button>
            </form>
            <div class="mt-6 text-center pb-2"><p class="text-xs text-slate-400">Already have an account? <a href="login.html" class="text-indigo-600 font-bold hover:underline">Log in</a></p></div>
        </div>
    </div>

    <div id="platform-modal" class="hidden-modal fixed inset-0 bg-slate-900/60 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mx-auto mb-4 text-xl"><i class="fas fa-info-circle"></i></div>
            <h3 class="text-lg font-bold mb-2 text-slate-900" id="modal-title">Error</h3>
            <p class="text-sm text-slate-500 mb-6" id="modal-msg">Something went wrong.</p>
            <button onclick="closeModal()" class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm transition">Okay</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xhufxnqfflnzlqhzhtaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWZ4bnFmZmxuemxxaHpodGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTkwMjUsImV4cCI6MjA3OTMzNTAyNX0.YXbjjLf90j6kGIwDVcZcJ8Cp0979acu3-OooNJ4hrmE';
        let supabaseClient = null;
        try { if(window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}

        let pendingListingId = null;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            pendingListingId = urlParams.get('listing_id');
            
            if(pendingListingId) {
                document.getElementById('role-selector').classList.add('hidden-option');
                document.getElementById('subtitle-text').innerText = "Create a resident account to continue application";
                const tenantRadio = document.querySelector('input[value="tenant"]');
                if(tenantRadio) {
                    tenantRadio.checked = true;
                    toggleRole(tenantRadio);
                }
            }
        };

        function toggleRole(radio) {
            const isOwner = radio.value === 'owner';
            document.getElementById('role-owner').className = isOwner ? 'role-selected border-2 rounded-xl p-3 text-center transition' : 'role-default border-2 rounded-xl p-3 text-center transition';
            document.getElementById('role-tenant').className = !isOwner ? 'role-selected border-2 rounded-xl p-3 text-center transition' : 'role-default border-2 rounded-xl p-3 text-center transition';
        }

       async function handleSignup(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-signup');
            const originalText = btn.innerHTML;
            
            // Get form values
            const role = document.querySelector('input[name="role"]:checked').value;
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirm-password').value;
            const fname = document.getElementById('fname').value.trim();
            const lname = document.getElementById('lname').value.trim();
            const phone = document.getElementById('phone').value.trim();
            
            // --- NEW: VALIDATE TERMS ---
            const agreed = document.getElementById('agree-terms').checked;
            
            if(!username || !email || !password || !fname || !lname) return showModal("Error", "Please fill in all required fields.");
            if(password !== confirm) return showModal("Error", "Passwords do not match.");
            if(!agreed) return showModal("Terms Required", "You must agree to the Terms of Service and Privacy Policy to create an account.");

            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Creating...`;
            btn.disabled = true;

            try {
                if(!supabaseClient) throw new Error("Database error");

                const now = new Date().toISOString();

                // 1. CREATE SECURE USER IN SUPABASE AUTH
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            role: role,
                            name: `${fname} ${lname}`,
                            phone: phone
                        }
                    }
                });

                if (authError) throw authError;

                const userId = authData.user.id;
                const userProfile = { 
                    username, 
                    name: `${fname} ${lname}`, 
                    email, 
                    phone, 
                    role, 
                    initials: (fname[0]+lname[0]).toUpperCase() 
                };

                // 2. CREATE PUBLIC RECORD
                if(role === 'tenant') {
                    const { data: existing } = await supabaseClient.from('tenants').select('*').eq('email', email).maybeSingle();
                    
                    if(existing && (existing.owner_id || existing.status === 'Active')) {
                        await supabaseClient.from('tenants').update({
                                id: userId,
                                name: userProfile.name,
                                phone: phone,
                                status: 'Active',
                                tos_agreed_at: now // Record timestamp
                            }).eq('email', email);
                    } else {
                        await supabaseClient.from('tenants').insert([{
                                id: userId,
                                name: userProfile.name,
                                email: email,
                                phone: phone,
                                status: 'Applicant',
                                rent_amount: 0,
                                tos_agreed_at: now // Record timestamp
                            }]);
                    }
                } else {
                    // Owner Record
                    await supabaseClient.from('owners').insert([{
                            id: userId,
                            name: `${fname} ${lname}`,
                            email: email,
                            phone: phone,
                            tos_agreed_at: now // Record timestamp
                        }]);
                }

                // 3. SEND REGISTRATION EMAIL
                try {
                    await supabaseClient.functions.invoke('send-email', {
                        body: { 
                            to: email, 
                            subject: "Account Created - Kozeyy", 
                            type: "action", 
                            data: { 
                                title: "Registration Successful",
                                message: `Hi ${fname}, your account has been created. You can now log in to complete your rental application.`,
                                actionLink: "https://kozeyy.com/login.html",
                                actionText: "Log In Now"
                            } 
                        }
                    });
                } catch (emailErr) {
                    console.warn("Welcome email failed:", emailErr);
                }

                // 4. SAVE SESSION & REDIRECT
                localStorage.setItem('kozeyy_user_id', userId);
                localStorage.setItem('kozeyy_role', role);
                localStorage.setItem('kozeyy_profile', JSON.stringify(userProfile));

                if(pendingListingId && role === 'tenant') {
                    window.location.href = `applicant.html?listing_id=${pendingListingId}`;
                } else if(role === 'owner') {
                    window.location.href = 'owner.html';
                } else {
                    window.location.href = 'tenant.html';
                }

            } catch(err) {
                console.error(err);
                showModal("Error", err.message || "Signup failed");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showModal(title, msg) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('platform-modal').classList.remove('hidden-modal');
        }
        function closeModal() {
            document.getElementById('platform-modal').classList.add('hidden-modal');
        }
    </script>
</body>
</html>

